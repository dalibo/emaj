-- mark.sql : test emaj_set_mark_group(), emaj_set_mark_groups(), emaj_comment_mark_group(),
-- emaj_rename_mark_group(), emaj_get_previous_mark_group(), emaj_delete_mark_group(),
-- emaj_protect_mark_group() and emaj_unprotect_mark_group() functions
--
-- set sequence restart value
select public.handle_emaj_sequences(3000);
 handle_emaj_sequences 
-----------------------
 
(1 row)

select emaj.emaj_start_group('myGroup1','Mark1');
 emaj_start_group 
------------------
                7
(1 row)

select emaj.emaj_start_group('myGroup2','Mark2');
 emaj_start_group 
------------------
               10
(1 row)

select emaj.emaj_start_group('emptyGroup','MarkInit');
 emaj_start_group 
------------------
                0
(1 row)

-----------------------------
-- emaj_set_mark_group() tests
-----------------------------
-- group is unknown
select emaj.emaj_set_mark_group(NULL,NULL);
ERROR:  _check_group_names: No group to process.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,boolean,boolean,boolean,boolean) line 30 at RAISE
SQL statement "SELECT emaj._check_group_names(p_groupNames := ARRAY[p_groupName], p_mayBeNull := FALSE, p_lockGroups := TRUE,
                                    p_checkLogging := TRUE)"
PL/pgSQL function emaj.emaj_set_mark_group(text,text) line 15 at PERFORM
select emaj.emaj_set_mark_group('unknownGroup',NULL);
ERROR:  _check_group_names: The group "unknownGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,boolean,boolean,boolean,boolean) line 42 at RAISE
SQL statement "SELECT emaj._check_group_names(p_groupNames := ARRAY[p_groupName], p_mayBeNull := FALSE, p_lockGroups := TRUE,
                                    p_checkLogging := TRUE)"
PL/pgSQL function emaj.emaj_set_mark_group(text,text) line 15 at PERFORM
-- reserved mark name
select emaj.emaj_set_mark_group('myGroup1','EMAJ_LAST_MARK');
ERROR:  _check_new_mark: "EMAJ_LAST_MARK" is not an allowed name for a new mark.
CONTEXT:  PL/pgSQL function emaj._check_new_mark(text[],text) line 14 at RAISE
SQL statement "SELECT emaj._check_new_mark(array[p_groupName], p_mark)"
PL/pgSQL function emaj.emaj_set_mark_group(text,text) line 21 at SQL statement
-- should be OK
select emaj.emaj_set_mark_group('myGroup1','SM1');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

select emaj.emaj_set_mark_group('myGroup2','SM1');
 emaj_set_mark_group 
---------------------
                  10
(1 row)

select emaj.emaj_set_mark_group('myGroup2','phil''s mark #1');
 emaj_set_mark_group 
---------------------
                  10
(1 row)

select emaj.emaj_set_mark_group('emptyGroup','SM1');
 emaj_set_mark_group 
---------------------
                   0
(1 row)

-- duplicate mark name
select emaj.emaj_set_mark_group('myGroup1','SM1');
ERROR:  _check_new_mark: The group "myGroup1" already contains a mark named "SM1".
CONTEXT:  PL/pgSQL function emaj._check_new_mark(text[],text) line 29 at RAISE
SQL statement "SELECT emaj._check_new_mark(array[p_groupName], p_mark)"
PL/pgSQL function emaj.emaj_set_mark_group(text,text) line 21 at SQL statement
-- mark with generated name and in a single transaction
begin transaction;
  select emaj.emaj_set_mark_group('myGroup1',NULL);
 emaj_set_mark_group 
---------------------
                   7
(1 row)

  select emaj.emaj_set_mark_group('myGroup2','');
 emaj_set_mark_group 
---------------------
                  10
(1 row)

commit;
-- default value for mark name
select pg_sleep(0.001);
 pg_sleep 
----------
 
(1 row)

select emaj.emaj_set_mark_group('myGroup2');
 emaj_set_mark_group 
---------------------
                  10
(1 row)

-- use of % in mark name
select emaj.emaj_set_mark_group('myGroup1','Foo%Bar');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

-- multiple emaj_set_mark_group() using the same generated start mark name => fails
-- this test is commented because the generated error message differs from one run to another
--begin;
--  select emaj.emaj_start_group('myGroup4');
--  select emaj.emaj_set_mark_group('myGroup4');
--  select emaj.emaj_set_mark_group('myGroup4');
--rollback;
-----------------------------
-- emaj_set_mark_groups() tests
-----------------------------
-- NULL group names array
select emaj.emaj_set_mark_groups(NULL,NULL);
WARNING:  _check_group_names: No group to process.
 emaj_set_mark_groups 
----------------------
                    0
(1 row)

-- groups array is unknown
select emaj.emaj_set_mark_groups('{"unknownGroup",""}',NULL);
ERROR:  _check_group_names: The group "unknownGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,boolean,boolean,boolean,boolean) line 42 at RAISE
SQL statement "SELECT emaj._check_group_names(p_groupNames := p_groupNames, p_mayBeNull := TRUE, p_lockGroups := TRUE, p_checkLogging := TRUE)"
PL/pgSQL function emaj.emaj_set_mark_groups(text[],text) line 15 at SQL statement
-- reserved mark name
select emaj.emaj_set_mark_groups('{"myGroup1"}','EMAJ_LAST_MARK');
ERROR:  _check_new_mark: "EMAJ_LAST_MARK" is not an allowed name for a new mark.
CONTEXT:  PL/pgSQL function emaj._check_new_mark(text[],text) line 14 at RAISE
SQL statement "SELECT emaj._check_new_mark(p_groupNames, p_mark)"
PL/pgSQL function emaj.emaj_set_mark_groups(text[],text) line 23 at SQL statement
-- should be OK
select emaj.emaj_set_mark_groups('{"myGroup1","myGroup2"}','SM3');
 emaj_set_mark_groups 
----------------------
                   17
(1 row)

-- duplicate mark name and warning on group names array content
select emaj.emaj_set_mark_groups(array['myGroup1',NULL,'myGroup2','','myGroup2','emptyGroup','myGroup2','myGroup1'],'SM3');
ERROR:  _check_new_mark: The groups "myGroup1, myGroup2" already contain a mark named "SM3".
CONTEXT:  PL/pgSQL function emaj._check_new_mark(text[],text) line 31 at RAISE
SQL statement "SELECT emaj._check_new_mark(p_groupNames, p_mark)"
PL/pgSQL function emaj.emaj_set_mark_groups(text[],text) line 23 at SQL statement
-- generated mark name
select emaj.emaj_set_mark_groups('{"myGroup1","myGroup2"}','');
 emaj_set_mark_groups 
----------------------
                   17
(1 row)

select pg_sleep(0.001);
 pg_sleep 
----------
 
(1 row)

select emaj.emaj_set_mark_groups('{"myGroup1","myGroup2"}',NULL);
 emaj_set_mark_groups 
----------------------
                   17
(1 row)

select pg_sleep(0.001);
 pg_sleep 
----------
 
(1 row)

select emaj.emaj_set_mark_groups('{"myGroup1","myGroup2"}');
 emaj_set_mark_groups 
----------------------
                   17
(1 row)

-- use of % in mark name
select emaj.emaj_set_mark_groups('{"myGroup1","myGroup2"}','Bar%Foo');
 emaj_set_mark_groups 
----------------------
                   17
(1 row)

-- check for emaj_set_mark_group() and emaj_set_mark_groups()
select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_deleted, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_time_id, mark_group;
    mark_group    | regexp_replace | mark_time_id | mark_is_deleted | mark_is_rlbk_protected | mark_comment | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------------+----------------+--------------+-----------------+------------------------+--------------+---------------------------+------------------------------
 phil's group#3", | Mark3          |         2004 | f               | f                      |              |                           | 
 myGroup1         | Mark1          |         3000 | f               | f                      |              |                         0 | 
 myGroup2         | Mark2          |         3001 | f               | f                      |              |                         0 | 
 emptyGroup       | MarkInit       |         3002 | f               | f                      |              |                         0 | 
 myGroup1         | SM1            |         3003 | f               | f                      |              |                         0 | 
 myGroup2         | SM1            |         3004 | f               | f                      |              |                         0 | 
 myGroup2         | phil's mark #1 |         3005 | f               | f                      |              |                         0 | 
 emptyGroup       | SM1            |         3006 | f               | f                      |              |                           | 
 myGroup1         | MARK_%         |         3007 | f               | f                      |              |                         0 | 
 myGroup2         | MARK_%         |         3008 | f               | f                      |              |                         0 | 
 myGroup2         | MARK_%         |         3009 | f               | f                      |              |                         0 | 
 myGroup1         | Foo%Bar        |         3010 | f               | f                      |              |                         0 | 
 myGroup1         | SM3            |         3011 | f               | f                      |              |                         0 | 
 myGroup2         | SM3            |         3011 | f               | f                      |              |                         0 | 
 myGroup1         | MARK_%         |         3012 | f               | f                      |              |                         0 | 
 myGroup2         | MARK_%         |         3012 | f               | f                      |              |                         0 | 
 myGroup1         | MARK_%         |         3013 | f               | f                      |              |                         0 | 
 myGroup2         | MARK_%         |         3013 | f               | f                      |              |                         0 | 
 myGroup1         | MARK_%         |         3014 | f               | f                      |              |                         0 | 
 myGroup2         | MARK_%         |         3014 | f               | f                      |              |                         0 | 
 myGroup1         | Bar%Foo        |         3015 | f               | f                      |              |                           | 
 myGroup2         | Bar%Foo        |         3015 | f               | f                      |              |                           | 
(22 rows)

select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 3000 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
    3000 |            3000000 | S
    3001 |            3000000 | S
    3002 |            3000000 | S
    3003 |            3000000 | M
    3004 |            3000000 | M
    3005 |            3000000 | M
    3006 |            3000000 | M
    3007 |            3000000 | M
    3008 |            3000000 | M
    3009 |            3000000 | M
    3010 |            3000000 | M
    3011 |            3000000 | M
    3012 |            3000000 | M
    3013 |            3000000 | M
    3014 |            3000000 | M
    3015 |            3000000 | M
(16 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
  sequ_schema   |     sequ_name     | sequ_time_id | sequ_last_val | sequ_is_called 
----------------+-------------------+--------------+---------------+----------------
 phil's schema3 | myTbl2\_col21_seq |         2004 |             1 | f
 phil's schema3 | phil's seq\1      |         2004 |          1000 | f
 myschema1      | myTbl3_col31_seq  |         3000 |             1 | f
 myschema1      | mytbl2b_col20_seq |         3000 |             1 | f
 myschema2      | myTbl3_col31_seq  |         3001 |             1 | f
 myschema2      | myseq1            |         3001 |          1000 | f
 myschema1      | myTbl3_col31_seq  |         3003 |             1 | f
 myschema1      | mytbl2b_col20_seq |         3003 |             1 | f
 myschema2      | myTbl3_col31_seq  |         3004 |             1 | f
 myschema2      | myseq1            |         3004 |          1000 | f
 myschema2      | myTbl3_col31_seq  |         3005 |             1 | f
 myschema2      | myseq1            |         3005 |          1000 | f
 myschema1      | myTbl3_col31_seq  |         3007 |             1 | f
 myschema1      | mytbl2b_col20_seq |         3007 |             1 | f
 myschema2      | myTbl3_col31_seq  |         3008 |             1 | f
 myschema2      | myseq1            |         3008 |          1000 | f
 myschema2      | myTbl3_col31_seq  |         3009 |             1 | f
 myschema2      | myseq1            |         3009 |          1000 | f
 myschema1      | myTbl3_col31_seq  |         3010 |             1 | f
 myschema1      | mytbl2b_col20_seq |         3010 |             1 | f
 myschema1      | myTbl3_col31_seq  |         3011 |             1 | f
 myschema1      | mytbl2b_col20_seq |         3011 |             1 | f
 myschema2      | myTbl3_col31_seq  |         3011 |             1 | f
 myschema2      | myseq1            |         3011 |          1000 | f
 myschema1      | myTbl3_col31_seq  |         3012 |             1 | f
 myschema1      | mytbl2b_col20_seq |         3012 |             1 | f
 myschema2      | myTbl3_col31_seq  |         3012 |             1 | f
 myschema2      | myseq1            |         3012 |          1000 | f
 myschema1      | myTbl3_col31_seq  |         3013 |             1 | f
 myschema1      | mytbl2b_col20_seq |         3013 |             1 | f
 myschema2      | myTbl3_col31_seq  |         3013 |             1 | f
 myschema2      | myseq1            |         3013 |          1000 | f
 myschema1      | myTbl3_col31_seq  |         3014 |             1 | f
 myschema1      | mytbl2b_col20_seq |         3014 |             1 | f
 myschema2      | myTbl3_col31_seq  |         3014 |             1 | f
 myschema2      | myseq1            |         3014 |          1000 | f
 myschema1      | myTbl3_col31_seq  |         3015 |             1 | f
 myschema1      | mytbl2b_col20_seq |         3015 |             1 | f
 myschema2      | myTbl3_col31_seq  |         3015 |             1 | f
 myschema2      | myseq1            |         3015 |          1000 | f
(40 rows)

select tbl_schema, tbl_name, tbl_time_id, tbl_tuples, tbl_pages, tbl_log_seq_last_val from emaj.emaj_table order by tbl_time_id, tbl_schema, tbl_name;
   tbl_schema   |  tbl_name   | tbl_time_id | tbl_tuples | tbl_pages | tbl_log_seq_last_val 
----------------+-------------+-------------+------------+-----------+----------------------
 phil's schema3 | myTbl2\     |        2004 |         -1 |         0 |                    0
 phil's schema3 | phil's tbl1 |        2004 |         -1 |         0 |                    0
 myschema1      | myTbl3      |        3000 |         -1 |         0 |                    0
 myschema1      | mytbl1      |        3000 |         -1 |         0 |                    0
 myschema1      | mytbl2      |        3000 |         -1 |         0 |                    0
 myschema1      | mytbl2b     |        3000 |         -1 |         0 |                    0
 myschema1      | mytbl4      |        3000 |         -1 |         0 |                    0
 myschema2      | myTbl3      |        3001 |         -1 |         0 |                    0
 myschema2      | mytbl1      |        3001 |         -1 |         0 |                    0
 myschema2      | mytbl2      |        3001 |         -1 |         0 |                    0
 myschema2      | mytbl4      |        3001 |         -1 |         0 |                    0
 myschema2      | mytbl5      |        3001 |         -1 |         0 |                    0
 myschema2      | mytbl6      |        3001 |         -1 |         0 |                    0
 myschema2      | mytbl7      |        3001 |         -1 |         0 |                    0
 myschema2      | mytbl8      |        3001 |         -1 |         0 |                    0
 myschema1      | myTbl3      |        3003 |         -1 |         0 |                    0
 myschema1      | mytbl1      |        3003 |         -1 |         0 |                    0
 myschema1      | mytbl2      |        3003 |         -1 |         0 |                    0
 myschema1      | mytbl2b     |        3003 |         -1 |         0 |                    0
 myschema1      | mytbl4      |        3003 |         -1 |         0 |                    0
 myschema2      | myTbl3      |        3004 |         -1 |         0 |                    0
 myschema2      | mytbl1      |        3004 |         -1 |         0 |                    0
 myschema2      | mytbl2      |        3004 |         -1 |         0 |                    0
 myschema2      | mytbl4      |        3004 |         -1 |         0 |                    0
 myschema2      | mytbl5      |        3004 |         -1 |         0 |                    0
 myschema2      | mytbl6      |        3004 |         -1 |         0 |                    0
 myschema2      | mytbl7      |        3004 |         -1 |         0 |                    0
 myschema2      | mytbl8      |        3004 |         -1 |         0 |                    0
 myschema2      | myTbl3      |        3005 |         -1 |         0 |                    0
 myschema2      | mytbl1      |        3005 |         -1 |         0 |                    0
 myschema2      | mytbl2      |        3005 |         -1 |         0 |                    0
 myschema2      | mytbl4      |        3005 |         -1 |         0 |                    0
 myschema2      | mytbl5      |        3005 |         -1 |         0 |                    0
 myschema2      | mytbl6      |        3005 |         -1 |         0 |                    0
 myschema2      | mytbl7      |        3005 |         -1 |         0 |                    0
 myschema2      | mytbl8      |        3005 |         -1 |         0 |                    0
 myschema1      | myTbl3      |        3007 |         -1 |         0 |                    0
 myschema1      | mytbl1      |        3007 |         -1 |         0 |                    0
 myschema1      | mytbl2      |        3007 |         -1 |         0 |                    0
 myschema1      | mytbl2b     |        3007 |         -1 |         0 |                    0
 myschema1      | mytbl4      |        3007 |         -1 |         0 |                    0
 myschema2      | myTbl3      |        3008 |         -1 |         0 |                    0
 myschema2      | mytbl1      |        3008 |         -1 |         0 |                    0
 myschema2      | mytbl2      |        3008 |         -1 |         0 |                    0
 myschema2      | mytbl4      |        3008 |         -1 |         0 |                    0
 myschema2      | mytbl5      |        3008 |         -1 |         0 |                    0
 myschema2      | mytbl6      |        3008 |         -1 |         0 |                    0
 myschema2      | mytbl7      |        3008 |         -1 |         0 |                    0
 myschema2      | mytbl8      |        3008 |         -1 |         0 |                    0
 myschema2      | myTbl3      |        3009 |         -1 |         0 |                    0
 myschema2      | mytbl1      |        3009 |         -1 |         0 |                    0
 myschema2      | mytbl2      |        3009 |         -1 |         0 |                    0
 myschema2      | mytbl4      |        3009 |         -1 |         0 |                    0
 myschema2      | mytbl5      |        3009 |         -1 |         0 |                    0
 myschema2      | mytbl6      |        3009 |         -1 |         0 |                    0
 myschema2      | mytbl7      |        3009 |         -1 |         0 |                    0
 myschema2      | mytbl8      |        3009 |         -1 |         0 |                    0
 myschema1      | myTbl3      |        3010 |         -1 |         0 |                    0
 myschema1      | mytbl1      |        3010 |         -1 |         0 |                    0
 myschema1      | mytbl2      |        3010 |         -1 |         0 |                    0
 myschema1      | mytbl2b     |        3010 |         -1 |         0 |                    0
 myschema1      | mytbl4      |        3010 |         -1 |         0 |                    0
 myschema1      | myTbl3      |        3011 |         -1 |         0 |                    0
 myschema1      | mytbl1      |        3011 |         -1 |         0 |                    0
 myschema1      | mytbl2      |        3011 |         -1 |         0 |                    0
 myschema1      | mytbl2b     |        3011 |         -1 |         0 |                    0
 myschema1      | mytbl4      |        3011 |         -1 |         0 |                    0
 myschema2      | myTbl3      |        3011 |         -1 |         0 |                    0
 myschema2      | mytbl1      |        3011 |         -1 |         0 |                    0
 myschema2      | mytbl2      |        3011 |         -1 |         0 |                    0
 myschema2      | mytbl4      |        3011 |         -1 |         0 |                    0
 myschema2      | mytbl5      |        3011 |         -1 |         0 |                    0
 myschema2      | mytbl6      |        3011 |         -1 |         0 |                    0
 myschema2      | mytbl7      |        3011 |         -1 |         0 |                    0
 myschema2      | mytbl8      |        3011 |         -1 |         0 |                    0
 myschema1      | myTbl3      |        3012 |         -1 |         0 |                    0
 myschema1      | mytbl1      |        3012 |         -1 |         0 |                    0
 myschema1      | mytbl2      |        3012 |         -1 |         0 |                    0
 myschema1      | mytbl2b     |        3012 |         -1 |         0 |                    0
 myschema1      | mytbl4      |        3012 |         -1 |         0 |                    0
 myschema2      | myTbl3      |        3012 |         -1 |         0 |                    0
 myschema2      | mytbl1      |        3012 |         -1 |         0 |                    0
 myschema2      | mytbl2      |        3012 |         -1 |         0 |                    0
 myschema2      | mytbl4      |        3012 |         -1 |         0 |                    0
 myschema2      | mytbl5      |        3012 |         -1 |         0 |                    0
 myschema2      | mytbl6      |        3012 |         -1 |         0 |                    0
 myschema2      | mytbl7      |        3012 |         -1 |         0 |                    0
 myschema2      | mytbl8      |        3012 |         -1 |         0 |                    0
 myschema1      | myTbl3      |        3013 |         -1 |         0 |                    0
 myschema1      | mytbl1      |        3013 |         -1 |         0 |                    0
 myschema1      | mytbl2      |        3013 |         -1 |         0 |                    0
 myschema1      | mytbl2b     |        3013 |         -1 |         0 |                    0
 myschema1      | mytbl4      |        3013 |         -1 |         0 |                    0
 myschema2      | myTbl3      |        3013 |         -1 |         0 |                    0
 myschema2      | mytbl1      |        3013 |         -1 |         0 |                    0
 myschema2      | mytbl2      |        3013 |         -1 |         0 |                    0
 myschema2      | mytbl4      |        3013 |         -1 |         0 |                    0
 myschema2      | mytbl5      |        3013 |         -1 |         0 |                    0
 myschema2      | mytbl6      |        3013 |         -1 |         0 |                    0
 myschema2      | mytbl7      |        3013 |         -1 |         0 |                    0
 myschema2      | mytbl8      |        3013 |         -1 |         0 |                    0
 myschema1      | myTbl3      |        3014 |         -1 |         0 |                    0
 myschema1      | mytbl1      |        3014 |         -1 |         0 |                    0
 myschema1      | mytbl2      |        3014 |         -1 |         0 |                    0
 myschema1      | mytbl2b     |        3014 |         -1 |         0 |                    0
 myschema1      | mytbl4      |        3014 |         -1 |         0 |                    0
 myschema2      | myTbl3      |        3014 |         -1 |         0 |                    0
 myschema2      | mytbl1      |        3014 |         -1 |         0 |                    0
 myschema2      | mytbl2      |        3014 |         -1 |         0 |                    0
 myschema2      | mytbl4      |        3014 |         -1 |         0 |                    0
 myschema2      | mytbl5      |        3014 |         -1 |         0 |                    0
 myschema2      | mytbl6      |        3014 |         -1 |         0 |                    0
 myschema2      | mytbl7      |        3014 |         -1 |         0 |                    0
 myschema2      | mytbl8      |        3014 |         -1 |         0 |                    0
 myschema1      | myTbl3      |        3015 |         -1 |         0 |                    0
 myschema1      | mytbl1      |        3015 |         -1 |         0 |                    0
 myschema1      | mytbl2      |        3015 |         -1 |         0 |                    0
 myschema1      | mytbl2b     |        3015 |         -1 |         0 |                    0
 myschema1      | mytbl4      |        3015 |         -1 |         0 |                    0
 myschema2      | myTbl3      |        3015 |         -1 |         0 |                    0
 myschema2      | mytbl1      |        3015 |         -1 |         0 |                    0
 myschema2      | mytbl2      |        3015 |         -1 |         0 |                    0
 myschema2      | mytbl4      |        3015 |         -1 |         0 |                    0
 myschema2      | mytbl5      |        3015 |         -1 |         0 |                    0
 myschema2      | mytbl6      |        3015 |         -1 |         0 |                    0
 myschema2      | mytbl7      |        3015 |         -1 |         0 |                    0
 myschema2      | mytbl8      |        3015 |         -1 |         0 |                    0
(127 rows)

select hist_id, hist_function, hist_event, hist_object, 
  regexp_replace(regexp_replace(hist_wording,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),E'\\[.+\\]','(timestamp)','g'),
  hist_user from emaj.emaj_hist where hist_id >= 3000 order by hist_id;
 hist_id |  hist_function  | hist_event |    hist_object    |         regexp_replace          | hist_user 
---------+-----------------+------------+-------------------+---------------------------------+-----------
    3000 | START_GROUP     | BEGIN      | myGroup1          | With log reset                  | postgres
    3001 | LOCK_GROUP      | BEGIN      | myGroup1          |                                 | postgres
    3002 | LOCK_GROUP      | END        | myGroup1          | 5 tables locked, 0 deadlock(s)  | postgres
    3003 | SET_MARK_GROUP  | BEGIN      | myGroup1          | Mark1                           | postgres
    3004 | SET_MARK_GROUP  | END        | myGroup1          | Mark1                           | postgres
    3005 | START_GROUP     | END        | myGroup1          | 7 tables/sequences processed    | postgres
    3006 | START_GROUP     | BEGIN      | myGroup2          | With log reset                  | postgres
    3007 | LOCK_GROUP      | BEGIN      | myGroup2          |                                 | postgres
    3008 | LOCK_GROUP      | END        | myGroup2          | 8 tables locked, 0 deadlock(s)  | postgres
    3009 | SET_MARK_GROUP  | BEGIN      | myGroup2          | Mark2                           | postgres
    3010 | SET_MARK_GROUP  | END        | myGroup2          | Mark2                           | postgres
    3011 | START_GROUP     | END        | myGroup2          | 10 tables/sequences processed   | postgres
    3012 | START_GROUP     | BEGIN      | emptyGroup        | With log reset                  | postgres
    3013 | LOCK_GROUP      | BEGIN      | emptyGroup        |                                 | postgres
    3014 | LOCK_GROUP      | END        | emptyGroup        | 0 tables locked, 0 deadlock(s)  | postgres
    3015 | SET_MARK_GROUP  | BEGIN      | emptyGroup        | MarkInit                        | postgres
    3016 | SET_MARK_GROUP  | END        | emptyGroup        | MarkInit                        | postgres
    3017 | START_GROUP     | END        | emptyGroup        | 0 tables/sequences processed    | postgres
    3021 | SET_MARK_GROUP  | BEGIN      | myGroup1          |                                 | postgres
    3022 | LOCK_GROUP      | BEGIN      | myGroup1          |                                 | postgres
    3023 | LOCK_GROUP      | END        | myGroup1          | 5 tables locked, 0 deadlock(s)  | postgres
    3024 | SET_MARK_GROUP  | END        | myGroup1          | SM1                             | postgres
    3025 | SET_MARK_GROUP  | BEGIN      | myGroup2          |                                 | postgres
    3026 | LOCK_GROUP      | BEGIN      | myGroup2          |                                 | postgres
    3027 | LOCK_GROUP      | END        | myGroup2          | 8 tables locked, 0 deadlock(s)  | postgres
    3028 | SET_MARK_GROUP  | END        | myGroup2          | SM1                             | postgres
    3029 | SET_MARK_GROUP  | BEGIN      | myGroup2          |                                 | postgres
    3030 | LOCK_GROUP      | BEGIN      | myGroup2          |                                 | postgres
    3031 | LOCK_GROUP      | END        | myGroup2          | 8 tables locked, 0 deadlock(s)  | postgres
    3032 | SET_MARK_GROUP  | END        | myGroup2          | phil's mark #1                  | postgres
    3033 | SET_MARK_GROUP  | BEGIN      | emptyGroup        |                                 | postgres
    3034 | LOCK_GROUP      | BEGIN      | emptyGroup        |                                 | postgres
    3035 | LOCK_GROUP      | END        | emptyGroup        | 0 tables locked, 0 deadlock(s)  | postgres
    3036 | SET_MARK_GROUP  | END        | emptyGroup        | SM1                             | postgres
    3038 | SET_MARK_GROUP  | BEGIN      | myGroup1          |                                 | postgres
    3039 | LOCK_GROUP      | BEGIN      | myGroup1          |                                 | postgres
    3040 | LOCK_GROUP      | END        | myGroup1          | 5 tables locked, 0 deadlock(s)  | postgres
    3041 | SET_MARK_GROUP  | END        | myGroup1          | MARK_%                          | postgres
    3042 | SET_MARK_GROUP  | BEGIN      | myGroup2          |                                 | postgres
    3043 | LOCK_GROUP      | BEGIN      | myGroup2          |                                 | postgres
    3044 | LOCK_GROUP      | END        | myGroup2          | 8 tables locked, 0 deadlock(s)  | postgres
    3045 | SET_MARK_GROUP  | END        | myGroup2          | MARK_%                          | postgres
    3046 | SET_MARK_GROUP  | BEGIN      | myGroup2          |                                 | postgres
    3047 | LOCK_GROUP      | BEGIN      | myGroup2          |                                 | postgres
    3048 | LOCK_GROUP      | END        | myGroup2          | 8 tables locked, 0 deadlock(s)  | postgres
    3049 | SET_MARK_GROUP  | END        | myGroup2          | MARK_%                          | postgres
    3050 | SET_MARK_GROUP  | BEGIN      | myGroup1          |                                 | postgres
    3051 | LOCK_GROUP      | BEGIN      | myGroup1          |                                 | postgres
    3052 | LOCK_GROUP      | END        | myGroup1          | 5 tables locked, 0 deadlock(s)  | postgres
    3053 | SET_MARK_GROUP  | END        | myGroup1          | Foo%Bar                         | postgres
    3054 | SET_MARK_GROUPS | BEGIN      |                   |                                 | postgres
    3055 | SET_MARK_GROUPS | END        |                   |                                 | postgres
    3058 | SET_MARK_GROUPS | BEGIN      | myGroup1,myGroup2 | SM3                             | postgres
    3059 | LOCK_GROUPS     | BEGIN      | myGroup1,myGroup2 |                                 | postgres
    3060 | LOCK_GROUPS     | END        | myGroup1,myGroup2 | 13 tables locked, 0 deadlock(s) | postgres
    3061 | SET_MARK_GROUPS | END        | myGroup1,myGroup2 | SM3                             | postgres
    3063 | SET_MARK_GROUPS | BEGIN      | myGroup1,myGroup2 |                                 | postgres
    3064 | LOCK_GROUPS     | BEGIN      | myGroup1,myGroup2 |                                 | postgres
    3065 | LOCK_GROUPS     | END        | myGroup1,myGroup2 | 13 tables locked, 0 deadlock(s) | postgres
    3066 | SET_MARK_GROUPS | END        | myGroup1,myGroup2 |                                 | postgres
    3067 | SET_MARK_GROUPS | BEGIN      | myGroup1,myGroup2 |                                 | postgres
    3068 | LOCK_GROUPS     | BEGIN      | myGroup1,myGroup2 |                                 | postgres
    3069 | LOCK_GROUPS     | END        | myGroup1,myGroup2 | 13 tables locked, 0 deadlock(s) | postgres
    3070 | SET_MARK_GROUPS | END        | myGroup1,myGroup2 |                                 | postgres
    3071 | SET_MARK_GROUPS | BEGIN      | myGroup1,myGroup2 |                                 | postgres
    3072 | LOCK_GROUPS     | BEGIN      | myGroup1,myGroup2 |                                 | postgres
    3073 | LOCK_GROUPS     | END        | myGroup1,myGroup2 | 13 tables locked, 0 deadlock(s) | postgres
    3074 | SET_MARK_GROUPS | END        | myGroup1,myGroup2 |                                 | postgres
    3075 | SET_MARK_GROUPS | BEGIN      | myGroup1,myGroup2 | Bar%Foo                         | postgres
    3076 | LOCK_GROUPS     | BEGIN      | myGroup1,myGroup2 |                                 | postgres
    3077 | LOCK_GROUPS     | END        | myGroup1,myGroup2 | 13 tables locked, 0 deadlock(s) | postgres
    3078 | SET_MARK_GROUPS | END        | myGroup1,myGroup2 | Bar%Foo                         | postgres
(72 rows)

select public.handle_emaj_sequences(3200);
 handle_emaj_sequences 
-----------------------
 
(1 row)

-----------------------------
-- emaj_comment_mark_group() tests
-----------------------------
-- group is unknown
select emaj.emaj_comment_mark_group(NULL,NULL,NULL);
ERROR:  _check_group_names: No group to process.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,boolean,boolean,boolean,boolean) line 30 at RAISE
SQL statement "SELECT emaj._check_group_names(p_groupNames := ARRAY[p_groupName], p_mayBeNull := FALSE, p_lockGroups := TRUE)"
PL/pgSQL function emaj.emaj_comment_mark_group(text,text,text) line 8 at PERFORM
select emaj.emaj_comment_mark_group('unknownGroup',NULL,NULL);
ERROR:  _check_group_names: The group "unknownGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,boolean,boolean,boolean,boolean) line 42 at RAISE
SQL statement "SELECT emaj._check_group_names(p_groupNames := ARRAY[p_groupName], p_mayBeNull := FALSE, p_lockGroups := TRUE)"
PL/pgSQL function emaj.emaj_comment_mark_group(text,text,text) line 8 at PERFORM
-- mark is unknown
select emaj.emaj_comment_mark_group('myGroup1','unknownMark',NULL);
ERROR:  _check_mark_name: The mark "unknownMark" does not exist for the group "myGroup1".
CONTEXT:  PL/pgSQL function emaj._check_mark_name(text[],text,boolean) line 59 at RAISE
SQL statement "SELECT emaj._check_mark_name(p_groupNames := ARRAY[p_groupName], p_mark := p_mark)"
PL/pgSQL function emaj.emaj_comment_mark_group(text,text,text) line 10 at SQL statement
-- should be OK
select emaj.emaj_comment_mark_group('myGroup1','SM1','a first comment for group #1');
 emaj_comment_mark_group 
-------------------------
 
(1 row)

select emaj.emaj_comment_mark_group('myGroup1','SM1','a better comment for group #1');
 emaj_comment_mark_group 
-------------------------
 
(1 row)

select emaj.emaj_comment_mark_group('myGroup2','SM1','a first comment for group #2');
 emaj_comment_mark_group 
-------------------------
 
(1 row)

select emaj.emaj_comment_mark_group('myGroup2','SM1',NULL);
 emaj_comment_mark_group 
-------------------------
 
(1 row)

select emaj.emaj_comment_mark_group('myGroup2','EMAJ_LAST_MARK','a comment for group #2');
 emaj_comment_mark_group 
-------------------------
 
(1 row)

select emaj.emaj_comment_mark_group('myGroup2','phil''s mark #1','a good phil''s comment!');
 emaj_comment_mark_group 
-------------------------
 
(1 row)

select emaj.emaj_comment_mark_group('emptyGroup','SM1','a comment on a mark for an empty group');
 emaj_comment_mark_group 
-------------------------
 
(1 row)

-----------------------------
-- emaj_get_previous_mark_group()
-----------------------------
-- group is unknown
select emaj.emaj_get_previous_mark_group(NULL,NULL::timestamptz);
ERROR:  _check_group_names: No group to process.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,boolean,boolean,boolean,boolean) line 30 at RAISE
SQL statement "SELECT emaj._check_group_names(p_groupNames := ARRAY[p_groupName], p_mayBeNull := FALSE, p_lockGroups := FALSE)"
PL/pgSQL function emaj.emaj_get_previous_mark_group(text,timestamp with time zone) line 9 at PERFORM
select emaj.emaj_get_previous_mark_group('unknownGroup',NULL::timestamptz);
ERROR:  _check_group_names: The group "unknownGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,boolean,boolean,boolean,boolean) line 42 at RAISE
SQL statement "SELECT emaj._check_group_names(p_groupNames := ARRAY[p_groupName], p_mayBeNull := FALSE, p_lockGroups := FALSE)"
PL/pgSQL function emaj.emaj_get_previous_mark_group(text,timestamp with time zone) line 9 at PERFORM
select emaj.emaj_get_previous_mark_group(NULL,NULL::text);
ERROR:  _check_group_names: No group to process.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,boolean,boolean,boolean,boolean) line 30 at RAISE
SQL statement "SELECT emaj._check_group_names(p_groupNames := ARRAY[p_groupName], p_mayBeNull := FALSE, p_lockGroups := FALSE)"
PL/pgSQL function emaj.emaj_get_previous_mark_group(text,text) line 9 at PERFORM
select emaj.emaj_get_previous_mark_group('unknownGroup',NULL::text);
ERROR:  _check_group_names: The group "unknownGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,boolean,boolean,boolean,boolean) line 42 at RAISE
SQL statement "SELECT emaj._check_group_names(p_groupNames := ARRAY[p_groupName], p_mayBeNull := FALSE, p_lockGroups := FALSE)"
PL/pgSQL function emaj.emaj_get_previous_mark_group(text,text) line 9 at PERFORM
-- mark is unknown in emaj_mark
select emaj.emaj_get_previous_mark_group('myGroup2','unknownMark');
ERROR:  _check_mark_name: The mark "unknownMark" does not exist for the group "myGroup2".
CONTEXT:  PL/pgSQL function emaj._check_mark_name(text[],text,boolean) line 59 at RAISE
SQL statement "SELECT emaj._check_mark_name(p_groupNames := ARRAY[p_groupName], p_mark := p_mark)"
PL/pgSQL function emaj.emaj_get_previous_mark_group(text,text) line 11 at SQL statement
-- should be OK
select emaj.emaj_get_previous_mark_group('myGroup2',(select time_clock_timestamp from emaj.emaj_mark, emaj.emaj_time_stamp where time_id = mark_time_id and mark_group = 'myGroup2' and mark_name = 'SM1'));
 emaj_get_previous_mark_group 
------------------------------
 Mark2
(1 row)

select emaj.emaj_get_previous_mark_group('myGroup2',(select time_clock_timestamp from emaj.emaj_mark, emaj.emaj_time_stamp where time_id = mark_time_id and mark_group = 'myGroup2' and mark_name = 'SM1')+'0.000001 SECOND'::interval);
 emaj_get_previous_mark_group 
------------------------------
 SM1
(1 row)

select emaj.emaj_get_previous_mark_group('myGroup1',(select min(time_clock_timestamp) from emaj.emaj_mark, emaj.emaj_time_stamp where time_id = mark_time_id and mark_group = 'myGroup1'));
 emaj_get_previous_mark_group 
------------------------------
 
(1 row)

select emaj.emaj_get_previous_mark_group('myGroup2','SM1');
 emaj_get_previous_mark_group 
------------------------------
 Mark2
(1 row)

select emaj.emaj_get_previous_mark_group('emptyGroup','SM1');
 emaj_get_previous_mark_group 
------------------------------
 MarkInit
(1 row)

select coalesce(emaj.emaj_get_previous_mark_group('myGroup2','Mark2'),'No previous mark');
     coalesce     
------------------
 No previous mark
(1 row)

select emaj.emaj_get_previous_mark_group('myGroup2',(select emaj.emaj_get_previous_mark_group('myGroup2',(select emaj.emaj_get_previous_mark_group('myGroup2',(select emaj.emaj_get_previous_mark_group('myGroup2','EMAJ_LAST_MARK')))))));
 emaj_get_previous_mark_group 
------------------------------
 SM3
(1 row)

-----------------------------
-- emaj_rename_mark_group() tests
-----------------------------
-- group is unknown
select emaj.emaj_rename_mark_group(NULL,NULL,NULL);
ERROR:  _check_group_names: No group to process.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,boolean,boolean,boolean,boolean) line 30 at RAISE
SQL statement "SELECT emaj._check_group_names(p_groupNames := ARRAY[p_groupName], p_mayBeNull := FALSE, p_lockGroups := TRUE)"
PL/pgSQL function emaj.emaj_rename_mark_group(text,text,text) line 12 at PERFORM
select emaj.emaj_rename_mark_group('unknownGroup',NULL,NULL);
ERROR:  _check_group_names: The group "unknownGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,boolean,boolean,boolean,boolean) line 42 at RAISE
SQL statement "SELECT emaj._check_group_names(p_groupNames := ARRAY[p_groupName], p_mayBeNull := FALSE, p_lockGroups := TRUE)"
PL/pgSQL function emaj.emaj_rename_mark_group(text,text,text) line 12 at PERFORM
-- unknown mark name
select emaj.emaj_rename_mark_group('myGroup1','DummyMark','new mark');
ERROR:  _check_mark_name: The mark "DummyMark" does not exist for the group "myGroup1".
CONTEXT:  PL/pgSQL function emaj._check_mark_name(text[],text,boolean) line 59 at RAISE
SQL statement "SELECT emaj._check_mark_name(p_groupNames := ARRAY[p_groupName], p_mark := p_mark)"
PL/pgSQL function emaj.emaj_rename_mark_group(text,text,text) line 14 at SQL statement
-- invalid new mark name
select emaj.emaj_rename_mark_group('myGroup1','Mark1','EMAJ_LAST_MARK');
ERROR:  _check_new_mark: "EMAJ_LAST_MARK" is not an allowed name for a new mark.
CONTEXT:  PL/pgSQL function emaj._check_new_mark(text[],text) line 14 at RAISE
SQL statement "SELECT emaj._check_new_mark(ARRAY[p_groupName], p_newName)"
PL/pgSQL function emaj.emaj_rename_mark_group(text,text,text) line 16 at SQL statement
-- new mark name already exists
select emaj.emaj_rename_mark_group('myGroup1','EMAJ_LAST_MARK','SM1');
ERROR:  _check_new_mark: The group "myGroup1" already contains a mark named "SM1".
CONTEXT:  PL/pgSQL function emaj._check_new_mark(text[],text) line 29 at RAISE
SQL statement "SELECT emaj._check_new_mark(ARRAY[p_groupName], p_newName)"
PL/pgSQL function emaj.emaj_rename_mark_group(text,text,text) line 16 at SQL statement
-- should be OK
select emaj.emaj_rename_mark_group('myGroup1','EMAJ_LAST_MARK',NULL);
 emaj_rename_mark_group 
------------------------
 
(1 row)

select emaj.emaj_rename_mark_group('myGroup1','EMAJ_LAST_MARK','SM2');
 emaj_rename_mark_group 
------------------------
 
(1 row)

select emaj.emaj_rename_mark_group('myGroup2','EMAJ_LAST_MARK','SM2');
 emaj_rename_mark_group 
------------------------
 
(1 row)

select emaj.emaj_rename_mark_group('myGroup2','phil''s mark #1','john''s mark #1');
 emaj_rename_mark_group 
------------------------
 
(1 row)

select emaj.emaj_rename_mark_group('emptyGroup','EMAJ_LAST_MARK','SM2');
 emaj_rename_mark_group 
------------------------
 
(1 row)

-- simulate SM2 is the end mark of a logged rollback operations on both myGroup1 and myGroup2 groups
update emaj.emaj_mark set mark_logged_rlbk_target_mark = 'Mark1' where mark_name = 'SM2';
select emaj.emaj_rename_mark_group('myGroup1','Mark1','First Mark');
 emaj_rename_mark_group 
------------------------
 
(1 row)

-- check for emaj_comment_mark_group() and emaj_rename_mark_group()
select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_deleted, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_time_id, mark_group;
    mark_group    | regexp_replace | mark_time_id | mark_is_deleted | mark_is_rlbk_protected |              mark_comment              | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------------+----------------+--------------+-----------------+------------------------+----------------------------------------+---------------------------+------------------------------
 phil's group#3", | Mark3          |         2004 | f               | f                      |                                        |                           | 
 myGroup1         | First Mark     |         3000 | f               | f                      |                                        |                         0 | 
 myGroup2         | Mark2          |         3001 | f               | f                      |                                        |                         0 | 
 emptyGroup       | MarkInit       |         3002 | f               | f                      |                                        |                         0 | 
 myGroup1         | SM1            |         3003 | f               | f                      | a better comment for group #1          |                         0 | 
 myGroup2         | SM1            |         3004 | f               | f                      |                                        |                         0 | 
 myGroup2         | john's mark #1 |         3005 | f               | f                      | a good phil's comment!                 |                         0 | 
 emptyGroup       | SM2            |         3006 | f               | f                      | a comment on a mark for an empty group |                           | Mark1
 myGroup1         | MARK_%         |         3007 | f               | f                      |                                        |                         0 | 
 myGroup2         | MARK_%         |         3008 | f               | f                      |                                        |                         0 | 
 myGroup2         | MARK_%         |         3009 | f               | f                      |                                        |                         0 | 
 myGroup1         | Foo%Bar        |         3010 | f               | f                      |                                        |                         0 | 
 myGroup1         | SM3            |         3011 | f               | f                      |                                        |                         0 | 
 myGroup2         | SM3            |         3011 | f               | f                      |                                        |                         0 | 
 myGroup1         | MARK_%         |         3012 | f               | f                      |                                        |                         0 | 
 myGroup2         | MARK_%         |         3012 | f               | f                      |                                        |                         0 | 
 myGroup1         | MARK_%         |         3013 | f               | f                      |                                        |                         0 | 
 myGroup2         | MARK_%         |         3013 | f               | f                      |                                        |                         0 | 
 myGroup1         | MARK_%         |         3014 | f               | f                      |                                        |                         0 | 
 myGroup2         | MARK_%         |         3014 | f               | f                      |                                        |                         0 | 
 myGroup1         | SM2            |         3015 | f               | f                      |                                        |                           | First Mark
 myGroup2         | SM2            |         3015 | f               | f                      | a comment for group #2                 |                           | Mark1
(22 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
  sequ_schema   |     sequ_name     | sequ_time_id | sequ_last_val | sequ_is_called 
----------------+-------------------+--------------+---------------+----------------
 phil's schema3 | myTbl2\_col21_seq |         2004 |             1 | f
 phil's schema3 | phil's seq\1      |         2004 |          1000 | f
 myschema1      | myTbl3_col31_seq  |         3000 |             1 | f
 myschema1      | mytbl2b_col20_seq |         3000 |             1 | f
 myschema2      | myTbl3_col31_seq  |         3001 |             1 | f
 myschema2      | myseq1            |         3001 |          1000 | f
 myschema1      | myTbl3_col31_seq  |         3003 |             1 | f
 myschema1      | mytbl2b_col20_seq |         3003 |             1 | f
 myschema2      | myTbl3_col31_seq  |         3004 |             1 | f
 myschema2      | myseq1            |         3004 |          1000 | f
 myschema2      | myTbl3_col31_seq  |         3005 |             1 | f
 myschema2      | myseq1            |         3005 |          1000 | f
 myschema1      | myTbl3_col31_seq  |         3007 |             1 | f
 myschema1      | mytbl2b_col20_seq |         3007 |             1 | f
 myschema2      | myTbl3_col31_seq  |         3008 |             1 | f
 myschema2      | myseq1            |         3008 |          1000 | f
 myschema2      | myTbl3_col31_seq  |         3009 |             1 | f
 myschema2      | myseq1            |         3009 |          1000 | f
 myschema1      | myTbl3_col31_seq  |         3010 |             1 | f
 myschema1      | mytbl2b_col20_seq |         3010 |             1 | f
 myschema1      | myTbl3_col31_seq  |         3011 |             1 | f
 myschema1      | mytbl2b_col20_seq |         3011 |             1 | f
 myschema2      | myTbl3_col31_seq  |         3011 |             1 | f
 myschema2      | myseq1            |         3011 |          1000 | f
 myschema1      | myTbl3_col31_seq  |         3012 |             1 | f
 myschema1      | mytbl2b_col20_seq |         3012 |             1 | f
 myschema2      | myTbl3_col31_seq  |         3012 |             1 | f
 myschema2      | myseq1            |         3012 |          1000 | f
 myschema1      | myTbl3_col31_seq  |         3013 |             1 | f
 myschema1      | mytbl2b_col20_seq |         3013 |             1 | f
 myschema2      | myTbl3_col31_seq  |         3013 |             1 | f
 myschema2      | myseq1            |         3013 |          1000 | f
 myschema1      | myTbl3_col31_seq  |         3014 |             1 | f
 myschema1      | mytbl2b_col20_seq |         3014 |             1 | f
 myschema2      | myTbl3_col31_seq  |         3014 |             1 | f
 myschema2      | myseq1            |         3014 |          1000 | f
 myschema1      | myTbl3_col31_seq  |         3015 |             1 | f
 myschema1      | mytbl2b_col20_seq |         3015 |             1 | f
 myschema2      | myTbl3_col31_seq  |         3015 |             1 | f
 myschema2      | myseq1            |         3015 |          1000 | f
(40 rows)

select tbl_schema, tbl_name, tbl_time_id, tbl_log_seq_last_val from emaj.emaj_table order by tbl_time_id, tbl_schema, tbl_name;
   tbl_schema   |  tbl_name   | tbl_time_id | tbl_log_seq_last_val 
----------------+-------------+-------------+----------------------
 phil's schema3 | myTbl2\     |        2004 |                    0
 phil's schema3 | phil's tbl1 |        2004 |                    0
 myschema1      | myTbl3      |        3000 |                    0
 myschema1      | mytbl1      |        3000 |                    0
 myschema1      | mytbl2      |        3000 |                    0
 myschema1      | mytbl2b     |        3000 |                    0
 myschema1      | mytbl4      |        3000 |                    0
 myschema2      | myTbl3      |        3001 |                    0
 myschema2      | mytbl1      |        3001 |                    0
 myschema2      | mytbl2      |        3001 |                    0
 myschema2      | mytbl4      |        3001 |                    0
 myschema2      | mytbl5      |        3001 |                    0
 myschema2      | mytbl6      |        3001 |                    0
 myschema2      | mytbl7      |        3001 |                    0
 myschema2      | mytbl8      |        3001 |                    0
 myschema1      | myTbl3      |        3003 |                    0
 myschema1      | mytbl1      |        3003 |                    0
 myschema1      | mytbl2      |        3003 |                    0
 myschema1      | mytbl2b     |        3003 |                    0
 myschema1      | mytbl4      |        3003 |                    0
 myschema2      | myTbl3      |        3004 |                    0
 myschema2      | mytbl1      |        3004 |                    0
 myschema2      | mytbl2      |        3004 |                    0
 myschema2      | mytbl4      |        3004 |                    0
 myschema2      | mytbl5      |        3004 |                    0
 myschema2      | mytbl6      |        3004 |                    0
 myschema2      | mytbl7      |        3004 |                    0
 myschema2      | mytbl8      |        3004 |                    0
 myschema2      | myTbl3      |        3005 |                    0
 myschema2      | mytbl1      |        3005 |                    0
 myschema2      | mytbl2      |        3005 |                    0
 myschema2      | mytbl4      |        3005 |                    0
 myschema2      | mytbl5      |        3005 |                    0
 myschema2      | mytbl6      |        3005 |                    0
 myschema2      | mytbl7      |        3005 |                    0
 myschema2      | mytbl8      |        3005 |                    0
 myschema1      | myTbl3      |        3007 |                    0
 myschema1      | mytbl1      |        3007 |                    0
 myschema1      | mytbl2      |        3007 |                    0
 myschema1      | mytbl2b     |        3007 |                    0
 myschema1      | mytbl4      |        3007 |                    0
 myschema2      | myTbl3      |        3008 |                    0
 myschema2      | mytbl1      |        3008 |                    0
 myschema2      | mytbl2      |        3008 |                    0
 myschema2      | mytbl4      |        3008 |                    0
 myschema2      | mytbl5      |        3008 |                    0
 myschema2      | mytbl6      |        3008 |                    0
 myschema2      | mytbl7      |        3008 |                    0
 myschema2      | mytbl8      |        3008 |                    0
 myschema2      | myTbl3      |        3009 |                    0
 myschema2      | mytbl1      |        3009 |                    0
 myschema2      | mytbl2      |        3009 |                    0
 myschema2      | mytbl4      |        3009 |                    0
 myschema2      | mytbl5      |        3009 |                    0
 myschema2      | mytbl6      |        3009 |                    0
 myschema2      | mytbl7      |        3009 |                    0
 myschema2      | mytbl8      |        3009 |                    0
 myschema1      | myTbl3      |        3010 |                    0
 myschema1      | mytbl1      |        3010 |                    0
 myschema1      | mytbl2      |        3010 |                    0
 myschema1      | mytbl2b     |        3010 |                    0
 myschema1      | mytbl4      |        3010 |                    0
 myschema1      | myTbl3      |        3011 |                    0
 myschema1      | mytbl1      |        3011 |                    0
 myschema1      | mytbl2      |        3011 |                    0
 myschema1      | mytbl2b     |        3011 |                    0
 myschema1      | mytbl4      |        3011 |                    0
 myschema2      | myTbl3      |        3011 |                    0
 myschema2      | mytbl1      |        3011 |                    0
 myschema2      | mytbl2      |        3011 |                    0
 myschema2      | mytbl4      |        3011 |                    0
 myschema2      | mytbl5      |        3011 |                    0
 myschema2      | mytbl6      |        3011 |                    0
 myschema2      | mytbl7      |        3011 |                    0
 myschema2      | mytbl8      |        3011 |                    0
 myschema1      | myTbl3      |        3012 |                    0
 myschema1      | mytbl1      |        3012 |                    0
 myschema1      | mytbl2      |        3012 |                    0
 myschema1      | mytbl2b     |        3012 |                    0
 myschema1      | mytbl4      |        3012 |                    0
 myschema2      | myTbl3      |        3012 |                    0
 myschema2      | mytbl1      |        3012 |                    0
 myschema2      | mytbl2      |        3012 |                    0
 myschema2      | mytbl4      |        3012 |                    0
 myschema2      | mytbl5      |        3012 |                    0
 myschema2      | mytbl6      |        3012 |                    0
 myschema2      | mytbl7      |        3012 |                    0
 myschema2      | mytbl8      |        3012 |                    0
 myschema1      | myTbl3      |        3013 |                    0
 myschema1      | mytbl1      |        3013 |                    0
 myschema1      | mytbl2      |        3013 |                    0
 myschema1      | mytbl2b     |        3013 |                    0
 myschema1      | mytbl4      |        3013 |                    0
 myschema2      | myTbl3      |        3013 |                    0
 myschema2      | mytbl1      |        3013 |                    0
 myschema2      | mytbl2      |        3013 |                    0
 myschema2      | mytbl4      |        3013 |                    0
 myschema2      | mytbl5      |        3013 |                    0
 myschema2      | mytbl6      |        3013 |                    0
 myschema2      | mytbl7      |        3013 |                    0
 myschema2      | mytbl8      |        3013 |                    0
 myschema1      | myTbl3      |        3014 |                    0
 myschema1      | mytbl1      |        3014 |                    0
 myschema1      | mytbl2      |        3014 |                    0
 myschema1      | mytbl2b     |        3014 |                    0
 myschema1      | mytbl4      |        3014 |                    0
 myschema2      | myTbl3      |        3014 |                    0
 myschema2      | mytbl1      |        3014 |                    0
 myschema2      | mytbl2      |        3014 |                    0
 myschema2      | mytbl4      |        3014 |                    0
 myschema2      | mytbl5      |        3014 |                    0
 myschema2      | mytbl6      |        3014 |                    0
 myschema2      | mytbl7      |        3014 |                    0
 myschema2      | mytbl8      |        3014 |                    0
 myschema1      | myTbl3      |        3015 |                    0
 myschema1      | mytbl1      |        3015 |                    0
 myschema1      | mytbl2      |        3015 |                    0
 myschema1      | mytbl2b     |        3015 |                    0
 myschema1      | mytbl4      |        3015 |                    0
 myschema2      | myTbl3      |        3015 |                    0
 myschema2      | mytbl1      |        3015 |                    0
 myschema2      | mytbl2      |        3015 |                    0
 myschema2      | mytbl4      |        3015 |                    0
 myschema2      | mytbl5      |        3015 |                    0
 myschema2      | mytbl6      |        3015 |                    0
 myschema2      | mytbl7      |        3015 |                    0
 myschema2      | mytbl8      |        3015 |                    0
(127 rows)

select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 3200 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
(0 rows)

select hist_id, hist_function, hist_event, hist_object, 
  regexp_replace(regexp_replace(hist_wording,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),E'\\[.+\\]','(timestamp)','g'),
  hist_user from emaj.emaj_hist where hist_id >= 3200 order by hist_id;
 hist_id |   hist_function    | hist_event | hist_object |            regexp_replace             | hist_user 
---------+--------------------+------------+-------------+---------------------------------------+-----------
    3200 | COMMENT_MARK_GROUP |            | myGroup1    | Mark SM1                              | postgres
    3201 | COMMENT_MARK_GROUP |            | myGroup1    | Mark SM1                              | postgres
    3202 | COMMENT_MARK_GROUP |            | myGroup2    | Mark SM1                              | postgres
    3203 | COMMENT_MARK_GROUP |            | myGroup2    | Mark SM1                              | postgres
    3204 | COMMENT_MARK_GROUP |            | myGroup2    | Mark Bar%Foo                          | postgres
    3205 | COMMENT_MARK_GROUP |            | myGroup2    | Mark phil's mark #1                   | postgres
    3206 | COMMENT_MARK_GROUP |            | emptyGroup  | Mark SM1                              | postgres
    3212 | RENAME_MARK_GROUP  | BEGIN      | myGroup1    | EMAJ_LAST_MARK                        | postgres
    3213 | RENAME_MARK_GROUP  | END        | myGroup1    | Bar%Foo renamed MARK_%                | postgres
    3214 | RENAME_MARK_GROUP  | BEGIN      | myGroup1    | EMAJ_LAST_MARK                        | postgres
    3215 | RENAME_MARK_GROUP  | END        | myGroup1    | MARK_% renamed SM2                    | postgres
    3216 | RENAME_MARK_GROUP  | BEGIN      | myGroup2    | EMAJ_LAST_MARK                        | postgres
    3217 | RENAME_MARK_GROUP  | END        | myGroup2    | Bar%Foo renamed SM2                   | postgres
    3218 | RENAME_MARK_GROUP  | BEGIN      | myGroup2    | phil's mark #1                        | postgres
    3219 | RENAME_MARK_GROUP  | END        | myGroup2    | phil's mark #1 renamed john's mark #1 | postgres
    3220 | RENAME_MARK_GROUP  | BEGIN      | emptyGroup  | EMAJ_LAST_MARK                        | postgres
    3221 | RENAME_MARK_GROUP  | END        | emptyGroup  | SM1 renamed SM2                       | postgres
    3222 | RENAME_MARK_GROUP  | BEGIN      | myGroup1    | Mark1                                 | postgres
    3223 | RENAME_MARK_GROUP  | END        | myGroup1    | Mark1 renamed First Mark              | postgres
(19 rows)

select public.handle_emaj_sequences(3400);
 handle_emaj_sequences 
-----------------------
 
(1 row)

-----------------------------
-- emaj_delete_mark_group() tests
-----------------------------
-- group is unknown
select emaj.emaj_delete_mark_group(NULL,NULL);
ERROR:  _check_group_names: No group to process.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,boolean,boolean,boolean,boolean) line 30 at RAISE
SQL statement "SELECT emaj._check_group_names(p_groupNames := ARRAY[p_groupName], p_mayBeNull := FALSE, p_lockGroups := TRUE)"
PL/pgSQL function emaj.emaj_delete_mark_group(text,text) line 27 at PERFORM
select emaj.emaj_delete_mark_group('unknownGroup',NULL);
ERROR:  _check_group_names: The group "unknownGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,boolean,boolean,boolean,boolean) line 42 at RAISE
SQL statement "SELECT emaj._check_group_names(p_groupNames := ARRAY[p_groupName], p_mayBeNull := FALSE, p_lockGroups := TRUE)"
PL/pgSQL function emaj.emaj_delete_mark_group(text,text) line 27 at PERFORM
-- unknown mark name
select emaj.emaj_delete_mark_group('myGroup2',NULL);
ERROR:  _check_mark_name: The mark "<NULL>" does not exist for the group "myGroup2".
CONTEXT:  PL/pgSQL function emaj._check_mark_name(text[],text,boolean) line 59 at RAISE
SQL statement "SELECT emaj._check_mark_name(p_groupNames := ARRAY[p_groupName], p_mark := p_mark)"
PL/pgSQL function emaj.emaj_delete_mark_group(text,text) line 29 at SQL statement
select emaj.emaj_delete_mark_group('myGroup2','DummyMark');
ERROR:  _check_mark_name: The mark "DummyMark" does not exist for the group "myGroup2".
CONTEXT:  PL/pgSQL function emaj._check_mark_name(text[],text,boolean) line 59 at RAISE
SQL statement "SELECT emaj._check_mark_name(p_groupNames := ARRAY[p_groupName], p_mark := p_mark)"
PL/pgSQL function emaj.emaj_delete_mark_group(text,text) line 29 at SQL statement
-- next attempts should be OK
select emaj.emaj_delete_mark_group('myGroup1','EMAJ_LAST_MARK');
 emaj_delete_mark_group 
------------------------
                      1
(1 row)

-- simulate SM3 is an end mark of a logged rollback operations on myGroup1 group
update emaj.emaj_mark set mark_logged_rlbk_target_mark = 'SM1' where mark_group = 'myGroup1' and mark_name = 'SM3';
select emaj.emaj_delete_mark_group('myGroup1','SM1');
 emaj_delete_mark_group 
------------------------
                      1
(1 row)

select mark_group, mark_name, mark_logged_rlbk_target_mark from emaj.emaj_mark where mark_group = 'myGroup1' and mark_name = 'SM3';
 mark_group | mark_name | mark_logged_rlbk_target_mark 
------------+-----------+------------------------------
 myGroup1   | SM3       | 
(1 row)

select emaj.emaj_delete_mark_group('emptyGroup','MarkInit');
 emaj_delete_mark_group 
------------------------
                      1
(1 row)

select emaj.emaj_delete_mark_group('myGroup1','First Mark');
 emaj_delete_mark_group 
------------------------
                      1
(1 row)

select sum(emaj.emaj_delete_mark_group('myGroup1',mark_name)) from 
 (select mark_name from emaj.emaj_mark
    where mark_group = 'myGroup1' and (mark_name ~ E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d')
    order by mark_time_id) as t;
 sum 
-----
   5
(1 row)

    
select emaj.emaj_delete_mark_group('myGroup2','john''s mark #1');
 emaj_delete_mark_group 
------------------------
                      1
(1 row)

-- error: at least 1 mark should remain
select emaj.emaj_delete_mark_group('myGroup1','SM3');
ERROR:  emaj_delete_mark_group: "SM3" is the only mark of the group. It cannot be deleted.
CONTEXT:  PL/pgSQL function emaj.emaj_delete_mark_group(text,text) line 36 at RAISE
-----------------------------
-- emaj_delete_before_mark_group() tests
-----------------------------
-- group is unknown
select emaj.emaj_delete_before_mark_group(NULL,NULL);
ERROR:  _check_group_names: No group to process.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,boolean,boolean,boolean,boolean) line 30 at RAISE
SQL statement "SELECT emaj._check_group_names(p_groupNames := ARRAY[p_groupName], p_mayBeNull := FALSE, p_lockGroups := TRUE)"
PL/pgSQL function emaj.emaj_delete_before_mark_group(text,text) line 17 at PERFORM
select emaj.emaj_delete_before_mark_group('unknownGroup',NULL);
ERROR:  _check_group_names: The group "unknownGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,boolean,boolean,boolean,boolean) line 42 at RAISE
SQL statement "SELECT emaj._check_group_names(p_groupNames := ARRAY[p_groupName], p_mayBeNull := FALSE, p_lockGroups := TRUE)"
PL/pgSQL function emaj.emaj_delete_before_mark_group(text,text) line 17 at PERFORM
-- unknown mark name
select emaj.emaj_delete_before_mark_group('myGroup2','DummyMark');
ERROR:  _check_mark_name: The mark "DummyMark" does not exist for the group "myGroup2".
CONTEXT:  PL/pgSQL function emaj._check_mark_name(text[],text,boolean) line 59 at RAISE
SQL statement "SELECT emaj._check_mark_name(p_groupNames := ARRAY[p_groupName], p_mark := p_mark)"
PL/pgSQL function emaj.emaj_delete_before_mark_group(text,text) line 23 at SQL statement
-- NULL input for mark name returns NULL
select emaj.emaj_delete_before_mark_group('myGroup2',NULL);
 emaj_delete_before_mark_group 
-------------------------------
                              
(1 row)

-- should be OK
select emaj.emaj_delete_before_mark_group('myGroup1','SM3');
 emaj_delete_before_mark_group 
-------------------------------
                             0
(1 row)

select emaj.emaj_delete_before_mark_group('myGroup1','EMAJ_LAST_MARK');
 emaj_delete_before_mark_group 
-------------------------------
                             0
(1 row)

select emaj.emaj_set_mark_group('emptyGroup','EGM3');
 emaj_set_mark_group 
---------------------
                   0
(1 row)

select emaj.emaj_set_mark_group('emptyGroup','EGM4');
 emaj_set_mark_group 
---------------------
                   0
(1 row)

select emaj.emaj_delete_before_mark_group('emptyGroup','SM2');
 emaj_delete_before_mark_group 
-------------------------------
                             0
(1 row)

-- simulate SM2 is an end mark of a logged rollback operations on myGroup2 group
update emaj.emaj_mark set mark_logged_rlbk_target_mark = 'SM1' where mark_group = 'myGroup2' and mark_name = 'SM2';
-- and delete marks including SM1
select emaj.emaj_delete_before_mark_group('myGroup2',
      (select emaj.emaj_get_previous_mark_group('myGroup2',
             (select time_clock_timestamp from emaj.emaj_mark, emaj.emaj_time_stamp where time_id = mark_time_id and mark_group = 'myGroup2' and mark_group = 'myGroup2' and mark_name = 'SM2')+'0.000001 SECOND'::interval)));
 emaj_delete_before_mark_group 
-------------------------------
                             8
(1 row)

select mark_group, mark_name, mark_logged_rlbk_target_mark from emaj.emaj_mark where mark_group = 'myGroup2' and mark_name = 'SM2';
 mark_group | mark_name | mark_logged_rlbk_target_mark 
------------+-----------+------------------------------
 myGroup2   | SM2       | 
(1 row)

-- check emaj_delete_before_mark_group() also cleans up the emaj_hist table
insert into emaj.emaj_param (param_key, param_value_interval) values ('history_retention','0 second'::interval);
select emaj.emaj_set_mark_group('phil''s group#3",','Mark4');
 emaj_set_mark_group 
---------------------
                   4
(1 row)

select emaj.emaj_set_mark_group('phil''s group#3",','Mark5');
 emaj_set_mark_group 
---------------------
                   4
(1 row)

select emaj.emaj_delete_before_mark_group('phil''s group#3",','Mark4');
 emaj_delete_before_mark_group 
-------------------------------
                             1
(1 row)

delete from emaj.emaj_param where param_key = 'history_retention';
-- check for emaj_delete_mark_group() and emaj_delete_before_mark_group()
select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 3400 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
    3400 |            3400000 | M
    3401 |            3400000 | M
    3402 |            3400000 | M
    3403 |            3400000 | M
(4 rows)

select hist_id, hist_function, hist_event, hist_object, 
  regexp_replace(regexp_replace(hist_wording,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),E'\\[.+\\]','(timestamp)','g'),
  hist_user from emaj.emaj_hist where hist_id >= 3400 order by hist_id;
 hist_id |      hist_function       |     hist_event     |    hist_object    |                 regexp_replace                  | hist_user 
---------+--------------------------+--------------------+-------------------+-------------------------------------------------+-----------
    3404 | DELETE_MARK_GROUP        | BEGIN              | myGroup1          | EMAJ_LAST_MARK                                  | postgres
    3405 | DELETE_MARK_GROUP        | END                | myGroup1          | SM2                                             | postgres
    3406 | DELETE_MARK_GROUP        | BEGIN              | myGroup1          | SM1                                             | postgres
    3407 | DELETE_MARK_GROUP        | END                | myGroup1          | SM1                                             | postgres
    3408 | DELETE_MARK_GROUP        | BEGIN              | emptyGroup        | MarkInit                                        | postgres
    3409 | DELETE_MARK_GROUP        | END                | emptyGroup        | MarkInit                                        | postgres
    3410 | DELETE_MARK_GROUP        | BEGIN              | myGroup1          | First Mark                                      | postgres
    3411 | DELETE_MARK_GROUP        | END                | myGroup1          | First Mark                                      | postgres
    3412 | DELETE_MARK_GROUP        | BEGIN              | myGroup1          | MARK_%                                          | postgres
    3413 | DELETE_MARK_GROUP        | END                | myGroup1          | MARK_%                                          | postgres
    3414 | DELETE_MARK_GROUP        | BEGIN              | myGroup1          | Foo%Bar                                         | postgres
    3415 | DELETE_MARK_GROUP        | END                | myGroup1          | Foo%Bar                                         | postgres
    3416 | DELETE_MARK_GROUP        | BEGIN              | myGroup1          | MARK_%                                          | postgres
    3417 | DELETE_MARK_GROUP        | END                | myGroup1          | MARK_%                                          | postgres
    3418 | DELETE_MARK_GROUP        | BEGIN              | myGroup1          | MARK_%                                          | postgres
    3419 | DELETE_MARK_GROUP        | END                | myGroup1          | MARK_%                                          | postgres
    3420 | DELETE_MARK_GROUP        | BEGIN              | myGroup1          | MARK_%                                          | postgres
    3421 | DELETE_MARK_GROUP        | END                | myGroup1          | MARK_%                                          | postgres
    3422 | DELETE_MARK_GROUP        | BEGIN              | myGroup2          | john's mark #1                                  | postgres
    3423 | DELETE_MARK_GROUP        | END                | myGroup2          | john's mark #1                                  | postgres
    3428 | DELETE_BEFORE_MARK_GROUP | BEGIN              | myGroup2          |                                                 | postgres
    3429 | DELETE_BEFORE_MARK_GROUP | BEGIN              | myGroup1          | SM3                                             | postgres
    3430 | DELETE_BEFORE_MARK_GROUP | END                | myGroup1          | 0 marks deleted ; SM3 is now the initial mark   | postgres
    3431 | DELETE_BEFORE_MARK_GROUP | BEGIN              | myGroup1          | EMAJ_LAST_MARK                                  | postgres
    3432 | DELETE_BEFORE_MARK_GROUP | END                | myGroup1          | 0 marks deleted ; SM3 is now the initial mark   | postgres
    3433 | SET_MARK_GROUP           | BEGIN              | emptyGroup        |                                                 | postgres
    3434 | LOCK_GROUP               | BEGIN              | emptyGroup        |                                                 | postgres
    3435 | LOCK_GROUP               | END                | emptyGroup        | 0 tables locked, 0 deadlock(s)                  | postgres
    3436 | SET_MARK_GROUP           | END                | emptyGroup        | EGM3                                            | postgres
    3437 | SET_MARK_GROUP           | BEGIN              | emptyGroup        |                                                 | postgres
    3438 | LOCK_GROUP               | BEGIN              | emptyGroup        |                                                 | postgres
    3439 | LOCK_GROUP               | END                | emptyGroup        | 0 tables locked, 0 deadlock(s)                  | postgres
    3440 | SET_MARK_GROUP           | END                | emptyGroup        | EGM4                                            | postgres
    3441 | DELETE_BEFORE_MARK_GROUP | BEGIN              | emptyGroup        | SM2                                             | postgres
    3442 | DELETE_BEFORE_MARK_GROUP | END                | emptyGroup        | 0 marks deleted ; SM2 is now the initial mark   | postgres
    3443 | DELETE_BEFORE_MARK_GROUP | BEGIN              | myGroup2          | SM2                                             | postgres
    3444 | DELETE_BEFORE_MARK_GROUP | END                | myGroup2          | 8 marks deleted ; SM2 is now the initial mark   | postgres
    3445 |                          | INSERTED PARAMETER | history_retention | @ 0                                             | postgres
    3446 | SET_MARK_GROUP           | BEGIN              | phil's group#3",  |                                                 | postgres
    3447 | LOCK_GROUP               | BEGIN              | phil's group#3",  |                                                 | postgres
    3448 | LOCK_GROUP               | END                | phil's group#3",  | 2 tables locked, 0 deadlock(s)                  | postgres
    3449 | SET_MARK_GROUP           | END                | phil's group#3",  | Mark4                                           | postgres
    3450 | SET_MARK_GROUP           | BEGIN              | phil's group#3",  |                                                 | postgres
    3451 | LOCK_GROUP               | BEGIN              | phil's group#3",  |                                                 | postgres
    3452 | LOCK_GROUP               | END                | phil's group#3",  | 2 tables locked, 0 deadlock(s)                  | postgres
    3453 | SET_MARK_GROUP           | END                | phil's group#3",  | Mark5                                           | postgres
    3454 | DELETE_BEFORE_MARK_GROUP | BEGIN              | phil's group#3",  | Mark4                                           | postgres
    3455 | PURGE_HISTORIES          |                    |                   | 210 emaj_hist rows deleted                      | postgres
    3456 | DELETE_BEFORE_MARK_GROUP | END                | phil's group#3",  | 1 marks deleted ; Mark4 is now the initial mark | postgres
    3457 |                          | DELETED PARAMETER  | history_retention |                                                 | postgres
(50 rows)

select public.handle_emaj_sequences(3600);
 handle_emaj_sequences 
-----------------------
 
(1 row)

-----------------------------
-- emaj_protect_mark_group() tests
-----------------------------
-- group is unknown
select emaj.emaj_protect_mark_group(NULL,NULL);
ERROR:  _check_group_names: No group to process.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,boolean,boolean,boolean,boolean) line 30 at RAISE
SQL statement "SELECT emaj._check_group_names(p_groupNames := ARRAY[p_groupName], p_mayBeNull := FALSE, p_lockGroups := TRUE,
                                    p_checkRollbackable := TRUE)"
PL/pgSQL function emaj.emaj_protect_mark_group(text,text) line 11 at PERFORM
select emaj.emaj_protect_mark_group('unknownGroup',NULL);
ERROR:  _check_group_names: The group "unknownGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,boolean,boolean,boolean,boolean) line 42 at RAISE
SQL statement "SELECT emaj._check_group_names(p_groupNames := ARRAY[p_groupName], p_mayBeNull := FALSE, p_lockGroups := TRUE,
                                    p_checkRollbackable := TRUE)"
PL/pgSQL function emaj.emaj_protect_mark_group(text,text) line 11 at PERFORM
-- group is not rollbackable
select emaj.emaj_protect_mark_group('phil''s group#3",',NULL);
ERROR:  _check_group_names: The group "phil's group#3"," has been created as AUDIT_ONLY.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,boolean,boolean,boolean,boolean) line 61 at RAISE
SQL statement "SELECT emaj._check_group_names(p_groupNames := ARRAY[p_groupName], p_mayBeNull := FALSE, p_lockGroups := TRUE,
                                    p_checkRollbackable := TRUE)"
PL/pgSQL function emaj.emaj_protect_mark_group(text,text) line 11 at PERFORM
-- mark is unknown
select emaj.emaj_protect_mark_group('myGroup1',NULL);
ERROR:  _check_mark_name: The mark "<NULL>" does not exist for the group "myGroup1".
CONTEXT:  PL/pgSQL function emaj._check_mark_name(text[],text,boolean) line 59 at RAISE
SQL statement "SELECT emaj._check_mark_name(p_groupNames := ARRAY[p_groupName], p_mark := p_mark, p_checkActive := TRUE)"
PL/pgSQL function emaj.emaj_protect_mark_group(text,text) line 14 at SQL statement
select emaj.emaj_protect_mark_group('myGroup1','unknownMark');
ERROR:  _check_mark_name: The mark "unknownMark" does not exist for the group "myGroup1".
CONTEXT:  PL/pgSQL function emaj._check_mark_name(text[],text,boolean) line 59 at RAISE
SQL statement "SELECT emaj._check_mark_name(p_groupNames := ARRAY[p_groupName], p_mark := p_mark, p_checkActive := TRUE)"
PL/pgSQL function emaj.emaj_protect_mark_group(text,text) line 14 at SQL statement
-- should be ok
select emaj.emaj_protect_mark_group('myGroup1','EMAJ_LAST_MARK');
 emaj_protect_mark_group 
-------------------------
                       1
(1 row)

select mark_time_id, mark_name, mark_group, mark_is_deleted, mark_is_rlbk_protected from emaj.emaj_mark where mark_group = 'myGroup1';
 mark_time_id | mark_name | mark_group | mark_is_deleted | mark_is_rlbk_protected 
--------------+-----------+------------+-----------------+------------------------
         3011 | SM3       | myGroup1   | f               | t
(1 row)

select emaj.emaj_protect_mark_group('emptyGroup','EMAJ_LAST_MARK');
 emaj_protect_mark_group 
-------------------------
                       1
(1 row)

-- protect an already protected group
select emaj.emaj_protect_mark_group('myGroup1','SM3');
 emaj_protect_mark_group 
-------------------------
                       0
(1 row)

select mark_time_id, mark_name, mark_group, mark_is_deleted, mark_is_rlbk_protected from emaj.emaj_mark where mark_group = 'myGroup1';
 mark_time_id | mark_name | mark_group | mark_is_deleted | mark_is_rlbk_protected 
--------------+-----------+------------+-----------------+------------------------
         3011 | SM3       | myGroup1   | f               | t
(1 row)

-----------------------------
-- emaj_unprotect_mark_group() tests
-----------------------------
-- group is unknown
select emaj.emaj_unprotect_mark_group(NULL,NULL);
ERROR:  _check_group_names: No group to process.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,boolean,boolean,boolean,boolean) line 30 at RAISE
SQL statement "SELECT emaj._check_group_names(p_groupNames := ARRAY[p_groupName], p_mayBeNull := FALSE, p_lockGroups := TRUE,
                                    p_checkRollbackable := TRUE)"
PL/pgSQL function emaj.emaj_unprotect_mark_group(text,text) line 10 at PERFORM
select emaj.emaj_unprotect_mark_group('unknownGroup',NULL);
ERROR:  _check_group_names: The group "unknownGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,boolean,boolean,boolean,boolean) line 42 at RAISE
SQL statement "SELECT emaj._check_group_names(p_groupNames := ARRAY[p_groupName], p_mayBeNull := FALSE, p_lockGroups := TRUE,
                                    p_checkRollbackable := TRUE)"
PL/pgSQL function emaj.emaj_unprotect_mark_group(text,text) line 10 at PERFORM
-- group is not rollbackable
select emaj.emaj_unprotect_mark_group('phil''s group#3",',NULL);
ERROR:  _check_group_names: The group "phil's group#3"," has been created as AUDIT_ONLY.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,boolean,boolean,boolean,boolean) line 61 at RAISE
SQL statement "SELECT emaj._check_group_names(p_groupNames := ARRAY[p_groupName], p_mayBeNull := FALSE, p_lockGroups := TRUE,
                                    p_checkRollbackable := TRUE)"
PL/pgSQL function emaj.emaj_unprotect_mark_group(text,text) line 10 at PERFORM
-- mark is unknown
select emaj.emaj_unprotect_mark_group('myGroup1',NULL);
ERROR:  _check_mark_name: The mark "<NULL>" does not exist for the group "myGroup1".
CONTEXT:  PL/pgSQL function emaj._check_mark_name(text[],text,boolean) line 59 at RAISE
SQL statement "SELECT emaj._check_mark_name(p_groupNames := ARRAY[p_groupName], p_mark := p_mark)"
PL/pgSQL function emaj.emaj_unprotect_mark_group(text,text) line 13 at SQL statement
select emaj.emaj_unprotect_mark_group('myGroup1','unknownMark');
ERROR:  _check_mark_name: The mark "unknownMark" does not exist for the group "myGroup1".
CONTEXT:  PL/pgSQL function emaj._check_mark_name(text[],text,boolean) line 59 at RAISE
SQL statement "SELECT emaj._check_mark_name(p_groupNames := ARRAY[p_groupName], p_mark := p_mark)"
PL/pgSQL function emaj.emaj_unprotect_mark_group(text,text) line 13 at SQL statement
-- should be ok
select emaj.emaj_unprotect_mark_group('myGroup1','EMAJ_LAST_MARK');
 emaj_unprotect_mark_group 
---------------------------
                         1
(1 row)

select mark_time_id, mark_name, mark_group, mark_is_deleted, mark_is_rlbk_protected from emaj.emaj_mark where mark_group = 'myGroup1';
 mark_time_id | mark_name | mark_group | mark_is_deleted | mark_is_rlbk_protected 
--------------+-----------+------------+-----------------+------------------------
         3011 | SM3       | myGroup1   | f               | f
(1 row)

select emaj.emaj_unprotect_mark_group('emptyGroup','EMAJ_LAST_MARK');
 emaj_unprotect_mark_group 
---------------------------
                         1
(1 row)

-- protect an already protected group
select emaj.emaj_unprotect_mark_group('myGroup1','SM3');
 emaj_unprotect_mark_group 
---------------------------
                         0
(1 row)

select mark_time_id, mark_name, mark_group, mark_is_deleted, mark_is_rlbk_protected from emaj.emaj_mark where mark_group = 'myGroup1';
 mark_time_id | mark_name | mark_group | mark_is_deleted | mark_is_rlbk_protected 
--------------+-----------+------------+-----------------+------------------------
         3011 | SM3       | myGroup1   | f               | f
(1 row)

-- check mark protections is removed by stop_group functions
select emaj.emaj_protect_mark_group('myGroup1','EMAJ_LAST_MARK');
 emaj_protect_mark_group 
-------------------------
                       1
(1 row)

select regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_is_deleted, mark_is_rlbk_protected 
  from emaj.emaj_mark where mark_group = 'myGroup1' order by mark_time_id, mark_group;
 regexp_replace | mark_is_deleted | mark_is_rlbk_protected 
----------------+-----------------+------------------------
 SM3            | f               | t
(1 row)

  
select emaj.emaj_stop_group('myGroup1');
 emaj_stop_group 
-----------------
               7
(1 row)

select regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_is_deleted, mark_is_rlbk_protected 
  from emaj.emaj_mark where mark_group = 'myGroup1' order by mark_time_id, mark_group;
 regexp_replace | mark_is_deleted | mark_is_rlbk_protected 
----------------+-----------------+------------------------
 SM3            | t               | f
 STOP_%         | t               | f
(2 rows)

-----------------------------
-- test functions with group not in logging state 
-----------------------------
-- myGroup1 is already stopped
select emaj.emaj_stop_group('myGroup2');
 emaj_stop_group 
-----------------
              10
(1 row)

select emaj.emaj_set_mark_group('myGroup1','SM1');
ERROR:  _check_group_names: The group "myGroup1" is not in LOGGING state.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,boolean,boolean,boolean,boolean) line 87 at RAISE
SQL statement "SELECT emaj._check_group_names(p_groupNames := ARRAY[p_groupName], p_mayBeNull := FALSE, p_lockGroups := TRUE,
                                    p_checkLogging := TRUE)"
PL/pgSQL function emaj.emaj_set_mark_group(text,text) line 15 at PERFORM
select emaj.emaj_set_mark_groups(array['myGroup1','myGroup2'],'SM1');
ERROR:  _check_group_names: The groups "myGroup1, myGroup2" are not in LOGGING state.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,boolean,boolean,boolean,boolean) line 90 at RAISE
SQL statement "SELECT emaj._check_group_names(p_groupNames := p_groupNames, p_mayBeNull := TRUE, p_lockGroups := TRUE, p_checkLogging := TRUE)"
PL/pgSQL function emaj.emaj_set_mark_groups(text[],text) line 15 at SQL statement
select emaj.emaj_rename_mark_group('myGroup1','EMAJ_LAST_MARK','RENAMED');
 emaj_rename_mark_group 
------------------------
 
(1 row)

select emaj.emaj_protect_mark_group('myGroup1','RENAMED');
ERROR:  _check_mark_name: For the group "myGroup1", the mark "RENAMED" is DELETED.
CONTEXT:  PL/pgSQL function emaj._check_mark_name(text[],text,boolean) line 81 at RAISE
SQL statement "SELECT emaj._check_mark_name(p_groupNames := ARRAY[p_groupName], p_mark := p_mark, p_checkActive := TRUE)"
PL/pgSQL function emaj.emaj_protect_mark_group(text,text) line 14 at SQL statement
select emaj.emaj_unprotect_mark_group('myGroup1','EMAJ_LAST_MARK');
 emaj_unprotect_mark_group 
---------------------------
                         0
(1 row)

-- check marks state
select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_deleted, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_time_id, mark_group;
    mark_group    | regexp_replace | mark_time_id | mark_is_deleted | mark_is_rlbk_protected |              mark_comment              | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------------+----------------+--------------+-----------------+------------------------+----------------------------------------+---------------------------+------------------------------
 emptyGroup       | SM2            |         3006 | f               | f                      | a comment on a mark for an empty group |                         0 | Mark1
 myGroup1         | SM3            |         3011 | t               | f                      |                                        |                         0 | 
 myGroup2         | SM2            |         3015 | t               | f                      | a comment for group #2                 |                         0 | 
 emptyGroup       | EGM3           |         3400 | f               | f                      |                                        |                         0 | 
 emptyGroup       | EGM4           |         3401 | f               | f                      |                                        |                           | 
 phil's group#3", | Mark4          |         3402 | f               | f                      |                                        |                         0 | 
 phil's group#3", | Mark5          |         3403 | f               | f                      |                                        |                           | 
 myGroup1         | RENAMED        |         3600 | t               | f                      |                                        |                         0 | 
 myGroup2         | STOP_%         |         3601 | t               | f                      |                                        |                         0 | 
(9 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
  sequ_schema   |     sequ_name     | sequ_time_id | sequ_last_val | sequ_is_called 
----------------+-------------------+--------------+---------------+----------------
 myschema1      | myTbl3_col31_seq  |         3011 |             1 | f
 myschema1      | mytbl2b_col20_seq |         3011 |             1 | f
 myschema2      | myTbl3_col31_seq  |         3015 |             1 | f
 myschema2      | myseq1            |         3015 |          1000 | f
 phil's schema3 | myTbl2\_col21_seq |         3402 |             1 | f
 phil's schema3 | phil's seq\1      |         3402 |          1000 | f
 phil's schema3 | myTbl2\_col21_seq |         3403 |             1 | f
 phil's schema3 | phil's seq\1      |         3403 |          1000 | f
 myschema1      | myTbl3_col31_seq  |         3600 |             1 | f
 myschema1      | mytbl2b_col20_seq |         3600 |             1 | f
 myschema2      | myTbl3_col31_seq  |         3601 |             1 | f
 myschema2      | myseq1            |         3601 |          1000 | f
(12 rows)

select tbl_schema, tbl_name, tbl_time_id, tbl_log_seq_last_val from emaj.emaj_table order by tbl_time_id, tbl_schema, tbl_name;
   tbl_schema   |  tbl_name   | tbl_time_id | tbl_log_seq_last_val 
----------------+-------------+-------------+----------------------
 myschema1      | myTbl3      |        3011 |                    0
 myschema1      | mytbl1      |        3011 |                    0
 myschema1      | mytbl2      |        3011 |                    0
 myschema1      | mytbl2b     |        3011 |                    0
 myschema1      | mytbl4      |        3011 |                    0
 myschema2      | myTbl3      |        3015 |                    0
 myschema2      | mytbl1      |        3015 |                    0
 myschema2      | mytbl2      |        3015 |                    0
 myschema2      | mytbl4      |        3015 |                    0
 myschema2      | mytbl5      |        3015 |                    0
 myschema2      | mytbl6      |        3015 |                    0
 myschema2      | mytbl7      |        3015 |                    0
 myschema2      | mytbl8      |        3015 |                    0
 phil's schema3 | myTbl2\     |        3402 |                    0
 phil's schema3 | phil's tbl1 |        3402 |                    0
 phil's schema3 | myTbl2\     |        3403 |                    0
 phil's schema3 | phil's tbl1 |        3403 |                    0
 myschema1      | myTbl3      |        3600 |                    0
 myschema1      | mytbl1      |        3600 |                    0
 myschema1      | mytbl2      |        3600 |                    0
 myschema1      | mytbl2b     |        3600 |                    0
 myschema1      | mytbl4      |        3600 |                    0
 myschema2      | myTbl3      |        3601 |                    0
 myschema2      | mytbl1      |        3601 |                    0
 myschema2      | mytbl2      |        3601 |                    0
 myschema2      | mytbl4      |        3601 |                    0
 myschema2      | mytbl5      |        3601 |                    0
 myschema2      | mytbl6      |        3601 |                    0
 myschema2      | mytbl7      |        3601 |                    0
 myschema2      | mytbl8      |        3601 |                    0
(30 rows)

-----------------------------
-- test end: check
-----------------------------
select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 3600 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
    3600 |            3600000 | X
    3601 |            3600000 | X
(2 rows)

select hist_id, hist_function, hist_event, regexp_replace(hist_object,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), regexp_replace(regexp_replace(hist_wording,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),E'\\[.+\\]','(timestamp)','g'), hist_user from 
  (select * from emaj.emaj_hist where hist_id >= 3600 order by hist_id) as t;
 hist_id |    hist_function     | hist_event | regexp_replace |         regexp_replace         | hist_user 
---------+----------------------+------------+----------------+--------------------------------+-----------
    3600 | PROTECT_MARK_GROUP   |            | myGroup1       | Mark SM3 ; status 1            | postgres
    3601 | PROTECT_MARK_GROUP   |            | emptyGroup     | Mark EGM4 ; status 1           | postgres
    3602 | PROTECT_MARK_GROUP   |            | myGroup1       | Mark SM3 ; status 0            | postgres
    3603 | UNPROTECT_MARK_GROUP |            | myGroup1       | Mark SM3 ; status 1            | postgres
    3604 | UNPROTECT_MARK_GROUP |            | emptyGroup     | Mark EGM4 ; status 1           | postgres
    3605 | UNPROTECT_MARK_GROUP |            | myGroup1       | Mark SM3 ; status 0            | postgres
    3606 | PROTECT_MARK_GROUP   |            | myGroup1       | Mark SM3 ; status 1            | postgres
    3607 | STOP_GROUP           | BEGIN      | myGroup1       |                                | postgres
    3608 | LOCK_GROUP           | BEGIN      | myGroup1       |                                | postgres
    3609 | LOCK_GROUP           | END        | myGroup1       | 5 tables locked, 0 deadlock(s) | postgres
    3610 | SET_MARK_GROUP       | BEGIN      | myGroup1       | STOP_%                         | postgres
    3611 | SET_MARK_GROUP       | END        | myGroup1       | STOP_%                         | postgres
    3612 | STOP_GROUP           | END        | myGroup1       | 7 tables/sequences processed   | postgres
    3613 | STOP_GROUP           | BEGIN      | myGroup2       |                                | postgres
    3614 | LOCK_GROUP           | BEGIN      | myGroup2       |                                | postgres
    3615 | LOCK_GROUP           | END        | myGroup2       | 8 tables locked, 0 deadlock(s) | postgres
    3616 | SET_MARK_GROUP       | BEGIN      | myGroup2       | STOP_%                         | postgres
    3617 | SET_MARK_GROUP       | END        | myGroup2       | STOP_%                         | postgres
    3618 | STOP_GROUP           | END        | myGroup2       | 10 tables/sequences processed  | postgres
    3621 | RENAME_MARK_GROUP    | BEGIN      | myGroup1       | EMAJ_LAST_MARK                 | postgres
    3622 | RENAME_MARK_GROUP    | END        | myGroup1       | STOP_% renamed RENAMED         | postgres
    3623 | UNPROTECT_MARK_GROUP |            | myGroup1       | Mark RENAMED ; status 0        | postgres
(22 rows)

