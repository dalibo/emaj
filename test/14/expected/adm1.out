-- adm1.sql : complex scenarios executed by an emaj_adm role
--
SET datestyle TO ymd;
-- set sequence restart value
select public.handle_emaj_sequences(12000);
 handle_emaj_sequences 
-----------------------
 
(1 row)

truncate emaj.emaj_hist;
-----------------------------
-- grant emaj_adm role 
-----------------------------
grant emaj_adm to emaj_regression_tests_adm_user1, emaj_regression_tests_adm_user2;
--
set role emaj_regression_tests_adm_user1;
-----------------------------
-- authorized table accesses
-----------------------------
select 'select ok' as result from (select count(*) from emaj.emaj_version_hist) as t;
  result   
-----------
 select ok
(1 row)

select 'select ok' as result from (select count(*) from emaj.emaj_param) as t;
  result   
-----------
 select ok
(1 row)

select 'select ok' as result from (select count(*) from emaj.emaj_visible_param) as t;
  result   
-----------
 select ok
(1 row)

select 'select ok' as result from (select count(*) from emaj.emaj_time_stamp) as t;
  result   
-----------
 select ok
(1 row)

select 'select ok' as result from (select count(*) from emaj.emaj_hist) as t;
  result   
-----------
 select ok
(1 row)

select 'select ok' as result from (select count(*) from emaj.emaj_group) as t;
  result   
-----------
 select ok
(1 row)

select 'select ok' as result from (select count(*) from emaj.emaj_schema) as t;
  result   
-----------
 select ok
(1 row)

select 'select ok' as result from (select count(*) from emaj.emaj_relation) as t;
  result   
-----------
 select ok
(1 row)

select 'select ok' as result from (select count(*) from emaj.emaj_rel_hist) as t;
  result   
-----------
 select ok
(1 row)

select 'select ok' as result from (select count(*) from emaj.emaj_log_session) as t;
  result   
-----------
 select ok
(1 row)

select 'select ok' as result from (select count(*) from emaj.emaj_mark) as t;
  result   
-----------
 select ok
(1 row)

select 'select ok' as result from (select count(*) from emaj.emaj_sequence) as t;
  result   
-----------
 select ok
(1 row)

select 'select ok' as result from (select count(*) from emaj.emaj_table) as t;
  result   
-----------
 select ok
(1 row)

select 'select ok' as result from (select count(*) from emaj.emaj_seq_hole) as t;
  result   
-----------
 select ok
(1 row)

select 'select ok' as result from (select count(*) from emaj.emaj_rlbk) as t;
  result   
-----------
 select ok
(1 row)

select 'select ok' as result from (select count(*) from emaj.emaj_rlbk_session) as t;
  result   
-----------
 select ok
(1 row)

select 'select ok' as result from (select count(*) from emaj.emaj_rlbk_plan) as t;
  result   
-----------
 select ok
(1 row)

select 'select ok' as result from (select count(*) from emaj.emaj_rlbk_stat) as t;
  result   
-----------
 select ok
(1 row)

select 'select ok' as result from (select count(*) from emaj_mySchema1.myTbl1_log) as t;
  result   
-----------
 select ok
(1 row)

-----------------------------
-- stop, reset and drop existing groups
-----------------------------
select emaj.emaj_stop_group('myGroup1','Simple stop mark');
 emaj_stop_group 
-----------------
               7
(1 row)

select emaj.emaj_reset_group('myGroup1');
 emaj_reset_group 
------------------
                7
(1 row)

select emaj.emaj_drop_group('myGroup1');
 emaj_drop_group 
-----------------
               7
(1 row)

select emaj.emaj_force_drop_group('myGroup2');
 emaj_force_drop_group 
-----------------------
                     8
(1 row)

select emaj.emaj_force_stop_group('emptyGroup');
 emaj_force_stop_group 
-----------------------
                     0
(1 row)

select emaj.emaj_drop_group('emptyGroup');
 emaj_drop_group 
-----------------
               0
(1 row)

-- emaj tables
select * from emaj.emaj_group;
 group_name | group_is_rollbackable | group_pg_version | group_last_alter_time_id | group_is_logging | group_is_rlbk_protected | group_nb_table | group_nb_sequence | group_comment 
------------+-----------------------+------------------+--------------------------+------------------+-------------------------+----------------+-------------------+---------------
(0 rows)

select sch_name from emaj.emaj_schema;
 sch_name 
----------
 emaj
(1 row)

select * from emaj.emaj_relation;
 rel_schema | rel_tblseq | rel_time_range | rel_group | rel_kind | rel_priority | rel_log_schema | rel_log_table | rel_log_dat_tsp | rel_log_index | rel_log_idx_tsp | rel_log_sequence | rel_log_function | rel_ignored_triggers | rel_pk_cols | rel_emaj_verb_attnum | rel_has_always_ident_col | rel_sql_rlbk_columns | rel_sql_gen_ins_col | rel_sql_gen_ins_val | rel_sql_gen_upd_set | rel_sql_gen_pk_conditions | rel_log_seq_last_value 
------------+------------+----------------+-----------+----------+--------------+----------------+---------------+-----------------+---------------+-----------------+------------------+------------------+----------------------+-------------+----------------------+--------------------------+----------------------+---------------------+---------------------+---------------------+---------------------------+------------------------
(0 rows)

select * from emaj.emaj_mark;
 mark_group | mark_name | mark_time_id | mark_is_rlbk_protected | mark_comment | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------+-----------+--------------+------------------------+--------------+---------------------------+------------------------------
(0 rows)

select * from emaj.emaj_sequence;
 sequ_schema | sequ_name | sequ_time_id | sequ_last_val | sequ_start_val | sequ_increment | sequ_max_val | sequ_min_val | sequ_cache_val | sequ_is_cycled | sequ_is_called 
-------------+-----------+--------------+---------------+----------------+----------------+--------------+--------------+----------------+----------------+----------------
(0 rows)

select * from emaj.emaj_table;
 tbl_schema | tbl_name | tbl_time_id | tbl_pages | tbl_tuples | tbl_log_seq_last_val 
------------+----------+-------------+-----------+------------+----------------------
(0 rows)

select * from emaj.emaj_seq_hole;
 sqhl_schema | sqhl_table | sqhl_begin_time_id | sqhl_end_time_id | sqhl_hole_size 
-------------+------------+--------------------+------------------+----------------
(0 rows)

select count(*) from emaj.emaj_rlbk;
 count 
-------
    40
(1 row)

select count(*) from emaj.emaj_rlbk_session;
 count 
-------
    40
(1 row)

select count(*) from emaj.emaj_rlbk_plan;
 count 
-------
   265
(1 row)

select count(*) from emaj.emaj_rlbk_stat;
 count 
-------
     0
(1 row)

-----------------------------
-- cleanup application tables
-----------------------------
reset role;
truncate mySchema1.myTbl1, mySchema1.myTbl2, mySchema1."myTbl3", mySchema1.myTbl4, mySchema1.myTbl2b; 
truncate mySchema2.myTbl1, mySchema2.myTbl2, mySchema2."myTbl3", mySchema2.myTbl4, mySchema2.myTbl5, mySchema2.myTbl6, mySchema2.myTbl7, mySchema2.myTbl8;
insert into myschema2.myTbl7 select i from generate_series(0,100,1) i;
insert into myschema2.myTbl6 (col61) values (0);
insert into myschema2.myTbl8 (col81) values (0);
alter sequence mySchema2.mySeq1 restart 1000;
truncate mySchema4.myTblM, mySchema4.myTblC1, mySchema4.myTblC2;
truncate mySchema4.myTblP, mySchema4.myPartP1a, mySchema4.myPartP1b, mySchema4.myPartP2, mySchema4.myTblR1, mySchema4.myTblR2 CASCADE;
-- analyze to get some statistics
analyze;
set role emaj_regression_tests_adm_user2;
-----------------------------
-- explicitely purge the histories
-----------------------------
select emaj.emaj_purge_histories('0 SECOND');
 emaj_purge_histories 
----------------------
 
(1 row)

select hist_function, hist_event, hist_wording
  from emaj.emaj_hist order by hist_id;
  hist_function  | hist_event |                                                                                      hist_wording                                                                                      
-----------------+------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 PURGE_HISTORIES | BEGIN      | Retention delay @ 0
 PURGE_HISTORIES |            | 25 emaj_hist rows deleted ; 17 log session rows deleted ; 13 group history rows deleted ; 144 relation history rows deleted ; 95 relation changes deleted ; 40 rollback events deleted
 PURGE_HISTORIES | END        | 
(3 rows)

-----------------------------
-- recreate and start groups
-----------------------------
-- set the parameter to drop the emaj_user_port column and add an 'extra_col_appname' column
insert into emaj.emaj_param (param_key, param_value_text) values ('alter_log_table',
  'ADD COLUMN emaj_user_ip INET DEFAULT inet_client_addr(), ADD COLUMN extra_col_appname TEXT DEFAULT current_setting(''application_name'')');
select emaj.emaj_create_group('myGroup1');
 emaj_create_group 
-------------------
                 1
(1 row)

select emaj.emaj_comment_group('myGroup1','This is group #1');
 emaj_comment_group 
--------------------
 
(1 row)

select emaj.emaj_assign_table('myschema1','mytbl1','myGroup1','{"priority":20}'::jsonb);
NOTICE:  table "mytbl1_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema1.mytbl1" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema1.mytbl1" does not exist, skipping
 emaj_assign_table 
-------------------
                 1
(1 row)

select emaj.emaj_assign_table('myschema1','mytbl2','myGroup1','{"log_data_tablespace":"tsplog1","log_index_tablespace":"tsplog1"}'::jsonb);
NOTICE:  table "mytbl2_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema1.mytbl2" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema1.mytbl2" does not exist, skipping
WARNING:  _create_tbl: The table "myschema1.mytbl2" has triggers that will be automatically disabled during E-Maj rollback operations (mytbl2trg1, mytbl2trg2). Use the emaj_modify_table() function to change this behaviour.
 emaj_assign_table 
-------------------
                 1
(1 row)

select emaj.emaj_assign_table('myschema1','mytbl2b','myGroup1','{"log_data_tablespace":"tsp log''2","log_index_tablespace":"tsp log''2"}'::jsonb);
NOTICE:  table "mytbl2b_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema1.mytbl2b" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema1.mytbl2b" does not exist, skipping
 emaj_assign_table 
-------------------
                 1
(1 row)

select emaj.emaj_assign_table('myschema1','myTbl3','myGroup1','{"priority":10,"log_data_tablespace":"tsplog1"}'::jsonb);
NOTICE:  table "myTbl3_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema1.myTbl3" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema1.myTbl3" does not exist, skipping
 emaj_assign_table 
-------------------
                 1
(1 row)

select emaj.emaj_assign_table('myschema1','mytbl4','myGroup1','{"priority":20,"log_data_tablespace":"tsplog1","log_index_tablespace":"tsp log''2"}'::jsonb);
NOTICE:  table "mytbl4_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema1.mytbl4" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema1.mytbl4" does not exist, skipping
 emaj_assign_table 
-------------------
                 1
(1 row)

select emaj.emaj_assign_sequences('myschema1','.*',null,'myGroup1');
 emaj_assign_sequences 
-----------------------
                     2
(1 row)

select emaj.emaj_create_group('myGroup2',true,'This is group #2');
 emaj_create_group 
-------------------
                 1
(1 row)

select emaj.emaj_assign_tables('myschema2','.*','mytbl[7,8]','myGroup2');
NOTICE:  table "myTbl3_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema2.myTbl3" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema2.myTbl3" does not exist, skipping
NOTICE:  table "mytbl1_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema2.mytbl1" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema2.mytbl1" does not exist, skipping
NOTICE:  table "mytbl2_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema2.mytbl2" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema2.mytbl2" does not exist, skipping
NOTICE:  table "mytbl4_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema2.mytbl4" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema2.mytbl4" does not exist, skipping
NOTICE:  table "mytbl5_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema2.mytbl5" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema2.mytbl5" does not exist, skipping
NOTICE:  table "mytbl6_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema2.mytbl6" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema2.mytbl6" does not exist, skipping
 emaj_assign_tables 
--------------------
                  6
(1 row)

select emaj.emaj_assign_sequences('myschema2','.*','myseq2','myGroup2');
 emaj_assign_sequences 
-----------------------
                     2
(1 row)

select emaj.emaj_create_group('emptyGroup');
 emaj_create_group 
-------------------
                 1
(1 row)

-- try to rename the last mark for a group that has no mark
select emaj.emaj_rename_mark_group('myGroup2','EMAJ_LAST_MARK','new_mark_name');
ERROR:  _check_mark_name: The group "myGroup2" has no mark.
CONTEXT:  PL/pgSQL function emaj._check_mark_name(text[],text,boolean) line 24 at RAISE
SQL statement "SELECT emaj._check_mark_name(p_groupNames := ARRAY[p_groupName], p_mark := p_mark)"
PL/pgSQL function emaj.emaj_rename_mark_group(text,text,text) line 14 at SQL statement
-- force a purge of the history, the alter and the rollback tables
INSERT INTO emaj.emaj_param (param_key, param_value_interval) VALUES ('history_retention','0.1 second'::interval);
select pg_sleep(0.2);
 pg_sleep 
----------
 
(1 row)

select emaj.emaj_start_group('myGroup1','M1');
 emaj_start_group 
------------------
                7
(1 row)

delete from emaj.emaj_param where param_key = 'history_retention';
select emaj.emaj_start_group('myGroup2','M1');
WARNING:  _check_fk_groups: The foreign key "mytbl6_col61_fkey" on the table "myschema2.mytbl6" references the table "myschema2.mytbl7" that is outside the groups (myGroup2).
WARNING:  _check_fk_groups: The table "myschema2.mytbl6" is referenced by the foreign key "mytbl8_col81_fkey" on the table "myschema2.mytbl8" that is outside the groups (myGroup2).
 emaj_start_group 
------------------
                8
(1 row)

-- set sequence restart value
select public.handle_emaj_sequences(12100);
 handle_emaj_sequences 
-----------------------
 
(1 row)

-----------------------------
-- Step 1 : for myGroup1, update tables and set 2 marks
-----------------------------
--
reset role;
set search_path=public,myschema1;
insert into myTbl1 select i, 'ABC', E'\\014'::bytea from generate_series (1,11) as i;
update myTbl1 set col13=E'\\034'::bytea where col11 <= 3;
insert into myTbl2 values (1,'ABC','2010-12-31');
delete from myTbl1 where col11 > 10;
insert into myTbl2 values (2,'DEF',NULL);
insert into "myTbl3" (col33) select generate_series(1000,1039,4)/100;
--
set role emaj_regression_tests_adm_user2;
select emaj.emaj_set_mark_group('myGroup1','M2');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

--
reset role;
set search_path=public,myschema1;
insert into myTbl4 values (1,'FK...',1,1,'ABC');
insert into myTbl4 values (2,'FK...',1,1,'ABC');
update myTbl4 set col43 = 2;
insert into myTbl4 values (3,'FK...',1,10,'ABC');
-- the 2 next statements activate fkey on delete and on update clauses 
delete from myTbl1 where col11 = 10;
update myTbl1 set col12='DEF' where col11 <= 2;
--
set role emaj_regression_tests_adm_user2;
select emaj.emaj_set_mark_group('myGroup1','M3');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

select emaj.emaj_comment_mark_group('myGroup1','M3','Third mark set');
 emaj_comment_mark_group 
-------------------------
 
(1 row)

-----------------------------
-- Checking step 1
-----------------------------
-- emaj tables
select group_name, group_is_rollbackable, group_last_alter_time_id, group_is_logging, group_is_rlbk_protected, group_nb_table, group_nb_sequence, group_comment
  from emaj.emaj_group order by group_name;
 group_name | group_is_rollbackable | group_last_alter_time_id | group_is_logging | group_is_rlbk_protected | group_nb_table | group_nb_sequence |  group_comment   
------------+-----------------------+--------------------------+------------------+-------------------------+----------------+-------------------+------------------
 emptyGroup | t                     |                          | f                | f                       |              0 |                 0 | 
 myGroup1   | t                     |                    12011 | t                | f                       |              5 |                 2 | This is group #1
 myGroup2   | t                     |                    12014 | t                | f                       |              6 |                 2 | This is group #2
(3 rows)

select * from emaj.emaj_group_hist order by grph_group, grph_time_range;
 grph_group | grph_time_range | grph_is_rollbackable | grph_log_sessions 
------------+-----------------+----------------------+-------------------
 emptyGroup | [12015,)        | t                    |                 0
 myGroup1   | [12005,)        | t                    |                 1
 myGroup2   | [12012,)        | t                    |                 1
(3 rows)

select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_rlbk_protected, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_time_id, mark_group;
 mark_group | regexp_replace | mark_time_id | mark_is_rlbk_protected | mark_is_rlbk_protected |  mark_comment  | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------+----------------+--------------+------------------------+------------------------+----------------+---------------------------+------------------------------
 myGroup1   | M1             |        12016 | f                      | f                      |                |                        29 | 
 myGroup2   | M1             |        12017 | f                      | f                      |                |                           | 
 myGroup1   | M2             |        12100 | f                      | f                      |                |                        11 | 
 myGroup1   | M3             |        12101 | f                      | f                      | Third mark set |                           | 
(4 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
 sequ_schema |     sequ_name     | sequ_time_id | sequ_last_val | sequ_is_called 
-------------+-------------------+--------------+---------------+----------------
 myschema1   | myTbl3_col31_seq  |        12016 |            11 | f
 myschema1   | mytbl2b_col20_seq |        12016 |             3 | f
 myschema2   | myTbl3_col31_seq  |        12017 |            10 | t
 myschema2   | myseq1            |        12017 |          1000 | f
 myschema1   | myTbl3_col31_seq  |        12100 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12100 |             4 | t
 myschema1   | myTbl3_col31_seq  |        12101 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12101 |             4 | t
(8 rows)

select tbl_schema, tbl_name, tbl_time_id, tbl_tuples, tbl_pages, tbl_log_seq_last_val from emaj.emaj_table order by tbl_time_id, tbl_schema, tbl_name;
 tbl_schema | tbl_name | tbl_time_id | tbl_tuples | tbl_pages | tbl_log_seq_last_val 
------------+----------+-------------+------------+-----------+----------------------
 myschema1  | myTbl3   |       12016 |          0 |         0 |                    0
 myschema1  | mytbl1   |       12016 |          0 |         0 |                    0
 myschema1  | mytbl2   |       12016 |          0 |         0 |                    0
 myschema1  | mytbl2b  |       12016 |          0 |         0 |                    0
 myschema1  | mytbl4   |       12016 |          0 |         0 |                    0
 myschema2  | myTbl3   |       12017 |          0 |         0 |                    0
 myschema2  | mytbl1   |       12017 |          0 |         0 |                    0
 myschema2  | mytbl2   |       12017 |          0 |         0 |                    0
 myschema2  | mytbl4   |       12017 |          0 |         0 |                    0
 myschema2  | mytbl5   |       12017 |          0 |         0 |                    0
 myschema2  | mytbl6   |       12017 |          1 |         1 |                    0
 myschema1  | myTbl3   |       12100 |          0 |         0 |                   10
 myschema1  | mytbl1   |       12100 |          0 |         0 |                   15
 myschema1  | mytbl2   |       12100 |          0 |         0 |                    2
 myschema1  | mytbl2b  |       12100 |          0 |         0 |                    2
 myschema1  | mytbl4   |       12100 |          0 |         0 |                    0
 myschema1  | myTbl3   |       12101 |          0 |         0 |                   10
 myschema1  | mytbl1   |       12101 |          0 |         0 |                   18
 myschema1  | mytbl2   |       12101 |          0 |         0 |                    2
 myschema1  | mytbl2b  |       12101 |          0 |         0 |                    2
 myschema1  | mytbl4   |       12101 |          0 |         0 |                    8
(21 rows)

select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 12000 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
   12000 |           12000000 | X
   12001 |           12000000 | D
   12002 |           12000000 | D
   12003 |           12000000 | X
   12004 |           12000000 | D
   12005 |           12000000 | C
   12006 |           12000000 | A
   12007 |           12000000 | A
   12008 |           12000000 | A
   12009 |           12000000 | A
   12010 |           12000000 | A
   12011 |           12000000 | A
   12012 |           12000000 | C
   12013 |           12000000 | A
   12014 |           12000000 | A
   12015 |           12000000 | C
   12016 |           12000000 | S
   12017 |           12000000 | S
   12100 |           12100029 | M
   12101 |           12100040 | M
(20 rows)

select hist_function, hist_event, hist_object,
       regexp_replace(regexp_replace(regexp_replace(hist_wording,
            E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),
            E'\\d\\d\\d\\d/\\d\\d\\/\\d\\d\\ \\d\\d\\:\\d\\d:\\d\\d .*?\\)','<timestamp>)','g'),
            E'\\[.+\\]','(timestamp)','g'), 
       hist_user
  from emaj.emaj_hist where hist_id >= 12000 order by hist_id;
   hist_function    |    hist_event     |    hist_object    |                                                  regexp_replace                                                   | hist_user 
--------------------+-------------------+-------------------+-------------------------------------------------------------------------------------------------------------------+-----------
 START_GROUP        | BEGIN             | myGroup1          | With log reset                                                                                                    | postgres
 START_GROUP        | TIME STAMP SET    | 12016             |                                                                                                                   | postgres
 PURGE_HISTORIES    |                   |                   | 56 emaj_hist rows deleted ; 1 group history rows deleted ; 8 relation changes deleted ; 0 rollback events deleted | postgres
 LOCK_GROUP         | BEGIN             | myGroup1          |                                                                                                                   | postgres
 LOCK_GROUP         | END               | myGroup1          | 5 tables locked, 0 deadlock(s)                                                                                    | postgres
 SET_MARK_GROUP     | BEGIN             | myGroup1          | M1                                                                                                                | postgres
 SET_MARK_GROUP     | END               | myGroup1          | M1                                                                                                                | postgres
 START_GROUP        | END               | myGroup1          | 7 tables/sequences processed                                                                                      | postgres
                    | DELETED PARAMETER | history_retention |                                                                                                                   | postgres
 START_GROUP        | BEGIN             | myGroup2          | With log reset                                                                                                    | postgres
 START_GROUP        | TIME STAMP SET    | 12017             |                                                                                                                   | postgres
 LOCK_GROUP         | BEGIN             | myGroup2          |                                                                                                                   | postgres
 LOCK_GROUP         | END               | myGroup2          | 6 tables locked, 0 deadlock(s)                                                                                    | postgres
 SET_MARK_GROUP     | BEGIN             | myGroup2          | M1                                                                                                                | postgres
 SET_MARK_GROUP     | END               | myGroup2          | M1                                                                                                                | postgres
 START_GROUP        | END               | myGroup2          | 8 tables/sequences processed                                                                                      | postgres
 SET_MARK_GROUP     | BEGIN             | myGroup1          |                                                                                                                   | postgres
 LOCK_GROUP         | BEGIN             | myGroup1          |                                                                                                                   | postgres
 LOCK_GROUP         | END               | myGroup1          | 5 tables locked, 0 deadlock(s)                                                                                    | postgres
 SET_MARK_GROUP     | TIME STAMP SET    | 12100             |                                                                                                                   | postgres
 SET_MARK_GROUP     | END               | myGroup1          | M2                                                                                                                | postgres
 SET_MARK_GROUP     | BEGIN             | myGroup1          |                                                                                                                   | postgres
 LOCK_GROUP         | BEGIN             | myGroup1          |                                                                                                                   | postgres
 LOCK_GROUP         | END               | myGroup1          | 5 tables locked, 0 deadlock(s)                                                                                    | postgres
 SET_MARK_GROUP     | TIME STAMP SET    | 12101             |                                                                                                                   | postgres
 SET_MARK_GROUP     | END               | myGroup1          | M3                                                                                                                | postgres
 COMMENT_MARK_GROUP |                   | myGroup1          | Mark M3                                                                                                           | postgres
(27 rows)

-- user tables
reset role;
select * from mySchema1.myTbl1 order by col11,col12;
 col11 |   col12    | col13 
-------+------------+-------
     1 | DEF        | \x1c
     2 | DEF        | \x1c
     3 | ABC        | \x1c
     4 | ABC        | \x0c
     5 | ABC        | \x0c
     6 | ABC        | \x0c
     7 | ABC        | \x0c
     8 | ABC        | \x0c
     9 | ABC        | \x0c
(9 rows)

select * from mySchema1.myTbl2 order by col21;
 col21 | col22 |   col23    
-------+-------+------------
     1 | ABC   | 12-31-2010
     2 | DEF   | 
(2 rows)

select * from mySchema1.myTbl2b order by col20;
 col20 | col21 | col22 | col23 
-------+-------+-------+-------
     3 |     1 |     1 | t
     4 |     2 |   0.5 | t
(2 rows)

select col31,col33 from mySchema1."myTbl3" order by col31;
 col31 | col33 
-------+-------
    11 | 10.00
    12 | 10.00
    13 | 10.00
    14 | 10.00
    15 | 10.00
    16 | 10.00
    17 | 10.00
    18 | 10.00
    19 | 10.00
    20 | 10.00
(10 rows)

select * from mySchema1.myTbl4 order by col41;
 col41 | col42 | col43 | col44 | col45 
-------+-------+-------+-------+-------
     1 | FK... |     2 |       | 
     2 | FK... |     2 |       | 
(2 rows)

-- log tables
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid, emaj_user, emaj_user_ip, extra_col_appname
    from emaj_mySchema1.myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid | emaj_user | emaj_user_ip | extra_col_appname 
-------+------------+-------+-----------+------------+----------+-----------+--------------+-------------------
     1 | ABC        | \x0c  | INS       | NEW        | 12100001 | postgres  | 127.0.0.1    | psql
     2 | ABC        | \x0c  | INS       | NEW        | 12100002 | postgres  | 127.0.0.1    | psql
     3 | ABC        | \x0c  | INS       | NEW        | 12100003 | postgres  | 127.0.0.1    | psql
     4 | ABC        | \x0c  | INS       | NEW        | 12100004 | postgres  | 127.0.0.1    | psql
     5 | ABC        | \x0c  | INS       | NEW        | 12100005 | postgres  | 127.0.0.1    | psql
     6 | ABC        | \x0c  | INS       | NEW        | 12100006 | postgres  | 127.0.0.1    | psql
     7 | ABC        | \x0c  | INS       | NEW        | 12100007 | postgres  | 127.0.0.1    | psql
     8 | ABC        | \x0c  | INS       | NEW        | 12100008 | postgres  | 127.0.0.1    | psql
     9 | ABC        | \x0c  | INS       | NEW        | 12100009 | postgres  | 127.0.0.1    | psql
    10 | ABC        | \x0c  | INS       | NEW        | 12100010 | postgres  | 127.0.0.1    | psql
    11 | ABC        | \x0c  | INS       | NEW        | 12100011 | postgres  | 127.0.0.1    | psql
     1 | ABC        | \x0c  | UPD       | OLD        | 12100012 | postgres  | 127.0.0.1    | psql
     1 | ABC        | \x1c  | UPD       | NEW        | 12100012 | postgres  | 127.0.0.1    | psql
     2 | ABC        | \x0c  | UPD       | OLD        | 12100013 | postgres  | 127.0.0.1    | psql
     2 | ABC        | \x1c  | UPD       | NEW        | 12100013 | postgres  | 127.0.0.1    | psql
     3 | ABC        | \x0c  | UPD       | OLD        | 12100014 | postgres  | 127.0.0.1    | psql
     3 | ABC        | \x1c  | UPD       | NEW        | 12100014 | postgres  | 127.0.0.1    | psql
    11 | ABC        | \x0c  | DEL       | OLD        | 12100017 | postgres  | 127.0.0.1    | psql
    10 | ABC        | \x0c  | DEL       | OLD        | 12100035 | postgres  | 127.0.0.1    | psql
     1 | ABC        | \x1c  | UPD       | OLD        | 12100037 | postgres  | 127.0.0.1    | psql
     1 | DEF        | \x1c  | UPD       | NEW        | 12100037 | postgres  | 127.0.0.1    | psql
     2 | ABC        | \x1c  | UPD       | OLD        | 12100038 | postgres  | 127.0.0.1    | psql
     2 | DEF        | \x1c  | UPD       | NEW        | 12100038 | postgres  | 127.0.0.1    | psql
(23 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid, emaj_user, emaj_user_ip, extra_col_appname
    from emaj_mySchema1.myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 |   col23    | emaj_verb | emaj_tuple | emaj_gid | emaj_user | emaj_user_ip | extra_col_appname 
-------+-------+------------+-----------+------------+----------+-----------+--------------+-------------------
     1 | ABC   | 12-31-2010 | INS       | NEW        | 12100015 | postgres  | 127.0.0.1    | psql
     2 | DEF   |            | INS       | NEW        | 12100018 | postgres  | 127.0.0.1    | psql
(2 rows)

select col20, col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid, emaj_user, emaj_user_ip, extra_col_appname
    from emaj_mySchema1.myTbl2b_log order by emaj_gid, emaj_tuple desc;
 col20 | col21 | col22 | col23 | emaj_verb | emaj_tuple | emaj_gid | emaj_user | emaj_user_ip | extra_col_appname 
-------+-------+-------+-------+-----------+------------+----------+-----------+--------------+-------------------
     3 |     1 |     1 | t     | INS       | NEW        | 12100016 | postgres  | 127.0.0.1    | psql
     4 |     2 |   0.5 | t     | INS       | NEW        | 12100019 | postgres  | 127.0.0.1    | psql
(2 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid, emaj_user, emaj_user_ip, extra_col_appname
    from emaj_myschema1."myTbl3_log" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid | emaj_user | emaj_user_ip | extra_col_appname 
-------+-------+-----------+------------+----------+-----------+--------------+-------------------
    11 | 10.00 | INS       | NEW        | 12100020 | postgres  | 127.0.0.1    | psql
    12 | 10.00 | INS       | NEW        | 12100021 | postgres  | 127.0.0.1    | psql
    13 | 10.00 | INS       | NEW        | 12100022 | postgres  | 127.0.0.1    | psql
    14 | 10.00 | INS       | NEW        | 12100023 | postgres  | 127.0.0.1    | psql
    15 | 10.00 | INS       | NEW        | 12100024 | postgres  | 127.0.0.1    | psql
    16 | 10.00 | INS       | NEW        | 12100025 | postgres  | 127.0.0.1    | psql
    17 | 10.00 | INS       | NEW        | 12100026 | postgres  | 127.0.0.1    | psql
    18 | 10.00 | INS       | NEW        | 12100027 | postgres  | 127.0.0.1    | psql
    19 | 10.00 | INS       | NEW        | 12100028 | postgres  | 127.0.0.1    | psql
    20 | 10.00 | INS       | NEW        | 12100029 | postgres  | 127.0.0.1    | psql
(10 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid, emaj_user, emaj_user_ip, extra_col_appname
    from emaj_mySchema1.myTbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 | col45 | emaj_verb | emaj_tuple | emaj_gid | emaj_user | emaj_user_ip | extra_col_appname 
-------+-------+-------+-------+-------+-----------+------------+----------+-----------+--------------+-------------------
     1 | FK... |     1 |     1 | ABC   | INS       | NEW        | 12100030 | postgres  | 127.0.0.1    | psql
     2 | FK... |     1 |     1 | ABC   | INS       | NEW        | 12100031 | postgres  | 127.0.0.1    | psql
     1 | FK... |     1 |     1 | ABC   | UPD       | OLD        | 12100032 | postgres  | 127.0.0.1    | psql
     1 | FK... |     2 |     1 | ABC   | UPD       | NEW        | 12100032 | postgres  | 127.0.0.1    | psql
     2 | FK... |     1 |     1 | ABC   | UPD       | OLD        | 12100033 | postgres  | 127.0.0.1    | psql
     2 | FK... |     2 |     1 | ABC   | UPD       | NEW        | 12100033 | postgres  | 127.0.0.1    | psql
     3 | FK... |     1 |    10 | ABC   | INS       | NEW        | 12100034 | postgres  | 127.0.0.1    | psql
     3 | FK... |     1 |    10 | ABC   | DEL       | OLD        | 12100036 | postgres  | 127.0.0.1    | psql
     1 | FK... |     2 |     1 | ABC   | UPD       | OLD        | 12100039 | postgres  | 127.0.0.1    | psql
     1 | FK... |     2 |       |       | UPD       | NEW        | 12100039 | postgres  | 127.0.0.1    | psql
     2 | FK... |     2 |     1 | ABC   | UPD       | OLD        | 12100040 | postgres  | 127.0.0.1    | psql
     2 | FK... |     2 |       |       | UPD       | NEW        | 12100040 | postgres  | 127.0.0.1    | psql
(12 rows)

-- set sequence restart value
select public.handle_emaj_sequences(12200);
 handle_emaj_sequences 
-----------------------
 
(1 row)

-----------------------------
-- Step 2 : for myGroup2, start, update tables and set 2 marks 
-----------------------------
set search_path=public,myschema2;
insert into myTbl1 select i, 'ABC', E'\\014'::bytea from generate_series (1,11) as i;
update myTbl1 set col13=E'\\034'::bytea where col11 <= 3;
insert into myTbl2 values (1,'ABC','2010-01-01');
delete from myTbl1 where col11 > 10;
select nextval('myschema2.myseq1');
 nextval 
---------
    1000
(1 row)

insert into myTbl2 values (2,'DEF',NULL);
insert into "myTbl3" (col33) select generate_series(1000,1039,4)/100;
insert into myTbl5 values (1,'{"abc","def","ghi"}','{1,2,3}',NULL,'{}',NULL,'{"id":1000}','[2020-01-01, 2021-01-01)',NULL);
insert into myTbl5 values (2,array['abc','def','ghi'],array[3,4,5],array['2000/02/01'::date,'2000/02/28'::date],'{"id":1001, "c1":"abc"}',NULL,'{"id":1001}',NULL,XMLPARSE (CONTENT '<foo>bar</foo>'));
update myTbl5 set col54 = '{"2010/11/28","2010/12/03"}', col55 = '{"id":1001, "c2":"def"}', col57 = '{"id":1001, "c3":"ghi"}' where col54 is null;
insert into myTbl6 select i, point(i,1.3), box(point(i,0),point(i+0.2,1)), circle(point(5,5),i),'((-2,-2),(3,0),(1,4))','10.20.30.40/27','EXECUTING',(i,point(i,1.3))::mycomposite from generate_series (1,8) as i;
update myTbl6 set col64 = '<(5,6),3.5>', col65 = null, col67 = 'COMPLETED' where col61 between 1 and 3;
--
set role emaj_regression_tests_adm_user1;
select emaj.emaj_set_mark_group('myGroup2','M2');
 emaj_set_mark_group 
---------------------
                   8
(1 row)

--
reset role;
set search_path=public,myschema2;
select nextval('myschema2.myseq1');
 nextval 
---------
    1001
(1 row)

select nextval('myschema2.myseq1');
 nextval 
---------
    1002
(1 row)

select nextval('myschema2.myseq1');
 nextval 
---------
    1003
(1 row)

--
alter sequence mySeq1 NO MAXVALUE NO CYCLE;
--
insert into myTbl4 values (1,'FK...',1,1,'ABC');
insert into myTbl4 values (2,'FK...',1,1,'ABC');
update myTbl4 set col43 = 2;
delete from mytbl5 where 4 = any(col53);
delete from myTbl6 where col65 is null and col61 <> 0;
--
set role emaj_regression_tests_adm_user1;
select emaj.emaj_set_mark_group('myGroup2','M3');
 emaj_set_mark_group 
---------------------
                   8
(1 row)

-----------------------------
-- Checking step 2
-----------------------------
-- emaj tables
select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_time_id, mark_group;
 mark_group | regexp_replace | mark_time_id | mark_is_rlbk_protected |  mark_comment  | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------+----------------+--------------+------------------------+----------------+---------------------------+------------------------------
 myGroup1   | M1             |        12016 | f                      |                |                        29 | 
 myGroup2   | M1             |        12017 | f                      |                |                        41 | 
 myGroup1   | M2             |        12100 | f                      |                |                        11 | 
 myGroup1   | M3             |        12101 | f                      | Third mark set |                           | 
 myGroup2   | M2             |        12200 | f                      |                |                         8 | 
 myGroup2   | M3             |        12201 | f                      |                |                           | 
(6 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
 sequ_schema |     sequ_name     | sequ_time_id | sequ_last_val | sequ_is_called 
-------------+-------------------+--------------+---------------+----------------
 myschema1   | myTbl3_col31_seq  |        12016 |            11 | f
 myschema1   | mytbl2b_col20_seq |        12016 |             3 | f
 myschema2   | myTbl3_col31_seq  |        12017 |            10 | t
 myschema2   | myseq1            |        12017 |          1000 | f
 myschema1   | myTbl3_col31_seq  |        12100 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12100 |             4 | t
 myschema1   | myTbl3_col31_seq  |        12101 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12101 |             4 | t
 myschema2   | myTbl3_col31_seq  |        12200 |            20 | t
 myschema2   | myseq1            |        12200 |          1000 | t
 myschema2   | myTbl3_col31_seq  |        12201 |            20 | t
 myschema2   | myseq1            |        12201 |          1003 | t
(12 rows)

select tbl_schema, tbl_name, tbl_time_id, tbl_log_seq_last_val from emaj.emaj_table order by tbl_time_id, tbl_schema, tbl_name;
 tbl_schema | tbl_name | tbl_time_id | tbl_log_seq_last_val 
------------+----------+-------------+----------------------
 myschema1  | myTbl3   |       12016 |                    0
 myschema1  | mytbl1   |       12016 |                    0
 myschema1  | mytbl2   |       12016 |                    0
 myschema1  | mytbl2b  |       12016 |                    0
 myschema1  | mytbl4   |       12016 |                    0
 myschema2  | myTbl3   |       12017 |                    0
 myschema2  | mytbl1   |       12017 |                    0
 myschema2  | mytbl2   |       12017 |                    0
 myschema2  | mytbl4   |       12017 |                    0
 myschema2  | mytbl5   |       12017 |                    0
 myschema2  | mytbl6   |       12017 |                    0
 myschema1  | myTbl3   |       12100 |                   10
 myschema1  | mytbl1   |       12100 |                   15
 myschema1  | mytbl2   |       12100 |                    2
 myschema1  | mytbl2b  |       12100 |                    2
 myschema1  | mytbl4   |       12100 |                    0
 myschema1  | myTbl3   |       12101 |                   10
 myschema1  | mytbl1   |       12101 |                   18
 myschema1  | mytbl2   |       12101 |                    2
 myschema1  | mytbl2b  |       12101 |                    2
 myschema1  | mytbl4   |       12101 |                    8
 myschema2  | myTbl3   |       12200 |                   10
 myschema2  | mytbl1   |       12200 |                   15
 myschema2  | mytbl2   |       12200 |                    2
 myschema2  | mytbl4   |       12200 |                    0
 myschema2  | mytbl5   |       12200 |                    3
 myschema2  | mytbl6   |       12200 |                   11
 myschema2  | myTbl3   |       12201 |                   10
 myschema2  | mytbl1   |       12201 |                   15
 myschema2  | mytbl2   |       12201 |                    2
 myschema2  | mytbl4   |       12201 |                    4
 myschema2  | mytbl5   |       12201 |                    4
 myschema2  | mytbl6   |       12201 |                   14
(33 rows)

select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 12200 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
   12200 |           12200041 | M
   12201 |           12200049 | M
(2 rows)

select hist_function, hist_event, hist_object,
       regexp_replace(regexp_replace(regexp_replace(hist_wording,
            E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),
            E'\\d\\d\\d\\d/\\d\\d\\/\\d\\d\\ \\d\\d\\:\\d\\d:\\d\\d .*?\\)','<timestamp>)','g'),
            E'\\[.+\\]','(timestamp)','g'), 
       hist_user
  from emaj.emaj_hist where hist_id >= 12200 order by hist_id;
 hist_function  |   hist_event   | hist_object |         regexp_replace         | hist_user 
----------------+----------------+-------------+--------------------------------+-----------
 SET_MARK_GROUP | BEGIN          | myGroup2    |                                | postgres
 LOCK_GROUP     | BEGIN          | myGroup2    |                                | postgres
 LOCK_GROUP     | END            | myGroup2    | 6 tables locked, 0 deadlock(s) | postgres
 SET_MARK_GROUP | TIME STAMP SET | 12200       |                                | postgres
 SET_MARK_GROUP | END            | myGroup2    | M2                             | postgres
 SET_MARK_GROUP | BEGIN          | myGroup2    |                                | postgres
 LOCK_GROUP     | BEGIN          | myGroup2    |                                | postgres
 LOCK_GROUP     | END            | myGroup2    | 6 tables locked, 0 deadlock(s) | postgres
 SET_MARK_GROUP | TIME STAMP SET | 12201       |                                | postgres
 SET_MARK_GROUP | END            | myGroup2    | M3                             | postgres
(10 rows)

-- user tables
reset role;
select * from mySchema2.myTbl1 order by col11,col12;
 col11 |   col12    | col13 
-------+------------+-------
     1 | ABC        | \x1c
     2 | ABC        | \x1c
     3 | ABC        | \x1c
     4 | ABC        | \x0c
     5 | ABC        | \x0c
     6 | ABC        | \x0c
     7 | ABC        | \x0c
     8 | ABC        | \x0c
     9 | ABC        | \x0c
    10 | ABC        | \x0c
(10 rows)

select * from mySchema2.myTbl2 order by col21;
 col21 | col22 |   col23    
-------+-------+------------
     1 | ABC   | 01-01-2010
     2 | DEF   | 
(2 rows)

select col31,col33 from mySchema2."myTbl3" order by col31;
 col31 | col33 
-------+-------
    11 | 10.00
    12 | 10.00
    13 | 10.00
    14 | 10.00
    15 | 10.00
    16 | 10.00
    17 | 10.00
    18 | 10.00
    19 | 10.00
    20 | 10.00
(10 rows)

select * from mySchema2.myTbl4 order by col41;
 col41 | col42 | col43 | col44 |   col45    
-------+-------+-------+-------+------------
     1 | FK... |     2 |     1 | ABC       
     2 | FK... |     2 |     1 | ABC       
(2 rows)

select * from mySchema2.myTbl5 order by col51;
 col51 |     col52     |  col53  |          col54          |          col55          | col56 |          col57          |          col58          | col59 
-------+---------------+---------+-------------------------+-------------------------+-------+-------------------------+-------------------------+-------
     1 | {abc,def,ghi} | {1,2,3} | {11-28-2010,12-03-2010} | {"id":1001, "c2":"def"} |       | {"id":1001, "c3":"ghi"} | [01-01-2020,01-01-2021) | 
(1 row)

select * from mySchema2.myTbl6 order by col61;
 col61 |  col62  |     col63     |   col64   |         col65         |     col66      |   col67   |     col68     |   col69   
-------+---------+---------------+-----------+-----------------------+----------------+-----------+---------------+-----------
     0 |         |               |           |                       |                |           |               | 
     4 | (4,1.3) | (4.2,1),(4,0) | <(5,5),4> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | EXECUTING | (4,"(4,1.3)") | (4.1,0.5)
     5 | (5,1.3) | (5.2,1),(5,0) | <(5,5),5> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | EXECUTING | (5,"(5,1.3)") | (5.1,0.5)
     6 | (6,1.3) | (6.2,1),(6,0) | <(5,5),6> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | EXECUTING | (6,"(6,1.3)") | (6.1,0.5)
     7 | (7,1.3) | (7.2,1),(7,0) | <(5,5),7> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | EXECUTING | (7,"(7,1.3)") | (7.1,0.5)
     8 | (8,1.3) | (8.2,1),(8,0) | <(5,5),8> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | EXECUTING | (8,"(8,1.3)") | (8.1,0.5)
(6 rows)

-- log tables
set role emaj_regression_tests_adm_user1;
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid 
-------+------------+-------+-----------+------------+----------
     1 | ABC        | \x0c  | INS       | NEW        | 12200001
     2 | ABC        | \x0c  | INS       | NEW        | 12200002
     3 | ABC        | \x0c  | INS       | NEW        | 12200003
     4 | ABC        | \x0c  | INS       | NEW        | 12200004
     5 | ABC        | \x0c  | INS       | NEW        | 12200005
     6 | ABC        | \x0c  | INS       | NEW        | 12200006
     7 | ABC        | \x0c  | INS       | NEW        | 12200007
     8 | ABC        | \x0c  | INS       | NEW        | 12200008
     9 | ABC        | \x0c  | INS       | NEW        | 12200009
    10 | ABC        | \x0c  | INS       | NEW        | 12200010
    11 | ABC        | \x0c  | INS       | NEW        | 12200011
     1 | ABC        | \x0c  | UPD       | OLD        | 12200012
     1 | ABC        | \x1c  | UPD       | NEW        | 12200012
     2 | ABC        | \x0c  | UPD       | OLD        | 12200013
     2 | ABC        | \x1c  | UPD       | NEW        | 12200013
     3 | ABC        | \x0c  | UPD       | OLD        | 12200014
     3 | ABC        | \x1c  | UPD       | NEW        | 12200014
    11 | ABC        | \x0c  | DEL       | OLD        | 12200016
(18 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 |   col23    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+------------+-----------+------------+----------
     1 | ABC   | 01-01-2010 | INS       | NEW        | 12200015
     2 | DEF   |            | INS       | NEW        | 12200017
(2 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema2."myTbl3_log" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
    11 | 10.00 | INS       | NEW        | 12200018
    12 | 10.00 | INS       | NEW        | 12200019
    13 | 10.00 | INS       | NEW        | 12200020
    14 | 10.00 | INS       | NEW        | 12200021
    15 | 10.00 | INS       | NEW        | 12200022
    16 | 10.00 | INS       | NEW        | 12200023
    17 | 10.00 | INS       | NEW        | 12200024
    18 | 10.00 | INS       | NEW        | 12200025
    19 | 10.00 | INS       | NEW        | 12200026
    20 | 10.00 | INS       | NEW        | 12200027
(10 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema2.mytbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 |   col45    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+------------+-----------+------------+----------
     1 | FK... |     1 |     1 | ABC        | INS       | NEW        | 12200042
     2 | FK... |     1 |     1 | ABC        | INS       | NEW        | 12200043
     1 | FK... |     1 |     1 | ABC        | UPD       | OLD        | 12200044
     1 | FK... |     2 |     1 | ABC        | UPD       | NEW        | 12200044
     2 | FK... |     1 |     1 | ABC        | UPD       | OLD        | 12200045
     2 | FK... |     2 |     1 | ABC        | UPD       | NEW        | 12200045
(6 rows)

select col51, col52, col53, col54, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema2.mytbl5_log order by emaj_gid, emaj_tuple desc;
 col51 |     col52     |  col53  |          col54          | emaj_verb | emaj_tuple | emaj_gid 
-------+---------------+---------+-------------------------+-----------+------------+----------
     1 | {abc,def,ghi} | {1,2,3} |                         | INS       | NEW        | 12200028
     2 | {abc,def,ghi} | {3,4,5} | {02-01-2000,02-28-2000} | INS       | NEW        | 12200029
     1 | {abc,def,ghi} | {1,2,3} |                         | UPD       | OLD        | 12200030
     1 | {abc,def,ghi} | {1,2,3} | {11-28-2010,12-03-2010} | UPD       | NEW        | 12200030
     2 | {abc,def,ghi} | {3,4,5} | {02-01-2000,02-28-2000} | DEL       | OLD        | 12200046
(5 rows)

select col61, col62, col63, col64, col65, col66, col67, col68, col69, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl6_log order by emaj_gid, emaj_tuple desc;
 col61 |  col62  |     col63     |    col64    |         col65         |     col66      |   col67   |     col68     |   col69   | emaj_verb | emaj_tuple | emaj_gid 
-------+---------+---------------+-------------+-----------------------+----------------+-----------+---------------+-----------+-----------+------------+----------
     1 | (1,1.3) | (1.2,1),(1,0) | <(5,5),1>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | EXECUTING | (1,"(1,1.3)") | (1.1,0.5) | INS       | NEW        | 12200031
     2 | (2,1.3) | (2.2,1),(2,0) | <(5,5),2>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | EXECUTING | (2,"(2,1.3)") | (2.1,0.5) | INS       | NEW        | 12200032
     3 | (3,1.3) | (3.2,1),(3,0) | <(5,5),3>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | EXECUTING | (3,"(3,1.3)") | (3.1,0.5) | INS       | NEW        | 12200033
     4 | (4,1.3) | (4.2,1),(4,0) | <(5,5),4>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | EXECUTING | (4,"(4,1.3)") | (4.1,0.5) | INS       | NEW        | 12200034
     5 | (5,1.3) | (5.2,1),(5,0) | <(5,5),5>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | EXECUTING | (5,"(5,1.3)") | (5.1,0.5) | INS       | NEW        | 12200035
     6 | (6,1.3) | (6.2,1),(6,0) | <(5,5),6>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | EXECUTING | (6,"(6,1.3)") | (6.1,0.5) | INS       | NEW        | 12200036
     7 | (7,1.3) | (7.2,1),(7,0) | <(5,5),7>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | EXECUTING | (7,"(7,1.3)") | (7.1,0.5) | INS       | NEW        | 12200037
     8 | (8,1.3) | (8.2,1),(8,0) | <(5,5),8>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | EXECUTING | (8,"(8,1.3)") | (8.1,0.5) | INS       | NEW        | 12200038
     1 | (1,1.3) | (1.2,1),(1,0) | <(5,5),1>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | EXECUTING | (1,"(1,1.3)") | (1.1,0.5) | UPD       | OLD        | 12200039
     1 | (1,1.3) | (1.2,1),(1,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | COMPLETED | (1,"(1,1.3)") | (1.1,0.5) | UPD       | NEW        | 12200039
     2 | (2,1.3) | (2.2,1),(2,0) | <(5,5),2>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | EXECUTING | (2,"(2,1.3)") | (2.1,0.5) | UPD       | OLD        | 12200040
     2 | (2,1.3) | (2.2,1),(2,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | COMPLETED | (2,"(2,1.3)") | (2.1,0.5) | UPD       | NEW        | 12200040
     3 | (3,1.3) | (3.2,1),(3,0) | <(5,5),3>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | EXECUTING | (3,"(3,1.3)") | (3.1,0.5) | UPD       | OLD        | 12200041
     3 | (3,1.3) | (3.2,1),(3,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | COMPLETED | (3,"(3,1.3)") | (3.1,0.5) | UPD       | NEW        | 12200041
     1 | (1,1.3) | (1.2,1),(1,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | COMPLETED | (1,"(1,1.3)") | (1.1,0.5) | DEL       | OLD        | 12200047
     2 | (2,1.3) | (2.2,1),(2,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | COMPLETED | (2,"(2,1.3)") | (2.1,0.5) | DEL       | OLD        | 12200048
     3 | (3,1.3) | (3.2,1),(3,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | COMPLETED | (3,"(3,1.3)") | (3.1,0.5) | DEL       | OLD        | 12200049
(17 rows)

-- set sequence restart value
select public.handle_emaj_sequences(12300);
 handle_emaj_sequences 
-----------------------
 
(1 row)

-----------------------------
-- Step 3 : for myGroup2, double logged rollback
-----------------------------
reset role;
analyze mytbl4;
-- rollback with dblink_connect_u not granted
revoke execute on function dblink_connect_u(text,text) from emaj_adm;
set role emaj_regression_tests_adm_user2;
select * from emaj.emaj_logged_rollback_group('myGroup2','M2',false) order by 1,2;
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | 1 / 2 sequences effectively processed.
 Notice        | 3 / 6 tables effectively processed.
 Notice        | Rollback id = 12300.
(3 rows)

select * from emaj.emaj_logged_rollback_group('myGroup2','M3',false) order by 1,2;
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | 1 / 2 sequences effectively processed.
 Notice        | 3 / 6 tables effectively processed.
 Notice        | Rollback id = 12301.
(3 rows)

reset role;
grant execute on function dblink_connect_u(text,text) to emaj_adm;
set role emaj_regression_tests_adm_user1;
-----------------------------
-- Checking step 3
-----------------------------
-- emaj tables
select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_time_id, mark_group;
 mark_group |  regexp_replace  | mark_time_id | mark_is_rlbk_protected |                  mark_comment                  | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------+------------------+--------------+------------------------+------------------------------------------------+---------------------------+------------------------------
 myGroup1   | M1               |        12016 | f                      |                                                |                        29 | 
 myGroup2   | M1               |        12017 | f                      |                                                |                        41 | 
 myGroup1   | M2               |        12100 | f                      |                                                |                        11 | 
 myGroup1   | M3               |        12101 | f                      | Third mark set                                 |                           | 
 myGroup2   | M2               |        12200 | f                      |                                                |                         8 | 
 myGroup2   | M3               |        12201 | f                      |                                                |                         0 | 
 myGroup2   | RLBK_12300_START |        12300 | f                      | Automatically set at rollback to mark M2 start |                         6 | 
 myGroup2   | RLBK_12300_DONE  |        12301 | f                      | Automatically set at rollback to mark M2 end   |                         0 | M2
 myGroup2   | RLBK_12301_START |        12302 | f                      | Automatically set at rollback to mark M3 start |                         6 | 
 myGroup2   | RLBK_12301_DONE  |        12303 | f                      | Automatically set at rollback to mark M3 end   |                           | M3
(10 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
 sequ_schema |     sequ_name     | sequ_time_id | sequ_last_val | sequ_is_called 
-------------+-------------------+--------------+---------------+----------------
 myschema1   | myTbl3_col31_seq  |        12016 |            11 | f
 myschema1   | mytbl2b_col20_seq |        12016 |             3 | f
 myschema2   | myTbl3_col31_seq  |        12017 |            10 | t
 myschema2   | myseq1            |        12017 |          1000 | f
 myschema1   | myTbl3_col31_seq  |        12100 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12100 |             4 | t
 myschema1   | myTbl3_col31_seq  |        12101 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12101 |             4 | t
 myschema2   | myTbl3_col31_seq  |        12200 |            20 | t
 myschema2   | myseq1            |        12200 |          1000 | t
 myschema2   | myTbl3_col31_seq  |        12201 |            20 | t
 myschema2   | myseq1            |        12201 |          1003 | t
 myschema2   | myTbl3_col31_seq  |        12300 |            20 | t
 myschema2   | myseq1            |        12300 |          1003 | t
 myschema2   | myTbl3_col31_seq  |        12301 |            20 | t
 myschema2   | myseq1            |        12301 |          1001 | f
 myschema2   | myTbl3_col31_seq  |        12302 |            20 | t
 myschema2   | myseq1            |        12302 |          1001 | f
 myschema2   | myTbl3_col31_seq  |        12303 |            20 | t
 myschema2   | myseq1            |        12303 |          1004 | f
(20 rows)

select tbl_schema, tbl_name, tbl_time_id, tbl_log_seq_last_val from emaj.emaj_table order by tbl_time_id, tbl_schema, tbl_name;
 tbl_schema | tbl_name | tbl_time_id | tbl_log_seq_last_val 
------------+----------+-------------+----------------------
 myschema1  | myTbl3   |       12016 |                    0
 myschema1  | mytbl1   |       12016 |                    0
 myschema1  | mytbl2   |       12016 |                    0
 myschema1  | mytbl2b  |       12016 |                    0
 myschema1  | mytbl4   |       12016 |                    0
 myschema2  | myTbl3   |       12017 |                    0
 myschema2  | mytbl1   |       12017 |                    0
 myschema2  | mytbl2   |       12017 |                    0
 myschema2  | mytbl4   |       12017 |                    0
 myschema2  | mytbl5   |       12017 |                    0
 myschema2  | mytbl6   |       12017 |                    0
 myschema1  | myTbl3   |       12100 |                   10
 myschema1  | mytbl1   |       12100 |                   15
 myschema1  | mytbl2   |       12100 |                    2
 myschema1  | mytbl2b  |       12100 |                    2
 myschema1  | mytbl4   |       12100 |                    0
 myschema1  | myTbl3   |       12101 |                   10
 myschema1  | mytbl1   |       12101 |                   18
 myschema1  | mytbl2   |       12101 |                    2
 myschema1  | mytbl2b  |       12101 |                    2
 myschema1  | mytbl4   |       12101 |                    8
 myschema2  | myTbl3   |       12200 |                   10
 myschema2  | mytbl1   |       12200 |                   15
 myschema2  | mytbl2   |       12200 |                    2
 myschema2  | mytbl4   |       12200 |                    0
 myschema2  | mytbl5   |       12200 |                    3
 myschema2  | mytbl6   |       12200 |                   11
 myschema2  | myTbl3   |       12201 |                   10
 myschema2  | mytbl1   |       12201 |                   15
 myschema2  | mytbl2   |       12201 |                    2
 myschema2  | mytbl4   |       12201 |                    4
 myschema2  | mytbl5   |       12201 |                    4
 myschema2  | mytbl6   |       12201 |                   14
 myschema2  | myTbl3   |       12300 |                   10
 myschema2  | mytbl1   |       12300 |                   15
 myschema2  | mytbl2   |       12300 |                    2
 myschema2  | mytbl4   |       12300 |                    4
 myschema2  | mytbl5   |       12300 |                    4
 myschema2  | mytbl6   |       12300 |                   14
 myschema2  | myTbl3   |       12301 |                   10
 myschema2  | mytbl1   |       12301 |                   15
 myschema2  | mytbl2   |       12301 |                    2
 myschema2  | mytbl4   |       12301 |                    6
 myschema2  | mytbl5   |       12301 |                    5
 myschema2  | mytbl6   |       12301 |                   17
 myschema2  | myTbl3   |       12302 |                   10
 myschema2  | mytbl1   |       12302 |                   15
 myschema2  | mytbl2   |       12302 |                    2
 myschema2  | mytbl4   |       12302 |                    6
 myschema2  | mytbl5   |       12302 |                    5
 myschema2  | mytbl6   |       12302 |                   17
 myschema2  | myTbl3   |       12303 |                   10
 myschema2  | mytbl1   |       12303 |                   15
 myschema2  | mytbl2   |       12303 |                    2
 myschema2  | mytbl4   |       12303 |                    8
 myschema2  | mytbl5   |       12303 |                    6
 myschema2  | mytbl6   |       12303 |                   20
(57 rows)

select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 12300 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
   12300 |           12300000 | R
   12301 |           12300006 | M
   12302 |           12300006 | R
   12303 |           12300012 | M
(4 rows)

select hist_function, hist_event, hist_object,
       regexp_replace(regexp_replace(regexp_replace(hist_wording,
            E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),
            E'\\d\\d\\d\\d/\\d\\d\\/\\d\\d\\ \\d\\d\\:\\d\\d:\\d\\d .*?\\)','<timestamp>)','g'),
            E'\\[.+\\]','(timestamp)','g'), 
       hist_user
  from emaj.emaj_hist where hist_id >= 12300 order by hist_id;
   hist_function   |   hist_event   |    hist_object    |                     regexp_replace                     | hist_user 
-------------------+----------------+-------------------+--------------------------------------------------------+-----------
 ROLLBACK_GROUP    | BEGIN          | myGroup2          | Logged rollback to mark M2 (timestamp)                 | postgres
 DBLINK_OPEN_CNX   |                | rlbk#1            | Status = -3                                            | postgres
 LOCK_GROUP        | BEGIN          | myGroup2          | Rollback session #1                                    | postgres
 LOCK_GROUP        | END            | myGroup2          | Rollback session #1: 6 tables locked, 0 deadlock(s)    | postgres
 ROLLBACK_GROUP    | TIME STAMP SET | 12300             |                                                        | postgres
 SET_MARK_GROUP    | BEGIN          | myGroup2          | RLBK_12300_START                                       | postgres
 SET_MARK_GROUP    | END            | myGroup2          | RLBK_12300_START                                       | postgres
 ROLLBACK_SEQUENCE |                | myschema2.myseq1  | RESTART 1001 MAXVALUE 2000 CYCLE                       | postgres
 ROLLBACK_TABLE    | BEGIN          | myschema2.mytbl4  | All log rows where emaj_gid > 12200041 and <= 12300000 | postgres
 ROLLBACK_TABLE    | END            | myschema2.mytbl4  | 2 rolled back primary keys                             | postgres
 ROLLBACK_TABLE    | BEGIN          | myschema2.mytbl6  | All log rows where emaj_gid > 12200041 and <= 12300000 | postgres
 ROLLBACK_TABLE    | END            | myschema2.mytbl6  | 3 rolled back primary keys                             | postgres
 ROLLBACK_TABLE    | BEGIN          | myschema2.mytbl5  | All log rows where emaj_gid > 12200041 and <= 12300000 | postgres
 ROLLBACK_TABLE    | END            | myschema2.mytbl5  | 1 rolled back primary keys                             | postgres
 ROLLBACK_GROUP    | TIME STAMP SET | 12301             |                                                        | postgres
 SET_MARK_GROUP    | BEGIN          | myGroup2          | RLBK_12300_DONE                                        | postgres
 SET_MARK_GROUP    | END            | myGroup2          | RLBK_12300_DONE                                        | postgres
 ROLLBACK_GROUP    | NOTICE         | Rollback id 12300 | Rollback id = 12300.                                   | postgres
 ROLLBACK_GROUP    | NOTICE         | Rollback id 12300 | 3 / 6 tables effectively processed.                    | postgres
 ROLLBACK_GROUP    | NOTICE         | Rollback id 12300 | 1 / 2 sequences effectively processed.                 | postgres
 ROLLBACK_GROUP    | END            | myGroup2          | Rollback_id 12300                                      | postgres
 ROLLBACK_GROUP    | BEGIN          | myGroup2          | Logged rollback to mark M3 (timestamp)                 | postgres
 DBLINK_OPEN_CNX   |                | rlbk#1            | Status = -3                                            | postgres
 LOCK_GROUP        | BEGIN          | myGroup2          | Rollback session #1                                    | postgres
 LOCK_GROUP        | END            | myGroup2          | Rollback session #1: 6 tables locked, 0 deadlock(s)    | postgres
 ROLLBACK_GROUP    | TIME STAMP SET | 12302             |                                                        | postgres
 SET_MARK_GROUP    | BEGIN          | myGroup2          | RLBK_12301_START                                       | postgres
 SET_MARK_GROUP    | END            | myGroup2          | RLBK_12301_START                                       | postgres
 ROLLBACK_SEQUENCE |                | myschema2.myseq1  | RESTART 1004 MAXVALUE 9223372036854775807 NO CYCLE     | postgres
 ROLLBACK_TABLE    | BEGIN          | myschema2.mytbl6  | All log rows where emaj_gid > 12200049 and <= 12300006 | postgres
 ROLLBACK_TABLE    | END            | myschema2.mytbl6  | 3 rolled back primary keys                             | postgres
 ROLLBACK_TABLE    | BEGIN          | myschema2.mytbl4  | All log rows where emaj_gid > 12200049 and <= 12300006 | postgres
 ROLLBACK_TABLE    | END            | myschema2.mytbl4  | 2 rolled back primary keys                             | postgres
 ROLLBACK_TABLE    | BEGIN          | myschema2.mytbl5  | All log rows where emaj_gid > 12200049 and <= 12300006 | postgres
 ROLLBACK_TABLE    | END            | myschema2.mytbl5  | 1 rolled back primary keys                             | postgres
 ROLLBACK_GROUP    | TIME STAMP SET | 12303             |                                                        | postgres
 SET_MARK_GROUP    | BEGIN          | myGroup2          | RLBK_12301_DONE                                        | postgres
 SET_MARK_GROUP    | END            | myGroup2          | RLBK_12301_DONE                                        | postgres
 ROLLBACK_GROUP    | NOTICE         | Rollback id 12301 | Rollback id = 12301.                                   | postgres
 ROLLBACK_GROUP    | NOTICE         | Rollback id 12301 | 3 / 6 tables effectively processed.                    | postgres
 ROLLBACK_GROUP    | NOTICE         | Rollback id 12301 | 1 / 2 sequences effectively processed.                 | postgres
 ROLLBACK_GROUP    | END            | myGroup2          | Rollback_id 12301                                      | postgres
(42 rows)

-- user tables
reset role;
select * from mySchema2.myTbl1 order by col11,col12;
 col11 |   col12    | col13 
-------+------------+-------
     1 | ABC        | \x1c
     2 | ABC        | \x1c
     3 | ABC        | \x1c
     4 | ABC        | \x0c
     5 | ABC        | \x0c
     6 | ABC        | \x0c
     7 | ABC        | \x0c
     8 | ABC        | \x0c
     9 | ABC        | \x0c
    10 | ABC        | \x0c
(10 rows)

select * from mySchema2.myTbl2 order by col21;
 col21 | col22 |   col23    
-------+-------+------------
     1 | ABC   | 01-01-2010
     2 | DEF   | 
(2 rows)

select col31,col33 from mySchema2."myTbl3" order by col31;
 col31 | col33 
-------+-------
    11 | 10.00
    12 | 10.00
    13 | 10.00
    14 | 10.00
    15 | 10.00
    16 | 10.00
    17 | 10.00
    18 | 10.00
    19 | 10.00
    20 | 10.00
(10 rows)

select * from mySchema2.myTbl4 order by col41;
 col41 | col42 | col43 | col44 |   col45    
-------+-------+-------+-------+------------
     1 | FK... |     2 |     1 | ABC       
     2 | FK... |     2 |     1 | ABC       
(2 rows)

select * from mySchema2.myTbl5 order by col51;
 col51 |     col52     |  col53  |          col54          |          col55          | col56 |          col57          |          col58          | col59 
-------+---------------+---------+-------------------------+-------------------------+-------+-------------------------+-------------------------+-------
     1 | {abc,def,ghi} | {1,2,3} | {11-28-2010,12-03-2010} | {"id":1001, "c2":"def"} |       | {"id":1001, "c3":"ghi"} | [01-01-2020,01-01-2021) | 
(1 row)

select * from mySchema2.myTbl6 order by col61;
 col61 |  col62  |     col63     |   col64   |         col65         |     col66      |   col67   |     col68     |   col69   
-------+---------+---------------+-----------+-----------------------+----------------+-----------+---------------+-----------
     0 |         |               |           |                       |                |           |               | 
     4 | (4,1.3) | (4.2,1),(4,0) | <(5,5),4> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | EXECUTING | (4,"(4,1.3)") | (4.1,0.5)
     5 | (5,1.3) | (5.2,1),(5,0) | <(5,5),5> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | EXECUTING | (5,"(5,1.3)") | (5.1,0.5)
     6 | (6,1.3) | (6.2,1),(6,0) | <(5,5),6> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | EXECUTING | (6,"(6,1.3)") | (6.1,0.5)
     7 | (7,1.3) | (7.2,1),(7,0) | <(5,5),7> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | EXECUTING | (7,"(7,1.3)") | (7.1,0.5)
     8 | (8,1.3) | (8.2,1),(8,0) | <(5,5),8> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | EXECUTING | (8,"(8,1.3)") | (8.1,0.5)
(6 rows)

-- log tables
set role emaj_regression_tests_adm_user1;
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid 
-------+------------+-------+-----------+------------+----------
     1 | ABC        | \x0c  | INS       | NEW        | 12200001
     2 | ABC        | \x0c  | INS       | NEW        | 12200002
     3 | ABC        | \x0c  | INS       | NEW        | 12200003
     4 | ABC        | \x0c  | INS       | NEW        | 12200004
     5 | ABC        | \x0c  | INS       | NEW        | 12200005
     6 | ABC        | \x0c  | INS       | NEW        | 12200006
     7 | ABC        | \x0c  | INS       | NEW        | 12200007
     8 | ABC        | \x0c  | INS       | NEW        | 12200008
     9 | ABC        | \x0c  | INS       | NEW        | 12200009
    10 | ABC        | \x0c  | INS       | NEW        | 12200010
    11 | ABC        | \x0c  | INS       | NEW        | 12200011
     1 | ABC        | \x0c  | UPD       | OLD        | 12200012
     1 | ABC        | \x1c  | UPD       | NEW        | 12200012
     2 | ABC        | \x0c  | UPD       | OLD        | 12200013
     2 | ABC        | \x1c  | UPD       | NEW        | 12200013
     3 | ABC        | \x0c  | UPD       | OLD        | 12200014
     3 | ABC        | \x1c  | UPD       | NEW        | 12200014
    11 | ABC        | \x0c  | DEL       | OLD        | 12200016
(18 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 |   col23    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+------------+-----------+------------+----------
     1 | ABC   | 01-01-2010 | INS       | NEW        | 12200015
     2 | DEF   |            | INS       | NEW        | 12200017
(2 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema2."myTbl3_log" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
    11 | 10.00 | INS       | NEW        | 12200018
    12 | 10.00 | INS       | NEW        | 12200019
    13 | 10.00 | INS       | NEW        | 12200020
    14 | 10.00 | INS       | NEW        | 12200021
    15 | 10.00 | INS       | NEW        | 12200022
    16 | 10.00 | INS       | NEW        | 12200023
    17 | 10.00 | INS       | NEW        | 12200024
    18 | 10.00 | INS       | NEW        | 12200025
    19 | 10.00 | INS       | NEW        | 12200026
    20 | 10.00 | INS       | NEW        | 12200027
(10 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema2.mytbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 |   col45    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+------------+-----------+------------+----------
     1 | FK... |     1 |     1 | ABC        | INS       | NEW        | 12200042
     2 | FK... |     1 |     1 | ABC        | INS       | NEW        | 12200043
     1 | FK... |     1 |     1 | ABC        | UPD       | OLD        | 12200044
     1 | FK... |     2 |     1 | ABC        | UPD       | NEW        | 12200044
     2 | FK... |     1 |     1 | ABC        | UPD       | OLD        | 12200045
     2 | FK... |     2 |     1 | ABC        | UPD       | NEW        | 12200045
     1 | FK... |     2 |     1 | ABC        | DEL       | OLD        | 12300001
     2 | FK... |     2 |     1 | ABC        | DEL       | OLD        | 12300002
     1 | FK... |     2 |     1 | ABC        | INS       | NEW        | 12300010
     2 | FK... |     2 |     1 | ABC        | INS       | NEW        | 12300011
(10 rows)

select col51, col52, col53, col54, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema2.mytbl5_log order by emaj_gid, emaj_tuple desc;
 col51 |     col52     |  col53  |          col54          | emaj_verb | emaj_tuple | emaj_gid 
-------+---------------+---------+-------------------------+-----------+------------+----------
     1 | {abc,def,ghi} | {1,2,3} |                         | INS       | NEW        | 12200028
     2 | {abc,def,ghi} | {3,4,5} | {02-01-2000,02-28-2000} | INS       | NEW        | 12200029
     1 | {abc,def,ghi} | {1,2,3} |                         | UPD       | OLD        | 12200030
     1 | {abc,def,ghi} | {1,2,3} | {11-28-2010,12-03-2010} | UPD       | NEW        | 12200030
     2 | {abc,def,ghi} | {3,4,5} | {02-01-2000,02-28-2000} | DEL       | OLD        | 12200046
     2 | {abc,def,ghi} | {3,4,5} | {02-01-2000,02-28-2000} | INS       | NEW        | 12300006
     2 | {abc,def,ghi} | {3,4,5} | {02-01-2000,02-28-2000} | DEL       | OLD        | 12300012
(7 rows)

select col61, col62, col63, col64, col65, col66, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl6_log order by emaj_gid, emaj_tuple desc;
 col61 |  col62  |     col63     |    col64    |         col65         |     col66      | emaj_verb | emaj_tuple | emaj_gid 
-------+---------+---------------+-------------+-----------------------+----------------+-----------+------------+----------
     1 | (1,1.3) | (1.2,1),(1,0) | <(5,5),1>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        | 12200031
     2 | (2,1.3) | (2.2,1),(2,0) | <(5,5),2>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        | 12200032
     3 | (3,1.3) | (3.2,1),(3,0) | <(5,5),3>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        | 12200033
     4 | (4,1.3) | (4.2,1),(4,0) | <(5,5),4>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        | 12200034
     5 | (5,1.3) | (5.2,1),(5,0) | <(5,5),5>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        | 12200035
     6 | (6,1.3) | (6.2,1),(6,0) | <(5,5),6>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        | 12200036
     7 | (7,1.3) | (7.2,1),(7,0) | <(5,5),7>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        | 12200037
     8 | (8,1.3) | (8.2,1),(8,0) | <(5,5),8>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        | 12200038
     1 | (1,1.3) | (1.2,1),(1,0) | <(5,5),1>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | UPD       | OLD        | 12200039
     1 | (1,1.3) | (1.2,1),(1,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | UPD       | NEW        | 12200039
     2 | (2,1.3) | (2.2,1),(2,0) | <(5,5),2>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | UPD       | OLD        | 12200040
     2 | (2,1.3) | (2.2,1),(2,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | UPD       | NEW        | 12200040
     3 | (3,1.3) | (3.2,1),(3,0) | <(5,5),3>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | UPD       | OLD        | 12200041
     3 | (3,1.3) | (3.2,1),(3,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | UPD       | NEW        | 12200041
     1 | (1,1.3) | (1.2,1),(1,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        | 12200047
     2 | (2,1.3) | (2.2,1),(2,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        | 12200048
     3 | (3,1.3) | (3.2,1),(3,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        | 12200049
     1 | (1,1.3) | (1.2,1),(1,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | INS       | NEW        | 12300003
     2 | (2,1.3) | (2.2,1),(2,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | INS       | NEW        | 12300004
     3 | (3,1.3) | (3.2,1),(3,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | INS       | NEW        | 12300005
     1 | (1,1.3) | (1.2,1),(1,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        | 12300007
     2 | (2,1.3) | (2.2,1),(2,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        | 12300008
     3 | (3,1.3) | (3.2,1),(3,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        | 12300009
(23 rows)

-- set sequence restart value
select public.handle_emaj_sequences(12400);
 handle_emaj_sequences 
-----------------------
 
(1 row)

-----------------------------
-- Step 4 : for myGroup1, rollback then update tables then set 3 marks
-----------------------------
select * from emaj.emaj_rollback_group('myGroup1','M2',false) order by 1,2;
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | 0 / 2 sequences effectively processed.
 Notice        | 2 / 5 tables effectively processed.
 Notice        | Rollback id = 12400.
(3 rows)

--
reset role;
set search_path=public,myschema1;
insert into myTbl1 select i, 'DEF', E'\\000'::bytea from generate_series (100,110) as i;
insert into myTbl2 values (3,'GHI','2010-01-02');
delete from myTbl1 where col11 = 1;
--
set role emaj_regression_tests_adm_user1;
select emaj.emaj_set_mark_group('myGroup1','M4');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

--
reset role;
update "myTbl3" set col33 = col33 / 2;
--
set role emaj_regression_tests_adm_user1;
select emaj.emaj_set_mark_group('myGroup1','M5');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

--
reset role;
update myTbl1 set col11 = 99 where col11 = 1;
--
set role emaj_regression_tests_adm_user1;
select emaj.emaj_set_mark_group('myGroup1','M6');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

-----------------------------
-- Checking step 4
-----------------------------
-- emaj tables
select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_time_id, mark_group;
 mark_group |  regexp_replace  | mark_time_id | mark_is_rlbk_protected |                  mark_comment                  | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------+------------------+--------------+------------------------+------------------------------------------------+---------------------------+------------------------------
 myGroup1   | M1               |        12016 | f                      |                                                |                        29 | 
 myGroup2   | M1               |        12017 | f                      |                                                |                        41 | 
 myGroup1   | M2               |        12100 | f                      |                                                |                        14 | 
 myGroup2   | M2               |        12200 | f                      |                                                |                         8 | 
 myGroup2   | M3               |        12201 | f                      |                                                |                         0 | 
 myGroup2   | RLBK_12300_START |        12300 | f                      | Automatically set at rollback to mark M2 start |                         6 | 
 myGroup2   | RLBK_12300_DONE  |        12301 | f                      | Automatically set at rollback to mark M2 end   |                         0 | M2
 myGroup2   | RLBK_12301_START |        12302 | f                      | Automatically set at rollback to mark M3 start |                         6 | 
 myGroup2   | RLBK_12301_DONE  |        12303 | f                      | Automatically set at rollback to mark M3 end   |                           | M3
 myGroup1   | M4               |        12401 | f                      |                                                |                        10 | 
 myGroup1   | M5               |        12402 | f                      |                                                |                         0 | 
 myGroup1   | M6               |        12403 | f                      |                                                |                           | 
(12 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
 sequ_schema |     sequ_name     | sequ_time_id | sequ_last_val | sequ_is_called 
-------------+-------------------+--------------+---------------+----------------
 myschema1   | myTbl3_col31_seq  |        12016 |            11 | f
 myschema1   | mytbl2b_col20_seq |        12016 |             3 | f
 myschema2   | myTbl3_col31_seq  |        12017 |            10 | t
 myschema2   | myseq1            |        12017 |          1000 | f
 myschema1   | myTbl3_col31_seq  |        12100 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12100 |             4 | t
 myschema2   | myTbl3_col31_seq  |        12200 |            20 | t
 myschema2   | myseq1            |        12200 |          1000 | t
 myschema2   | myTbl3_col31_seq  |        12201 |            20 | t
 myschema2   | myseq1            |        12201 |          1003 | t
 myschema2   | myTbl3_col31_seq  |        12300 |            20 | t
 myschema2   | myseq1            |        12300 |          1003 | t
 myschema2   | myTbl3_col31_seq  |        12301 |            20 | t
 myschema2   | myseq1            |        12301 |          1001 | f
 myschema2   | myTbl3_col31_seq  |        12302 |            20 | t
 myschema2   | myseq1            |        12302 |          1001 | f
 myschema2   | myTbl3_col31_seq  |        12303 |            20 | t
 myschema2   | myseq1            |        12303 |          1004 | f
 myschema1   | myTbl3_col31_seq  |        12401 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12401 |             5 | t
 myschema1   | myTbl3_col31_seq  |        12402 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12402 |             5 | t
 myschema1   | myTbl3_col31_seq  |        12403 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12403 |             5 | t
(24 rows)

select tbl_schema, tbl_name, tbl_time_id, tbl_log_seq_last_val from emaj.emaj_table order by tbl_time_id, tbl_schema, tbl_name;
 tbl_schema | tbl_name | tbl_time_id | tbl_log_seq_last_val 
------------+----------+-------------+----------------------
 myschema1  | myTbl3   |       12016 |                    0
 myschema1  | mytbl1   |       12016 |                    0
 myschema1  | mytbl2   |       12016 |                    0
 myschema1  | mytbl2b  |       12016 |                    0
 myschema1  | mytbl4   |       12016 |                    0
 myschema2  | myTbl3   |       12017 |                    0
 myschema2  | mytbl1   |       12017 |                    0
 myschema2  | mytbl2   |       12017 |                    0
 myschema2  | mytbl4   |       12017 |                    0
 myschema2  | mytbl5   |       12017 |                    0
 myschema2  | mytbl6   |       12017 |                    0
 myschema1  | myTbl3   |       12100 |                   10
 myschema1  | mytbl1   |       12100 |                   15
 myschema1  | mytbl2   |       12100 |                    2
 myschema1  | mytbl2b  |       12100 |                    2
 myschema1  | mytbl4   |       12100 |                    0
 myschema2  | myTbl3   |       12200 |                   10
 myschema2  | mytbl1   |       12200 |                   15
 myschema2  | mytbl2   |       12200 |                    2
 myschema2  | mytbl4   |       12200 |                    0
 myschema2  | mytbl5   |       12200 |                    3
 myschema2  | mytbl6   |       12200 |                   11
 myschema2  | myTbl3   |       12201 |                   10
 myschema2  | mytbl1   |       12201 |                   15
 myschema2  | mytbl2   |       12201 |                    2
 myschema2  | mytbl4   |       12201 |                    4
 myschema2  | mytbl5   |       12201 |                    4
 myschema2  | mytbl6   |       12201 |                   14
 myschema2  | myTbl3   |       12300 |                   10
 myschema2  | mytbl1   |       12300 |                   15
 myschema2  | mytbl2   |       12300 |                    2
 myschema2  | mytbl4   |       12300 |                    4
 myschema2  | mytbl5   |       12300 |                    4
 myschema2  | mytbl6   |       12300 |                   14
 myschema2  | myTbl3   |       12301 |                   10
 myschema2  | mytbl1   |       12301 |                   15
 myschema2  | mytbl2   |       12301 |                    2
 myschema2  | mytbl4   |       12301 |                    6
 myschema2  | mytbl5   |       12301 |                    5
 myschema2  | mytbl6   |       12301 |                   17
 myschema2  | myTbl3   |       12302 |                   10
 myschema2  | mytbl1   |       12302 |                   15
 myschema2  | mytbl2   |       12302 |                    2
 myschema2  | mytbl4   |       12302 |                    6
 myschema2  | mytbl5   |       12302 |                    5
 myschema2  | mytbl6   |       12302 |                   17
 myschema2  | myTbl3   |       12303 |                   10
 myschema2  | mytbl1   |       12303 |                   15
 myschema2  | mytbl2   |       12303 |                    2
 myschema2  | mytbl4   |       12303 |                    8
 myschema2  | mytbl5   |       12303 |                    6
 myschema2  | mytbl6   |       12303 |                   20
 myschema1  | myTbl3   |       12401 |                   10
 myschema1  | mytbl1   |       12401 |                   30
 myschema1  | mytbl2   |       12401 |                    3
 myschema1  | mytbl2b  |       12401 |                    3
 myschema1  | mytbl4   |       12401 |                    8
 myschema1  | myTbl3   |       12402 |                   20
 myschema1  | mytbl1   |       12402 |                   30
 myschema1  | mytbl2   |       12402 |                    3
 myschema1  | mytbl2b  |       12402 |                    3
 myschema1  | mytbl4   |       12402 |                    8
 myschema1  | myTbl3   |       12403 |                   20
 myschema1  | mytbl1   |       12403 |                   30
 myschema1  | mytbl2   |       12403 |                    3
 myschema1  | mytbl2b  |       12403 |                    3
 myschema1  | mytbl4   |       12403 |                    8
(67 rows)

select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 12400 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
   12400 |           12400000 | R
   12401 |           12400014 | M
   12402 |           12400024 | M
   12403 |           12400024 | M
(4 rows)

select hist_function, hist_event, hist_object,
       regexp_replace(regexp_replace(regexp_replace(hist_wording,
            E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),
            E'\\d\\d\\d\\d/\\d\\d\\/\\d\\d\\ \\d\\d\\:\\d\\d:\\d\\d .*?\\)','<timestamp>)','g'),
            E'\\[.+\\]','(timestamp)','g'), 
       hist_user
  from emaj.emaj_hist where hist_id >= 12400 order by hist_id;
   hist_function    |   hist_event   |    hist_object    |                     regexp_replace                     | hist_user 
--------------------+----------------+-------------------+--------------------------------------------------------+-----------
 ROLLBACK_GROUP     | BEGIN          | myGroup1          | Unlogged rollback to mark M2 (timestamp)               | postgres
 DBLINK_OPEN_CNX    |                | rlbk#1            | Status = 1                                             | postgres
 LOCK_GROUP         | BEGIN          | myGroup1          | Rollback session #1                                    | postgres
 LOCK_GROUP         | END            | myGroup1          | Rollback session #1: 5 tables locked, 0 deadlock(s)    | postgres
 ROLLBACK_GROUP     | TIME STAMP SET | 12400             |                                                        | postgres
 ROLLBACK_TABLE     | BEGIN          | myschema1.mytbl1  | All log rows where emaj_gid > 12100029 and <= 12400000 | postgres
 ROLLBACK_TABLE     | END            | myschema1.mytbl1  | 5 rolled back primary keys                             | postgres
 ROLLBACK_TABLE     | BEGIN          | myschema1.mytbl4  | All log rows where emaj_gid > 12100029 and <= 12400000 | postgres
 ROLLBACK_TABLE     | END            | myschema1.mytbl4  | 5 rolled back primary keys                             | postgres
 ROLLBACK_GROUP     | MARK DELETED   | myGroup1          | mark M3 is deleted                                     | postgres
 ROLLBACK_GROUP     | NOTICE         | Rollback id 12400 | Rollback id = 12400.                                   | postgres
 ROLLBACK_GROUP     | NOTICE         | Rollback id 12400 | 2 / 5 tables effectively processed.                    | postgres
 ROLLBACK_GROUP     | NOTICE         | Rollback id 12400 | 0 / 2 sequences effectively processed.                 | postgres
 DBLINK_CLOSE_CNX   |                | rlbk#1            |                                                        | postgres
 ROLLBACK_GROUP     | END            | myGroup1          | Rollback_id 12400                                      | postgres
 SET_MARK_GROUP     | BEGIN          | myGroup1          |                                                        | postgres
 LOCK_GROUP         | BEGIN          | myGroup1          |                                                        | postgres
 LOCK_GROUP         | END            | myGroup1          | 5 tables locked, 0 deadlock(s)                         | postgres
 SET_MARK_GROUP     | TIME STAMP SET | 12401             |                                                        | postgres
 CLEANUP_RLBK_STATE |                | Rollback id 12400 | set to COMMITTED                                       | postgres
 SET_MARK_GROUP     | END            | myGroup1          | M4                                                     | postgres
 SET_MARK_GROUP     | BEGIN          | myGroup1          |                                                        | postgres
 LOCK_GROUP         | BEGIN          | myGroup1          |                                                        | postgres
 LOCK_GROUP         | END            | myGroup1          | 5 tables locked, 0 deadlock(s)                         | postgres
 SET_MARK_GROUP     | TIME STAMP SET | 12402             |                                                        | postgres
 SET_MARK_GROUP     | END            | myGroup1          | M5                                                     | postgres
 SET_MARK_GROUP     | BEGIN          | myGroup1          |                                                        | postgres
 LOCK_GROUP         | BEGIN          | myGroup1          |                                                        | postgres
 LOCK_GROUP         | END            | myGroup1          | 5 tables locked, 0 deadlock(s)                         | postgres
 SET_MARK_GROUP     | TIME STAMP SET | 12403             |                                                        | postgres
 SET_MARK_GROUP     | END            | myGroup1          | M6                                                     | postgres
(31 rows)

-- user tables
reset role;
select * from mySchema1.myTbl1 order by col11,col12;
 col11 |   col12    | col13 
-------+------------+-------
     2 | ABC        | \x1c
     3 | ABC        | \x1c
     4 | ABC        | \x0c
     5 | ABC        | \x0c
     6 | ABC        | \x0c
     7 | ABC        | \x0c
     8 | ABC        | \x0c
     9 | ABC        | \x0c
    10 | ABC        | \x0c
   100 | DEF        | \x00
   101 | DEF        | \x00
   102 | DEF        | \x00
   103 | DEF        | \x00
   104 | DEF        | \x00
   105 | DEF        | \x00
   106 | DEF        | \x00
   107 | DEF        | \x00
   108 | DEF        | \x00
   109 | DEF        | \x00
   110 | DEF        | \x00
(20 rows)

select * from mySchema1.myTbl2 order by col21;
 col21 | col22 |   col23    
-------+-------+------------
     1 | ABC   | 12-31-2010
     2 | DEF   | 
     3 | GHI   | 01-02-2010
(3 rows)

select * from mySchema1.myTbl2b order by col20;
 col20 | col21 |       col22        | col23 
-------+-------+--------------------+-------
     3 |     1 |                  1 | t
     4 |     2 |                0.5 | t
     5 |     3 | 0.3333333333333333 | t
(3 rows)

select col31,col33 from mySchema1."myTbl3" order by col31;
 col31 | col33 
-------+-------
    11 |  5.00
    12 |  5.00
    13 |  5.00
    14 |  5.00
    15 |  5.00
    16 |  5.00
    17 |  5.00
    18 |  5.00
    19 |  5.00
    20 |  5.00
(10 rows)

select * from mySchema1.myTbl4 order by col41;
 col41 | col42 | col43 | col44 | col45 
-------+-------+-------+-------+-------
(0 rows)

-- log tables
set role emaj_regression_tests_adm_user1;
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid 
-------+------------+-------+-----------+------------+----------
     1 | ABC        | \x0c  | INS       | NEW        | 12100001
     2 | ABC        | \x0c  | INS       | NEW        | 12100002
     3 | ABC        | \x0c  | INS       | NEW        | 12100003
     4 | ABC        | \x0c  | INS       | NEW        | 12100004
     5 | ABC        | \x0c  | INS       | NEW        | 12100005
     6 | ABC        | \x0c  | INS       | NEW        | 12100006
     7 | ABC        | \x0c  | INS       | NEW        | 12100007
     8 | ABC        | \x0c  | INS       | NEW        | 12100008
     9 | ABC        | \x0c  | INS       | NEW        | 12100009
    10 | ABC        | \x0c  | INS       | NEW        | 12100010
    11 | ABC        | \x0c  | INS       | NEW        | 12100011
     1 | ABC        | \x0c  | UPD       | OLD        | 12100012
     1 | ABC        | \x1c  | UPD       | NEW        | 12100012
     2 | ABC        | \x0c  | UPD       | OLD        | 12100013
     2 | ABC        | \x1c  | UPD       | NEW        | 12100013
     3 | ABC        | \x0c  | UPD       | OLD        | 12100014
     3 | ABC        | \x1c  | UPD       | NEW        | 12100014
    11 | ABC        | \x0c  | DEL       | OLD        | 12100017
   100 | DEF        | \x00  | INS       | NEW        | 12400001
   101 | DEF        | \x00  | INS       | NEW        | 12400002
   102 | DEF        | \x00  | INS       | NEW        | 12400003
   103 | DEF        | \x00  | INS       | NEW        | 12400004
   104 | DEF        | \x00  | INS       | NEW        | 12400005
   105 | DEF        | \x00  | INS       | NEW        | 12400006
   106 | DEF        | \x00  | INS       | NEW        | 12400007
   107 | DEF        | \x00  | INS       | NEW        | 12400008
   108 | DEF        | \x00  | INS       | NEW        | 12400009
   109 | DEF        | \x00  | INS       | NEW        | 12400010
   110 | DEF        | \x00  | INS       | NEW        | 12400011
     1 | ABC        | \x1c  | DEL       | OLD        | 12400014
(30 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 |   col23    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+------------+-----------+------------+----------
     1 | ABC   | 12-31-2010 | INS       | NEW        | 12100015
     2 | DEF   |            | INS       | NEW        | 12100018
     3 | GHI   | 01-02-2010 | INS       | NEW        | 12400012
(3 rows)

select col20, col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl2b_log order by emaj_gid, emaj_tuple desc;
 col20 | col21 |       col22        | col23 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+--------------------+-------+-----------+------------+----------
     3 |     1 |                  1 | t     | INS       | NEW        | 12100016
     4 |     2 |                0.5 | t     | INS       | NEW        | 12100019
     5 |     3 | 0.3333333333333333 | t     | INS       | NEW        | 12400013
(3 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema1."myTbl3_log" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
    11 | 10.00 | INS       | NEW        | 12100020
    12 | 10.00 | INS       | NEW        | 12100021
    13 | 10.00 | INS       | NEW        | 12100022
    14 | 10.00 | INS       | NEW        | 12100023
    15 | 10.00 | INS       | NEW        | 12100024
    16 | 10.00 | INS       | NEW        | 12100025
    17 | 10.00 | INS       | NEW        | 12100026
    18 | 10.00 | INS       | NEW        | 12100027
    19 | 10.00 | INS       | NEW        | 12100028
    20 | 10.00 | INS       | NEW        | 12100029
    11 | 10.00 | UPD       | OLD        | 12400015
    11 |  5.00 | UPD       | NEW        | 12400015
    12 | 10.00 | UPD       | OLD        | 12400016
    12 |  5.00 | UPD       | NEW        | 12400016
    13 | 10.00 | UPD       | OLD        | 12400017
    13 |  5.00 | UPD       | NEW        | 12400017
    14 | 10.00 | UPD       | OLD        | 12400018
    14 |  5.00 | UPD       | NEW        | 12400018
    15 | 10.00 | UPD       | OLD        | 12400019
    15 |  5.00 | UPD       | NEW        | 12400019
    16 | 10.00 | UPD       | OLD        | 12400020
    16 |  5.00 | UPD       | NEW        | 12400020
    17 | 10.00 | UPD       | OLD        | 12400021
    17 |  5.00 | UPD       | NEW        | 12400021
    18 | 10.00 | UPD       | OLD        | 12400022
    18 |  5.00 | UPD       | NEW        | 12400022
    19 | 10.00 | UPD       | OLD        | 12400023
    19 |  5.00 | UPD       | NEW        | 12400023
    20 | 10.00 | UPD       | OLD        | 12400024
    20 |  5.00 | UPD       | NEW        | 12400024
(30 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 | col45 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+-------+-----------+------------+----------
(0 rows)

-- set sequence restart value
select public.handle_emaj_sequences(12500);
 handle_emaj_sequences 
-----------------------
 
(1 row)

-----------------------------
-- Step 5 : for myGroup2, logged rollback again then unlogged rollback 
-----------------------------
select * from emaj.emaj_logged_rollback_group('myGroup2','M2',false) order by 1,2;
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | 1 / 2 sequences effectively processed.
 Notice        | 3 / 6 tables effectively processed.
 Notice        | Rollback id = 12500.
(3 rows)

--
select * from emaj.emaj_rollback_group('myGroup2','M3',false) order by 1,2;
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | 1 / 2 sequences effectively processed.
 Notice        | 3 / 6 tables effectively processed.
 Notice        | Rollback id = 12501.
(3 rows)

-----------------------------
-- Checking step 5
-----------------------------
-- emaj tables
select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_time_id, mark_group;
 mark_group | regexp_replace | mark_time_id | mark_is_rlbk_protected | mark_comment | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------+----------------+--------------+------------------------+--------------+---------------------------+------------------------------
 myGroup1   | M1             |        12016 | f                      |              |                        29 | 
 myGroup2   | M1             |        12017 | f                      |              |                        41 | 
 myGroup1   | M2             |        12100 | f                      |              |                        14 | 
 myGroup2   | M2             |        12200 | f                      |              |                         8 | 
 myGroup2   | M3             |        12201 | f                      |              |                           | 
 myGroup1   | M4             |        12401 | f                      |              |                        10 | 
 myGroup1   | M5             |        12402 | f                      |              |                         0 | 
 myGroup1   | M6             |        12403 | f                      |              |                           | 
(8 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
 sequ_schema |     sequ_name     | sequ_time_id | sequ_last_val | sequ_is_called 
-------------+-------------------+--------------+---------------+----------------
 myschema1   | myTbl3_col31_seq  |        12016 |            11 | f
 myschema1   | mytbl2b_col20_seq |        12016 |             3 | f
 myschema2   | myTbl3_col31_seq  |        12017 |            10 | t
 myschema2   | myseq1            |        12017 |          1000 | f
 myschema1   | myTbl3_col31_seq  |        12100 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12100 |             4 | t
 myschema2   | myTbl3_col31_seq  |        12200 |            20 | t
 myschema2   | myseq1            |        12200 |          1000 | t
 myschema2   | myTbl3_col31_seq  |        12201 |            20 | t
 myschema2   | myseq1            |        12201 |          1003 | t
 myschema1   | myTbl3_col31_seq  |        12401 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12401 |             5 | t
 myschema1   | myTbl3_col31_seq  |        12402 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12402 |             5 | t
 myschema1   | myTbl3_col31_seq  |        12403 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12403 |             5 | t
(16 rows)

select tbl_schema, tbl_name, tbl_time_id, tbl_log_seq_last_val from emaj.emaj_table order by tbl_time_id, tbl_schema, tbl_name;
 tbl_schema | tbl_name | tbl_time_id | tbl_log_seq_last_val 
------------+----------+-------------+----------------------
 myschema1  | myTbl3   |       12016 |                    0
 myschema1  | mytbl1   |       12016 |                    0
 myschema1  | mytbl2   |       12016 |                    0
 myschema1  | mytbl2b  |       12016 |                    0
 myschema1  | mytbl4   |       12016 |                    0
 myschema2  | myTbl3   |       12017 |                    0
 myschema2  | mytbl1   |       12017 |                    0
 myschema2  | mytbl2   |       12017 |                    0
 myschema2  | mytbl4   |       12017 |                    0
 myschema2  | mytbl5   |       12017 |                    0
 myschema2  | mytbl6   |       12017 |                    0
 myschema1  | myTbl3   |       12100 |                   10
 myschema1  | mytbl1   |       12100 |                   15
 myschema1  | mytbl2   |       12100 |                    2
 myschema1  | mytbl2b  |       12100 |                    2
 myschema1  | mytbl4   |       12100 |                    0
 myschema2  | myTbl3   |       12200 |                   10
 myschema2  | mytbl1   |       12200 |                   15
 myschema2  | mytbl2   |       12200 |                    2
 myschema2  | mytbl4   |       12200 |                    0
 myschema2  | mytbl5   |       12200 |                    3
 myschema2  | mytbl6   |       12200 |                   11
 myschema2  | myTbl3   |       12201 |                   10
 myschema2  | mytbl1   |       12201 |                   15
 myschema2  | mytbl2   |       12201 |                    2
 myschema2  | mytbl4   |       12201 |                    4
 myschema2  | mytbl5   |       12201 |                    4
 myschema2  | mytbl6   |       12201 |                   14
 myschema1  | myTbl3   |       12401 |                   10
 myschema1  | mytbl1   |       12401 |                   30
 myschema1  | mytbl2   |       12401 |                    3
 myschema1  | mytbl2b  |       12401 |                    3
 myschema1  | mytbl4   |       12401 |                    8
 myschema1  | myTbl3   |       12402 |                   20
 myschema1  | mytbl1   |       12402 |                   30
 myschema1  | mytbl2   |       12402 |                    3
 myschema1  | mytbl2b  |       12402 |                    3
 myschema1  | mytbl4   |       12402 |                    8
 myschema1  | myTbl3   |       12403 |                   20
 myschema1  | mytbl1   |       12403 |                   30
 myschema1  | mytbl2   |       12403 |                    3
 myschema1  | mytbl2b  |       12403 |                    3
 myschema1  | mytbl4   |       12403 |                    8
(43 rows)

select sqhl_schema, sqhl_table, sqhl_begin_time_id, sqhl_end_time_id, sqhl_hole_size from emaj.emaj_seq_hole order by 1,2,3;
 sqhl_schema | sqhl_table | sqhl_begin_time_id | sqhl_end_time_id | sqhl_hole_size 
-------------+------------+--------------------+------------------+----------------
 myschema1   | mytbl1     |              12100 |            12400 |              3
 myschema1   | mytbl4     |              12100 |            12400 |              8
 myschema2   | mytbl4     |              12201 |            12502 |              6
 myschema2   | mytbl5     |              12201 |            12502 |              3
 myschema2   | mytbl6     |              12201 |            12502 |              9
(5 rows)

select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 12500 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
   12500 |           12500000 | R
   12501 |           12500006 | M
   12502 |           12500006 | R
(3 rows)

select hist_function, hist_event, hist_object,
       regexp_replace(regexp_replace(regexp_replace(hist_wording,
            E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),
            E'\\d\\d\\d\\d/\\d\\d\\/\\d\\d\\ \\d\\d\\:\\d\\d:\\d\\d .*?\\)','<timestamp>)','g'),
            E'\\[.+\\]','(timestamp)','g'), 
       hist_user
  from emaj.emaj_hist where hist_id >= 12500 order by hist_id;
   hist_function   |   hist_event   |    hist_object    |                     regexp_replace                     | hist_user 
-------------------+----------------+-------------------+--------------------------------------------------------+-----------
 ROLLBACK_GROUP    | BEGIN          | myGroup2          | Logged rollback to mark M2 (timestamp)                 | postgres
 DBLINK_OPEN_CNX   |                | rlbk#1            | Status = 1                                             | postgres
 LOCK_GROUP        | BEGIN          | myGroup2          | Rollback session #1                                    | postgres
 LOCK_GROUP        | END            | myGroup2          | Rollback session #1: 6 tables locked, 0 deadlock(s)    | postgres
 ROLLBACK_GROUP    | TIME STAMP SET | 12500             |                                                        | postgres
 SET_MARK_GROUP    | BEGIN          | myGroup2          | RLBK_12500_START                                       | postgres
 SET_MARK_GROUP    | END            | myGroup2          | RLBK_12500_START                                       | postgres
 ROLLBACK_SEQUENCE |                | myschema2.myseq1  | RESTART 1001 MAXVALUE 2000 CYCLE                       | postgres
 ROLLBACK_TABLE    | BEGIN          | myschema2.mytbl6  | All log rows where emaj_gid > 12200041 and <= 12500000 | postgres
 ROLLBACK_TABLE    | END            | myschema2.mytbl6  | 3 rolled back primary keys                             | postgres
 ROLLBACK_TABLE    | BEGIN          | myschema2.mytbl4  | All log rows where emaj_gid > 12200041 and <= 12500000 | postgres
 ROLLBACK_TABLE    | END            | myschema2.mytbl4  | 2 rolled back primary keys                             | postgres
 ROLLBACK_TABLE    | BEGIN          | myschema2.mytbl5  | All log rows where emaj_gid > 12200041 and <= 12500000 | postgres
 ROLLBACK_TABLE    | END            | myschema2.mytbl5  | 1 rolled back primary keys                             | postgres
 ROLLBACK_GROUP    | TIME STAMP SET | 12501             |                                                        | postgres
 SET_MARK_GROUP    | BEGIN          | myGroup2          | RLBK_12500_DONE                                        | postgres
 SET_MARK_GROUP    | END            | myGroup2          | RLBK_12500_DONE                                        | postgres
 ROLLBACK_GROUP    | NOTICE         | Rollback id 12500 | Rollback id = 12500.                                   | postgres
 ROLLBACK_GROUP    | NOTICE         | Rollback id 12500 | 3 / 6 tables effectively processed.                    | postgres
 ROLLBACK_GROUP    | NOTICE         | Rollback id 12500 | 1 / 2 sequences effectively processed.                 | postgres
 DBLINK_CLOSE_CNX  |                | rlbk#1            |                                                        | postgres
 ROLLBACK_GROUP    | END            | myGroup2          | Rollback_id 12500                                      | postgres
 ROLLBACK_GROUP    | BEGIN          | myGroup2          | Unlogged rollback to mark M3 (timestamp)               | postgres
 DBLINK_OPEN_CNX   |                | rlbk#1            | Status = 1                                             | postgres
 LOCK_GROUP        | BEGIN          | myGroup2          | Rollback session #1                                    | postgres
 LOCK_GROUP        | END            | myGroup2          | Rollback session #1: 6 tables locked, 0 deadlock(s)    | postgres
 ROLLBACK_GROUP    | TIME STAMP SET | 12502             |                                                        | postgres
 ROLLBACK_SEQUENCE |                | myschema2.myseq1  | RESTART 1004 MAXVALUE 9223372036854775807 NO CYCLE     | postgres
 ROLLBACK_TABLE    | BEGIN          | myschema2.mytbl6  | All log rows where emaj_gid > 12200049 and <= 12500006 | postgres
 ROLLBACK_TABLE    | END            | myschema2.mytbl6  | 3 rolled back primary keys                             | postgres
 ROLLBACK_TABLE    | BEGIN          | myschema2.mytbl4  | All log rows where emaj_gid > 12200049 and <= 12500006 | postgres
 ROLLBACK_TABLE    | END            | myschema2.mytbl4  | 2 rolled back primary keys                             | postgres
 ROLLBACK_TABLE    | BEGIN          | myschema2.mytbl5  | All log rows where emaj_gid > 12200049 and <= 12500006 | postgres
 ROLLBACK_TABLE    | END            | myschema2.mytbl5  | 1 rolled back primary keys                             | postgres
 ROLLBACK_GROUP    | MARK DELETED   | myGroup2          | mark RLBK_12300_START is deleted                       | postgres
 ROLLBACK_GROUP    | MARK DELETED   | myGroup2          | mark RLBK_12300_DONE is deleted                        | postgres
 ROLLBACK_GROUP    | MARK DELETED   | myGroup2          | mark RLBK_12301_START is deleted                       | postgres
 ROLLBACK_GROUP    | MARK DELETED   | myGroup2          | mark RLBK_12301_DONE is deleted                        | postgres
 ROLLBACK_GROUP    | MARK DELETED   | myGroup2          | mark RLBK_12500_START is deleted                       | postgres
 ROLLBACK_GROUP    | MARK DELETED   | myGroup2          | mark RLBK_12500_DONE is deleted                        | postgres
 ROLLBACK_GROUP    | NOTICE         | Rollback id 12501 | Rollback id = 12501.                                   | postgres
 ROLLBACK_GROUP    | NOTICE         | Rollback id 12501 | 3 / 6 tables effectively processed.                    | postgres
 ROLLBACK_GROUP    | NOTICE         | Rollback id 12501 | 1 / 2 sequences effectively processed.                 | postgres
 DBLINK_CLOSE_CNX  |                | rlbk#1            |                                                        | postgres
 ROLLBACK_GROUP    | END            | myGroup2          | Rollback_id 12501                                      | postgres
(45 rows)

-- user tables
reset role;
select * from mySchema2.myTbl1 order by col11,col12;
 col11 |   col12    | col13 
-------+------------+-------
     1 | ABC        | \x1c
     2 | ABC        | \x1c
     3 | ABC        | \x1c
     4 | ABC        | \x0c
     5 | ABC        | \x0c
     6 | ABC        | \x0c
     7 | ABC        | \x0c
     8 | ABC        | \x0c
     9 | ABC        | \x0c
    10 | ABC        | \x0c
(10 rows)

select * from mySchema2.myTbl2 order by col21;
 col21 | col22 |   col23    
-------+-------+------------
     1 | ABC   | 01-01-2010
     2 | DEF   | 
(2 rows)

select col31,col33 from mySchema2."myTbl3" order by col31;
 col31 | col33 
-------+-------
    11 | 10.00
    12 | 10.00
    13 | 10.00
    14 | 10.00
    15 | 10.00
    16 | 10.00
    17 | 10.00
    18 | 10.00
    19 | 10.00
    20 | 10.00
(10 rows)

select * from mySchema2.myTbl4 order by col41;
 col41 | col42 | col43 | col44 |   col45    
-------+-------+-------+-------+------------
     1 | FK... |     2 |     1 | ABC       
     2 | FK... |     2 |     1 | ABC       
(2 rows)

select * from mySchema2.myTbl5 order by col51;
 col51 |     col52     |  col53  |          col54          |          col55          | col56 |          col57          |          col58          | col59 
-------+---------------+---------+-------------------------+-------------------------+-------+-------------------------+-------------------------+-------
     1 | {abc,def,ghi} | {1,2,3} | {11-28-2010,12-03-2010} | {"id":1001, "c2":"def"} |       | {"id":1001, "c3":"ghi"} | [01-01-2020,01-01-2021) | 
(1 row)

select * from mySchema2.myTbl6 order by col61;
 col61 |  col62  |     col63     |   col64   |         col65         |     col66      |   col67   |     col68     |   col69   
-------+---------+---------------+-----------+-----------------------+----------------+-----------+---------------+-----------
     0 |         |               |           |                       |                |           |               | 
     4 | (4,1.3) | (4.2,1),(4,0) | <(5,5),4> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | EXECUTING | (4,"(4,1.3)") | (4.1,0.5)
     5 | (5,1.3) | (5.2,1),(5,0) | <(5,5),5> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | EXECUTING | (5,"(5,1.3)") | (5.1,0.5)
     6 | (6,1.3) | (6.2,1),(6,0) | <(5,5),6> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | EXECUTING | (6,"(6,1.3)") | (6.1,0.5)
     7 | (7,1.3) | (7.2,1),(7,0) | <(5,5),7> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | EXECUTING | (7,"(7,1.3)") | (7.1,0.5)
     8 | (8,1.3) | (8.2,1),(8,0) | <(5,5),8> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | EXECUTING | (8,"(8,1.3)") | (8.1,0.5)
(6 rows)

-- log tables
set role emaj_regression_tests_adm_user1;
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid 
-------+------------+-------+-----------+------------+----------
     1 | ABC        | \x0c  | INS       | NEW        | 12200001
     2 | ABC        | \x0c  | INS       | NEW        | 12200002
     3 | ABC        | \x0c  | INS       | NEW        | 12200003
     4 | ABC        | \x0c  | INS       | NEW        | 12200004
     5 | ABC        | \x0c  | INS       | NEW        | 12200005
     6 | ABC        | \x0c  | INS       | NEW        | 12200006
     7 | ABC        | \x0c  | INS       | NEW        | 12200007
     8 | ABC        | \x0c  | INS       | NEW        | 12200008
     9 | ABC        | \x0c  | INS       | NEW        | 12200009
    10 | ABC        | \x0c  | INS       | NEW        | 12200010
    11 | ABC        | \x0c  | INS       | NEW        | 12200011
     1 | ABC        | \x0c  | UPD       | OLD        | 12200012
     1 | ABC        | \x1c  | UPD       | NEW        | 12200012
     2 | ABC        | \x0c  | UPD       | OLD        | 12200013
     2 | ABC        | \x1c  | UPD       | NEW        | 12200013
     3 | ABC        | \x0c  | UPD       | OLD        | 12200014
     3 | ABC        | \x1c  | UPD       | NEW        | 12200014
    11 | ABC        | \x0c  | DEL       | OLD        | 12200016
(18 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 |   col23    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+------------+-----------+------------+----------
     1 | ABC   | 01-01-2010 | INS       | NEW        | 12200015
     2 | DEF   |            | INS       | NEW        | 12200017
(2 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema2."myTbl3_log" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
    11 | 10.00 | INS       | NEW        | 12200018
    12 | 10.00 | INS       | NEW        | 12200019
    13 | 10.00 | INS       | NEW        | 12200020
    14 | 10.00 | INS       | NEW        | 12200021
    15 | 10.00 | INS       | NEW        | 12200022
    16 | 10.00 | INS       | NEW        | 12200023
    17 | 10.00 | INS       | NEW        | 12200024
    18 | 10.00 | INS       | NEW        | 12200025
    19 | 10.00 | INS       | NEW        | 12200026
    20 | 10.00 | INS       | NEW        | 12200027
(10 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema2.mytbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 |   col45    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+------------+-----------+------------+----------
     1 | FK... |     1 |     1 | ABC        | INS       | NEW        | 12200042
     2 | FK... |     1 |     1 | ABC        | INS       | NEW        | 12200043
     1 | FK... |     1 |     1 | ABC        | UPD       | OLD        | 12200044
     1 | FK... |     2 |     1 | ABC        | UPD       | NEW        | 12200044
     2 | FK... |     1 |     1 | ABC        | UPD       | OLD        | 12200045
     2 | FK... |     2 |     1 | ABC        | UPD       | NEW        | 12200045
(6 rows)

select col51, col52, col53, col54, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema2.mytbl5_log order by emaj_gid, emaj_tuple desc;
 col51 |     col52     |  col53  |          col54          | emaj_verb | emaj_tuple | emaj_gid 
-------+---------------+---------+-------------------------+-----------+------------+----------
     1 | {abc,def,ghi} | {1,2,3} |                         | INS       | NEW        | 12200028
     2 | {abc,def,ghi} | {3,4,5} | {02-01-2000,02-28-2000} | INS       | NEW        | 12200029
     1 | {abc,def,ghi} | {1,2,3} |                         | UPD       | OLD        | 12200030
     1 | {abc,def,ghi} | {1,2,3} | {11-28-2010,12-03-2010} | UPD       | NEW        | 12200030
     2 | {abc,def,ghi} | {3,4,5} | {02-01-2000,02-28-2000} | DEL       | OLD        | 12200046
(5 rows)

select col61, col62, col63, col64, col65, col66, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl6_log order by emaj_gid, emaj_tuple desc;
 col61 |  col62  |     col63     |    col64    |         col65         |     col66      | emaj_verb | emaj_tuple | emaj_gid 
-------+---------+---------------+-------------+-----------------------+----------------+-----------+------------+----------
     1 | (1,1.3) | (1.2,1),(1,0) | <(5,5),1>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        | 12200031
     2 | (2,1.3) | (2.2,1),(2,0) | <(5,5),2>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        | 12200032
     3 | (3,1.3) | (3.2,1),(3,0) | <(5,5),3>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        | 12200033
     4 | (4,1.3) | (4.2,1),(4,0) | <(5,5),4>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        | 12200034
     5 | (5,1.3) | (5.2,1),(5,0) | <(5,5),5>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        | 12200035
     6 | (6,1.3) | (6.2,1),(6,0) | <(5,5),6>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        | 12200036
     7 | (7,1.3) | (7.2,1),(7,0) | <(5,5),7>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        | 12200037
     8 | (8,1.3) | (8.2,1),(8,0) | <(5,5),8>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        | 12200038
     1 | (1,1.3) | (1.2,1),(1,0) | <(5,5),1>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | UPD       | OLD        | 12200039
     1 | (1,1.3) | (1.2,1),(1,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | UPD       | NEW        | 12200039
     2 | (2,1.3) | (2.2,1),(2,0) | <(5,5),2>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | UPD       | OLD        | 12200040
     2 | (2,1.3) | (2.2,1),(2,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | UPD       | NEW        | 12200040
     3 | (3,1.3) | (3.2,1),(3,0) | <(5,5),3>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | UPD       | OLD        | 12200041
     3 | (3,1.3) | (3.2,1),(3,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | UPD       | NEW        | 12200041
     1 | (1,1.3) | (1.2,1),(1,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        | 12200047
     2 | (2,1.3) | (2.2,1),(2,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        | 12200048
     3 | (3,1.3) | (3.2,1),(3,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        | 12200049
(17 rows)

-- set sequence restart value
select public.handle_emaj_sequences(12600);
 handle_emaj_sequences 
-----------------------
 
(1 row)

-----------------------------
-- Step 6 : for myGroup1, update tables, rollback, other updates, then logged rollback
-----------------------------
reset role;
set search_path=public,myschema1;
--
insert into myTbl1 values (1, 'Step 6', E'\\000'::bytea);
insert into myTbl4 values (11,'FK...',1,1,'Step 6');
insert into myTbl4 values (12,'FK...',1,1,'Step 6');
--
set role emaj_regression_tests_adm_user1;
select * from emaj.emaj_rollback_group('myGroup1','M5',false) order by 1,2;
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | 0 / 2 sequences effectively processed.
 Notice        | 2 / 5 tables effectively processed.
 Notice        | Rollback id = 12600.
(3 rows)

--
reset role;
insert into myTbl1 values (1, 'Step 6', E'\\001'::bytea);
insert into myTbl4 values (11,'',1,1,'Step 6');
insert into myTbl4 values (12,'',1,1,'Step 6');
--
-- for an equivalent of "select * from emaj.emaj_logged_rollback_group('myGroup1','M4',true,'my comment');"
set role emaj_regression_tests_adm_user1;
select * from emaj._rlbk_async(emaj._rlbk_init(array['myGroup1'], 'M4', true, 1, false, true, 'my comment'), false);
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | Rollback id = 12601.
 Notice        | 3 / 5 tables effectively processed.
 Notice        | 0 / 2 sequences effectively processed.
(3 rows)

select emaj.emaj_comment_rollback(12601,'Updated comment');
 emaj_comment_rollback 
-----------------------
 
(1 row)

-- and check the rollback result
select rlbk_id, rlbk_groups, rlbk_mark, rlbk_mark_time_id, rlbk_time_id, rlbk_is_logged, rlbk_is_alter_group_allowed, rlbk_comment,
       rlbk_nb_session, rlbk_nb_table, rlbk_nb_sequence, rlbk_eff_nb_table, rlbk_eff_nb_sequence, rlbk_status, rlbk_begin_hist_id,
       rlbk_dblink_schema, rlbk_is_dblink_used, rlbk_messages
 from emaj.emaj_rlbk order by rlbk_id desc limit 1;
 rlbk_id | rlbk_groups | rlbk_mark | rlbk_mark_time_id | rlbk_time_id | rlbk_is_logged | rlbk_is_alter_group_allowed |  rlbk_comment   | rlbk_nb_session | rlbk_nb_table | rlbk_nb_sequence | rlbk_eff_nb_table | rlbk_eff_nb_sequence | rlbk_status | rlbk_begin_hist_id | rlbk_dblink_schema | rlbk_is_dblink_used |                                                          rlbk_messages                                                          
---------+-------------+-----------+-------------------+--------------+----------------+-----------------------------+-----------------+-----------------+---------------+------------------+-------------------+----------------------+-------------+--------------------+--------------------+---------------------+---------------------------------------------------------------------------------------------------------------------------------
   12601 | {myGroup1}  | M4        |             12401 |        12601 | t              | t                           | Updated comment |               1 |             5 |                2 |                 3 |                    0 | COMPLETED   |              12615 | public             | t                   | {"Notice: Rollback id = 12601.","Notice: 3 / 5 tables effectively processed.","Notice: 0 / 2 sequences effectively processed."}
(1 row)

-----------------------------
-- Checking step 6
-----------------------------
-- emaj tables
select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_time_id, mark_group;
 mark_group |  regexp_replace  | mark_time_id | mark_is_rlbk_protected |                  mark_comment                  | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------+------------------+--------------+------------------------+------------------------------------------------+---------------------------+------------------------------
 myGroup1   | M1               |        12016 | f                      |                                                |                        29 | 
 myGroup2   | M1               |        12017 | f                      |                                                |                        41 | 
 myGroup1   | M2               |        12100 | f                      |                                                |                        14 | 
 myGroup2   | M2               |        12200 | f                      |                                                |                         8 | 
 myGroup2   | M3               |        12201 | f                      |                                                |                           | 
 myGroup1   | M4               |        12401 | f                      |                                                |                        10 | 
 myGroup1   | M5               |        12402 | f                      |                                                |                         3 | 
 myGroup1   | RLBK_12601_START |        12601 | f                      | Automatically set at rollback to mark M4 start |                        23 | 
 myGroup1   | RLBK_12601_DONE  |        12602 | f                      | Automatically set at rollback to mark M4 end   |                           | M4
(9 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
 sequ_schema |     sequ_name     | sequ_time_id | sequ_last_val | sequ_is_called 
-------------+-------------------+--------------+---------------+----------------
 myschema1   | myTbl3_col31_seq  |        12016 |            11 | f
 myschema1   | mytbl2b_col20_seq |        12016 |             3 | f
 myschema2   | myTbl3_col31_seq  |        12017 |            10 | t
 myschema2   | myseq1            |        12017 |          1000 | f
 myschema1   | myTbl3_col31_seq  |        12100 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12100 |             4 | t
 myschema2   | myTbl3_col31_seq  |        12200 |            20 | t
 myschema2   | myseq1            |        12200 |          1000 | t
 myschema2   | myTbl3_col31_seq  |        12201 |            20 | t
 myschema2   | myseq1            |        12201 |          1003 | t
 myschema1   | myTbl3_col31_seq  |        12401 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12401 |             5 | t
 myschema1   | myTbl3_col31_seq  |        12402 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12402 |             5 | t
 myschema1   | myTbl3_col31_seq  |        12601 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12601 |             5 | t
 myschema1   | myTbl3_col31_seq  |        12602 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12602 |             5 | t
(18 rows)

select tbl_schema, tbl_name, tbl_time_id, tbl_log_seq_last_val from emaj.emaj_table order by tbl_time_id, tbl_schema, tbl_name;
 tbl_schema | tbl_name | tbl_time_id | tbl_log_seq_last_val 
------------+----------+-------------+----------------------
 myschema1  | myTbl3   |       12016 |                    0
 myschema1  | mytbl1   |       12016 |                    0
 myschema1  | mytbl2   |       12016 |                    0
 myschema1  | mytbl2b  |       12016 |                    0
 myschema1  | mytbl4   |       12016 |                    0
 myschema2  | myTbl3   |       12017 |                    0
 myschema2  | mytbl1   |       12017 |                    0
 myschema2  | mytbl2   |       12017 |                    0
 myschema2  | mytbl4   |       12017 |                    0
 myschema2  | mytbl5   |       12017 |                    0
 myschema2  | mytbl6   |       12017 |                    0
 myschema1  | myTbl3   |       12100 |                   10
 myschema1  | mytbl1   |       12100 |                   15
 myschema1  | mytbl2   |       12100 |                    2
 myschema1  | mytbl2b  |       12100 |                    2
 myschema1  | mytbl4   |       12100 |                    0
 myschema2  | myTbl3   |       12200 |                   10
 myschema2  | mytbl1   |       12200 |                   15
 myschema2  | mytbl2   |       12200 |                    2
 myschema2  | mytbl4   |       12200 |                    0
 myschema2  | mytbl5   |       12200 |                    3
 myschema2  | mytbl6   |       12200 |                   11
 myschema2  | myTbl3   |       12201 |                   10
 myschema2  | mytbl1   |       12201 |                   15
 myschema2  | mytbl2   |       12201 |                    2
 myschema2  | mytbl4   |       12201 |                    4
 myschema2  | mytbl5   |       12201 |                    4
 myschema2  | mytbl6   |       12201 |                   14
 myschema1  | myTbl3   |       12401 |                   10
 myschema1  | mytbl1   |       12401 |                   30
 myschema1  | mytbl2   |       12401 |                    3
 myschema1  | mytbl2b  |       12401 |                    3
 myschema1  | mytbl4   |       12401 |                    8
 myschema1  | myTbl3   |       12402 |                   20
 myschema1  | mytbl1   |       12402 |                   30
 myschema1  | mytbl2   |       12402 |                    3
 myschema1  | mytbl2b  |       12402 |                    3
 myschema1  | mytbl4   |       12402 |                    8
 myschema1  | myTbl3   |       12601 |                   20
 myschema1  | mytbl1   |       12601 |                   32
 myschema1  | mytbl2   |       12601 |                    3
 myschema1  | mytbl2b  |       12601 |                    3
 myschema1  | mytbl4   |       12601 |                   12
 myschema1  | myTbl3   |       12602 |                   40
 myschema1  | mytbl1   |       12602 |                   33
 myschema1  | mytbl2   |       12602 |                    3
 myschema1  | mytbl2b  |       12602 |                    3
 myschema1  | mytbl4   |       12602 |                   14
(48 rows)

-- check that mark_log_stat_before_next column is always equal to either NULL or the emaj_log_stat_rows() function's result
-- this should always return 0 row
select * from 
  (select mark_time_id, mark_group, mark_name, mark_log_rows_before_next - 
    (select sum(stat_rows) from emaj.emaj_log_stat_group(mark_group, mark_name, 
      (select mark_name from emaj.emaj_mark m2 where m2.mark_group = m1.mark_group and m2.mark_time_id > m1.mark_time_id order by mark_time_id limit 1))
    ) as checked_stat_rows from emaj.emaj_mark m1 where mark_log_rows_before_next is not null
  ) as t 
  where checked_stat_rows <> 0;  
 mark_time_id | mark_group | mark_name | checked_stat_rows 
--------------+------------+-----------+-------------------
(0 rows)

--
select sqhl_schema, sqhl_table, sqhl_begin_time_id, sqhl_end_time_id, sqhl_hole_size from emaj.emaj_seq_hole order by 1,2,3;
 sqhl_schema | sqhl_table | sqhl_begin_time_id | sqhl_end_time_id | sqhl_hole_size 
-------------+------------+--------------------+------------------+----------------
 myschema1   | mytbl1     |              12100 |            12400 |              3
 myschema1   | mytbl1     |              12402 |            12600 |              1
 myschema1   | mytbl4     |              12100 |            12400 |              8
 myschema1   | mytbl4     |              12402 |            12600 |              2
 myschema2   | mytbl4     |              12201 |            12502 |              6
 myschema2   | mytbl5     |              12201 |            12502 |              3
 myschema2   | mytbl6     |              12201 |            12502 |              9
(7 rows)

select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 12600 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
   12600 |           12600003 | R
   12601 |           12600006 | R
   12602 |           12600029 | M
(3 rows)

select hist_function, hist_event, hist_object,
       regexp_replace(regexp_replace(regexp_replace(hist_wording,
            E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),
            E'\\d\\d\\d\\d/\\d\\d\\/\\d\\d\\ \\d\\d\\:\\d\\d:\\d\\d .*?\\)','<timestamp>)','g'),
            E'\\[.+\\]','(timestamp)','g'), 
       hist_user
  from emaj.emaj_hist where hist_id >= 12600 order by hist_id;
   hist_function    |   hist_event   |    hist_object     |                     regexp_replace                     | hist_user 
--------------------+----------------+--------------------+--------------------------------------------------------+-----------
 ROLLBACK_GROUP     | BEGIN          | myGroup1           | Unlogged rollback to mark M5 (timestamp)               | postgres
 DBLINK_OPEN_CNX    |                | rlbk#1             | Status = 1                                             | postgres
 LOCK_GROUP         | BEGIN          | myGroup1           | Rollback session #1                                    | postgres
 LOCK_GROUP         | END            | myGroup1           | Rollback session #1: 5 tables locked, 0 deadlock(s)    | postgres
 ROLLBACK_GROUP     | TIME STAMP SET | 12600              |                                                        | postgres
 ROLLBACK_TABLE     | BEGIN          | myschema1.mytbl1   | All log rows where emaj_gid > 12400024 and <= 12600003 | postgres
 ROLLBACK_TABLE     | END            | myschema1.mytbl1   | 1 rolled back primary keys                             | postgres
 ROLLBACK_TABLE     | BEGIN          | myschema1.mytbl4   | All log rows where emaj_gid > 12400024 and <= 12600003 | postgres
 ROLLBACK_TABLE     | END            | myschema1.mytbl4   | 2 rolled back primary keys                             | postgres
 ROLLBACK_GROUP     | MARK DELETED   | myGroup1           | mark M6 is deleted                                     | postgres
 ROLLBACK_GROUP     | NOTICE         | Rollback id 12600  | Rollback id = 12600.                                   | postgres
 ROLLBACK_GROUP     | NOTICE         | Rollback id 12600  | 2 / 5 tables effectively processed.                    | postgres
 ROLLBACK_GROUP     | NOTICE         | Rollback id 12600  | 0 / 2 sequences effectively processed.                 | postgres
 DBLINK_CLOSE_CNX   |                | rlbk#1             |                                                        | postgres
 ROLLBACK_GROUP     | END            | myGroup1           | Rollback_id 12600                                      | postgres
 ROLLBACK_GROUP     | BEGIN          | myGroup1           | Logged rollback to mark M4 (timestamp)                 | postgres
 DBLINK_OPEN_CNX    |                | rlbk#1             | Status = 1                                             | postgres
 DBLINK_OPEN_CNX    |                | rlbk#1             | Status = 0                                             | postgres
 LOCK_GROUP         | BEGIN          | myGroup1           | Rollback session #1                                    | postgres
 LOCK_GROUP         | END            | myGroup1           | Rollback session #1: 5 tables locked, 0 deadlock(s)    | postgres
 ROLLBACK_GROUP     | TIME STAMP SET | 12601              |                                                        | postgres
 SET_MARK_GROUP     | BEGIN          | myGroup1           | RLBK_12601_START                                       | postgres
 CLEANUP_RLBK_STATE |                | Rollback id 12500  | set to COMMITTED                                       | postgres
 CLEANUP_RLBK_STATE |                | Rollback id 12501  | set to COMMITTED                                       | postgres
 CLEANUP_RLBK_STATE |                | Rollback id 12600  | set to COMMITTED                                       | postgres
 SET_MARK_GROUP     | END            | myGroup1           | RLBK_12601_START                                       | postgres
 ROLLBACK_TABLE     | BEGIN          | myschema1."myTbl3" | All log rows where emaj_gid > 12400014 and <= 12600006 | postgres
 ROLLBACK_TABLE     | END            | myschema1."myTbl3" | 10 rolled back primary keys                            | postgres
 ROLLBACK_TABLE     | BEGIN          | myschema1.mytbl1   | All log rows where emaj_gid > 12400014 and <= 12600006 | postgres
 ROLLBACK_TABLE     | END            | myschema1.mytbl1   | 1 rolled back primary keys                             | postgres
 ROLLBACK_TABLE     | BEGIN          | myschema1.mytbl4   | All log rows where emaj_gid > 12400014 and <= 12600006 | postgres
 ROLLBACK_TABLE     | END            | myschema1.mytbl4   | 2 rolled back primary keys                             | postgres
 ROLLBACK_GROUP     | TIME STAMP SET | 12602              |                                                        | postgres
 SET_MARK_GROUP     | BEGIN          | myGroup1           | RLBK_12601_DONE                                        | postgres
 SET_MARK_GROUP     | END            | myGroup1           | RLBK_12601_DONE                                        | postgres
 ROLLBACK_GROUP     | NOTICE         | Rollback id 12601  | Rollback id = 12601.                                   | postgres
 ROLLBACK_GROUP     | NOTICE         | Rollback id 12601  | 3 / 5 tables effectively processed.                    | postgres
 ROLLBACK_GROUP     | NOTICE         | Rollback id 12601  | 0 / 2 sequences effectively processed.                 | postgres
 DBLINK_CLOSE_CNX   |                | rlbk#1             |                                                        | postgres
 ROLLBACK_GROUP     | END            | myGroup1           | Rollback_id 12601                                      | postgres
 COMMENT_ROLLBACK   |                | 12601              |                                                        | postgres
(41 rows)

-- user tables
reset role;
select * from mySchema1.myTbl1 order by col11,col12;
 col11 |   col12    | col13 
-------+------------+-------
     2 | ABC        | \x1c
     3 | ABC        | \x1c
     4 | ABC        | \x0c
     5 | ABC        | \x0c
     6 | ABC        | \x0c
     7 | ABC        | \x0c
     8 | ABC        | \x0c
     9 | ABC        | \x0c
    10 | ABC        | \x0c
   100 | DEF        | \x00
   101 | DEF        | \x00
   102 | DEF        | \x00
   103 | DEF        | \x00
   104 | DEF        | \x00
   105 | DEF        | \x00
   106 | DEF        | \x00
   107 | DEF        | \x00
   108 | DEF        | \x00
   109 | DEF        | \x00
   110 | DEF        | \x00
(20 rows)

select * from mySchema1.myTbl2 order by col21;
 col21 | col22 |   col23    
-------+-------+------------
     1 | ABC   | 12-31-2010
     2 | DEF   | 
     3 | GHI   | 01-02-2010
(3 rows)

select * from mySchema1.myTbl2b order by col20;
 col20 | col21 |       col22        | col23 
-------+-------+--------------------+-------
     3 |     1 |                  1 | t
     4 |     2 |                0.5 | t
     5 |     3 | 0.3333333333333333 | t
(3 rows)

select col31,col33 from mySchema1."myTbl3" order by col31;
 col31 | col33 
-------+-------
    11 | 10.00
    12 | 10.00
    13 | 10.00
    14 | 10.00
    15 | 10.00
    16 | 10.00
    17 | 10.00
    18 | 10.00
    19 | 10.00
    20 | 10.00
(10 rows)

select * from mySchema1.myTbl4 order by col41;
 col41 | col42 | col43 | col44 | col45 
-------+-------+-------+-------+-------
(0 rows)

-- log tables
set role emaj_regression_tests_adm_user1;
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid 
-------+------------+-------+-----------+------------+----------
     1 | ABC        | \x0c  | INS       | NEW        | 12100001
     2 | ABC        | \x0c  | INS       | NEW        | 12100002
     3 | ABC        | \x0c  | INS       | NEW        | 12100003
     4 | ABC        | \x0c  | INS       | NEW        | 12100004
     5 | ABC        | \x0c  | INS       | NEW        | 12100005
     6 | ABC        | \x0c  | INS       | NEW        | 12100006
     7 | ABC        | \x0c  | INS       | NEW        | 12100007
     8 | ABC        | \x0c  | INS       | NEW        | 12100008
     9 | ABC        | \x0c  | INS       | NEW        | 12100009
    10 | ABC        | \x0c  | INS       | NEW        | 12100010
    11 | ABC        | \x0c  | INS       | NEW        | 12100011
     1 | ABC        | \x0c  | UPD       | OLD        | 12100012
     1 | ABC        | \x1c  | UPD       | NEW        | 12100012
     2 | ABC        | \x0c  | UPD       | OLD        | 12100013
     2 | ABC        | \x1c  | UPD       | NEW        | 12100013
     3 | ABC        | \x0c  | UPD       | OLD        | 12100014
     3 | ABC        | \x1c  | UPD       | NEW        | 12100014
    11 | ABC        | \x0c  | DEL       | OLD        | 12100017
   100 | DEF        | \x00  | INS       | NEW        | 12400001
   101 | DEF        | \x00  | INS       | NEW        | 12400002
   102 | DEF        | \x00  | INS       | NEW        | 12400003
   103 | DEF        | \x00  | INS       | NEW        | 12400004
   104 | DEF        | \x00  | INS       | NEW        | 12400005
   105 | DEF        | \x00  | INS       | NEW        | 12400006
   106 | DEF        | \x00  | INS       | NEW        | 12400007
   107 | DEF        | \x00  | INS       | NEW        | 12400008
   108 | DEF        | \x00  | INS       | NEW        | 12400009
   109 | DEF        | \x00  | INS       | NEW        | 12400010
   110 | DEF        | \x00  | INS       | NEW        | 12400011
     1 | ABC        | \x1c  | DEL       | OLD        | 12400014
     1 | Step 6     | \x01  | INS       | NEW        | 12600004
     1 | Step 6     | \x01  | DEL       | OLD        | 12600027
(32 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 |   col23    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+------------+-----------+------------+----------
     1 | ABC   | 12-31-2010 | INS       | NEW        | 12100015
     2 | DEF   |            | INS       | NEW        | 12100018
     3 | GHI   | 01-02-2010 | INS       | NEW        | 12400012
(3 rows)

select col20, col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl2b_log order by emaj_gid, emaj_tuple desc;
 col20 | col21 |       col22        | col23 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+--------------------+-------+-----------+------------+----------
     3 |     1 |                  1 | t     | INS       | NEW        | 12100016
     4 |     2 |                0.5 | t     | INS       | NEW        | 12100019
     5 |     3 | 0.3333333333333333 | t     | INS       | NEW        | 12400013
(3 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema1."myTbl3_log" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
    11 | 10.00 | INS       | NEW        | 12100020
    12 | 10.00 | INS       | NEW        | 12100021
    13 | 10.00 | INS       | NEW        | 12100022
    14 | 10.00 | INS       | NEW        | 12100023
    15 | 10.00 | INS       | NEW        | 12100024
    16 | 10.00 | INS       | NEW        | 12100025
    17 | 10.00 | INS       | NEW        | 12100026
    18 | 10.00 | INS       | NEW        | 12100027
    19 | 10.00 | INS       | NEW        | 12100028
    20 | 10.00 | INS       | NEW        | 12100029
    11 | 10.00 | UPD       | OLD        | 12400015
    11 |  5.00 | UPD       | NEW        | 12400015
    12 | 10.00 | UPD       | OLD        | 12400016
    12 |  5.00 | UPD       | NEW        | 12400016
    13 | 10.00 | UPD       | OLD        | 12400017
    13 |  5.00 | UPD       | NEW        | 12400017
    14 | 10.00 | UPD       | OLD        | 12400018
    14 |  5.00 | UPD       | NEW        | 12400018
    15 | 10.00 | UPD       | OLD        | 12400019
    15 |  5.00 | UPD       | NEW        | 12400019
    16 | 10.00 | UPD       | OLD        | 12400020
    16 |  5.00 | UPD       | NEW        | 12400020
    17 | 10.00 | UPD       | OLD        | 12400021
    17 |  5.00 | UPD       | NEW        | 12400021
    18 | 10.00 | UPD       | OLD        | 12400022
    18 |  5.00 | UPD       | NEW        | 12400022
    19 | 10.00 | UPD       | OLD        | 12400023
    19 |  5.00 | UPD       | NEW        | 12400023
    20 | 10.00 | UPD       | OLD        | 12400024
    20 |  5.00 | UPD       | NEW        | 12400024
    11 |  5.00 | DEL       | OLD        | 12600007
    12 |  5.00 | DEL       | OLD        | 12600008
    13 |  5.00 | DEL       | OLD        | 12600009
    14 |  5.00 | DEL       | OLD        | 12600010
    15 |  5.00 | DEL       | OLD        | 12600011
    16 |  5.00 | DEL       | OLD        | 12600012
    17 |  5.00 | DEL       | OLD        | 12600013
    18 |  5.00 | DEL       | OLD        | 12600014
    19 |  5.00 | DEL       | OLD        | 12600015
    20 |  5.00 | DEL       | OLD        | 12600016
    11 | 10.00 | INS       | NEW        | 12600017
    12 | 10.00 | INS       | NEW        | 12600018
    13 | 10.00 | INS       | NEW        | 12600019
    14 | 10.00 | INS       | NEW        | 12600020
    15 | 10.00 | INS       | NEW        | 12600021
    16 | 10.00 | INS       | NEW        | 12600022
    17 | 10.00 | INS       | NEW        | 12600023
    18 | 10.00 | INS       | NEW        | 12600024
    19 | 10.00 | INS       | NEW        | 12600025
    20 | 10.00 | INS       | NEW        | 12600026
(50 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 | col45  | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+--------+-----------+------------+----------
    11 |       |     1 |     1 | Step 6 | INS       | NEW        | 12600005
    12 |       |     1 |     1 | Step 6 | INS       | NEW        | 12600006
    11 |       |     1 |     1 | Step 6 | DEL       | OLD        | 12600028
    12 |       |     1 |     1 | Step 6 | DEL       | OLD        | 12600029
(4 rows)

-- set sequence restart value
select public.handle_emaj_sequences(12700);
 handle_emaj_sequences 
-----------------------
 
(1 row)

-----------------------------
-- Step 7 : for myGroup1, update tables, rename a mark, then delete 2 marks then delete all before a mark 
-----------------------------
set search_path=public,myschema1;
--
reset role;
delete from "myTbl3" where col31 = 14;
delete from "myTbl3" where col31 = 15;
delete from "myTbl3" where col31 = 16;
delete from "myTbl3" where col31 = 17;
delete from "myTbl3" where col31 = 18;
--
set role emaj_regression_tests_adm_user1;
select emaj.emaj_rename_mark_group('myGroup1',mark_name,'Before logged rollback to M4') from emaj.emaj_mark where mark_comment like '%to mark M4 start';
 emaj_rename_mark_group 
------------------------
 
(1 row)

-- 
select emaj.emaj_delete_mark_group('myGroup1',mark_name) from emaj.emaj_mark where mark_comment like '%to mark M4 end';
 emaj_delete_mark_group 
------------------------
                      1
(1 row)

select emaj.emaj_delete_mark_group('myGroup1','M1');
 emaj_delete_mark_group 
------------------------
                      1
(1 row)

--
select emaj.emaj_delete_before_mark_group('myGroup1','M4');
 emaj_delete_before_mark_group 
-------------------------------
                             1
(1 row)

-----------------------------
-- Checking step 7
-----------------------------
-- emaj tables
select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_time_id, mark_group;
 mark_group |        regexp_replace        | mark_time_id | mark_is_rlbk_protected |                  mark_comment                  | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------+------------------------------+--------------+------------------------+------------------------------------------------+---------------------------+------------------------------
 myGroup2   | M1                           |        12017 | f                      |                                                |                        41 | 
 myGroup2   | M2                           |        12200 | f                      |                                                |                         8 | 
 myGroup2   | M3                           |        12201 | f                      |                                                |                           | 
 myGroup1   | M4                           |        12401 | f                      |                                                |                        10 | 
 myGroup1   | M5                           |        12402 | f                      |                                                |                         3 | 
 myGroup1   | Before logged rollback to M4 |        12601 | f                      | Automatically set at rollback to mark M4 start |                           | 
(6 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
 sequ_schema |     sequ_name     | sequ_time_id | sequ_last_val | sequ_is_called 
-------------+-------------------+--------------+---------------+----------------
 myschema2   | myTbl3_col31_seq  |        12017 |            10 | t
 myschema2   | myseq1            |        12017 |          1000 | f
 myschema2   | myTbl3_col31_seq  |        12200 |            20 | t
 myschema2   | myseq1            |        12200 |          1000 | t
 myschema2   | myTbl3_col31_seq  |        12201 |            20 | t
 myschema2   | myseq1            |        12201 |          1003 | t
 myschema1   | myTbl3_col31_seq  |        12401 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12401 |             5 | t
 myschema1   | myTbl3_col31_seq  |        12402 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12402 |             5 | t
 myschema1   | myTbl3_col31_seq  |        12601 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12601 |             5 | t
 myschema1   | myTbl3_col31_seq  |        12602 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12602 |             5 | t
(14 rows)

select tbl_schema, tbl_name, tbl_time_id, tbl_log_seq_last_val from emaj.emaj_table order by tbl_time_id, tbl_schema, tbl_name;
 tbl_schema | tbl_name | tbl_time_id | tbl_log_seq_last_val 
------------+----------+-------------+----------------------
 myschema2  | myTbl3   |       12017 |                    0
 myschema2  | mytbl1   |       12017 |                    0
 myschema2  | mytbl2   |       12017 |                    0
 myschema2  | mytbl4   |       12017 |                    0
 myschema2  | mytbl5   |       12017 |                    0
 myschema2  | mytbl6   |       12017 |                    0
 myschema2  | myTbl3   |       12200 |                   10
 myschema2  | mytbl1   |       12200 |                   15
 myschema2  | mytbl2   |       12200 |                    2
 myschema2  | mytbl4   |       12200 |                    0
 myschema2  | mytbl5   |       12200 |                    3
 myschema2  | mytbl6   |       12200 |                   11
 myschema2  | myTbl3   |       12201 |                   10
 myschema2  | mytbl1   |       12201 |                   15
 myschema2  | mytbl2   |       12201 |                    2
 myschema2  | mytbl4   |       12201 |                    4
 myschema2  | mytbl5   |       12201 |                    4
 myschema2  | mytbl6   |       12201 |                   14
 myschema1  | myTbl3   |       12401 |                   10
 myschema1  | mytbl1   |       12401 |                   30
 myschema1  | mytbl2   |       12401 |                    3
 myschema1  | mytbl2b  |       12401 |                    3
 myschema1  | mytbl4   |       12401 |                    8
 myschema1  | myTbl3   |       12402 |                   20
 myschema1  | mytbl1   |       12402 |                   30
 myschema1  | mytbl2   |       12402 |                    3
 myschema1  | mytbl2b  |       12402 |                    3
 myschema1  | mytbl4   |       12402 |                    8
 myschema1  | myTbl3   |       12601 |                   20
 myschema1  | mytbl1   |       12601 |                   32
 myschema1  | mytbl2   |       12601 |                    3
 myschema1  | mytbl2b  |       12601 |                    3
 myschema1  | mytbl4   |       12601 |                   12
 myschema1  | myTbl3   |       12602 |                   40
 myschema1  | mytbl1   |       12602 |                   33
 myschema1  | mytbl2   |       12602 |                    3
 myschema1  | mytbl2b  |       12602 |                    3
 myschema1  | mytbl4   |       12602 |                   14
(38 rows)

select sqhl_schema, sqhl_table, sqhl_begin_time_id, sqhl_end_time_id, sqhl_hole_size from emaj.emaj_seq_hole order by 1,2,3;
 sqhl_schema | sqhl_table | sqhl_begin_time_id | sqhl_end_time_id | sqhl_hole_size 
-------------+------------+--------------------+------------------+----------------
 myschema1   | mytbl1     |              12402 |            12600 |              1
 myschema1   | mytbl4     |              12402 |            12600 |              2
 myschema2   | mytbl4     |              12201 |            12502 |              6
 myschema2   | mytbl5     |              12201 |            12502 |              3
 myschema2   | mytbl6     |              12201 |            12502 |              9
(5 rows)

select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 12700 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
(0 rows)

select hist_function, hist_event, hist_object,
       regexp_replace(regexp_replace(regexp_replace(hist_wording,
            E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),
            E'\\d\\d\\d\\d/\\d\\d\\/\\d\\d\\ \\d\\d\\:\\d\\d:\\d\\d .*?\\)','<timestamp>)','g'),
            E'\\[.+\\]','(timestamp)','g'), 
       hist_user
  from emaj.emaj_hist where hist_id >= 12700 order by hist_id;
      hist_function       | hist_event | hist_object |                    regexp_replace                     | hist_user 
--------------------------+------------+-------------+-------------------------------------------------------+-----------
 RENAME_MARK_GROUP        | BEGIN      | myGroup1    | RLBK_12601_START                                      | postgres
 RENAME_MARK_GROUP        | END        | myGroup1    | RLBK_12601_START renamed Before logged rollback to M4 | postgres
 DELETE_MARK_GROUP        | BEGIN      | myGroup1    | RLBK_12601_DONE                                       | postgres
 DELETE_MARK_GROUP        | END        | myGroup1    | RLBK_12601_DONE                                       | postgres
 DELETE_MARK_GROUP        | BEGIN      | myGroup1    | M1                                                    | postgres
 DELETE_MARK_GROUP        | END        | myGroup1    | M1                                                    | postgres
 DELETE_BEFORE_MARK_GROUP | BEGIN      | myGroup1    | M4                                                    | postgres
 DELETE_BEFORE_MARK_GROUP | END        | myGroup1    | 1 marks deleted ; M4 is now the initial mark          | postgres
(8 rows)

-- user tables
reset role;
select * from mySchema1.myTbl1 order by col11,col12;
 col11 |   col12    | col13 
-------+------------+-------
     2 | ABC        | \x1c
     3 | ABC        | \x1c
     4 | ABC        | \x0c
     5 | ABC        | \x0c
     6 | ABC        | \x0c
     7 | ABC        | \x0c
     8 | ABC        | \x0c
     9 | ABC        | \x0c
    10 | ABC        | \x0c
   100 | DEF        | \x00
   101 | DEF        | \x00
   102 | DEF        | \x00
   103 | DEF        | \x00
   104 | DEF        | \x00
   105 | DEF        | \x00
   106 | DEF        | \x00
   107 | DEF        | \x00
   108 | DEF        | \x00
   109 | DEF        | \x00
   110 | DEF        | \x00
(20 rows)

select * from mySchema1.myTbl2 order by col21;
 col21 | col22 |   col23    
-------+-------+------------
     1 | ABC   | 12-31-2010
     2 | DEF   | 
     3 | GHI   | 01-02-2010
(3 rows)

select * from mySchema1.myTbl2b order by col20;
 col20 | col21 |       col22        | col23 
-------+-------+--------------------+-------
     3 |     1 |                  1 | t
     4 |     2 |                0.5 | t
     5 |     3 | 0.3333333333333333 | t
(3 rows)

select col31,col33 from mySchema1."myTbl3" order by col31;
 col31 | col33 
-------+-------
    11 | 10.00
    12 | 10.00
    13 | 10.00
    19 | 10.00
    20 | 10.00
(5 rows)

select * from mySchema1.myTbl4 order by col41;
 col41 | col42 | col43 | col44 | col45 
-------+-------+-------+-------+-------
(0 rows)

-- log tables
set role emaj_regression_tests_adm_user1;
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid 
-------+------------+-------+-----------+------------+----------
     1 | Step 6     | \x01  | INS       | NEW        | 12600004
     1 | Step 6     | \x01  | DEL       | OLD        | 12600027
(2 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 | col23 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-----------+------------+----------
(0 rows)

select col20, col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl2b_log order by emaj_gid, emaj_tuple desc;
 col20 | col21 | col22 | col23 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+-----------+------------+----------
(0 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema1."myTbl3_log" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
    11 | 10.00 | UPD       | OLD        | 12400015
    11 |  5.00 | UPD       | NEW        | 12400015
    12 | 10.00 | UPD       | OLD        | 12400016
    12 |  5.00 | UPD       | NEW        | 12400016
    13 | 10.00 | UPD       | OLD        | 12400017
    13 |  5.00 | UPD       | NEW        | 12400017
    14 | 10.00 | UPD       | OLD        | 12400018
    14 |  5.00 | UPD       | NEW        | 12400018
    15 | 10.00 | UPD       | OLD        | 12400019
    15 |  5.00 | UPD       | NEW        | 12400019
    16 | 10.00 | UPD       | OLD        | 12400020
    16 |  5.00 | UPD       | NEW        | 12400020
    17 | 10.00 | UPD       | OLD        | 12400021
    17 |  5.00 | UPD       | NEW        | 12400021
    18 | 10.00 | UPD       | OLD        | 12400022
    18 |  5.00 | UPD       | NEW        | 12400022
    19 | 10.00 | UPD       | OLD        | 12400023
    19 |  5.00 | UPD       | NEW        | 12400023
    20 | 10.00 | UPD       | OLD        | 12400024
    20 |  5.00 | UPD       | NEW        | 12400024
    11 |  5.00 | DEL       | OLD        | 12600007
    12 |  5.00 | DEL       | OLD        | 12600008
    13 |  5.00 | DEL       | OLD        | 12600009
    14 |  5.00 | DEL       | OLD        | 12600010
    15 |  5.00 | DEL       | OLD        | 12600011
    16 |  5.00 | DEL       | OLD        | 12600012
    17 |  5.00 | DEL       | OLD        | 12600013
    18 |  5.00 | DEL       | OLD        | 12600014
    19 |  5.00 | DEL       | OLD        | 12600015
    20 |  5.00 | DEL       | OLD        | 12600016
    11 | 10.00 | INS       | NEW        | 12600017
    12 | 10.00 | INS       | NEW        | 12600018
    13 | 10.00 | INS       | NEW        | 12600019
    14 | 10.00 | INS       | NEW        | 12600020
    15 | 10.00 | INS       | NEW        | 12600021
    16 | 10.00 | INS       | NEW        | 12600022
    17 | 10.00 | INS       | NEW        | 12600023
    18 | 10.00 | INS       | NEW        | 12600024
    19 | 10.00 | INS       | NEW        | 12600025
    20 | 10.00 | INS       | NEW        | 12600026
    14 | 10.00 | DEL       | OLD        | 12700001
    15 | 10.00 | DEL       | OLD        | 12700002
    16 | 10.00 | DEL       | OLD        | 12700003
    17 | 10.00 | DEL       | OLD        | 12700004
    18 | 10.00 | DEL       | OLD        | 12700005
(45 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 | col45  | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+--------+-----------+------------+----------
    11 |       |     1 |     1 | Step 6 | INS       | NEW        | 12600005
    12 |       |     1 |     1 | Step 6 | INS       | NEW        | 12600006
    11 |       |     1 |     1 | Step 6 | DEL       | OLD        | 12600028
    12 |       |     1 |     1 | Step 6 | DEL       | OLD        | 12600029
(4 rows)

--
--		grp1									grp2
--1	M1 up M2 up M3 
--2											M1 up M2 up M3
--3											LR-M2 (->M2%S+M2%E) LR-M3 (->M3%S+M3%E)
--4	R-M2 up M4 up M5 up M6
--5											LR-M2 (->M2%S+M2%E) R-M3
--6	up R-M5 up LR-M4(->M4S+M4E)
--7	up M7 REN-M4S DEL-M4E DEL-M1 DELBEF-M4
--
reset role;
