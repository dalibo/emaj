-- adm2.sql : complex scenario executed by an emaj_adm role. 
--            Follows adm1.sql, and includes more specific test cases
--
-- set sequence restart value
select public.handle_emaj_sequences(14000);
 handle_emaj_sequences 
-----------------------
 
(1 row)

-- define and create the temp file directory to be used by the script
\setenv EMAJTESTTMPDIR '/tmp/emaj_'`echo $PGVER`'/adm2'
\set EMAJTESTTMPDIR `echo $EMAJTESTTMPDIR`
\! mkdir -p $EMAJTESTTMPDIR
set role emaj_regression_tests_adm_user1;
-- before going on, save and reload parameters
select emaj.emaj_import_parameters_configuration(emaj.emaj_export_parameters_configuration());
 emaj_import_parameters_configuration 
--------------------------------------
                                    3
(1 row)

-----------------------------
-- Step 8 : use of multi-group functions, start_group(s) without log reset and use old marks (i.e. set before the latest group start)
-----------------------------
-- stop both groups
select emaj.emaj_stop_groups(array['myGroup1','myGroup2']);
 emaj_stop_groups 
------------------
               15
(1 row)

-- start both groups
select emaj.emaj_start_groups(array['myGroup1','myGroup2'],'Multi-1', false);
WARNING:  _check_fk_groups: The foreign key "mytbl6_col61_fkey" on the table "myschema2.mytbl6" references the table "myschema2.mytbl7" that is outside the groups (myGroup1,myGroup2).
WARNING:  _check_fk_groups: The table "myschema2.mytbl6" is referenced by the foreign key "mytbl8_col81_fkey" on the table "myschema2.mytbl8" that is outside the groups (myGroup1,myGroup2).
 emaj_start_groups 
-------------------
                15
(1 row)

-- set a mark for both groups
select emaj.emaj_set_mark_groups(array['myGroup1','myGroup2'],'Multi-2');
 emaj_set_mark_groups 
----------------------
                   15
(1 row)

-- logged rollback to Multi-1
select * from emaj.emaj_logged_rollback_groups(array['myGroup1','myGroup2'],'Multi-1',false) order by 1,2;
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | 0 / 11 tables effectively processed.
 Notice        | 0 / 4 sequences effectively processed.
 Notice        | Rollback id = 14000.
(3 rows)

-- rollback to Multi-2
select * from emaj.emaj_rollback_groups(array['myGroup1','myGroup2'],'Multi-2',false) order by 1,2;
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | 0 / 11 tables effectively processed.
 Notice        | 0 / 4 sequences effectively processed.
 Notice        | Rollback id = 14001.
(3 rows)

-- rollback and stop to Multi-1
select * from emaj.emaj_rollback_groups(array['myGroup1','myGroup2'],'Multi-1',false) order by 1,2;
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | 0 / 11 tables effectively processed.
 Notice        | 0 / 4 sequences effectively processed.
 Notice        | Rollback id = 14002.
(3 rows)

select emaj.emaj_stop_groups(array['myGroup1','myGroup2'],'Stop after rollback');
 emaj_stop_groups 
------------------
               15
(1 row)

-- try to start both groups, but with an old mark name
select emaj.emaj_start_groups(array['myGroup1','myGroup2'],'Multi-1', false);
WARNING:  _check_fk_groups: The foreign key "mytbl6_col61_fkey" on the table "myschema2.mytbl6" references the table "myschema2.mytbl7" that is outside the groups (myGroup1,myGroup2).
WARNING:  _check_fk_groups: The table "myschema2.mytbl6" is referenced by the foreign key "mytbl8_col81_fkey" on the table "myschema2.mytbl8" that is outside the groups (myGroup1,myGroup2).
ERROR:  _check_new_mark: The groups "myGroup1, myGroup2" already contain a mark named "Multi-1".
CONTEXT:  PL/pgSQL function emaj._check_new_mark(text[],text) line 31 at RAISE
SQL statement "SELECT emaj._check_new_mark(p_groupNames, p_mark)"
PL/pgSQL function emaj._start_groups(text[],text,boolean,boolean) line 46 at SQL statement
PL/pgSQL function emaj.emaj_start_groups(text[],text,boolean) line 11 at RETURN
-- really start both groups
select emaj.emaj_start_groups(array['myGroup1','myGroup2'],'Multi-1b', false);
WARNING:  _check_fk_groups: The foreign key "mytbl6_col61_fkey" on the table "myschema2.mytbl6" references the table "myschema2.mytbl7" that is outside the groups (myGroup1,myGroup2).
WARNING:  _check_fk_groups: The table "myschema2.mytbl6" is referenced by the foreign key "mytbl8_col81_fkey" on the table "myschema2.mytbl8" that is outside the groups (myGroup1,myGroup2).
 emaj_start_groups 
-------------------
                15
(1 row)

-- try to rollback several groups to an old common mark
select * from emaj.emaj_rollback_groups(array['myGroup1','myGroup2'],'Multi-1', false);
ERROR:  _check_mark_name: For the groups "myGroup1, myGroup2", the mark "Multi-1" was set before the latest group start.
CONTEXT:  PL/pgSQL function emaj._check_mark_name(text[],text,boolean) line 89 at RAISE
SQL statement "SELECT emaj._check_mark_name(p_groupNames := p_groupNames, p_mark := p_mark, p_checkActive := TRUE)"
PL/pgSQL function emaj._rlbk_check(text[],text,boolean,boolean) line 21 at SQL statement
SQL statement "SELECT emaj._rlbk_check(p_groupNames, p_mark, p_isAlterGroupAllowed, FALSE)"
PL/pgSQL function emaj._rlbk_init(text[],text,boolean,integer,boolean,boolean,text) line 25 at SQL statement
SQL statement "SELECT emaj._rlbk_init(p_groupNames, p_mark, p_isLoggedRlbk, 1, p_multiGroup, p_isAlterGroupAllowed, p_comment)"
PL/pgSQL function emaj._rlbk_groups(text[],text,boolean,boolean,boolean,text) line 26 at SQL statement
PL/pgSQL function emaj.emaj_rollback_groups(text[],text,boolean,text) line 8 at RETURN QUERY
-- set again a mark for both groups
select emaj.emaj_set_mark_groups(array['myGroup1','myGroup2'],'Multi-2');
 emaj_set_mark_groups 
----------------------
                   15
(1 row)

-- delete the mark for only 1 group and get detailed statistics for the other group
select emaj.emaj_delete_mark_group('myGroup1','Multi-2');
 emaj_delete_mark_group 
------------------------
                      1
(1 row)

-- use this mark for the other group before delete it
select * from emaj.emaj_detailed_log_stat_group('myGroup2','Multi-2',NULL);
 stat_group | stat_schema | stat_table | stat_first_mark | stat_first_mark_datetime | stat_last_mark | stat_last_mark_datetime | stat_role | stat_verb | stat_rows 
------------+-------------+------------+-----------------+--------------------------+----------------+-------------------------+-----------+-----------+-----------
(0 rows)

select stat_group, stat_schema, stat_sequence, stat_first_mark, stat_last_mark, stat_increments, stat_has_structure_changed
  from emaj.emaj_sequence_stat_group('myGroup2', 'Multi-2', NULL)
  order by stat_group, stat_schema, stat_sequence, stat_first_mark_datetime;
 stat_group | stat_schema |  stat_sequence   | stat_first_mark | stat_last_mark | stat_increments | stat_has_structure_changed 
------------+-------------+------------------+-----------------+----------------+-----------------+----------------------------
 myGroup2   | myschema2   | myTbl3_col31_seq | Multi-2         |                |               0 | f
 myGroup2   | myschema2   | myseq1           | Multi-2         |                |               0 | f
(2 rows)

select * from emaj.emaj_rollback_group('myGroup2','Multi-2',false) order by 1,2;
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | 0 / 2 sequences effectively processed.
 Notice        | 0 / 6 tables effectively processed.
 Notice        | Rollback id = 14003.
(3 rows)

select emaj.emaj_delete_mark_group('myGroup2','Multi-2');
 emaj_delete_mark_group 
------------------------
                      1
(1 row)

-- get statistics using old marks
select stat_group, stat_schema, stat_table, stat_first_mark, stat_last_mark, stat_role, stat_verb, stat_rows
  from emaj.emaj_detailed_log_stat_group('myGroup2','M1','M2');
 stat_group | stat_schema | stat_table | stat_first_mark | stat_last_mark | stat_role | stat_verb | stat_rows 
------------+-------------+------------+-----------------+----------------+-----------+-----------+-----------
 myGroup2   | myschema2   | myTbl3     | M1              | M2             | postgres  | INSERT    |        10
 myGroup2   | myschema2   | mytbl1     | M1              | M2             | postgres  | DELETE    |         1
 myGroup2   | myschema2   | mytbl1     | M1              | M2             | postgres  | INSERT    |        11
 myGroup2   | myschema2   | mytbl1     | M1              | M2             | postgres  | UPDATE    |         3
 myGroup2   | myschema2   | mytbl2     | M1              | M2             | postgres  | INSERT    |         2
 myGroup2   | myschema2   | mytbl5     | M1              | M2             | postgres  | INSERT    |         2
 myGroup2   | myschema2   | mytbl5     | M1              | M2             | postgres  | UPDATE    |         1
 myGroup2   | myschema2   | mytbl6     | M1              | M2             | postgres  | INSERT    |         8
 myGroup2   | myschema2   | mytbl6     | M1              | M2             | postgres  | UPDATE    |         3
(9 rows)

select stat_group, stat_schema, stat_sequence, stat_first_mark, stat_last_mark, stat_increments, stat_has_structure_changed
  from emaj.emaj_sequence_stat_group('myGroup2', 'M1', 'M2')
  order by stat_group, stat_schema, stat_sequence, stat_first_mark_datetime;
 stat_group | stat_schema |  stat_sequence   | stat_first_mark | stat_last_mark | stat_increments | stat_has_structure_changed 
------------+-------------+------------------+-----------------+----------------+-----------------+----------------------------
 myGroup2   | myschema2   | myTbl3_col31_seq | M1              | M2             |              10 | f
 myGroup2   | myschema2   | myseq1           | M1              | M2             |               1 | f
(2 rows)

-- delete intermediate old marks
select emaj.emaj_delete_mark_group('myGroup1','Multi-1');
 emaj_delete_mark_group 
------------------------
                      1
(1 row)

select emaj.emaj_delete_mark_group('myGroup2','Multi-1');
 emaj_delete_mark_group 
------------------------
                      1
(1 row)

-- ... and reuse mark names for parallel rollback test
select emaj.emaj_rename_mark_group('myGroup1','Multi-1b','Multi-1');
 emaj_rename_mark_group 
------------------------
 
(1 row)

select emaj.emaj_rename_mark_group('myGroup2','Multi-1b','Multi-1');
 emaj_rename_mark_group 
------------------------
 
(1 row)

-- rename an old mark
select emaj.emaj_rename_mark_group('myGroup2','M2','Deleted M2');
 emaj_rename_mark_group 
------------------------
 
(1 row)

-- use emaj_get_previous_mark_group and delete an initial old mark
select emaj.emaj_delete_before_mark_group('myGroup2',
      (select emaj.emaj_get_previous_mark_group('myGroup2',
             (select time_clock_timestamp from emaj.emaj_mark, emaj.emaj_time_stamp where time_id = mark_time_id and mark_group = 'myGroup2' and mark_group = 'myGroup2' and mark_name = 'M3')+'0.000001 SECOND'::interval)));
 emaj_delete_before_mark_group 
-------------------------------
                             2
(1 row)

-- comment an old mark
select emaj.emaj_comment_mark_group('myGroup2','M3','This mark is old');
 emaj_comment_mark_group 
-------------------------
 
(1 row)

-- try to get a rollback duration estimate on an old mark
select emaj.emaj_estimate_rollback_group('myGroup2','M3',TRUE);
ERROR:  _check_mark_name: For the group "myGroup2", the mark "M3" was set before the latest group start.
CONTEXT:  PL/pgSQL function emaj._check_mark_name(text[],text,boolean) line 85 at RAISE
SQL statement "SELECT emaj._check_mark_name(p_groupNames := p_groupNames, p_mark := p_mark, p_checkActive := TRUE)"
PL/pgSQL function emaj._rlbk_check(text[],text,boolean,boolean) line 21 at SQL statement
SQL statement "SELECT emaj._rlbk_check(p_groupNames, p_mark, TRUE, TRUE)"
PL/pgSQL function emaj._estimate_rollback_groups(text[],boolean,text,boolean) line 25 at SQL statement
PL/pgSQL function emaj.emaj_estimate_rollback_group(text,text,boolean) line 7 at RETURN
-- try to rollback on an old mark
select * from emaj.emaj_rollback_group('myGroup2','M3',false) order by 1,2;
ERROR:  _check_mark_name: For the group "myGroup2", the mark "M3" was set before the latest group start.
CONTEXT:  PL/pgSQL function emaj._check_mark_name(text[],text,boolean) line 85 at RAISE
SQL statement "SELECT emaj._check_mark_name(p_groupNames := p_groupNames, p_mark := p_mark, p_checkActive := TRUE)"
PL/pgSQL function emaj._rlbk_check(text[],text,boolean,boolean) line 21 at SQL statement
SQL statement "SELECT emaj._rlbk_check(p_groupNames, p_mark, p_isAlterGroupAllowed, FALSE)"
PL/pgSQL function emaj._rlbk_init(text[],text,boolean,integer,boolean,boolean,text) line 25 at SQL statement
SQL statement "SELECT emaj._rlbk_init(p_groupNames, p_mark, p_isLoggedRlbk, 1, p_multiGroup, p_isAlterGroupAllowed, p_comment)"
PL/pgSQL function emaj._rlbk_groups(text[],text,boolean,boolean,boolean,text) line 26 at SQL statement
PL/pgSQL function emaj.emaj_rollback_group(text,text,boolean,text) line 8 at RETURN QUERY
-----------------------------
-- Checking step 8
-----------------------------
-- emaj tables
select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_time_id, mark_group;
 mark_group |        regexp_replace        | mark_time_id | mark_is_rlbk_protected |                  mark_comment                  | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------+------------------------------+--------------+------------------------+------------------------------------------------+---------------------------+------------------------------
 myGroup2   | M3                           |        12201 | f                      | This mark is old                               |                         0 | 
 myGroup1   | M4                           |        12401 | f                      |                                                |                        10 | 
 myGroup1   | M5                           |        12402 | f                      |                                                |                         3 | 
 myGroup1   | Before logged rollback to M4 |        12601 | f                      | Automatically set at rollback to mark M4 start |                        28 | 
 myGroup1   | STOP_%                       |        14000 | f                      |                                                |                         0 | 
 myGroup2   | STOP_%                       |        14000 | f                      |                                                |                         0 | 
 myGroup1   | Stop after rollback          |        14007 | f                      |                                                |                         0 | 
 myGroup2   | Stop after rollback          |        14007 | f                      |                                                |                         0 | 
 myGroup1   | Multi-1                      |        14009 | f                      |                                                |                           | 
 myGroup2   | Multi-1                      |        14009 | f                      |                                                |                           | 
(10 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
 sequ_schema |     sequ_name     | sequ_time_id | sequ_last_val | sequ_is_called 
-------------+-------------------+--------------+---------------+----------------
 myschema2   | myTbl3_col31_seq  |        12201 |            20 | t
 myschema2   | myseq1            |        12201 |          1003 | t
 myschema1   | myTbl3_col31_seq  |        12401 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12401 |             5 | t
 myschema1   | myTbl3_col31_seq  |        12402 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12402 |             5 | t
 myschema1   | myTbl3_col31_seq  |        12601 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12601 |             5 | t
 myschema1   | myTbl3_col31_seq  |        12602 |            20 | t
 myschema1   | mytbl2b_col20_seq |        12602 |             5 | t
 myschema1   | myTbl3_col31_seq  |        14000 |            20 | t
 myschema1   | mytbl2b_col20_seq |        14000 |             5 | t
 myschema2   | myTbl3_col31_seq  |        14000 |            20 | t
 myschema2   | myseq1            |        14000 |          1004 | f
 myschema1   | myTbl3_col31_seq  |        14001 |            20 | t
 myschema1   | mytbl2b_col20_seq |        14001 |             5 | t
 myschema2   | myTbl3_col31_seq  |        14001 |            20 | t
 myschema2   | myseq1            |        14001 |          1004 | f
 myschema1   | myTbl3_col31_seq  |        14007 |            20 | t
 myschema1   | mytbl2b_col20_seq |        14007 |             5 | t
 myschema2   | myTbl3_col31_seq  |        14007 |            20 | t
 myschema2   | myseq1            |        14007 |          1004 | f
 myschema1   | myTbl3_col31_seq  |        14009 |            20 | t
 myschema1   | mytbl2b_col20_seq |        14009 |             5 | t
 myschema2   | myTbl3_col31_seq  |        14009 |            20 | t
 myschema2   | myseq1            |        14009 |          1004 | f
 myschema1   | myTbl3_col31_seq  |        14010 |            20 | t
 myschema1   | mytbl2b_col20_seq |        14010 |             5 | t
 myschema2   | myTbl3_col31_seq  |        14010 |            20 | t
 myschema2   | myseq1            |        14010 |          1004 | f
(30 rows)

select tbl_schema, tbl_name, tbl_time_id, tbl_tuples, tbl_pages, tbl_log_seq_last_val from emaj.emaj_table order by tbl_time_id, tbl_schema, tbl_name;
 tbl_schema | tbl_name | tbl_time_id | tbl_tuples | tbl_pages | tbl_log_seq_last_val 
------------+----------+-------------+------------+-----------+----------------------
 myschema2  | myTbl3   |       12201 |          0 |         0 |                   10
 myschema2  | mytbl1   |       12201 |          0 |         0 |                   15
 myschema2  | mytbl2   |       12201 |          0 |         0 |                    2
 myschema2  | mytbl4   |       12201 |          0 |         0 |                    4
 myschema2  | mytbl5   |       12201 |          0 |         0 |                    4
 myschema2  | mytbl6   |       12201 |          1 |         1 |                   14
 myschema1  | myTbl3   |       12401 |          0 |         0 |                   10
 myschema1  | mytbl1   |       12401 |          0 |         0 |                   30
 myschema1  | mytbl2   |       12401 |          0 |         0 |                    3
 myschema1  | mytbl2b  |       12401 |          0 |         0 |                    3
 myschema1  | mytbl4   |       12401 |          0 |         0 |                    8
 myschema1  | myTbl3   |       12402 |          0 |         0 |                   20
 myschema1  | mytbl1   |       12402 |          0 |         0 |                   30
 myschema1  | mytbl2   |       12402 |          0 |         0 |                    3
 myschema1  | mytbl2b  |       12402 |          0 |         0 |                    3
 myschema1  | mytbl4   |       12402 |          0 |         0 |                    8
 myschema1  | myTbl3   |       12601 |          0 |         0 |                   20
 myschema1  | mytbl1   |       12601 |          0 |         0 |                   32
 myschema1  | mytbl2   |       12601 |          0 |         0 |                    3
 myschema1  | mytbl2b  |       12601 |          0 |         0 |                    3
 myschema1  | mytbl4   |       12601 |          0 |         0 |                   12
 myschema1  | myTbl3   |       12602 |          0 |         0 |                   40
 myschema1  | mytbl1   |       12602 |          0 |         0 |                   33
 myschema1  | mytbl2   |       12602 |          0 |         0 |                    3
 myschema1  | mytbl2b  |       12602 |          0 |         0 |                    3
 myschema1  | mytbl4   |       12602 |          0 |         0 |                   14
 myschema1  | myTbl3   |       14000 |          0 |         0 |                   45
 myschema1  | mytbl1   |       14000 |          0 |         0 |                   33
 myschema1  | mytbl2   |       14000 |          0 |         0 |                    3
 myschema1  | mytbl2b  |       14000 |          0 |         0 |                    3
 myschema1  | mytbl4   |       14000 |          0 |         0 |                   14
 myschema2  | myTbl3   |       14000 |          0 |         0 |                   10
 myschema2  | mytbl1   |       14000 |          0 |         0 |                   15
 myschema2  | mytbl2   |       14000 |          0 |         0 |                    2
 myschema2  | mytbl4   |       14000 |          2 |         1 |                   10
 myschema2  | mytbl5   |       14000 |          0 |         0 |                    7
 myschema2  | mytbl6   |       14000 |          1 |         1 |                   23
 myschema1  | myTbl3   |       14001 |          0 |         0 |                   45
 myschema1  | mytbl1   |       14001 |          0 |         0 |                   33
 myschema1  | mytbl2   |       14001 |          0 |         0 |                    3
 myschema1  | mytbl2b  |       14001 |          0 |         0 |                    3
 myschema1  | mytbl4   |       14001 |          0 |         0 |                   14
 myschema2  | myTbl3   |       14001 |          0 |         0 |                   10
 myschema2  | mytbl1   |       14001 |          0 |         0 |                   15
 myschema2  | mytbl2   |       14001 |          0 |         0 |                    2
 myschema2  | mytbl4   |       14001 |          2 |         1 |                   10
 myschema2  | mytbl5   |       14001 |          0 |         0 |                    7
 myschema2  | mytbl6   |       14001 |          1 |         1 |                   23
 myschema1  | myTbl3   |       14007 |          0 |         0 |                   45
 myschema1  | mytbl1   |       14007 |          0 |         0 |                   33
 myschema1  | mytbl2   |       14007 |          0 |         0 |                    3
 myschema1  | mytbl2b  |       14007 |          0 |         0 |                    3
 myschema1  | mytbl4   |       14007 |          0 |         0 |                   14
 myschema2  | myTbl3   |       14007 |          0 |         0 |                   10
 myschema2  | mytbl1   |       14007 |          0 |         0 |                   15
 myschema2  | mytbl2   |       14007 |          0 |         0 |                    2
 myschema2  | mytbl4   |       14007 |          2 |         1 |                   10
 myschema2  | mytbl5   |       14007 |          0 |         0 |                    7
 myschema2  | mytbl6   |       14007 |          1 |         1 |                   23
 myschema1  | myTbl3   |       14009 |          0 |         0 |                   45
 myschema1  | mytbl1   |       14009 |          0 |         0 |                   33
 myschema1  | mytbl2   |       14009 |          0 |         0 |                    3
 myschema1  | mytbl2b  |       14009 |          0 |         0 |                    3
 myschema1  | mytbl4   |       14009 |          0 |         0 |                   14
 myschema2  | myTbl3   |       14009 |          0 |         0 |                   10
 myschema2  | mytbl1   |       14009 |          0 |         0 |                   15
 myschema2  | mytbl2   |       14009 |          0 |         0 |                    2
 myschema2  | mytbl4   |       14009 |          2 |         1 |                   10
 myschema2  | mytbl5   |       14009 |          0 |         0 |                    7
 myschema2  | mytbl6   |       14009 |          1 |         1 |                   23
 myschema1  | myTbl3   |       14010 |          0 |         0 |                   45
 myschema1  | mytbl1   |       14010 |          0 |         0 |                   33
 myschema1  | mytbl2   |       14010 |          0 |         0 |                    3
 myschema1  | mytbl2b  |       14010 |          0 |         0 |                    3
 myschema1  | mytbl4   |       14010 |          0 |         0 |                   14
 myschema2  | myTbl3   |       14010 |          0 |         0 |                   10
 myschema2  | mytbl1   |       14010 |          0 |         0 |                   15
 myschema2  | mytbl2   |       14010 |          0 |         0 |                    2
 myschema2  | mytbl4   |       14010 |          2 |         1 |                   10
 myschema2  | mytbl5   |       14010 |          0 |         0 |                    7
 myschema2  | mytbl6   |       14010 |          1 |         1 |                   23
(81 rows)

select sqhl_schema, sqhl_table, sqhl_begin_time_id, sqhl_end_time_id, sqhl_hole_size from emaj.emaj_seq_hole order by 1,2,3;
 sqhl_schema | sqhl_table | sqhl_begin_time_id | sqhl_end_time_id | sqhl_hole_size 
-------------+------------+--------------------+------------------+----------------
 myschema1   | mytbl1     |              12402 |            12600 |              1
 myschema1   | mytbl4     |              12402 |            12600 |              2
 myschema2   | mytbl4     |              12201 |            12502 |              6
 myschema2   | mytbl5     |              12201 |            12502 |              3
 myschema2   | mytbl6     |              12201 |            12502 |              9
(5 rows)

select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 14000 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
   14000 |           14000000 | X
   14001 |           14000000 | S
   14002 |           14000000 | M
   14003 |           14000000 | R
   14004 |           14000000 | M
   14005 |           14000000 | R
   14006 |           14000000 | R
   14007 |           14000000 | X
   14009 |           14000000 | S
   14010 |           14000000 | M
   14011 |           14000000 | R
(11 rows)

select hist_function, hist_event, hist_object,
       regexp_replace(regexp_replace(regexp_replace(hist_wording,
            E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),
            E'\\d\\d\\d\\d/\\d\\d\\/\\d\\d\\ \\d\\d\\:\\d\\d:\\d\\d .*?\\)','<timestamp>)','g'),
            E'\\[.+\\]','(timestamp)','g'), 
       hist_user
  from emaj.emaj_hist where hist_id >= 14000 order by hist_id;
      hist_function       |    hist_event     |         hist_object          |                                                             regexp_replace                                                             | hist_user 
--------------------------+-------------------+------------------------------+----------------------------------------------------------------------------------------------------------------------------------------+-----------
 IMPORT_PARAMETERS        | BEGIN             |                              |                                                                                                                                        | postgres
                          | UPDATED PARAMETER | dblink_user_password         | <masked data>                                                                                                                          | postgres
                          | UPDATED PARAMETER | alter_log_table              | ADD COLUMN emaj_user_ip INET DEFAULT inet_client_addr(), ADD COLUMN extra_col_appname TEXT DEFAULT current_setting('application_name') | postgres
                          | UPDATED PARAMETER | fixed_step_rollback_duration | @ 0.0025 secs                                                                                                                          | postgres
 IMPORT_PARAMETERS        | END               |                              | 3 parameters imported                                                                                                                  | postgres
 STOP_GROUPS              | BEGIN             | myGroup1,myGroup2            |                                                                                                                                        | postgres
 STOP_GROUPS              | TIME STAMP SET    | 14000                        |                                                                                                                                        | postgres
 LOCK_GROUPS              | BEGIN             | myGroup1,myGroup2            |                                                                                                                                        | postgres
 LOCK_GROUPS              | END               | myGroup1,myGroup2            | 11 tables locked, 0 deadlock(s)                                                                                                        | postgres
 SET_MARK_GROUPS          | BEGIN             | myGroup1,myGroup2            | STOP_%                                                                                                                                 | postgres
 CLEANUP_RLBK_STATE       |                   | Rollback id 12601            | set to COMMITTED                                                                                                                       | postgres
 SET_MARK_GROUPS          | END               | myGroup1,myGroup2            | STOP_%                                                                                                                                 | postgres
 STOP_GROUPS              | END               | myGroup1,myGroup2            | 15 tables/sequences processed                                                                                                          | postgres
 START_GROUPS             | BEGIN             | myGroup1,myGroup2            | Without log reset                                                                                                                      | postgres
 START_GROUPS             | TIME STAMP SET    | 14001                        |                                                                                                                                        | postgres
 LOCK_GROUPS              | BEGIN             | myGroup1,myGroup2            |                                                                                                                                        | postgres
 LOCK_GROUPS              | END               | myGroup1,myGroup2            | 11 tables locked, 0 deadlock(s)                                                                                                        | postgres
 SET_MARK_GROUPS          | BEGIN             | myGroup1,myGroup2            | Multi-1                                                                                                                                | postgres
 SET_MARK_GROUPS          | END               | myGroup1,myGroup2            | Multi-1                                                                                                                                | postgres
 START_GROUPS             | END               | myGroup1,myGroup2            | 15 tables/sequences processed                                                                                                          | postgres
 SET_MARK_GROUPS          | BEGIN             | myGroup1,myGroup2            | Multi-2                                                                                                                                | postgres
 LOCK_GROUPS              | BEGIN             | myGroup1,myGroup2            |                                                                                                                                        | postgres
 LOCK_GROUPS              | END               | myGroup1,myGroup2            | 11 tables locked, 0 deadlock(s)                                                                                                        | postgres
 SET_MARK_GROUPS          | TIME STAMP SET    | 14002                        |                                                                                                                                        | postgres
 SET_MARK_GROUPS          | END               | myGroup1,myGroup2            | Multi-2                                                                                                                                | postgres
 ROLLBACK_GROUPS          | BEGIN             | myGroup1,myGroup2            | Logged rollback to mark Multi-1 (timestamp)                                                                                            | postgres
 DBLINK_OPEN_CNX          |                   | rlbk#1                       | Status = 1                                                                                                                             | postgres
 LOCK_GROUP               | BEGIN             | myGroup1,myGroup2            | Rollback session #1                                                                                                                    | postgres
 LOCK_GROUP               | END               | myGroup1,myGroup2            | Rollback session #1: 11 tables locked, 0 deadlock(s)                                                                                   | postgres
 ROLLBACK_GROUPS          | TIME STAMP SET    | 14003                        |                                                                                                                                        | postgres
 SET_MARK_GROUPS          | BEGIN             | myGroup1,myGroup2            | RLBK_14000_START                                                                                                                       | postgres
 SET_MARK_GROUPS          | END               | myGroup1,myGroup2            | RLBK_14000_START                                                                                                                       | postgres
 ROLLBACK_GROUPS          | TIME STAMP SET    | 14004                        |                                                                                                                                        | postgres
 SET_MARK_GROUPS          | BEGIN             | myGroup1,myGroup2            | RLBK_14000_DONE                                                                                                                        | postgres
 SET_MARK_GROUPS          | END               | myGroup1,myGroup2            | RLBK_14000_DONE                                                                                                                        | postgres
 ROLLBACK_GROUPS          | NOTICE            | Rollback id 14000            | Rollback id = 14000.                                                                                                                   | postgres
 ROLLBACK_GROUPS          | NOTICE            | Rollback id 14000            | 0 / 11 tables effectively processed.                                                                                                   | postgres
 ROLLBACK_GROUPS          | NOTICE            | Rollback id 14000            | 0 / 4 sequences effectively processed.                                                                                                 | postgres
 DBLINK_CLOSE_CNX         |                   | rlbk#1                       |                                                                                                                                        | postgres
 ROLLBACK_GROUPS          | END               | myGroup1,myGroup2            | Rollback_id 14000                                                                                                                      | postgres
 ROLLBACK_GROUPS          | BEGIN             | myGroup1,myGroup2            | Unlogged rollback to mark Multi-2 (timestamp)                                                                                          | postgres
 DBLINK_OPEN_CNX          |                   | rlbk#1                       | Status = 1                                                                                                                             | postgres
 LOCK_GROUP               | BEGIN             | myGroup1,myGroup2            | Rollback session #1                                                                                                                    | postgres
 LOCK_GROUP               | END               | myGroup1,myGroup2            | Rollback session #1: 11 tables locked, 0 deadlock(s)                                                                                   | postgres
 ROLLBACK_GROUPS          | TIME STAMP SET    | 14005                        |                                                                                                                                        | postgres
 ROLLBACK_GROUPS          | MARK DELETED      | myGroup1                     | mark RLBK_14000_START is deleted                                                                                                       | postgres
 ROLLBACK_GROUPS          | MARK DELETED      | myGroup2                     | mark RLBK_14000_START is deleted                                                                                                       | postgres
 ROLLBACK_GROUPS          | MARK DELETED      | myGroup1                     | mark RLBK_14000_DONE is deleted                                                                                                        | postgres
 ROLLBACK_GROUPS          | MARK DELETED      | myGroup2                     | mark RLBK_14000_DONE is deleted                                                                                                        | postgres
 ROLLBACK_GROUPS          | NOTICE            | Rollback id 14001            | Rollback id = 14001.                                                                                                                   | postgres
 ROLLBACK_GROUPS          | NOTICE            | Rollback id 14001            | 0 / 11 tables effectively processed.                                                                                                   | postgres
 ROLLBACK_GROUPS          | NOTICE            | Rollback id 14001            | 0 / 4 sequences effectively processed.                                                                                                 | postgres
 DBLINK_CLOSE_CNX         |                   | rlbk#1                       |                                                                                                                                        | postgres
 ROLLBACK_GROUPS          | END               | myGroup1,myGroup2            | Rollback_id 14001                                                                                                                      | postgres
 ROLLBACK_GROUPS          | BEGIN             | myGroup1,myGroup2            | Unlogged rollback to mark Multi-1 (timestamp)                                                                                          | postgres
 DBLINK_OPEN_CNX          |                   | rlbk#1                       | Status = 1                                                                                                                             | postgres
 LOCK_GROUP               | BEGIN             | myGroup1,myGroup2            | Rollback session #1                                                                                                                    | postgres
 LOCK_GROUP               | END               | myGroup1,myGroup2            | Rollback session #1: 11 tables locked, 0 deadlock(s)                                                                                   | postgres
 ROLLBACK_GROUPS          | TIME STAMP SET    | 14006                        |                                                                                                                                        | postgres
 ROLLBACK_GROUPS          | MARK DELETED      | myGroup1                     | mark Multi-2 is deleted                                                                                                                | postgres
 ROLLBACK_GROUPS          | MARK DELETED      | myGroup2                     | mark Multi-2 is deleted                                                                                                                | postgres
 ROLLBACK_GROUPS          | NOTICE            | Rollback id 14002            | Rollback id = 14002.                                                                                                                   | postgres
 ROLLBACK_GROUPS          | NOTICE            | Rollback id 14002            | 0 / 11 tables effectively processed.                                                                                                   | postgres
 ROLLBACK_GROUPS          | NOTICE            | Rollback id 14002            | 0 / 4 sequences effectively processed.                                                                                                 | postgres
 DBLINK_CLOSE_CNX         |                   | rlbk#1                       |                                                                                                                                        | postgres
 ROLLBACK_GROUPS          | END               | myGroup1,myGroup2            | Rollback_id 14002                                                                                                                      | postgres
 STOP_GROUPS              | BEGIN             | myGroup1,myGroup2            |                                                                                                                                        | postgres
 STOP_GROUPS              | TIME STAMP SET    | 14007                        |                                                                                                                                        | postgres
 LOCK_GROUPS              | BEGIN             | myGroup1,myGroup2            |                                                                                                                                        | postgres
 LOCK_GROUPS              | END               | myGroup1,myGroup2            | 11 tables locked, 0 deadlock(s)                                                                                                        | postgres
 SET_MARK_GROUPS          | BEGIN             | myGroup1,myGroup2            | Stop after rollback                                                                                                                    | postgres
 CLEANUP_RLBK_STATE       |                   | Rollback id 14000            | set to COMMITTED                                                                                                                       | postgres
 CLEANUP_RLBK_STATE       |                   | Rollback id 14001            | set to COMMITTED                                                                                                                       | postgres
 CLEANUP_RLBK_STATE       |                   | Rollback id 14002            | set to COMMITTED                                                                                                                       | postgres
 SET_MARK_GROUPS          | END               | myGroup1,myGroup2            | Stop after rollback                                                                                                                    | postgres
 STOP_GROUPS              | END               | myGroup1,myGroup2            | 15 tables/sequences processed                                                                                                          | postgres
 START_GROUPS             | BEGIN             | myGroup1,myGroup2            | Without log reset                                                                                                                      | postgres
 START_GROUPS             | TIME STAMP SET    | 14009                        |                                                                                                                                        | postgres
 LOCK_GROUPS              | BEGIN             | myGroup1,myGroup2            |                                                                                                                                        | postgres
 LOCK_GROUPS              | END               | myGroup1,myGroup2            | 11 tables locked, 0 deadlock(s)                                                                                                        | postgres
 SET_MARK_GROUPS          | BEGIN             | myGroup1,myGroup2            | Multi-1b                                                                                                                               | postgres
 SET_MARK_GROUPS          | END               | myGroup1,myGroup2            | Multi-1b                                                                                                                               | postgres
 START_GROUPS             | END               | myGroup1,myGroup2            | 15 tables/sequences processed                                                                                                          | postgres
 SET_MARK_GROUPS          | BEGIN             | myGroup1,myGroup2            | Multi-2                                                                                                                                | postgres
 LOCK_GROUPS              | BEGIN             | myGroup1,myGroup2            |                                                                                                                                        | postgres
 LOCK_GROUPS              | END               | myGroup1,myGroup2            | 11 tables locked, 0 deadlock(s)                                                                                                        | postgres
 SET_MARK_GROUPS          | TIME STAMP SET    | 14010                        |                                                                                                                                        | postgres
 SET_MARK_GROUPS          | END               | myGroup1,myGroup2            | Multi-2                                                                                                                                | postgres
 DELETE_MARK_GROUP        | BEGIN             | myGroup1                     | Multi-2                                                                                                                                | postgres
 DELETE_MARK_GROUP        | END               | myGroup1                     | Multi-2                                                                                                                                | postgres
 ROLLBACK_GROUP           | BEGIN             | myGroup2                     | Unlogged rollback to mark Multi-2 (timestamp)                                                                                          | postgres
 DBLINK_OPEN_CNX          |                   | rlbk#1                       | Status = 1                                                                                                                             | postgres
 LOCK_GROUP               | BEGIN             | myGroup2                     | Rollback session #1                                                                                                                    | postgres
 LOCK_GROUP               | END               | myGroup2                     | Rollback session #1: 6 tables locked, 0 deadlock(s)                                                                                    | postgres
 ROLLBACK_GROUP           | TIME STAMP SET    | 14011                        |                                                                                                                                        | postgres
 ROLLBACK_GROUP           | NOTICE            | Rollback id 14003            | Rollback id = 14003.                                                                                                                   | postgres
 ROLLBACK_GROUP           | NOTICE            | Rollback id 14003            | 0 / 6 tables effectively processed.                                                                                                    | postgres
 ROLLBACK_GROUP           | NOTICE            | Rollback id 14003            | 0 / 2 sequences effectively processed.                                                                                                 | postgres
 DBLINK_CLOSE_CNX         |                   | rlbk#1                       |                                                                                                                                        | postgres
 ROLLBACK_GROUP           | END               | myGroup2                     | Rollback_id 14003                                                                                                                      | postgres
 DELETE_MARK_GROUP        | BEGIN             | myGroup2                     | Multi-2                                                                                                                                | postgres
 DELETE_MARK_GROUP        | END               | myGroup2                     | Multi-2                                                                                                                                | postgres
 DELETE_MARK_GROUP        | BEGIN             | myGroup1                     | Multi-1                                                                                                                                | postgres
 DELETE_MARK_GROUP        | END               | myGroup1                     | Multi-1                                                                                                                                | postgres
 DELETE_MARK_GROUP        | BEGIN             | myGroup2                     | Multi-1                                                                                                                                | postgres
 DELETE_MARK_GROUP        | END               | myGroup2                     | Multi-1                                                                                                                                | postgres
 RENAME_MARK_GROUP        | BEGIN             | myGroup1                     | Multi-1b                                                                                                                               | postgres
 RENAME_MARK_GROUP        | END               | myGroup1                     | Multi-1b renamed Multi-1                                                                                                               | postgres
 RENAME_MARK_GROUP        | BEGIN             | myGroup2                     | Multi-1b                                                                                                                               | postgres
 RENAME_MARK_GROUP        | END               | myGroup2                     | Multi-1b renamed Multi-1                                                                                                               | postgres
 RENAME_MARK_GROUP        | BEGIN             | myGroup2                     | M2                                                                                                                                     | postgres
 RENAME_MARK_GROUP        | END               | myGroup2                     | M2 renamed Deleted M2                                                                                                                  | postgres
 DELETE_BEFORE_MARK_GROUP | BEGIN             | myGroup2                     | M3                                                                                                                                     | postgres
 DELETE_BEFORE_MARK_GROUP | END               | myGroup2                     | 2 marks deleted ; M3 is now the initial mark                                                                                           | postgres
 COMMENT_MARK_GROUP       |                   | myGroup2                     | Mark M3                                                                                                                                | postgres
(115 rows)

-- log tables
reset role;
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid 
-------+------------+-------+-----------+------------+----------
     1 | Step 6     | \x01  | INS       | NEW        | 12600004
     1 | Step 6     | \x01  | DEL       | OLD        | 12600029
(2 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 | col23 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-----------+------------+----------
(0 rows)

select col20, col21, col22, col23, col24, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl2b_log order by emaj_gid, emaj_tuple desc;
 col20 | col21 | col22 | col23 | col24 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+-------+-----------+------------+----------
(0 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema1."myTbl3_log" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
    11 | 10.00 | UPD       | OLD        | 12400015
    11 |  5.00 | UPD       | NEW        | 12400015
    12 | 10.00 | UPD       | OLD        | 12400016
    12 |  5.00 | UPD       | NEW        | 12400016
    13 | 10.00 | UPD       | OLD        | 12400017
    13 |  5.00 | UPD       | NEW        | 12400017
    14 | 10.00 | UPD       | OLD        | 12400018
    14 |  5.00 | UPD       | NEW        | 12400018
    15 | 10.00 | UPD       | OLD        | 12400019
    15 |  5.00 | UPD       | NEW        | 12400019
    16 | 10.00 | UPD       | OLD        | 12400020
    16 |  5.00 | UPD       | NEW        | 12400020
    17 | 10.00 | UPD       | OLD        | 12400021
    17 |  5.00 | UPD       | NEW        | 12400021
    18 | 10.00 | UPD       | OLD        | 12400022
    18 |  5.00 | UPD       | NEW        | 12400022
    19 | 10.00 | UPD       | OLD        | 12400023
    19 |  5.00 | UPD       | NEW        | 12400023
    20 | 10.00 | UPD       | OLD        | 12400024
    20 |  5.00 | UPD       | NEW        | 12400024
    11 |  5.00 | DEL       | OLD        | 12600007
    12 |  5.00 | DEL       | OLD        | 12600008
    13 |  5.00 | DEL       | OLD        | 12600009
    14 |  5.00 | DEL       | OLD        | 12600010
    15 |  5.00 | DEL       | OLD        | 12600011
    16 |  5.00 | DEL       | OLD        | 12600012
    17 |  5.00 | DEL       | OLD        | 12600013
    18 |  5.00 | DEL       | OLD        | 12600014
    19 |  5.00 | DEL       | OLD        | 12600015
    20 |  5.00 | DEL       | OLD        | 12600016
    11 | 10.00 | INS       | NEW        | 12600017
    12 | 10.00 | INS       | NEW        | 12600018
    13 | 10.00 | INS       | NEW        | 12600019
    14 | 10.00 | INS       | NEW        | 12600020
    15 | 10.00 | INS       | NEW        | 12600021
    16 | 10.00 | INS       | NEW        | 12600022
    17 | 10.00 | INS       | NEW        | 12600023
    18 | 10.00 | INS       | NEW        | 12600024
    19 | 10.00 | INS       | NEW        | 12600025
    20 | 10.00 | INS       | NEW        | 12600026
    14 | 10.00 | DEL       | OLD        | 12700001
    15 | 10.00 | DEL       | OLD        | 12700002
    16 | 10.00 | DEL       | OLD        | 12700003
    17 | 10.00 | DEL       | OLD        | 12700004
    18 | 10.00 | DEL       | OLD        | 12700005
(45 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 | col45  | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+--------+-----------+------------+----------
    11 |       |     1 |     1 | Step 6 | INS       | NEW        | 12600005
    12 |       |     1 |     1 | Step 6 | INS       | NEW        | 12600006
    11 |       |     1 |     1 | Step 6 | DEL       | OLD        | 12600027
    12 |       |     1 |     1 | Step 6 | DEL       | OLD        | 12600028
(4 rows)

select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 | col12 | col13 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-----------+------------+----------
(0 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 | col23 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-----------+------------+----------
(0 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema2."myTbl3_log" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
(0 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema2.mytbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 | col45 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+-------+-----------+------------+----------
(0 rows)

select col51, col52, col53, col54, col55, col56, col57, col58, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema2.mytbl5_log order by emaj_gid, emaj_tuple desc;
 col51 | col52 | col53 | col54 | col55 | col56 | col57 | col58 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+-------+-------+-------+-------+-----------+------------+----------
(0 rows)

select col61, col62, col63, col64, col65, col66, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl6_log order by emaj_gid, emaj_tuple desc;
 col61 | col62 | col63 | col64 | col65 | col66 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+-------+-------+-----------+------------+----------
(0 rows)

-- set sequence restart value
select public.handle_emaj_sequences(14200);
 handle_emaj_sequences 
-----------------------
 
(1 row)

-----------------------------
-- Step 9 : for phil''s group#3", recreate the group as rollbackable, update tables, 
--          rename a mark, then delete 2 marks then delete all before a mark 
-----------------------------
-- prepare phil's group#3, group
--
reset role;
alter table "phil's schema""3"."myTbl2\" add primary key (col21);
set role emaj_regression_tests_adm_user2;
select emaj.emaj_create_group('phil''s group#3",');
 emaj_create_group 
-------------------
                 1
(1 row)

select emaj.emaj_assign_tables('phil''s schema"3','.*','my"tbl4','phil''s group#3",');
NOTICE:  table "myTbl2\_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "phil's schema"3.myTbl2\" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "phil's schema"3.myTbl2\" does not exist, skipping
NOTICE:  table "phil's tbl1_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "phil's schema"3.phil's tbl1" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "phil's schema"3.phil's tbl1" does not exist, skipping
 emaj_assign_tables 
--------------------
                  2
(1 row)

select emaj.emaj_assign_sequences('phil''s schema"3','.*',null,'phil''s group#3",');
 emaj_assign_sequences 
-----------------------
                     2
(1 row)

select emaj.emaj_start_group('phil''s group#3",','M1_rollbackable');
WARNING:  _check_fk_groups: The foreign key "mytbl2_col21_fkey" on the table "phil's schema"3.myTbl2\" references the table "phil's schema"3.my"tbl4" that is outside the groups (phil's group#3",).
WARNING:  _check_fk_groups: The table "phil's schema"3.phil's tbl1" is referenced by the foreign key "my"tbl4_col44_fkey" on the table "phil's schema"3.my"tbl4" that is outside the groups (phil's group#3",).
 emaj_start_group 
------------------
                4
(1 row)

--
reset role;
set search_path=public,"phil's schema""3";
--
insert into "phil's tbl1" select i, 'AB''C', E'\\014'::bytea from generate_series (1,31) as i;
update "phil's tbl1" set "phil\s""col13" = E'\\034'::bytea where "phil's col11" <= 3;
update "phil's tbl1" set "phil\s""col13" = E'\\034'''::bytea where "phil's col11" between 18 and 22;
insert into "my""tbl4" (col41) values (1);
insert into "my""tbl4" (col41) values (2);
insert into "myTbl2\" values (1,'ABC','2010-12-31');
delete from "phil's tbl1" where "phil's col11" > 20;
insert into "myTbl2\" values (2,'DEF',NULL);
select nextval(E'"phil''s schema""3"."phil''s""seq\\1"');
 nextval 
---------
    1000
(1 row)

--
set role emaj_regression_tests_adm_user2;
select emaj.emaj_set_mark_group('phil''s group#3",','M2_rollbackable');
 emaj_set_mark_group 
---------------------
                   4
(1 row)

select emaj.emaj_set_mark_group('phil''s group#3",','M2_again!');
 emaj_set_mark_group 
---------------------
                   4
(1 row)

--
reset role;
delete from "phil's tbl1" where "phil's col11" = 10;
update "phil's tbl1" set "phil's col12" = 'DEF' where "phil's col11" <= 2;
select nextval(E'"phil''s schema""3"."phil''s""seq\\1"');
 nextval 
---------
    1001
(1 row)

--
set role emaj_regression_tests_adm_user2;
select emaj.emaj_set_mark_groups(array['phil''s group#3",'],'phil''s mark #1','Third mark set');
 emaj_set_mark_groups 
----------------------
                    4
(1 row)

--
select emaj.emaj_rename_mark_group('phil''s group#3",','phil''s mark #1','phil''s mark #3');
 emaj_rename_mark_group 
------------------------
 
(1 row)

-- 
select emaj.emaj_delete_mark_group('phil''s group#3",','M2_again!');
 emaj_delete_mark_group 
------------------------
                      1
(1 row)

--
select stat_group, stat_schema, stat_table, stat_first_mark, stat_last_mark, stat_rows from emaj.emaj_log_stat_group('phil''s group#3",','M1_rollbackable','');
    stat_group    |   stat_schema   | stat_table  | stat_first_mark | stat_last_mark | stat_rows 
------------------+-----------------+-------------+-----------------+----------------+-----------
 phil's group#3", | phil's schema"3 | myTbl2\     | M1_rollbackable |                |         2
 phil's group#3", | phil's schema"3 | phil's tbl1 | M1_rollbackable |                |        53
(2 rows)

select stat_group, stat_schema, stat_table, stat_first_mark, stat_last_mark, stat_role, stat_verb, stat_rows
  from emaj.emaj_detailed_log_stat_group('phil''s group#3",','phil''s mark #3','');
 stat_group | stat_schema | stat_table | stat_first_mark | stat_last_mark | stat_role | stat_verb | stat_rows 
------------+-------------+------------+-----------------+----------------+-----------+-----------+-----------
(0 rows)

--
select * from emaj.emaj_logged_rollback_group('phil''s group#3",','phil''s mark #3',false) order by 1,2;
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | 0 / 2 sequences effectively processed.
 Notice        | 0 / 2 tables effectively processed.
 Notice        | Rollback id = 14200.
(3 rows)

select * from emaj.emaj_rollback_group('phil''s group#3",','phil''s mark #3',false) order by 1,2;
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | 0 / 2 sequences effectively processed.
 Notice        | 0 / 2 tables effectively processed.
 Notice        | Rollback id = 14201.
(3 rows)

-----------------------------
-- Checking step 9
-----------------------------
-- emaj tables
select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_time_id, mark_group;
    mark_group    |        regexp_replace        | mark_time_id | mark_is_rlbk_protected |                  mark_comment                  | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------------+------------------------------+--------------+------------------------+------------------------------------------------+---------------------------+------------------------------
 myGroup2         | M3                           |        12201 | f                      | This mark is old                               |                         0 | 
 myGroup1         | M4                           |        12401 | f                      |                                                |                        10 | 
 myGroup1         | M5                           |        12402 | f                      |                                                |                         3 | 
 myGroup1         | Before logged rollback to M4 |        12601 | f                      | Automatically set at rollback to mark M4 start |                        28 | 
 myGroup1         | STOP_%                       |        14000 | f                      |                                                |                         0 | 
 myGroup2         | STOP_%                       |        14000 | f                      |                                                |                         0 | 
 myGroup1         | Stop after rollback          |        14007 | f                      |                                                |                         0 | 
 myGroup2         | Stop after rollback          |        14007 | f                      |                                                |                         0 | 
 myGroup1         | Multi-1                      |        14009 | f                      |                                                |                           | 
 myGroup2         | Multi-1                      |        14009 | f                      |                                                |                           | 
 phil's group#3", | M1_rollbackable              |        14203 | f                      |                                                |                        52 | 
 phil's group#3", | M2_rollbackable              |        14204 | f                      |                                                |                         3 | 
 phil's group#3", | phil's mark #3               |        14206 | f                      | Third mark set                                 |                           | 
(13 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
   sequ_schema   |     sequ_name     | sequ_time_id | sequ_last_val | sequ_is_called 
-----------------+-------------------+--------------+---------------+----------------
 myschema2       | myTbl3_col31_seq  |        12201 |            20 | t
 myschema2       | myseq1            |        12201 |          1003 | t
 myschema1       | myTbl3_col31_seq  |        12401 |            20 | t
 myschema1       | mytbl2b_col20_seq |        12401 |             5 | t
 myschema1       | myTbl3_col31_seq  |        12402 |            20 | t
 myschema1       | mytbl2b_col20_seq |        12402 |             5 | t
 myschema1       | myTbl3_col31_seq  |        12601 |            20 | t
 myschema1       | mytbl2b_col20_seq |        12601 |             5 | t
 myschema1       | myTbl3_col31_seq  |        12602 |            20 | t
 myschema1       | mytbl2b_col20_seq |        12602 |             5 | t
 myschema1       | myTbl3_col31_seq  |        14000 |            20 | t
 myschema1       | mytbl2b_col20_seq |        14000 |             5 | t
 myschema2       | myTbl3_col31_seq  |        14000 |            20 | t
 myschema2       | myseq1            |        14000 |          1004 | f
 myschema1       | myTbl3_col31_seq  |        14001 |            20 | t
 myschema1       | mytbl2b_col20_seq |        14001 |             5 | t
 myschema2       | myTbl3_col31_seq  |        14001 |            20 | t
 myschema2       | myseq1            |        14001 |          1004 | f
 myschema1       | myTbl3_col31_seq  |        14007 |            20 | t
 myschema1       | mytbl2b_col20_seq |        14007 |             5 | t
 myschema2       | myTbl3_col31_seq  |        14007 |            20 | t
 myschema2       | myseq1            |        14007 |          1004 | f
 myschema1       | myTbl3_col31_seq  |        14009 |            20 | t
 myschema1       | mytbl2b_col20_seq |        14009 |             5 | t
 myschema2       | myTbl3_col31_seq  |        14009 |            20 | t
 myschema2       | myseq1            |        14009 |          1004 | f
 myschema1       | myTbl3_col31_seq  |        14010 |            20 | t
 myschema1       | mytbl2b_col20_seq |        14010 |             5 | t
 myschema2       | myTbl3_col31_seq  |        14010 |            20 | t
 myschema2       | myseq1            |        14010 |          1004 | f
 phil's schema"3 | myTbl2\_col21_seq |        14203 |             1 | f
 phil's schema"3 | phil's"seq\1      |        14203 |          1000 | f
 phil's schema"3 | myTbl2\_col21_seq |        14204 |             1 | f
 phil's schema"3 | phil's"seq\1      |        14204 |          1000 | t
 phil's schema"3 | myTbl2\_col21_seq |        14205 |             1 | f
 phil's schema"3 | phil's"seq\1      |        14205 |          1000 | t
 phil's schema"3 | myTbl2\_col21_seq |        14206 |             1 | f
 phil's schema"3 | phil's"seq\1      |        14206 |          1001 | t
(38 rows)

select tbl_schema, tbl_name, tbl_time_id, tbl_log_seq_last_val from emaj.emaj_table order by tbl_time_id, tbl_schema, tbl_name;
   tbl_schema    |  tbl_name   | tbl_time_id | tbl_log_seq_last_val 
-----------------+-------------+-------------+----------------------
 myschema2       | myTbl3      |       12201 |                   10
 myschema2       | mytbl1      |       12201 |                   15
 myschema2       | mytbl2      |       12201 |                    2
 myschema2       | mytbl4      |       12201 |                    4
 myschema2       | mytbl5      |       12201 |                    4
 myschema2       | mytbl6      |       12201 |                   14
 myschema1       | myTbl3      |       12401 |                   10
 myschema1       | mytbl1      |       12401 |                   30
 myschema1       | mytbl2      |       12401 |                    3
 myschema1       | mytbl2b     |       12401 |                    3
 myschema1       | mytbl4      |       12401 |                    8
 myschema1       | myTbl3      |       12402 |                   20
 myschema1       | mytbl1      |       12402 |                   30
 myschema1       | mytbl2      |       12402 |                    3
 myschema1       | mytbl2b     |       12402 |                    3
 myschema1       | mytbl4      |       12402 |                    8
 myschema1       | myTbl3      |       12601 |                   20
 myschema1       | mytbl1      |       12601 |                   32
 myschema1       | mytbl2      |       12601 |                    3
 myschema1       | mytbl2b     |       12601 |                    3
 myschema1       | mytbl4      |       12601 |                   12
 myschema1       | myTbl3      |       12602 |                   40
 myschema1       | mytbl1      |       12602 |                   33
 myschema1       | mytbl2      |       12602 |                    3
 myschema1       | mytbl2b     |       12602 |                    3
 myschema1       | mytbl4      |       12602 |                   14
 myschema1       | myTbl3      |       14000 |                   45
 myschema1       | mytbl1      |       14000 |                   33
 myschema1       | mytbl2      |       14000 |                    3
 myschema1       | mytbl2b     |       14000 |                    3
 myschema1       | mytbl4      |       14000 |                   14
 myschema2       | myTbl3      |       14000 |                   10
 myschema2       | mytbl1      |       14000 |                   15
 myschema2       | mytbl2      |       14000 |                    2
 myschema2       | mytbl4      |       14000 |                   10
 myschema2       | mytbl5      |       14000 |                    7
 myschema2       | mytbl6      |       14000 |                   23
 myschema1       | myTbl3      |       14001 |                   45
 myschema1       | mytbl1      |       14001 |                   33
 myschema1       | mytbl2      |       14001 |                    3
 myschema1       | mytbl2b     |       14001 |                    3
 myschema1       | mytbl4      |       14001 |                   14
 myschema2       | myTbl3      |       14001 |                   10
 myschema2       | mytbl1      |       14001 |                   15
 myschema2       | mytbl2      |       14001 |                    2
 myschema2       | mytbl4      |       14001 |                   10
 myschema2       | mytbl5      |       14001 |                    7
 myschema2       | mytbl6      |       14001 |                   23
 myschema1       | myTbl3      |       14007 |                   45
 myschema1       | mytbl1      |       14007 |                   33
 myschema1       | mytbl2      |       14007 |                    3
 myschema1       | mytbl2b     |       14007 |                    3
 myschema1       | mytbl4      |       14007 |                   14
 myschema2       | myTbl3      |       14007 |                   10
 myschema2       | mytbl1      |       14007 |                   15
 myschema2       | mytbl2      |       14007 |                    2
 myschema2       | mytbl4      |       14007 |                   10
 myschema2       | mytbl5      |       14007 |                    7
 myschema2       | mytbl6      |       14007 |                   23
 myschema1       | myTbl3      |       14009 |                   45
 myschema1       | mytbl1      |       14009 |                   33
 myschema1       | mytbl2      |       14009 |                    3
 myschema1       | mytbl2b     |       14009 |                    3
 myschema1       | mytbl4      |       14009 |                   14
 myschema2       | myTbl3      |       14009 |                   10
 myschema2       | mytbl1      |       14009 |                   15
 myschema2       | mytbl2      |       14009 |                    2
 myschema2       | mytbl4      |       14009 |                   10
 myschema2       | mytbl5      |       14009 |                    7
 myschema2       | mytbl6      |       14009 |                   23
 myschema1       | myTbl3      |       14010 |                   45
 myschema1       | mytbl1      |       14010 |                   33
 myschema1       | mytbl2      |       14010 |                    3
 myschema1       | mytbl2b     |       14010 |                    3
 myschema1       | mytbl4      |       14010 |                   14
 myschema2       | myTbl3      |       14010 |                   10
 myschema2       | mytbl1      |       14010 |                   15
 myschema2       | mytbl2      |       14010 |                    2
 myschema2       | mytbl4      |       14010 |                   10
 myschema2       | mytbl5      |       14010 |                    7
 myschema2       | mytbl6      |       14010 |                   23
 phil's schema"3 | myTbl2\     |       14203 |                    0
 phil's schema"3 | phil's tbl1 |       14203 |                    0
 phil's schema"3 | myTbl2\     |       14204 |                    2
 phil's schema"3 | phil's tbl1 |       14204 |                   50
 phil's schema"3 | myTbl2\     |       14205 |                    2
 phil's schema"3 | phil's tbl1 |       14205 |                   50
 phil's schema"3 | myTbl2\     |       14206 |                    2
 phil's schema"3 | phil's tbl1 |       14206 |                   53
(89 rows)

select sqhl_schema, sqhl_table, sqhl_begin_time_id, sqhl_end_time_id, sqhl_hole_size from emaj.emaj_seq_hole order by 1,2,3;
 sqhl_schema | sqhl_table | sqhl_begin_time_id | sqhl_end_time_id | sqhl_hole_size 
-------------+------------+--------------------+------------------+----------------
 myschema1   | mytbl1     |              12402 |            12600 |              1
 myschema1   | mytbl4     |              12402 |            12600 |              2
 myschema2   | mytbl4     |              12201 |            12502 |              6
 myschema2   | mytbl5     |              12201 |            12502 |              3
 myschema2   | mytbl6     |              12201 |            12502 |              9
(5 rows)

select rlbt_rlbk_id, rlbt_step, rlbt_schema, rlbt_table, rlbt_object, rlbt_quantity from emaj.emaj_rlbk_stat
  order by rlbt_rlbk_id, rlbt_step, rlbt_schema, rlbt_table, rlbt_object;
 rlbt_rlbk_id |   rlbt_step    | rlbt_schema | rlbt_table |    rlbt_object    | rlbt_quantity 
--------------+----------------+-------------+------------+-------------------+---------------
        12300 | RLBK_SEQUENCES |             |            |                   |             2
        12300 | SET_FK_DEF     |             |            |                   |             2
        12300 | RLBK_TABLE     | myschema2   | mytbl4     |                   |             4
        12300 | RLBK_TABLE     | myschema2   | mytbl5     |                   |             1
        12300 | RLBK_TABLE     | myschema2   | mytbl6     |                   |             3
        12300 | SET_FK_IMM     | myschema2   | mytbl6     | mytbl6_col61_fkey |             3
        12300 | SET_FK_IMM     | myschema2   | mytbl8     | mytbl8_col81_fkey |             3
        12300 | CTRL-DBLINK    |             |            |                   |             8
        12301 | RLBK_SEQUENCES |             |            |                   |             2
        12301 | SET_FK_DEF     |             |            |                   |             2
        12301 | RLBK_TABLE     | myschema2   | mytbl4     |                   |             2
        12301 | RLBK_TABLE     | myschema2   | mytbl5     |                   |             1
        12301 | RLBK_TABLE     | myschema2   | mytbl6     |                   |             3
        12301 | SET_FK_IMM     | myschema2   | mytbl6     | mytbl6_col61_fkey |             3
        12301 | SET_FK_IMM     | myschema2   | mytbl8     | mytbl8_col81_fkey |             3
        12301 | CTRL-DBLINK    |             |            |                   |             8
        12400 | RLBK_SEQUENCES |             |            |                   |             2
        12400 | DIS_LOG_TRG    |             |            |                   |             2
        12400 | RLBK_TABLE     | myschema1   | mytbl1     |                   |             3
        12400 | RLBK_TABLE     | myschema1   | mytbl4     |                   |             8
        12400 | DELETE_LOG     | myschema1   | mytbl1     |                   |             3
        12400 | DELETE_LOG     | myschema1   | mytbl4     |                   |             8
        12400 | ENA_LOG_TRG    |             |            |                   |             2
        12400 | CTRL+DBLINK    |             |            |                   |             9
        12500 | RLBK_SEQUENCES |             |            |                   |             2
        12500 | SET_FK_DEF     |             |            |                   |             2
        12500 | RLBK_TABLE     | myschema2   | mytbl4     |                   |             8
        12500 | RLBK_TABLE     | myschema2   | mytbl5     |                   |             3
        12500 | RLBK_TABLE     | myschema2   | mytbl6     |                   |             9
        12500 | SET_FK_IMM     | myschema2   | mytbl6     | mytbl6_col61_fkey |             9
        12500 | SET_FK_IMM     | myschema2   | mytbl8     | mytbl8_col81_fkey |             9
        12500 | CTRL+DBLINK    |             |            |                   |             8
        12501 | RLBK_SEQUENCES |             |            |                   |             2
        12501 | DIS_LOG_TRG    |             |            |                   |             3
        12501 | SET_FK_DEF     |             |            |                   |             2
        12501 | RLBK_TABLE     | myschema2   | mytbl4     |                   |             6
        12501 | RLBK_TABLE     | myschema2   | mytbl5     |                   |             3
        12501 | RLBK_TABLE     | myschema2   | mytbl6     |                   |             9
        12501 | DELETE_LOG     | myschema2   | mytbl4     |                   |             6
        12501 | DELETE_LOG     | myschema2   | mytbl5     |                   |             3
        12501 | DELETE_LOG     | myschema2   | mytbl6     |                   |             9
        12501 | SET_FK_IMM     | myschema2   | mytbl6     | mytbl6_col61_fkey |             9
        12501 | SET_FK_IMM     | myschema2   | mytbl8     | mytbl8_col81_fkey |             9
        12501 | ENA_LOG_TRG    |             |            |                   |             3
        12501 | CTRL+DBLINK    |             |            |                   |            17
        12600 | RLBK_SEQUENCES |             |            |                   |             2
        12600 | DIS_LOG_TRG    |             |            |                   |             2
        12600 | RLBK_TABLE     | myschema1   | mytbl1     |                   |             1
        12600 | RLBK_TABLE     | myschema1   | mytbl4     |                   |             2
        12600 | DELETE_LOG     | myschema1   | mytbl1     |                   |             1
        12600 | DELETE_LOG     | myschema1   | mytbl4     |                   |             2
        12600 | ENA_LOG_TRG    |             |            |                   |             2
        12600 | CTRL+DBLINK    |             |            |                   |             9
        12601 | RLBK_SEQUENCES |             |            |                   |             2
        12601 | RLBK_TABLE     | myschema1   | myTbl3     |                   |            10
        12601 | RLBK_TABLE     | myschema1   | mytbl1     |                   |             1
        12601 | RLBK_TABLE     | myschema1   | mytbl4     |                   |             2
        12601 | CTRL+DBLINK    |             |            |                   |             4
        14000 | RLBK_SEQUENCES |             |            |                   |             4
        14000 | CTRL+DBLINK    |             |            |                   |             1
        14001 | RLBK_SEQUENCES |             |            |                   |             4
        14001 | CTRL+DBLINK    |             |            |                   |             1
        14002 | RLBK_SEQUENCES |             |            |                   |             4
        14002 | CTRL+DBLINK    |             |            |                   |             1
        14003 | RLBK_SEQUENCES |             |            |                   |             2
        14003 | CTRL+DBLINK    |             |            |                   |             1
        14200 | RLBK_SEQUENCES |             |            |                   |             2
        14200 | CTRL+DBLINK    |             |            |                   |             1
        14201 | RLBK_SEQUENCES |             |            |                   |             2
        14201 | CTRL+DBLINK    |             |            |                   |             1
(70 rows)

select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 14200 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
   14200 |           14200000 | C
   14201 |           14200000 | A
   14202 |           14200000 | A
   14203 |           14200000 | S
   14204 |           14200052 | M
   14205 |           14200052 | M
   14206 |           14200055 | M
   14207 |           14200055 | R
   14208 |           14200055 | M
   14209 |           14200055 | R
(10 rows)

select hist_function, hist_event, hist_object,
       regexp_replace(regexp_replace(regexp_replace(hist_wording,
            E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),
            E'\\d\\d\\d\\d/\\d\\d\\/\\d\\d\\ \\d\\d\\:\\d\\d:\\d\\d .*?\\)','<timestamp>)','g'),
            E'\\[.+\\]','(timestamp)','g'), 
       hist_user
  from emaj.emaj_hist where hist_id >= 14200 order by hist_id;
   hist_function    |     hist_event     |              hist_object               |                    regexp_replace                    | hist_user 
--------------------+--------------------+----------------------------------------+------------------------------------------------------+-----------
 CREATE_GROUP       | BEGIN              | phil's group#3",                       | rollbackable                                         | postgres
 CREATE_GROUP       | TIME STAMP SET     | 14200                                  |                                                      | postgres
 CREATE_GROUP       | END                | phil's group#3",                       |                                                      | postgres
 ASSIGN_TABLES      | BEGIN              |                                        |                                                      | postgres
 ASSIGN_TABLES      | TIME STAMP SET     | 14201                                  |                                                      | postgres
 ASSIGN_TABLES      | LOG_SCHEMA CREATED | "emaj_phil's schema""3"                |                                                      | postgres
 ASSIGN_TABLES      | TABLE ADDED        | "phil's schema""3"."myTbl2\"           | To the idle group phil's group#3",                   | postgres
 ASSIGN_TABLES      | TABLE ADDED        | "phil's schema""3"."phil's tbl1"       | To the idle group phil's group#3",                   | postgres
 ASSIGN_TABLES      | END                |                                        | 2 tables assigned to the group phil's group#3",      | postgres
 ASSIGN_SEQUENCES   | BEGIN              |                                        |                                                      | postgres
 ASSIGN_SEQUENCES   | TIME STAMP SET     | 14202                                  |                                                      | postgres
 ASSIGN_SEQUENCES   | SEQUENCE ADDED     | "phil's schema""3"."myTbl2\_col21_seq" | To the idle group phil's group#3",                   | postgres
 ASSIGN_SEQUENCES   | SEQUENCE ADDED     | "phil's schema""3"."phil's""seq\1"     | To the idle group phil's group#3",                   | postgres
 ASSIGN_SEQUENCES   | END                |                                        | 2 sequences assigned to the group phil's group#3",   | postgres
 START_GROUP        | BEGIN              | phil's group#3",                       | With log reset                                       | postgres
 START_GROUP        | TIME STAMP SET     | 14203                                  |                                                      | postgres
 LOCK_GROUP         | BEGIN              | phil's group#3",                       |                                                      | postgres
 LOCK_GROUP         | END                | phil's group#3",                       | 2 tables locked, 0 deadlock(s)                       | postgres
 SET_MARK_GROUP     | BEGIN              | phil's group#3",                       | M1_rollbackable                                      | postgres
 CLEANUP_RLBK_STATE |                    | Rollback id 14003                      | set to COMMITTED                                     | postgres
 SET_MARK_GROUP     | END                | phil's group#3",                       | M1_rollbackable                                      | postgres
 START_GROUP        | END                | phil's group#3",                       | 4 tables/sequences processed                         | postgres
 SET_MARK_GROUP     | BEGIN              | phil's group#3",                       |                                                      | postgres
 LOCK_GROUP         | BEGIN              | phil's group#3",                       |                                                      | postgres
 LOCK_GROUP         | END                | phil's group#3",                       | 2 tables locked, 0 deadlock(s)                       | postgres
 SET_MARK_GROUP     | TIME STAMP SET     | 14204                                  |                                                      | postgres
 SET_MARK_GROUP     | END                | phil's group#3",                       | M2_rollbackable                                      | postgres
 SET_MARK_GROUP     | BEGIN              | phil's group#3",                       |                                                      | postgres
 LOCK_GROUP         | BEGIN              | phil's group#3",                       |                                                      | postgres
 LOCK_GROUP         | END                | phil's group#3",                       | 2 tables locked, 0 deadlock(s)                       | postgres
 SET_MARK_GROUP     | TIME STAMP SET     | 14205                                  |                                                      | postgres
 SET_MARK_GROUP     | END                | phil's group#3",                       | M2_again!                                            | postgres
 SET_MARK_GROUPS    | BEGIN              | phil's group#3",                       | phil's mark #1                                       | postgres
 LOCK_GROUPS        | BEGIN              | phil's group#3",                       |                                                      | postgres
 LOCK_GROUPS        | END                | phil's group#3",                       | 2 tables locked, 0 deadlock(s)                       | postgres
 SET_MARK_GROUPS    | TIME STAMP SET     | 14206                                  |                                                      | postgres
 SET_MARK_GROUPS    | END                | phil's group#3",                       | phil's mark #1                                       | postgres
 RENAME_MARK_GROUP  | BEGIN              | phil's group#3",                       | phil's mark #1                                       | postgres
 RENAME_MARK_GROUP  | END                | phil's group#3",                       | phil's mark #1 renamed phil's mark #3                | postgres
 DELETE_MARK_GROUP  | BEGIN              | phil's group#3",                       | M2_again!                                            | postgres
 DELETE_MARK_GROUP  | END                | phil's group#3",                       | M2_again!                                            | postgres
 ROLLBACK_GROUP     | BEGIN              | phil's group#3",                       | Logged rollback to mark phil's mark #3 (timestamp)   | postgres
 DBLINK_OPEN_CNX    |                    | rlbk#1                                 | Status = 1                                           | postgres
 LOCK_GROUP         | BEGIN              | phil's group#3",                       | Rollback session #1                                  | postgres
 LOCK_GROUP         | END                | phil's group#3",                       | Rollback session #1: 2 tables locked, 0 deadlock(s)  | postgres
 ROLLBACK_GROUP     | TIME STAMP SET     | 14207                                  |                                                      | postgres
 SET_MARK_GROUP     | BEGIN              | phil's group#3",                       | RLBK_14200_START                                     | postgres
 SET_MARK_GROUP     | END                | phil's group#3",                       | RLBK_14200_START                                     | postgres
 ROLLBACK_GROUP     | TIME STAMP SET     | 14208                                  |                                                      | postgres
 SET_MARK_GROUP     | BEGIN              | phil's group#3",                       | RLBK_14200_DONE                                      | postgres
 SET_MARK_GROUP     | END                | phil's group#3",                       | RLBK_14200_DONE                                      | postgres
 ROLLBACK_GROUP     | NOTICE             | Rollback id 14200                      | Rollback id = 14200.                                 | postgres
 ROLLBACK_GROUP     | NOTICE             | Rollback id 14200                      | 0 / 2 tables effectively processed.                  | postgres
 ROLLBACK_GROUP     | NOTICE             | Rollback id 14200                      | 0 / 2 sequences effectively processed.               | postgres
 DBLINK_CLOSE_CNX   |                    | rlbk#1                                 |                                                      | postgres
 ROLLBACK_GROUP     | END                | phil's group#3",                       | Rollback_id 14200                                    | postgres
 ROLLBACK_GROUP     | BEGIN              | phil's group#3",                       | Unlogged rollback to mark phil's mark #3 (timestamp) | postgres
 DBLINK_OPEN_CNX    |                    | rlbk#1                                 | Status = 1                                           | postgres
 LOCK_GROUP         | BEGIN              | phil's group#3",                       | Rollback session #1                                  | postgres
 LOCK_GROUP         | END                | phil's group#3",                       | Rollback session #1: 2 tables locked, 0 deadlock(s)  | postgres
 ROLLBACK_GROUP     | TIME STAMP SET     | 14209                                  |                                                      | postgres
 ROLLBACK_GROUP     | MARK DELETED       | phil's group#3",                       | mark RLBK_14200_START is deleted                     | postgres
 ROLLBACK_GROUP     | MARK DELETED       | phil's group#3",                       | mark RLBK_14200_DONE is deleted                      | postgres
 ROLLBACK_GROUP     | NOTICE             | Rollback id 14201                      | Rollback id = 14201.                                 | postgres
 ROLLBACK_GROUP     | NOTICE             | Rollback id 14201                      | 0 / 2 tables effectively processed.                  | postgres
 ROLLBACK_GROUP     | NOTICE             | Rollback id 14201                      | 0 / 2 sequences effectively processed.               | postgres
 DBLINK_CLOSE_CNX   |                    | rlbk#1                                 |                                                      | postgres
 ROLLBACK_GROUP     | END                | phil's group#3",                       | Rollback_id 14201                                    | postgres
(68 rows)

-- user tables
reset role;
select * from "phil's schema""3"."phil's tbl1" order by "phil's col11","phil's col12";
 phil's col11 | phil's col12 | phil\s"col13 
--------------+--------------+--------------
            1 | DEF          | \x1c
            2 | DEF          | \x1c
            3 | AB'C         | \x1c
            4 | AB'C         | \x0c
            5 | AB'C         | \x0c
            6 | AB'C         | \x0c
            7 | AB'C         | \x0c
            8 | AB'C         | \x0c
            9 | AB'C         | \x0c
           11 | AB'C         | \x0c
           12 | AB'C         | \x0c
           13 | AB'C         | \x0c
           14 | AB'C         | \x0c
           15 | AB'C         | \x0c
           16 | AB'C         | \x0c
           17 | AB'C         | \x0c
           18 | AB'C         | \x1c27
           19 | AB'C         | \x1c27
           20 | AB'C         | \x1c27
(19 rows)

select * from "phil's schema""3"."myTbl2\" order by col21;
 col21 | col22 |   col23    
-------+-------+------------
     1 | ABC   | 12-31-2010
     2 | DEF   | 
(2 rows)

-- log tables
set role emaj_regression_tests_adm_user2;
select "phil's col11", "phil's col12", "phil\s""col13", emaj_verb, emaj_tuple, emaj_gid from "emaj_phil's schema""3"."phil's tbl1_log" order by emaj_gid, emaj_tuple desc;
 phil's col11 | phil's col12 | phil\s"col13 | emaj_verb | emaj_tuple | emaj_gid 
--------------+--------------+--------------+-----------+------------+----------
            1 | AB'C         | \x0c         | INS       | NEW        | 14200001
            2 | AB'C         | \x0c         | INS       | NEW        | 14200002
            3 | AB'C         | \x0c         | INS       | NEW        | 14200003
            4 | AB'C         | \x0c         | INS       | NEW        | 14200004
            5 | AB'C         | \x0c         | INS       | NEW        | 14200005
            6 | AB'C         | \x0c         | INS       | NEW        | 14200006
            7 | AB'C         | \x0c         | INS       | NEW        | 14200007
            8 | AB'C         | \x0c         | INS       | NEW        | 14200008
            9 | AB'C         | \x0c         | INS       | NEW        | 14200009
           10 | AB'C         | \x0c         | INS       | NEW        | 14200010
           11 | AB'C         | \x0c         | INS       | NEW        | 14200011
           12 | AB'C         | \x0c         | INS       | NEW        | 14200012
           13 | AB'C         | \x0c         | INS       | NEW        | 14200013
           14 | AB'C         | \x0c         | INS       | NEW        | 14200014
           15 | AB'C         | \x0c         | INS       | NEW        | 14200015
           16 | AB'C         | \x0c         | INS       | NEW        | 14200016
           17 | AB'C         | \x0c         | INS       | NEW        | 14200017
           18 | AB'C         | \x0c         | INS       | NEW        | 14200018
           19 | AB'C         | \x0c         | INS       | NEW        | 14200019
           20 | AB'C         | \x0c         | INS       | NEW        | 14200020
           21 | AB'C         | \x0c         | INS       | NEW        | 14200021
           22 | AB'C         | \x0c         | INS       | NEW        | 14200022
           23 | AB'C         | \x0c         | INS       | NEW        | 14200023
           24 | AB'C         | \x0c         | INS       | NEW        | 14200024
           25 | AB'C         | \x0c         | INS       | NEW        | 14200025
           26 | AB'C         | \x0c         | INS       | NEW        | 14200026
           27 | AB'C         | \x0c         | INS       | NEW        | 14200027
           28 | AB'C         | \x0c         | INS       | NEW        | 14200028
           29 | AB'C         | \x0c         | INS       | NEW        | 14200029
           30 | AB'C         | \x0c         | INS       | NEW        | 14200030
           31 | AB'C         | \x0c         | INS       | NEW        | 14200031
            1 | AB'C         | \x0c         | UPD       | OLD        | 14200032
            1 | AB'C         | \x1c         | UPD       | NEW        | 14200032
            2 | AB'C         | \x0c         | UPD       | OLD        | 14200033
            2 | AB'C         | \x1c         | UPD       | NEW        | 14200033
            3 | AB'C         | \x0c         | UPD       | OLD        | 14200034
            3 | AB'C         | \x1c         | UPD       | NEW        | 14200034
           18 | AB'C         | \x0c         | UPD       | OLD        | 14200035
           18 | AB'C         | \x1c27       | UPD       | NEW        | 14200035
           19 | AB'C         | \x0c         | UPD       | OLD        | 14200036
           19 | AB'C         | \x1c27       | UPD       | NEW        | 14200036
           20 | AB'C         | \x0c         | UPD       | OLD        | 14200037
           20 | AB'C         | \x1c27       | UPD       | NEW        | 14200037
           21 | AB'C         | \x0c         | UPD       | OLD        | 14200038
           21 | AB'C         | \x1c27       | UPD       | NEW        | 14200038
           22 | AB'C         | \x0c         | UPD       | OLD        | 14200039
           22 | AB'C         | \x1c27       | UPD       | NEW        | 14200039
           23 | AB'C         | \x0c         | DEL       | OLD        | 14200041
           24 | AB'C         | \x0c         | DEL       | OLD        | 14200042
           25 | AB'C         | \x0c         | DEL       | OLD        | 14200043
           26 | AB'C         | \x0c         | DEL       | OLD        | 14200044
           27 | AB'C         | \x0c         | DEL       | OLD        | 14200045
           28 | AB'C         | \x0c         | DEL       | OLD        | 14200046
           29 | AB'C         | \x0c         | DEL       | OLD        | 14200047
           30 | AB'C         | \x0c         | DEL       | OLD        | 14200048
           31 | AB'C         | \x0c         | DEL       | OLD        | 14200049
           21 | AB'C         | \x1c27       | DEL       | OLD        | 14200050
           22 | AB'C         | \x1c27       | DEL       | OLD        | 14200051
           10 | AB'C         | \x0c         | DEL       | OLD        | 14200053
            1 | AB'C         | \x1c         | UPD       | OLD        | 14200054
            1 | DEF          | \x1c         | UPD       | NEW        | 14200054
            2 | AB'C         | \x1c         | UPD       | OLD        | 14200055
            2 | DEF          | \x1c         | UPD       | NEW        | 14200055
(63 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from "emaj_phil's schema""3"."myTbl2\_log" order by emaj_gid, emaj_tuple desc;
 col21 | col22 |   col23    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+------------+-----------+------------+----------
     1 | ABC   | 12-31-2010 | INS       | NEW        | 14200040
     2 | DEF   |            | INS       | NEW        | 14200052
(2 rows)

-- set sequence restart value
select public.handle_emaj_sequences(14300);
 handle_emaj_sequences 
-----------------------
 
(1 row)

-----------------------------
-- Step 10 : for myGroup1, in a transaction, update tables and rollback the transaction, 
--           then rollback to previous mark 
-----------------------------
reset role;
set search_path=public,myschema1;
--
begin transaction;
  delete from mytbl1;
rollback;
--
set role emaj_regression_tests_adm_user2;
select * from emaj.emaj_rollback_group('myGroup1','EMAJ_LAST_MARK',false) order by 1,2;
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | 0 / 2 sequences effectively processed.
 Notice        | 1 / 5 tables effectively processed.
 Notice        | Rollback id = 14300.
(3 rows)

-----------------------------
-- Checking step 10
-----------------------------
-- emaj tables
select sqhl_schema, sqhl_table, sqhl_begin_time_id, sqhl_end_time_id, sqhl_hole_size from emaj.emaj_seq_hole order by 1,2,3;
 sqhl_schema | sqhl_table | sqhl_begin_time_id | sqhl_end_time_id | sqhl_hole_size 
-------------+------------+--------------------+------------------+----------------
 myschema1   | mytbl1     |              12402 |            12600 |              1
 myschema1   | mytbl1     |              14009 |            14300 |             20
 myschema1   | mytbl4     |              12402 |            12600 |              2
 myschema2   | mytbl4     |              12201 |            12502 |              6
 myschema2   | mytbl5     |              12201 |            12502 |              3
 myschema2   | mytbl6     |              12201 |            12502 |              9
(6 rows)

select rlbt_rlbk_id, rlbt_step, rlbt_schema, rlbt_table, rlbt_object, rlbt_quantity from emaj.emaj_rlbk_stat
  order by rlbt_rlbk_id, rlbt_step, rlbt_schema, rlbt_table, rlbt_object;
 rlbt_rlbk_id |   rlbt_step    | rlbt_schema | rlbt_table |    rlbt_object    | rlbt_quantity 
--------------+----------------+-------------+------------+-------------------+---------------
        12300 | RLBK_SEQUENCES |             |            |                   |             2
        12300 | SET_FK_DEF     |             |            |                   |             2
        12300 | RLBK_TABLE     | myschema2   | mytbl4     |                   |             4
        12300 | RLBK_TABLE     | myschema2   | mytbl5     |                   |             1
        12300 | RLBK_TABLE     | myschema2   | mytbl6     |                   |             3
        12300 | SET_FK_IMM     | myschema2   | mytbl6     | mytbl6_col61_fkey |             3
        12300 | SET_FK_IMM     | myschema2   | mytbl8     | mytbl8_col81_fkey |             3
        12300 | CTRL-DBLINK    |             |            |                   |             8
        12301 | RLBK_SEQUENCES |             |            |                   |             2
        12301 | SET_FK_DEF     |             |            |                   |             2
        12301 | RLBK_TABLE     | myschema2   | mytbl4     |                   |             2
        12301 | RLBK_TABLE     | myschema2   | mytbl5     |                   |             1
        12301 | RLBK_TABLE     | myschema2   | mytbl6     |                   |             3
        12301 | SET_FK_IMM     | myschema2   | mytbl6     | mytbl6_col61_fkey |             3
        12301 | SET_FK_IMM     | myschema2   | mytbl8     | mytbl8_col81_fkey |             3
        12301 | CTRL-DBLINK    |             |            |                   |             8
        12400 | RLBK_SEQUENCES |             |            |                   |             2
        12400 | DIS_LOG_TRG    |             |            |                   |             2
        12400 | RLBK_TABLE     | myschema1   | mytbl1     |                   |             3
        12400 | RLBK_TABLE     | myschema1   | mytbl4     |                   |             8
        12400 | DELETE_LOG     | myschema1   | mytbl1     |                   |             3
        12400 | DELETE_LOG     | myschema1   | mytbl4     |                   |             8
        12400 | ENA_LOG_TRG    |             |            |                   |             2
        12400 | CTRL+DBLINK    |             |            |                   |             9
        12500 | RLBK_SEQUENCES |             |            |                   |             2
        12500 | SET_FK_DEF     |             |            |                   |             2
        12500 | RLBK_TABLE     | myschema2   | mytbl4     |                   |             8
        12500 | RLBK_TABLE     | myschema2   | mytbl5     |                   |             3
        12500 | RLBK_TABLE     | myschema2   | mytbl6     |                   |             9
        12500 | SET_FK_IMM     | myschema2   | mytbl6     | mytbl6_col61_fkey |             9
        12500 | SET_FK_IMM     | myschema2   | mytbl8     | mytbl8_col81_fkey |             9
        12500 | CTRL+DBLINK    |             |            |                   |             8
        12501 | RLBK_SEQUENCES |             |            |                   |             2
        12501 | DIS_LOG_TRG    |             |            |                   |             3
        12501 | SET_FK_DEF     |             |            |                   |             2
        12501 | RLBK_TABLE     | myschema2   | mytbl4     |                   |             6
        12501 | RLBK_TABLE     | myschema2   | mytbl5     |                   |             3
        12501 | RLBK_TABLE     | myschema2   | mytbl6     |                   |             9
        12501 | DELETE_LOG     | myschema2   | mytbl4     |                   |             6
        12501 | DELETE_LOG     | myschema2   | mytbl5     |                   |             3
        12501 | DELETE_LOG     | myschema2   | mytbl6     |                   |             9
        12501 | SET_FK_IMM     | myschema2   | mytbl6     | mytbl6_col61_fkey |             9
        12501 | SET_FK_IMM     | myschema2   | mytbl8     | mytbl8_col81_fkey |             9
        12501 | ENA_LOG_TRG    |             |            |                   |             3
        12501 | CTRL+DBLINK    |             |            |                   |            17
        12600 | RLBK_SEQUENCES |             |            |                   |             2
        12600 | DIS_LOG_TRG    |             |            |                   |             2
        12600 | RLBK_TABLE     | myschema1   | mytbl1     |                   |             1
        12600 | RLBK_TABLE     | myschema1   | mytbl4     |                   |             2
        12600 | DELETE_LOG     | myschema1   | mytbl1     |                   |             1
        12600 | DELETE_LOG     | myschema1   | mytbl4     |                   |             2
        12600 | ENA_LOG_TRG    |             |            |                   |             2
        12600 | CTRL+DBLINK    |             |            |                   |             9
        12601 | RLBK_SEQUENCES |             |            |                   |             2
        12601 | RLBK_TABLE     | myschema1   | myTbl3     |                   |            10
        12601 | RLBK_TABLE     | myschema1   | mytbl1     |                   |             1
        12601 | RLBK_TABLE     | myschema1   | mytbl4     |                   |             2
        12601 | CTRL+DBLINK    |             |            |                   |             4
        14000 | RLBK_SEQUENCES |             |            |                   |             4
        14000 | CTRL+DBLINK    |             |            |                   |             1
        14001 | RLBK_SEQUENCES |             |            |                   |             4
        14001 | CTRL+DBLINK    |             |            |                   |             1
        14002 | RLBK_SEQUENCES |             |            |                   |             4
        14002 | CTRL+DBLINK    |             |            |                   |             1
        14003 | RLBK_SEQUENCES |             |            |                   |             2
        14003 | CTRL+DBLINK    |             |            |                   |             1
        14200 | RLBK_SEQUENCES |             |            |                   |             2
        14200 | CTRL+DBLINK    |             |            |                   |             1
        14201 | RLBK_SEQUENCES |             |            |                   |             2
        14201 | CTRL+DBLINK    |             |            |                   |             1
        14300 | RLBK_SEQUENCES |             |            |                   |             2
        14300 | DIS_LOG_TRG    |             |            |                   |             1
        14300 | RLBK_TABLE     | myschema1   | mytbl1     |                   |            20
        14300 | DELETE_LOG     | myschema1   | mytbl1     |                   |            20
        14300 | ENA_LOG_TRG    |             |            |                   |             1
        14300 | CTRL+DBLINK    |             |            |                   |             5
(76 rows)

select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 14300 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
   14300 |           14300020 | R
(1 row)

select hist_function, hist_event, hist_object,
       regexp_replace(regexp_replace(regexp_replace(hist_wording,
            E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),
            E'\\d\\d\\d\\d/\\d\\d\\/\\d\\d\\ \\d\\d\\:\\d\\d:\\d\\d .*?\\)','<timestamp>)','g'),
            E'\\[.+\\]','(timestamp)','g'), 
       hist_user
  from emaj.emaj_hist where hist_id >= 14300 order by hist_id;
  hist_function   |   hist_event   |    hist_object    |                                           regexp_replace                                           | hist_user 
------------------+----------------+-------------------+----------------------------------------------------------------------------------------------------+-----------
 ROLLBACK_GROUP   | BEGIN          | myGroup1          | Unlogged rollback to mark Multi-1 (timestamp)                                                      | postgres
 DBLINK_OPEN_CNX  |                | rlbk#1            | Status = 1                                                                                         | postgres
 LOCK_GROUP       | BEGIN          | myGroup1          | Rollback session #1                                                                                | postgres
 LOCK_GROUP       | END            | myGroup1          | Rollback session #1: 5 tables locked, 0 deadlock(s)                                                | postgres
 ROLLBACK_GROUP   | TIME STAMP SET | 14300             |                                                                                                    | postgres
 ROLLBACK_TABLE   | BEGIN          | myschema1.mytbl1  | All log rows where emaj_gid > 14000000 and <= 14300020, in session_replication_role = replica mode | postgres
 ROLLBACK_TABLE   | END            | myschema1.mytbl1  | 0 rolled back primary keys                                                                         | postgres
 ROLLBACK_GROUP   | NOTICE         | Rollback id 14300 | Rollback id = 14300.                                                                               | postgres
 ROLLBACK_GROUP   | NOTICE         | Rollback id 14300 | 1 / 5 tables effectively processed.                                                                | postgres
 ROLLBACK_GROUP   | NOTICE         | Rollback id 14300 | 0 / 2 sequences effectively processed.                                                             | postgres
 DBLINK_CLOSE_CNX |                | rlbk#1            |                                                                                                    | postgres
 ROLLBACK_GROUP   | END            | myGroup1          | Rollback_id 14300                                                                                  | postgres
(12 rows)

-- set sequence restart value
select public.handle_emaj_sequences(14400);
 handle_emaj_sequences 
-----------------------
 
(1 row)

-----------------------------
-- Step 11 : tests snaps and script generation functions
-----------------------------
-- first perform changes in a table with generated columns
reset role;
set search_path=public,myschema1;
insert into mytbl2b (col21) values (10),(11);
update mytbl2b set col21 = 12 where col21 = 11;
delete from mytbl2b where col21 >= 10;
-- add some updates for tables with unusual types (arrays, geometric)
set search_path=public,myschema2;
insert into myTbl5 values (10,'{"abc","def","ghi"}','{1,2,3}',NULL,'{}',NULL,'{"id":1000}','[2020-01-01, 2021-01-01)',NULL);
insert into myTbl5 values (20,array['abc','def','ghi'],array[3,4,5],array['2000/02/01'::date,'2000/02/28'::date],'{"id":1001, "c1":"abc"}',NULL,'{"id":1001}',NULL,XMLPARSE (CONTENT '<foo>bar</foo>'));
update myTbl5 set col54 = '{"2010/11/28","2010/12/03"}', col55 = '{"id":1001, "c2":"def"}', col57 = '{"id":1001, "c3":"ghi"}' where col54 is null;
insert into myTbl6 select i+10, point(i,1.3), box(point(i,2),point(i+0.2,3)), circle(point(5,5),i),'((-2,-2),(3,0),(1,4))','10.20.30.40/27','EXECUTING',(i+10,point(i,1.3))::mycomposite from generate_series (1,8) as i;
update myTbl6 set col64 = '<(5,6),3.5>', col65 = null, col67 = 'COMPLETED' where col61 <= 13;
-- also add rows with unusual text content
insert into mytbl2 values (10, E'row 1 \r... and row 2 with a '' (quote) character',null);
insert into mytbl2 values (11, E'row 1 with a true \\ character\r... and row 2 with two \\n true and a '' (quote) characters',null);
-- and manupulate NULL characters
insert into mytbl1 values (200, E'Start\tEnd ', E'A\\000B'::BYTEA);
update mytbl1 set col12 = E' Start\tEnd' where col11 = 200;
delete from mytbl1 where col13 = E'A\\000B'::BYTEA;
-- also apply some changes in sequence characteristics
alter sequence myschema2.myseq1 minvalue 1 maxvalue 100 increment 10 start 21 restart 11 cache 2 cycle;
-- create the directory for the first snaps set
\! mkdir -p $EMAJTESTTMPDIR/snaps1
-- ... and snap all groups
set role emaj_regression_tests_adm_user1;
select emaj.emaj_snap_group('myGroup1',:'EMAJTESTTMPDIR' || '/snaps1','CSV HEADER');
 emaj_snap_group 
-----------------
               7
(1 row)

select emaj.emaj_snap_group('myGroup2',:'EMAJTESTTMPDIR' || '/snaps1','CSV HEADER');
 emaj_snap_group 
-----------------
               8
(1 row)

select emaj.emaj_snap_group('phil''s group#3",',:'EMAJTESTTMPDIR' || '/snaps1','CSV HEADER');
 emaj_snap_group 
-----------------
               4
(1 row)

\! ls $EMAJTESTTMPDIR/snaps1
_INFO
myschema1_myTbl3.snap
myschema1_myTbl3_col31_seq.snap
myschema1_mytbl1.snap
myschema1_mytbl2.snap
myschema1_mytbl2b.snap
myschema1_mytbl2b_col20_seq.snap
myschema1_mytbl4.snap
myschema2_myTbl3.snap
myschema2_myTbl3_col31_seq.snap
myschema2_myseq1.snap
myschema2_mytbl1.snap
myschema2_mytbl2.snap
myschema2_mytbl4.snap
myschema2_mytbl5.snap
myschema2_mytbl6.snap
phil_s_schema_3_myTbl2_.snap
phil_s_schema_3_myTbl2__col21_seq.snap
phil_s_schema_3_phil_s_seq_1.snap
phil_s_schema_3_phil_s_tbl1.snap
-- generate a sql script for each active group (and check the result with detailed log statistics + number of sequences)
select emaj.emaj_gen_sql_group('myGroup1', 'Multi-1', NULL, :'EMAJTESTTMPDIR' || '/myGroup1.sql');
NOTICE:  table "emaj_temp_script" does not exist, skipping
 emaj_gen_sql_group 
--------------------
                  6
(1 row)

select coalesce(sum(stat_rows),0) + 1 /* sequence change */ as check from emaj.emaj_detailed_log_stat_group('myGroup1', 'Multi-1', NULL);
 check 
-------
     6
(1 row)

select emaj.emaj_gen_sql_group('myGroup2', 'Multi-1', NULL, :'EMAJTESTTMPDIR' || '/myGroup2.sql', array[
     'myschema2.mytbl1','myschema2.mytbl2','myschema2.myTbl3','myschema2.mytbl4',
     'myschema2.mytbl5','myschema2.mytbl6','myschema2.myseq1','myschema2.myTbl3_col31_seq']);
NOTICE:  table "emaj_temp_script" does not exist, skipping
 emaj_gen_sql_group 
--------------------
                 26
(1 row)

select sum(stat_rows) + 1 /* sequence change */ as check from emaj.emaj_detailed_log_stat_group('myGroup2', 'Multi-1', NULL);
 check 
-------
    26
(1 row)

select emaj.emaj_gen_sql_group('phil''s group#3",', 'M1_rollbackable', NULL, :'EMAJTESTTMPDIR' || '/Group3.sql');
NOTICE:  table "emaj_temp_script" does not exist, skipping
 emaj_gen_sql_group 
--------------------
                 56
(1 row)

select sum(stat_rows) + 1 /* sequence change*/ as check from emaj.emaj_detailed_log_stat_group('phil''s group#3",', 'M1_rollbackable', NULL);
 check 
-------
    56
(1 row)

-- generate another sql script for myGroup1 but with a manual export and check both scripts are the same
select emaj.emaj_gen_sql_group('myGroup1', 'Multi-1', NULL, NULL);
NOTICE:  table "emaj_temp_script" does not exist, skipping
 emaj_gen_sql_group 
--------------------
                  6
(1 row)

\setenv FILE1 :EMAJTESTTMPDIR'/myGroup1_2.sql'
\copy (select * from emaj_sql_script) to program 'cat >$FILE1'
-- mask timestamp in initial comment and compare
\! find $EMAJTESTTMPDIR -name '*.sql' -type f -print0 | xargs -0 sed -i -s 's/at .*$/at [ts]$/'
\! diff $EMAJTESTTMPDIR/myGroup1.sql $EMAJTESTTMPDIR/myGroup1_2.sql
-- process \\ characters in script files
\! find $EMAJTESTTMPDIR -name '*.sql' -type f -print0 | xargs -0 sed -i_s -s 's/\\\\/\\/g'
-- comment transaction commands for the need of the current test
\! find $EMAJTESTTMPDIR -name '*.sql' -type f -print0 | xargs -0 sed -i -s 's/^BEGIN/--BEGIN/;s/^COMMIT/--COMMIT/'
-- mask timestamp in initial comment
\! find $EMAJTESTTMPDIR -name '*.sql' -type f -print0 | xargs -0 sed -i -s 's/at .*$/at [ts]$/'
\! ls $EMAJTESTTMPDIR
Group3.sql
Group3.sql_s
myGroup1.sql
myGroup1.sql_s
myGroup1_2.sql
myGroup1_2.sql_s
myGroup2.sql
myGroup2.sql_s
snaps1
-- create the directory for the second snaps set
\! mkdir $EMAJTESTTMPDIR/snaps2
-- in a single transaction and as superuser:
--   rollback groups, replay updates with generated scripts, snap groups again and cancel the transaction
begin;
  select * from emaj.emaj_rollback_group('myGroup1','Multi-1',false) order by 1,2;
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | 1 / 2 sequences effectively processed.
 Notice        | 1 / 5 tables effectively processed.
 Notice        | Rollback id = 14400.
(3 rows)

  select * from emaj.emaj_rollback_group('myGroup2','Multi-1',false) order by 1,2;
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | 1 / 2 sequences effectively processed.
 Notice        | 4 / 6 tables effectively processed.
 Notice        | Rollback id = 14401.
(3 rows)

  select * from emaj.emaj_rollback_group('phil''s group#3",','M1_rollbackable',false) order by 1,2;
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | 1 / 2 sequences effectively processed.
 Notice        | 2 / 2 tables effectively processed.
 Notice        | Rollback id = 14402.
(3 rows)

  \! cat $EMAJTESTTMPDIR/myGroup1.sql
-- SQL script generated by E-Maj at [ts]$
--    for tables group(s): myGroup1
--    processing logs between mark Multi-1 and the current state
SET standard_conforming_strings = OFF;
SET escape_string_warning = OFF;
SET datestyle = 'ISO, YMD';
--BEGIN TRANSACTION;
INSERT INTO myschema1.mytbl2b (col20, col21, col24) OVERRIDING SYSTEM VALUE VALUES (6, 10, 'true');
INSERT INTO myschema1.mytbl2b (col20, col21, col24) OVERRIDING SYSTEM VALUE VALUES (7, 11, 'true');
UPDATE ONLY myschema1.mytbl2b SET col21 = 12, col24 = 'true' WHERE col20 = 7;
DELETE FROM ONLY myschema1.mytbl2b WHERE col20 = 6;
DELETE FROM ONLY myschema1.mytbl2b WHERE col20 = 7;
ALTER SEQUENCE myschema1.mytbl2b_col20_seq  RESTART 8;
--COMMIT;
RESET standard_conforming_strings;
RESET escape_string_warning;
RESET datestyle;
  reset role;
  \set FILE1 :EMAJTESTTMPDIR '/myGroup1.sql'
  \i :FILE1
-- SQL script generated by E-Maj at [ts]$
--    for tables group(s): myGroup1
--    processing logs between mark Multi-1 and the current state
SET standard_conforming_strings = OFF;
SET escape_string_warning = OFF;
SET datestyle = 'ISO, YMD';
--BEGIN TRANSACTION;
INSERT INTO myschema1.mytbl2b (col20, col21, col24) OVERRIDING SYSTEM VALUE VALUES (6, 10, 'true');
INSERT INTO myschema1.mytbl2b (col20, col21, col24) OVERRIDING SYSTEM VALUE VALUES (7, 11, 'true');
UPDATE ONLY myschema1.mytbl2b SET col21 = 12, col24 = 'true' WHERE col20 = 7;
DELETE FROM ONLY myschema1.mytbl2b WHERE col20 = 6;
DELETE FROM ONLY myschema1.mytbl2b WHERE col20 = 7;
ALTER SEQUENCE myschema1.mytbl2b_col20_seq  RESTART 8;
--COMMIT;
RESET standard_conforming_strings;
RESET escape_string_warning;
RESET datestyle;
  \set FILE2 :EMAJTESTTMPDIR '/myGroup2.sql'
  \i :FILE2
-- SQL script generated by E-Maj at [ts]$
--    for tables group(s): myGroup2
--    processing logs between mark Multi-1 and the current state
--    only for the following tables/sequences: myschema2.myTbl3,myschema2.myTbl3_col31_seq,myschema2.myseq1,myschema2.mytbl1,myschema2.mytbl2,myschema2.mytbl4,myschema2.mytbl5,myschema2.mytbl6
SET standard_conforming_strings = OFF;
SET escape_string_warning = OFF;
SET datestyle = 'ISO, YMD';
--BEGIN TRANSACTION;
INSERT INTO myschema2.mytbl5 VALUES (10, '{abc,def,ghi}', '{1,2,3}', NULL, '{}', NULL, '{"id":1000}', '[2020-01-01,2021-01-01)', NULL);
INSERT INTO myschema2.mytbl5 VALUES (20, '{abc,def,ghi}', '{3,4,5}', '{2000-02-01,2000-02-28}', '{"id":1001, "c1":"abc"}', NULL, '{"id":1001}', NULL, '<foo>bar</foo>');
UPDATE ONLY myschema2.mytbl5 SET col51 = 10, col52 = '{abc,def,ghi}', col53 = '{1,2,3}', col54 = '{2010-11-28,2010-12-03}', col55 = '{"id":1001, "c2":"def"}', col56 = NULL, col57 = '{"id":1001, "c3":"ghi"}', col58 = '[2020-01-01,2021-01-01)', col59 = NULL WHERE col51 = 10;
INSERT INTO myschema2.mytbl6 (col61, col62, col63, col64, col65, col66, col67, col68) VALUES (11, '(1,1.3)', '(1.2,3),(1,2)', '<(5,5),1>', '((-2,-2),(3,0),(1,4))', '10.20.30.40/27', 'EXECUTING', '(11,"(1,1.3)")');
INSERT INTO myschema2.mytbl6 (col61, col62, col63, col64, col65, col66, col67, col68) VALUES (12, '(2,1.3)', '(2.2,3),(2,2)', '<(5,5),2>', '((-2,-2),(3,0),(1,4))', '10.20.30.40/27', 'EXECUTING', '(12,"(2,1.3)")');
INSERT INTO myschema2.mytbl6 (col61, col62, col63, col64, col65, col66, col67, col68) VALUES (13, '(3,1.3)', '(3.2,3),(3,2)', '<(5,5),3>', '((-2,-2),(3,0),(1,4))', '10.20.30.40/27', 'EXECUTING', '(13,"(3,1.3)")');
INSERT INTO myschema2.mytbl6 (col61, col62, col63, col64, col65, col66, col67, col68) VALUES (14, '(4,1.3)', '(4.2,3),(4,2)', '<(5,5),4>', '((-2,-2),(3,0),(1,4))', '10.20.30.40/27', 'EXECUTING', '(14,"(4,1.3)")');
INSERT INTO myschema2.mytbl6 (col61, col62, col63, col64, col65, col66, col67, col68) VALUES (15, '(5,1.3)', '(5.2,3),(5,2)', '<(5,5),5>', '((-2,-2),(3,0),(1,4))', '10.20.30.40/27', 'EXECUTING', '(15,"(5,1.3)")');
INSERT INTO myschema2.mytbl6 (col61, col62, col63, col64, col65, col66, col67, col68) VALUES (16, '(6,1.3)', '(6.2,3),(6,2)', '<(5,5),6>', '((-2,-2),(3,0),(1,4))', '10.20.30.40/27', 'EXECUTING', '(16,"(6,1.3)")');
INSERT INTO myschema2.mytbl6 (col61, col62, col63, col64, col65, col66, col67, col68) VALUES (17, '(7,1.3)', '(7.2,3),(7,2)', '<(5,5),7>', '((-2,-2),(3,0),(1,4))', '10.20.30.40/27', 'EXECUTING', '(17,"(7,1.3)")');
INSERT INTO myschema2.mytbl6 (col61, col62, col63, col64, col65, col66, col67, col68) VALUES (18, '(8,1.3)', '(8.2,3),(8,2)', '<(5,5),8>', '((-2,-2),(3,0),(1,4))', '10.20.30.40/27', 'EXECUTING', '(18,"(8,1.3)")');
UPDATE ONLY myschema2.mytbl6 SET col61 = 0, col62 = NULL, col63 = NULL, col64 = '<(5,6),3.5>', col65 = NULL, col66 = NULL, col67 = 'COMPLETED', col68 = NULL WHERE col61 = 0;
UPDATE ONLY myschema2.mytbl6 SET col61 = 4, col62 = '(4,1.3)', col63 = '(4.2,1),(4,0)', col64 = '<(5,6),3.5>', col65 = NULL, col66 = '10.20.30.40/27', col67 = 'COMPLETED', col68 = '(4,"(4,1.3)")' WHERE col61 = 4;
UPDATE ONLY myschema2.mytbl6 SET col61 = 5, col62 = '(5,1.3)', col63 = '(5.2,1),(5,0)', col64 = '<(5,6),3.5>', col65 = NULL, col66 = '10.20.30.40/27', col67 = 'COMPLETED', col68 = '(5,"(5,1.3)")' WHERE col61 = 5;
UPDATE ONLY myschema2.mytbl6 SET col61 = 6, col62 = '(6,1.3)', col63 = '(6.2,1),(6,0)', col64 = '<(5,6),3.5>', col65 = NULL, col66 = '10.20.30.40/27', col67 = 'COMPLETED', col68 = '(6,"(6,1.3)")' WHERE col61 = 6;
UPDATE ONLY myschema2.mytbl6 SET col61 = 7, col62 = '(7,1.3)', col63 = '(7.2,1),(7,0)', col64 = '<(5,6),3.5>', col65 = NULL, col66 = '10.20.30.40/27', col67 = 'COMPLETED', col68 = '(7,"(7,1.3)")' WHERE col61 = 7;
UPDATE ONLY myschema2.mytbl6 SET col61 = 8, col62 = '(8,1.3)', col63 = '(8.2,1),(8,0)', col64 = '<(5,6),3.5>', col65 = NULL, col66 = '10.20.30.40/27', col67 = 'COMPLETED', col68 = '(8,"(8,1.3)")' WHERE col61 = 8;
UPDATE ONLY myschema2.mytbl6 SET col61 = 11, col62 = '(1,1.3)', col63 = '(1.2,3),(1,2)', col64 = '<(5,6),3.5>', col65 = NULL, col66 = '10.20.30.40/27', col67 = 'COMPLETED', col68 = '(11,"(1,1.3)")' WHERE col61 = 11;
UPDATE ONLY myschema2.mytbl6 SET col61 = 12, col62 = '(2,1.3)', col63 = '(2.2,3),(2,2)', col64 = '<(5,6),3.5>', col65 = NULL, col66 = '10.20.30.40/27', col67 = 'COMPLETED', col68 = '(12,"(2,1.3)")' WHERE col61 = 12;
UPDATE ONLY myschema2.mytbl6 SET col61 = 13, col62 = '(3,1.3)', col63 = '(3.2,3),(3,2)', col64 = '<(5,6),3.5>', col65 = NULL, col66 = '10.20.30.40/27', col67 = 'COMPLETED', col68 = '(13,"(3,1.3)")' WHERE col61 = 13;
INSERT INTO myschema2.mytbl2 VALUES (10, 'row 1 \r... and row 2 with a '' (quote) character', NULL);
INSERT INTO myschema2.mytbl2 VALUES (11, E'row 1 with a true \\ character\r... and row 2 with two \\n true and a '' (quote) characters', NULL);
INSERT INTO myschema2.mytbl1 VALUES (200, 'Start\tEnd', E'\\x410042');
UPDATE ONLY myschema2.mytbl1 SET col11 = 200, col12 = ' Start\tEnd', col13 = E'\\x410042' WHERE col11 = 200 AND col12 = 'Start\tEnd';
DELETE FROM ONLY myschema2.mytbl1 WHERE col11 = 200 AND col12 = ' Start\tEnd';
ALTER SEQUENCE myschema2.myseq1  RESTART 11 START 21 INCREMENT 10 MINVALUE 1 MAXVALUE 100 CACHE 2 CYCLE ;
--COMMIT;
RESET standard_conforming_strings;
RESET escape_string_warning;
RESET datestyle;
  \set FILE3 :EMAJTESTTMPDIR '/Group3.sql'
  \i :FILE3
-- SQL script generated by E-Maj at [ts]$
--    for tables group(s): phil's group#3",
--    processing logs between mark M1_rollbackable and the current state
SET standard_conforming_strings = OFF;
SET escape_string_warning = OFF;
SET datestyle = 'ISO, YMD';
--BEGIN TRANSACTION;
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (1, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (2, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (3, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (4, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (5, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (6, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (7, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (8, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (9, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (10, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (11, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (12, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (13, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (14, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (15, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (16, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (17, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (18, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (19, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (20, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (21, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (22, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (23, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (24, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (25, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (26, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (27, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (28, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (29, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (30, 'AB''C', E'\\x0c');
INSERT INTO "phil's schema""3"."phil's tbl1" VALUES (31, 'AB''C', E'\\x0c');
UPDATE ONLY "phil's schema""3"."phil's tbl1" SET "phil's col11" = 1, "phil's col12" = 'AB''C', "phil\s""col13" = E'\\x1c' WHERE "phil's col11" = 1 AND "phil's col12" = 'AB''C';
UPDATE ONLY "phil's schema""3"."phil's tbl1" SET "phil's col11" = 2, "phil's col12" = 'AB''C', "phil\s""col13" = E'\\x1c' WHERE "phil's col11" = 2 AND "phil's col12" = 'AB''C';
UPDATE ONLY "phil's schema""3"."phil's tbl1" SET "phil's col11" = 3, "phil's col12" = 'AB''C', "phil\s""col13" = E'\\x1c' WHERE "phil's col11" = 3 AND "phil's col12" = 'AB''C';
UPDATE ONLY "phil's schema""3"."phil's tbl1" SET "phil's col11" = 18, "phil's col12" = 'AB''C', "phil\s""col13" = E'\\x1c27' WHERE "phil's col11" = 18 AND "phil's col12" = 'AB''C';
UPDATE ONLY "phil's schema""3"."phil's tbl1" SET "phil's col11" = 19, "phil's col12" = 'AB''C', "phil\s""col13" = E'\\x1c27' WHERE "phil's col11" = 19 AND "phil's col12" = 'AB''C';
UPDATE ONLY "phil's schema""3"."phil's tbl1" SET "phil's col11" = 20, "phil's col12" = 'AB''C', "phil\s""col13" = E'\\x1c27' WHERE "phil's col11" = 20 AND "phil's col12" = 'AB''C';
UPDATE ONLY "phil's schema""3"."phil's tbl1" SET "phil's col11" = 21, "phil's col12" = 'AB''C', "phil\s""col13" = E'\\x1c27' WHERE "phil's col11" = 21 AND "phil's col12" = 'AB''C';
UPDATE ONLY "phil's schema""3"."phil's tbl1" SET "phil's col11" = 22, "phil's col12" = 'AB''C', "phil\s""col13" = E'\\x1c27' WHERE "phil's col11" = 22 AND "phil's col12" = 'AB''C';
INSERT INTO "phil's schema""3"."myTbl2\" VALUES (1, 'ABC', '2010-12-31');
DELETE FROM ONLY "phil's schema""3"."phil's tbl1" WHERE "phil's col11" = 23 AND "phil's col12" = 'AB''C';
DELETE FROM ONLY "phil's schema""3"."phil's tbl1" WHERE "phil's col11" = 24 AND "phil's col12" = 'AB''C';
DELETE FROM ONLY "phil's schema""3"."phil's tbl1" WHERE "phil's col11" = 25 AND "phil's col12" = 'AB''C';
DELETE FROM ONLY "phil's schema""3"."phil's tbl1" WHERE "phil's col11" = 26 AND "phil's col12" = 'AB''C';
DELETE FROM ONLY "phil's schema""3"."phil's tbl1" WHERE "phil's col11" = 27 AND "phil's col12" = 'AB''C';
DELETE FROM ONLY "phil's schema""3"."phil's tbl1" WHERE "phil's col11" = 28 AND "phil's col12" = 'AB''C';
DELETE FROM ONLY "phil's schema""3"."phil's tbl1" WHERE "phil's col11" = 29 AND "phil's col12" = 'AB''C';
DELETE FROM ONLY "phil's schema""3"."phil's tbl1" WHERE "phil's col11" = 30 AND "phil's col12" = 'AB''C';
DELETE FROM ONLY "phil's schema""3"."phil's tbl1" WHERE "phil's col11" = 31 AND "phil's col12" = 'AB''C';
DELETE FROM ONLY "phil's schema""3"."phil's tbl1" WHERE "phil's col11" = 21 AND "phil's col12" = 'AB''C';
DELETE FROM ONLY "phil's schema""3"."phil's tbl1" WHERE "phil's col11" = 22 AND "phil's col12" = 'AB''C';
INSERT INTO "phil's schema""3"."myTbl2\" VALUES (2, 'DEF', NULL);
DELETE FROM ONLY "phil's schema""3"."phil's tbl1" WHERE "phil's col11" = 10 AND "phil's col12" = 'AB''C';
UPDATE ONLY "phil's schema""3"."phil's tbl1" SET "phil's col11" = 1, "phil's col12" = 'DEF', "phil\s""col13" = E'\\x1c' WHERE "phil's col11" = 1 AND "phil's col12" = 'AB''C';
UPDATE ONLY "phil's schema""3"."phil's tbl1" SET "phil's col11" = 2, "phil's col12" = 'DEF', "phil\s""col13" = E'\\x1c' WHERE "phil's col11" = 2 AND "phil's col12" = 'AB''C';
ALTER SEQUENCE "phil's schema""3"."phil's""seq\1"  RESTART 1002;
--COMMIT;
RESET standard_conforming_strings;
RESET escape_string_warning;
RESET datestyle;
  set role emaj_regression_tests_adm_user1;
  select emaj.emaj_snap_group('myGroup1',:'EMAJTESTTMPDIR' || '/snaps2','CSV HEADER');
 emaj_snap_group 
-----------------
               7
(1 row)

  select emaj.emaj_snap_group('myGroup2',:'EMAJTESTTMPDIR' || '/snaps2','CSV HEADER');
 emaj_snap_group 
-----------------
               8
(1 row)

  select emaj.emaj_snap_group('phil''s group#3",',:'EMAJTESTTMPDIR' || '/snaps2','CSV HEADER');
 emaj_snap_group 
-----------------
               4
(1 row)

rollback;
-- mask timestamp in _INFO files
\! sed -i_s -s 's/at .*/at [ts]/' $EMAJTESTTMPDIR/snaps1/_INFO $EMAJTESTTMPDIR/snaps2/_INFO
-- and compare both snaps sets
-- sequences are detected as different because of :
-- - the effect of RESTART on is_called and next_val attributes
-- - internal log_cnt value being reset
\! diff --exclude _INFO_s $EMAJTESTTMPDIR/snaps1 $EMAJTESTTMPDIR/snaps2
diff --exclude _INFO_s /tmp/emaj_13/adm2/snaps1/myschema1_mytbl2b_col20_seq.snap /tmp/emaj_13/adm2/snaps2/myschema1_mytbl2b_col20_seq.snap
2c2
< mytbl2b_col20_seq,7,1,1,2147483647,1,1,f,t
---
> mytbl2b_col20_seq,8,1,1,2147483647,1,1,f,f
diff --exclude _INFO_s /tmp/emaj_13/adm2/snaps1/phil_s_schema_3_phil_s_seq_1.snap /tmp/emaj_13/adm2/snaps2/phil_s_schema_3_phil_s_seq_1.snap
2c2
< "phil's""seq\1",1001,1000,1,2000,1000,1,t,t
---
> "phil's""seq\1",1002,1000,1,2000,1000,1,t,f
-- reset the sequence myschema2.myseq1 to its previous characteristics
reset role;
alter sequence myschema2.myseq1 restart 1004 start 1000 increment 1 maxvalue 9223372036854775807 minvalue 1000 cache 1 no cycle;
set role emaj_regression_tests_adm_user2;
-----------------------------
-- Checking step 11
-----------------------------
select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 14400 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
   14400 |           14400030 | R
   14401 |           14400030 | R
   14402 |           14400030 | R
(3 rows)

select hist_function, hist_event, hist_object,
       regexp_replace(regexp_replace(regexp_replace(hist_wording,
            E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),
            E'\\d\\d\\d\\d/\\d\\d\\/\\d\\d\\ \\d\\d\\:\\d\\d:\\d\\d .*?\\)','<timestamp>)','g'),
            E'\\[.+\\]','(timestamp)','g'), 
       hist_user
  from emaj.emaj_hist where hist_id >= 14400 order by hist_id;
 hist_function | hist_event |   hist_object    |                                regexp_replace                                 | hist_user 
---------------+------------+------------------+-------------------------------------------------------------------------------+-----------
 SNAP_GROUP    | BEGIN      | myGroup1         | /tmp/emaj_13/adm2/snaps1                                                      | postgres
 SNAP_GROUP    | END        | myGroup1         | 7 tables/sequences processed                                                  | postgres
 SNAP_GROUP    | BEGIN      | myGroup2         | /tmp/emaj_13/adm2/snaps1                                                      | postgres
 SNAP_GROUP    | END        | myGroup2         | 8 tables/sequences processed                                                  | postgres
 SNAP_GROUP    | BEGIN      | phil's group#3", | /tmp/emaj_13/adm2/snaps1                                                      | postgres
 SNAP_GROUP    | END        | phil's group#3", | 4 tables/sequences processed                                                  | postgres
 GEN_SQL_GROUP | BEGIN      | myGroup1         | From mark Multi-1 to current state                                            | postgres
 GEN_SQL_GROUP | END        | myGroup1         | 6 generated statements - script exported into /tmp/emaj_13/adm2/myGroup1.sql  | postgres
 GEN_SQL_GROUP | BEGIN      | myGroup2         | From mark Multi-1 to current state with tables/sequences filtering            | postgres
 GEN_SQL_GROUP | END        | myGroup2         | 26 generated statements - script exported into /tmp/emaj_13/adm2/myGroup2.sql | postgres
 GEN_SQL_GROUP | BEGIN      | phil's group#3", | From mark M1_rollbackable to current state                                    | postgres
 GEN_SQL_GROUP | END        | phil's group#3", | 56 generated statements - script exported into /tmp/emaj_13/adm2/Group3.sql   | postgres
 GEN_SQL_GROUP | BEGIN      | myGroup1         | From mark Multi-1 to current state                                            | postgres
 GEN_SQL_GROUP | END        | myGroup1         | 6 generated statements - script not exported                                  | postgres
(14 rows)

-- set sequence restart value
select public.handle_emaj_sequences(14500);
 handle_emaj_sequences 
-----------------------
 
(1 row)

-----------------------------
-- Step 12 : test use of a table with a very long name (63 characters long)
-----------------------------
select emaj.emaj_stop_group('phil''s group#3",');
 emaj_stop_group 
-----------------
               4
(1 row)

-- remove the "phil's tbl1" table, rename it and reassign it to its group
select emaj.emaj_remove_table('phil''s schema"3','phil''s tbl1');
 emaj_remove_table 
-------------------
                 1
(1 row)

reset role;
alter table "phil's schema""3"."phil's tbl1" rename to table_with_very_looooooooooooooooooooooooooooooooooooooong_name;
set role emaj_regression_tests_adm_user1;
select emaj.emaj_assign_table('phil''s schema"3', 'table_with_very_looooooooooooooooooooooooooooooooooooooong_name', 'phil''s group#3",');
NOTICE:  table "table_with_very_looooooooooooooooooooooooooooooooo#1_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "phil's schema"3.table_with_very_looooooooooooooooooooooooooooooooooooooong_name" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "phil's schema"3.table_with_very_looooooooooooooooooooooooooooooooooooooong_name" does not exist, skipping
 emaj_assign_table 
-------------------
                 1
(1 row)

-- use the table and its group
select emaj.emaj_start_group('phil''s group#3",','M1_after_table_rename');
WARNING:  _check_fk_groups: The foreign key "mytbl2_col21_fkey" on the table "phil's schema"3.myTbl2\" references the table "phil's schema"3.my"tbl4" that is outside the groups (phil's group#3",).
WARNING:  _check_fk_groups: The table "phil's schema"3.table_with_very_looooooooooooooooooooooooooooooooooooooong_name" is referenced by the foreign key "my"tbl4_col44_fkey" on the table "phil's schema"3.my"tbl4" that is outside the groups (phil's group#3",).
 emaj_start_group 
------------------
                4
(1 row)

reset role;
update "phil's schema""3".table_with_very_looooooooooooooooooooooooooooooooooooooong_name set "phil's col12" = 'GHI' where "phil's col11" between 6 and 9;
set role emaj_regression_tests_adm_user1;
select emaj.emaj_set_mark_group('phil''s group#3",','M2');
 emaj_set_mark_group 
---------------------
                   4
(1 row)

reset role;
delete from "phil's schema""3".table_with_very_looooooooooooooooooooooooooooooooooooooong_name where "phil's col11" > 18;
set role emaj_regression_tests_adm_user1;
select * from emaj.emaj_rollback_group('phil''s group#3",','M1_after_table_rename',false) order by 1,2;
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | 0 / 2 sequences effectively processed.
 Notice        | 1 / 2 tables effectively processed.
 Notice        | Rollback id = 14500.
(3 rows)

select emaj.emaj_stop_group('phil''s group#3",');
 emaj_stop_group 
-----------------
               4
(1 row)

select emaj.emaj_drop_group('phil''s group#3",');
 emaj_drop_group 
-----------------
               4
(1 row)

--
reset role;
alter table "phil's schema""3".table_with_very_looooooooooooooooooooooooooooooooooooooong_name rename to "phil's tbl1";
-----------------------------
-- Checking step 12
-----------------------------
set role emaj_regression_tests_adm_user1;
select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 14500 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
   14500 |           14500000 | X
   14501 |           14500000 | A
   14502 |           14500000 | A
   14503 |           14500000 | S
   14504 |           14500004 | M
   14505 |           14500006 | R
   14506 |           14500006 | X
   14507 |           14500006 | D
(8 rows)

select hist_function, hist_event, hist_object,
       regexp_replace(regexp_replace(regexp_replace(hist_wording,
            E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),
            E'\\d\\d\\d\\d/\\d\\d\\/\\d\\d\\ \\d\\d\\:\\d\\d:\\d\\d .*?\\)','<timestamp>)','g'),
            E'\\[.+\\]','(timestamp)','g'), 
       hist_user
  from emaj.emaj_hist where hist_id >= 14500 order by hist_id;
   hist_function    |     hist_event     |                                    hist_object                                     |                       regexp_replace                        | hist_user 
--------------------+--------------------+------------------------------------------------------------------------------------+-------------------------------------------------------------+-----------
 STOP_GROUP         | BEGIN              | phil's group#3",                                                                   |                                                             | postgres
 STOP_GROUP         | TIME STAMP SET     | 14500                                                                              |                                                             | postgres
 LOCK_GROUP         | BEGIN              | phil's group#3",                                                                   |                                                             | postgres
 LOCK_GROUP         | END                | phil's group#3",                                                                   | 2 tables locked, 0 deadlock(s)                              | postgres
 SET_MARK_GROUP     | BEGIN              | phil's group#3",                                                                   | STOP_%                                                      | postgres
 CLEANUP_RLBK_STATE |                    | Rollback id 14200                                                                  | set to COMMITTED                                            | postgres
 CLEANUP_RLBK_STATE |                    | Rollback id 14201                                                                  | set to COMMITTED                                            | postgres
 CLEANUP_RLBK_STATE |                    | Rollback id 14300                                                                  | set to COMMITTED                                            | postgres
 CLEANUP_RLBK_STATE |                    | Rollback id 14400                                                                  | set to ABORTED                                              | postgres
 CLEANUP_RLBK_STATE |                    | Rollback id 14401                                                                  | set to ABORTED                                              | postgres
 CLEANUP_RLBK_STATE |                    | Rollback id 14402                                                                  | set to ABORTED                                              | postgres
 SET_MARK_GROUP     | END                | phil's group#3",                                                                   | STOP_%                                                      | postgres
 STOP_GROUP         | END                | phil's group#3",                                                                   | 4 tables/sequences processed                                | postgres
 REMOVE_TABLE       | BEGIN              |                                                                                    |                                                             | postgres
 REMOVE_TABLE       | TIME STAMP SET     | 14501                                                                              |                                                             | postgres
 REMOVE_TABLE       | TABLE REMOVED      | "phil's schema""3"."phil's tbl1"                                                   | From the idle group phil's group#3",                        | postgres
 REMOVE_TABLE       | END                |                                                                                    | 1 tables removed from their groups                          | postgres
 ASSIGN_TABLE       | BEGIN              |                                                                                    |                                                             | postgres
 ASSIGN_TABLE       | TIME STAMP SET     | 14502                                                                              |                                                             | postgres
 ASSIGN_TABLE       | TABLE ADDED        | "phil's schema""3".table_with_very_looooooooooooooooooooooooooooooooooooooong_name | To the idle group phil's group#3",                          | postgres
 ASSIGN_TABLE       | END                |                                                                                    | 1 tables assigned to the group phil's group#3",             | postgres
 START_GROUP        | BEGIN              | phil's group#3",                                                                   | With log reset                                              | postgres
 START_GROUP        | TIME STAMP SET     | 14503                                                                              |                                                             | postgres
 LOCK_GROUP         | BEGIN              | phil's group#3",                                                                   |                                                             | postgres
 LOCK_GROUP         | END                | phil's group#3",                                                                   | 2 tables locked, 0 deadlock(s)                              | postgres
 SET_MARK_GROUP     | BEGIN              | phil's group#3",                                                                   | M1_after_table_rename                                       | postgres
 SET_MARK_GROUP     | END                | phil's group#3",                                                                   | M1_after_table_rename                                       | postgres
 START_GROUP        | END                | phil's group#3",                                                                   | 4 tables/sequences processed                                | postgres
 SET_MARK_GROUP     | BEGIN              | phil's group#3",                                                                   |                                                             | postgres
 LOCK_GROUP         | BEGIN              | phil's group#3",                                                                   |                                                             | postgres
 LOCK_GROUP         | END                | phil's group#3",                                                                   | 2 tables locked, 0 deadlock(s)                              | postgres
 SET_MARK_GROUP     | TIME STAMP SET     | 14504                                                                              |                                                             | postgres
 SET_MARK_GROUP     | END                | phil's group#3",                                                                   | M2                                                          | postgres
 ROLLBACK_GROUP     | BEGIN              | phil's group#3",                                                                   | Unlogged rollback to mark M1_after_table_rename (timestamp) | postgres
 DBLINK_OPEN_CNX    |                    | rlbk#1                                                                             | Status = 1                                                  | postgres
 LOCK_GROUP         | BEGIN              | phil's group#3",                                                                   | Rollback session #1                                         | postgres
 LOCK_GROUP         | END                | phil's group#3",                                                                   | Rollback session #1: 2 tables locked, 0 deadlock(s)         | postgres
 ROLLBACK_GROUP     | TIME STAMP SET     | 14505                                                                              |                                                             | postgres
 ROLLBACK_TABLE     | BEGIN              | "phil's schema""3".table_with_very_looooooooooooooooooooooooooooooooooooooong_name | All log rows where emaj_gid > 14500000 and <= 14500006      | postgres
 ROLLBACK_TABLE     | END                | "phil's schema""3".table_with_very_looooooooooooooooooooooooooooooooooooooong_name | 10 rolled back primary keys                                 | postgres
 ROLLBACK_GROUP     | MARK DELETED       | phil's group#3",                                                                   | mark M2 is deleted                                          | postgres
 ROLLBACK_GROUP     | NOTICE             | Rollback id 14500                                                                  | Rollback id = 14500.                                        | postgres
 ROLLBACK_GROUP     | NOTICE             | Rollback id 14500                                                                  | 1 / 2 tables effectively processed.                         | postgres
 ROLLBACK_GROUP     | NOTICE             | Rollback id 14500                                                                  | 0 / 2 sequences effectively processed.                      | postgres
 DBLINK_CLOSE_CNX   |                    | rlbk#1                                                                             |                                                             | postgres
 ROLLBACK_GROUP     | END                | phil's group#3",                                                                   | Rollback_id 14500                                           | postgres
 STOP_GROUP         | BEGIN              | phil's group#3",                                                                   |                                                             | postgres
 STOP_GROUP         | TIME STAMP SET     | 14506                                                                              |                                                             | postgres
 LOCK_GROUP         | BEGIN              | phil's group#3",                                                                   |                                                             | postgres
 LOCK_GROUP         | END                | phil's group#3",                                                                   | 2 tables locked, 0 deadlock(s)                              | postgres
 SET_MARK_GROUP     | BEGIN              | phil's group#3",                                                                   | STOP_%                                                      | postgres
 CLEANUP_RLBK_STATE |                    | Rollback id 14500                                                                  | set to COMMITTED                                            | postgres
 SET_MARK_GROUP     | END                | phil's group#3",                                                                   | STOP_%                                                      | postgres
 STOP_GROUP         | END                | phil's group#3",                                                                   | 4 tables/sequences processed                                | postgres
 DROP_GROUP         | BEGIN              | phil's group#3",                                                                   |                                                             | postgres
 DROP_GROUP         | TIME STAMP SET     | 14507                                                                              |                                                             | postgres
 DROP_GROUP         | LOG_SCHEMA DROPPED | "emaj_phil's schema""3"                                                            |                                                             | postgres
 DROP_GROUP         | END                | phil's group#3",                                                                   | 4 tables/sequences processed                                | postgres
(58 rows)

-- set sequence restart value
select public.handle_emaj_sequences(14600);
 handle_emaj_sequences 
-----------------------
 
(1 row)

-----------------------------
-- Step 13 : test use of groups or marks protection
-----------------------------
set role emaj_regression_tests_adm_user2;
-- try to rollback a protected group
select emaj.emaj_protect_group('myGroup2');
 emaj_protect_group 
--------------------
                  1
(1 row)

select * from emaj.emaj_rollback_group('myGroup2','M3',false) order by 1,2;
ERROR:  _check_group_names: The group "myGroup2" is currently protected against rollback operations.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,boolean,boolean,boolean,boolean) line 100 at RAISE
SQL statement "SELECT emaj._check_group_names(p_groupNames := p_groupNames, p_mayBeNull := FALSE, p_lockGroups := TRUE,
                                     p_checkLogging := TRUE, p_checkRollbackable := TRUE, p_checkUnprotected := TRUE)"
PL/pgSQL function emaj._rlbk_check(text[],text,boolean,boolean) line 16 at SQL statement
SQL statement "SELECT emaj._rlbk_check(p_groupNames, p_mark, p_isAlterGroupAllowed, FALSE)"
PL/pgSQL function emaj._rlbk_init(text[],text,boolean,integer,boolean,boolean,text) line 25 at SQL statement
SQL statement "SELECT emaj._rlbk_init(p_groupNames, p_mark, p_isLoggedRlbk, 1, p_multiGroup, p_isAlterGroupAllowed, p_comment)"
PL/pgSQL function emaj._rlbk_groups(text[],text,boolean,boolean,boolean,text) line 26 at SQL statement
PL/pgSQL function emaj.emaj_rollback_group(text,text,boolean,text) line 8 at RETURN QUERY
select emaj.emaj_unprotect_group('myGroup2');
 emaj_unprotect_group 
----------------------
                    1
(1 row)

-- try to rollback over a protected mark
select emaj.emaj_set_mark_group('myGroup1','Mark_to_protect');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

select emaj.emaj_protect_mark_group('myGroup1','Mark_to_protect');
 emaj_protect_mark_group 
-------------------------
                       1
(1 row)

select * from emaj.emaj_rollback_group('myGroup1','Multi-1',false) order by 1,2;
ERROR:  _rlbk_check: Protected marks (Mark_to_protect) for the group "myGroup1" block the rollback to the mark "Multi-1".
CONTEXT:  PL/pgSQL function emaj._rlbk_check(text[],text,boolean,boolean) line 41 at RAISE
SQL statement "SELECT emaj._rlbk_check(p_groupNames, p_mark, p_isAlterGroupAllowed, FALSE)"
PL/pgSQL function emaj._rlbk_init(text[],text,boolean,integer,boolean,boolean,text) line 25 at SQL statement
SQL statement "SELECT emaj._rlbk_init(p_groupNames, p_mark, p_isLoggedRlbk, 1, p_multiGroup, p_isAlterGroupAllowed, p_comment)"
PL/pgSQL function emaj._rlbk_groups(text[],text,boolean,boolean,boolean,text) line 26 at SQL statement
PL/pgSQL function emaj.emaj_rollback_group(text,text,boolean,text) line 8 at RETURN QUERY
select emaj.emaj_unprotect_mark_group('myGroup1','Mark_to_protect');
 emaj_unprotect_mark_group 
---------------------------
                         1
(1 row)

select emaj.emaj_delete_mark_group('myGroup1','Mark_to_protect');
 emaj_delete_mark_group 
------------------------
                      1
(1 row)

-----------------------------
-- Checking step 13
-----------------------------
select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 14600 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
   14600 |           14600000 | M
(1 row)

select hist_function, hist_event, hist_object,
       regexp_replace(regexp_replace(regexp_replace(hist_wording,
            E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),
            E'\\d\\d\\d\\d/\\d\\d\\/\\d\\d\\ \\d\\d\\:\\d\\d:\\d\\d .*?\\)','<timestamp>)','g'),
            E'\\[.+\\]','(timestamp)','g'), 
       hist_user
  from emaj.emaj_hist where hist_id >= 14600 order by hist_id;
    hist_function     |   hist_event   | hist_object |         regexp_replace          | hist_user 
----------------------+----------------+-------------+---------------------------------+-----------
 PROTECT_GROUP        |                | myGroup2    | Status 1                        | postgres
 UNPROTECT_GROUP      |                | myGroup2    | Status 1                        | postgres
 SET_MARK_GROUP       | BEGIN          | myGroup1    |                                 | postgres
 LOCK_GROUP           | BEGIN          | myGroup1    |                                 | postgres
 LOCK_GROUP           | END            | myGroup1    | 5 tables locked, 0 deadlock(s)  | postgres
 SET_MARK_GROUP       | TIME STAMP SET | 14600       |                                 | postgres
 SET_MARK_GROUP       | END            | myGroup1    | Mark_to_protect                 | postgres
 PROTECT_MARK_GROUP   |                | myGroup1    | Mark Mark_to_protect ; status 1 | postgres
 UNPROTECT_MARK_GROUP |                | myGroup1    | Mark Mark_to_protect ; status 1 | postgres
 DELETE_MARK_GROUP    | BEGIN          | myGroup1    | Mark_to_protect                 | postgres
 DELETE_MARK_GROUP    | END            | myGroup1    | Mark_to_protect                 | postgres
(11 rows)

-- set sequence restart value
select public.handle_emaj_sequences(14700);
 handle_emaj_sequences 
-----------------------
 
(1 row)

-----------------------------
-- Step 14 : test complex use of rollbacks consolidations, with an application trigger kept enabled
-----------------------------
set search_path=public,myschema1;
select emaj.emaj_modify_table('myschema1','mytbl2','{"ignored_triggers":["mytbl2trg2"]}');
 emaj_modify_table 
-------------------
                 1
(1 row)

-- 2 consolidations of 2 logged rollbacks
-- Multi-1 MC1 MC2 RMC1S RMC1D      MC3 MC4 MC5 RMC3S RMC3D
--         ^       lrg(MC1)         ^           lrg(MC3)
--         xxxxxxxxxxxxxxx conso(RMC1D)
-- 	       	                        xxxxxxxxxxxxxxxxxxx conso(RMC3D)
select emaj.emaj_set_mark_group('myGroup1','MC1');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

reset role;
insert into myTbl1 select i, 'Test', 'Conso' from generate_series (2000,2012) as i;
insert into myTbl2 values (2000,'TC1',NULL);
delete from myTbl1 where col11 > 2010;
set role emaj_regression_tests_adm_user2;
select emaj.emaj_set_mark_group('myGroup1','MC2');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

reset role;
update myTbl2 set col22 = 'TC2' WHERE col22 ='TC1';
set role emaj_regression_tests_adm_user2;
select * from emaj.emaj_logged_rollback_group('myGroup1','MC1',false) order by 1,2;
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | 1 / 2 sequences effectively processed.
 Notice        | 3 / 5 tables effectively processed.
 Notice        | Rollback id = 14700.
(3 rows)

reset role;
insert into myTbl2 values (2000,'TC3',NULL);
set role emaj_regression_tests_adm_user2;
select emaj.emaj_rename_mark_group('myGroup1','EMAJ_LAST_MARK','RLBK_MC1_DONE');
 emaj_rename_mark_group 
------------------------
 
(1 row)

select emaj.emaj_set_mark_group('myGroup1','MC3');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

reset role;
insert into "myTbl3" (col33) select generate_series(2000,2039,4)/100;
insert into myTbl4 values (2000,'FK...',1,10,'ABC');
update myTbl4 set col44 = NULL where col41 = 2000;
set role emaj_regression_tests_adm_user2;
select emaj.emaj_set_mark_group('myGroup1','MC4');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

select emaj.emaj_set_mark_group('myGroup1','MC5');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

select * from emaj.emaj_logged_rollback_group('myGroup1','MC3',false) order by 1,2;
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | 1 / 2 sequences effectively processed.
 Notice        | 2 / 5 tables effectively processed.
 Notice        | Rollback id = 14701.
(3 rows)

select cons_group, regexp_replace(cons_end_rlbk_mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), 
       cons_target_rlbk_mark_name, cons_end_rlbk_mark_time_id, cons_target_rlbk_mark_time_id, cons_rows, cons_marks, cons_marks
  from emaj.emaj_get_consolidable_rollbacks();
 cons_group | regexp_replace  | cons_target_rlbk_mark_name | cons_end_rlbk_mark_time_id | cons_target_rlbk_mark_time_id | cons_rows | cons_marks | cons_marks 
------------+-----------------+----------------------------+----------------------------+-------------------------------+-----------+------------+------------
 myGroup1   | RLBK_MC1_DONE   | MC1                        |                      14704 |                         14701 |        33 |          2 |          2
 myGroup1   | RLBK_14701_DONE | MC3                        |                      14709 |                         14705 |        23 |          3 |          3
(2 rows)

  
-- consolidate both logged rollback at once
select cons_target_rlbk_mark_name, regexp_replace(cons_end_rlbk_mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), 
       emaj.emaj_consolidate_rollback_group(cons_group, cons_end_rlbk_mark_name)
  from emaj.emaj_get_consolidable_rollbacks() where cons_group = 'myGroup1';
 cons_target_rlbk_mark_name | regexp_replace  | emaj_consolidate_rollback_group 
----------------------------+-----------------+---------------------------------
 MC1                        | RLBK_MC1_DONE   |                               5
 MC3                        | RLBK_14701_DONE |                               4
(2 rows)

select cons_group, regexp_replace(cons_end_rlbk_mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), 
       cons_target_rlbk_mark_name, cons_end_rlbk_mark_time_id, cons_target_rlbk_mark_time_id, cons_rows, cons_marks
  from emaj.emaj_get_consolidable_rollbacks();
 cons_group | regexp_replace  | cons_target_rlbk_mark_name | cons_end_rlbk_mark_time_id | cons_target_rlbk_mark_time_id | cons_rows | cons_marks 
------------+-----------------+----------------------------+----------------------------+-------------------------------+-----------+------------
 myGroup1   | RLBK_MC1_DONE   | MC1                        |                      14704 |                         14701 |         0 |          0
 myGroup1   | RLBK_14701_DONE | MC3                        |                      14709 |                         14705 |         0 |          0
(2 rows)

select stat_group, stat_schema, stat_table, stat_first_mark, stat_last_mark, stat_role, stat_verb, stat_rows
  from emaj.emaj_detailed_log_stat_group('myGroup1','Multi-1',NULL);
 stat_group | stat_schema | stat_table | stat_first_mark | stat_last_mark | stat_role | stat_verb | stat_rows 
------------+-------------+------------+-----------------+----------------+-----------+-----------+-----------
 myGroup1   | myschema1   | mytbl2     | Multi-1         |                | postgres  | INSERT    |         1
 myGroup1   | myschema1   | mytbl2b    | Multi-1         |                | postgres  | DELETE    |         2
 myGroup1   | myschema1   | mytbl2b    | Multi-1         |                | postgres  | INSERT    |         3
 myGroup1   | myschema1   | mytbl2b    | Multi-1         |                | postgres  | UPDATE    |         1
(4 rows)

-- 2 consolidations of 2 nested logged rollbacks
-- MC6 MC7 MC8  RMC8S RMC8D M9 RMC6S RMC6D
--         ^    lrg(MC8)
--         xxxxxxxxxxxx conso(RMC8D)
-- ^                           lrb(MC6)
-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx conso(RMC6D)
select emaj.emaj_set_mark_group('myGroup1','MC6');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

reset role;
insert into myTbl1 select i, 'Test', 'Conso' from generate_series (2000,2012) as i;
insert into myTbl2 values (3000,'TC6',NULL);
delete from myTbl1 where col11 > 2010;
set role emaj_regression_tests_adm_user2;
select emaj.emaj_set_mark_group('myGroup1','MC7');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

reset role;
update myTbl2 set col22 = 'TC7' WHERE col22 ='TC6';
set role emaj_regression_tests_adm_user2;
select emaj.emaj_set_mark_group('myGroup1','MC8');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

reset role;
insert into myTbl2 values (3001,'TC8',NULL);
set role emaj_regression_tests_adm_user2;
select * from emaj.emaj_logged_rollback_group('myGroup1','MC8',false) order by 1,2;
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | 1 / 2 sequences effectively processed.
 Notice        | 2 / 5 tables effectively processed.
 Notice        | Rollback id = 14702.
(3 rows)

select emaj.emaj_consolidate_rollback_group('myGroup1','EMAJ_LAST_MARK');
 emaj_consolidate_rollback_group 
---------------------------------
                               4
(1 row)

select emaj.emaj_set_mark_group('myGroup1','MC9');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

reset role;
insert into "myTbl3" (col33) select generate_series(2000,2039,4)/100;
insert into myTbl4 values (2000,'FK...',1,10,'ABC');
update myTbl4 set col44 = NULL where col41 = 2000;
set role emaj_regression_tests_adm_user2;
select * from emaj.emaj_logged_rollback_group('myGroup1','MC6',false) order by 1,2;
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | 2 / 2 sequences effectively processed.
 Notice        | 5 / 5 tables effectively processed.
 Notice        | Rollback id = 14703.
(3 rows)

select emaj.emaj_consolidate_rollback_group('myGroup1','EMAJ_LAST_MARK');
 emaj_consolidate_rollback_group 
---------------------------------
                               7
(1 row)

select stat_group, stat_schema, stat_table, stat_first_mark, stat_last_mark, stat_role, stat_verb, stat_rows
  from emaj.emaj_detailed_log_stat_group('myGroup1','Multi-1',NULL);
 stat_group | stat_schema | stat_table | stat_first_mark | stat_last_mark | stat_role | stat_verb | stat_rows 
------------+-------------+------------+-----------------+----------------+-----------+-----------+-----------
 myGroup1   | myschema1   | mytbl2     | Multi-1         |                | postgres  | INSERT    |         1
 myGroup1   | myschema1   | mytbl2b    | Multi-1         |                | postgres  | DELETE    |         2
 myGroup1   | myschema1   | mytbl2b    | Multi-1         |                | postgres  | INSERT    |         3
 myGroup1   | myschema1   | mytbl2b    | Multi-1         |                | postgres  | UPDATE    |         1
(4 rows)

-- consolidation of 2 logged rollbacks referencing the same mark
-- MC10  RMC10S RMC10D M11 RMC10S RMC10D
-- ^     lrg(MC10)
-- ^                       lrb(MC10)
-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx conso(RMC10D)
select emaj.emaj_set_mark_group('myGroup1','MC10');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

reset role;
insert into myTbl1 select i, 'Test', 'Conso' from generate_series (3000,3010) as i;
delete from myTbl1 where col11 > 3005;
set role emaj_regression_tests_adm_user2;
select * from emaj.emaj_logged_rollback_group('myGroup1','MC10',false) order by 1,2;
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | 0 / 2 sequences effectively processed.
 Notice        | 1 / 5 tables effectively processed.
 Notice        | Rollback id = 14704.
(3 rows)

reset role;
update myTbl2 set col22 = 'TC7' WHERE col22 ='TC6';
set role emaj_regression_tests_adm_user2;
select emaj.emaj_set_mark_group('myGroup1','MC11');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

reset role;
insert into myTbl4 values (3000,'FK...',1,10,'ABC');
update myTbl4 set col44 = NULL where col41 = 3000;
set role emaj_regression_tests_adm_user2;
select * from emaj.emaj_logged_rollback_group('myGroup1','MC10',false) order by 1,2;
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | 0 / 2 sequences effectively processed.
 Notice        | 2 / 5 tables effectively processed.
 Notice        | Rollback id = 14705.
(3 rows)

select emaj.emaj_consolidate_rollback_group('myGroup1','EMAJ_LAST_MARK');
 emaj_consolidate_rollback_group 
---------------------------------
                               4
(1 row)

select stat_group, stat_schema, stat_table, stat_first_mark, stat_last_mark, stat_role, stat_verb, stat_rows
  from emaj.emaj_detailed_log_stat_group('myGroup1','Multi-1',NULL);
 stat_group | stat_schema | stat_table | stat_first_mark | stat_last_mark | stat_role | stat_verb | stat_rows 
------------+-------------+------------+-----------------+----------------+-----------+-----------+-----------
 myGroup1   | myschema1   | mytbl2     | Multi-1         |                | postgres  | INSERT    |         1
 myGroup1   | myschema1   | mytbl2b    | Multi-1         |                | postgres  | DELETE    |         2
 myGroup1   | myschema1   | mytbl2b    | Multi-1         |                | postgres  | INSERT    |         3
 myGroup1   | myschema1   | mytbl2b    | Multi-1         |                | postgres  | UPDATE    |         1
(4 rows)

-- consolidation of 1 from 2 overlapping logged rollbacks
-- MC15 MC16 RMC15S RMC15D MC17 RMC16S RMC16D
-- ^         lrg(MC15)
--      ^                       lrg(MC16)
-- xxxxxxxxxxxxxxxxx conso(RMC15D)
select emaj.emaj_set_mark_group('myGroup1','MC15');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

reset role;
insert into myTbl1 select i, 'Test', 'Conso' from generate_series (4000,4012) as i;
insert into myTbl2 values (4000,'TC15',NULL);
delete from myTbl1 where col11 > 4010;
set role emaj_regression_tests_adm_user2;
select emaj.emaj_set_mark_group('myGroup1','MC16');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

reset role;
update myTbl2 set col22 = 'TC16' WHERE col22 ='TC15';
set role emaj_regression_tests_adm_user2;
select * from emaj.emaj_logged_rollback_group('myGroup1','MC15',false) order by 1,2;
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | 1 / 2 sequences effectively processed.
 Notice        | 3 / 5 tables effectively processed.
 Notice        | Rollback id = 14706.
(3 rows)

select emaj.emaj_rename_mark_group('myGroup1','EMAJ_LAST_MARK','RLBK_MC15_DONE');
 emaj_rename_mark_group 
------------------------
 
(1 row)

select emaj.emaj_set_mark_group('myGroup1','MC17');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

reset role;
insert into myTbl2 values (4001,'TC15',NULL);
set role emaj_regression_tests_adm_user2;
select * from emaj.emaj_logged_rollback_group('myGroup1','MC16',false) order by 1,2;
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | 0 / 2 sequences effectively processed.
 Notice        | 3 / 5 tables effectively processed.
 Notice        | Rollback id = 14707.
(3 rows)

select emaj.emaj_consolidate_rollback_group('myGroup1','RLBK_MC15_DONE');
 emaj_consolidate_rollback_group 
---------------------------------
                               5
(1 row)

select stat_group, stat_schema, stat_table, stat_first_mark, stat_last_mark, stat_role, stat_verb, stat_rows
  from emaj.emaj_detailed_log_stat_group('myGroup1','Multi-1',NULL);
 stat_group | stat_schema | stat_table | stat_first_mark | stat_last_mark | stat_role | stat_verb | stat_rows 
------------+-------------+------------+-----------------+----------------+-----------+-----------+-----------
 myGroup1   | myschema1   | mytbl1     | Multi-1         |                | postgres  | INSERT    |        11
 myGroup1   | myschema1   | mytbl2     | Multi-1         |                | postgres  | DELETE    |         1
 myGroup1   | myschema1   | mytbl2     | Multi-1         |                | postgres  | INSERT    |         3
 myGroup1   | myschema1   | mytbl2b    | Multi-1         |                | postgres  | DELETE    |         3
 myGroup1   | myschema1   | mytbl2b    | Multi-1         |                | postgres  | INSERT    |         5
 myGroup1   | myschema1   | mytbl2b    | Multi-1         |                | postgres  | UPDATE    |         1
(6 rows)

reset role;
select * from myTbl1 order by col11;
 col11 |   col12    |    col13     
-------+------------+--------------
     2 | ABC        | \x1c
     3 | ABC        | \x1c
     4 | ABC        | \x0c
     5 | ABC        | \x0c
     6 | ABC        | \x0c
     7 | ABC        | \x0c
     8 | ABC        | \x0c
     9 | ABC        | \x0c
    10 | ABC        | \x0c
   100 | DEF        | \x00
   101 | DEF        | \x00
   102 | DEF        | \x00
   103 | DEF        | \x00
   104 | DEF        | \x00
   105 | DEF        | \x00
   106 | DEF        | \x00
   107 | DEF        | \x00
   108 | DEF        | \x00
   109 | DEF        | \x00
   110 | DEF        | \x00
  4000 | Test       | \x436f6e736f
  4001 | Test       | \x436f6e736f
  4002 | Test       | \x436f6e736f
  4003 | Test       | \x436f6e736f
  4004 | Test       | \x436f6e736f
  4005 | Test       | \x436f6e736f
  4006 | Test       | \x436f6e736f
  4007 | Test       | \x436f6e736f
  4008 | Test       | \x436f6e736f
  4009 | Test       | \x436f6e736f
  4010 | Test       | \x436f6e736f
(31 rows)

select * from myTbl2 order by col21;
 col21 | col22 |   col23    
-------+-------+------------
     1 | ABC   | 12-31-2010
     2 | DEF   | 
     3 | GHI   | 01-02-2010
  2000 | TC3   | 
  4000 | TC15  | 
(5 rows)

-----------------------------
-- Checking step 14
-----------------------------
set role emaj_regression_tests_adm_user2;
select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark where mark_group = 'myGroup1' order by mark_time_id, mark_group;
 mark_group |        regexp_replace        | mark_time_id | mark_is_rlbk_protected |                   mark_comment                   | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------+------------------------------+--------------+------------------------+--------------------------------------------------+---------------------------+------------------------------
 myGroup1   | M4                           |        12401 | f                      |                                                  |                        10 | 
 myGroup1   | M5                           |        12402 | f                      |                                                  |                         3 | 
 myGroup1   | Before logged rollback to M4 |        12601 | f                      | Automatically set at rollback to mark M4 start   |                        28 | 
 myGroup1   | STOP_%                       |        14000 | f                      |                                                  |                         0 | 
 myGroup1   | Stop after rollback          |        14007 | f                      |                                                  |                         0 | 
 myGroup1   | Multi-1                      |        14009 | f                      |                                                  |                        10 | 
 myGroup1   | MODIFY_%                     |        14700 | f                      |                                                  |                         0 | 
 myGroup1   | MC1                          |        14701 | f                      |                                                  |                         0 | 
 myGroup1   | RLBK_MC1_DONE                |        14704 | f                      | Automatically set at rollback to mark MC1 end    |                         2 | MC1
 myGroup1   | MC3                          |        14705 | f                      |                                                  |                         0 | 
 myGroup1   | RLBK_14701_DONE              |        14709 | f                      | Automatically set at rollback to mark MC3 end    |                         0 | MC3
 myGroup1   | MC6                          |        14710 | f                      |                                                  |                         0 | 
 myGroup1   | RLBK_14703_DONE              |        14717 | f                      | Automatically set at rollback to mark MC6 end    |                         0 | MC6
 myGroup1   | MC10                         |        14718 | f                      |                                                  |                         0 | 
 myGroup1   | RLBK_14705_DONE              |        14723 | f                      | Automatically set at rollback to mark MC10 end   |                         0 | MC10
 myGroup1   | MC15                         |        14724 | f                      |                                                  |                         0 | 
 myGroup1   | RLBK_MC15_DONE               |        14727 | f                      | Automatically set at rollback to mark MC15 end   |                         0 | MC15
 myGroup1   | MC17                         |        14728 | f                      |                                                  |                         2 | 
 myGroup1   | RLBK_14707_START             |        14729 | f                      | Automatically set at rollback to mark MC16 start |                        15 | 
 myGroup1   | RLBK_14707_DONE              |        14730 | f                      | Automatically set at rollback to mark MC16 end   |                           | 
(20 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence where sequ_schema = 'emaj_myschema1' order by sequ_time_id, sequ_schema, sequ_name;
 sequ_schema | sequ_name | sequ_time_id | sequ_last_val | sequ_is_called 
-------------+-----------+--------------+---------------+----------------
(0 rows)

select tbl_schema, tbl_name, tbl_time_id, tbl_log_seq_last_val from emaj.emaj_table where tbl_schema = 'myschema1' order by tbl_time_id, tbl_schema, tbl_name;
 tbl_schema | tbl_name | tbl_time_id | tbl_log_seq_last_val 
------------+----------+-------------+----------------------
 myschema1  | myTbl3   |       12401 |                   10
 myschema1  | mytbl1   |       12401 |                   30
 myschema1  | mytbl2   |       12401 |                    3
 myschema1  | mytbl2b  |       12401 |                    3
 myschema1  | mytbl4   |       12401 |                    8
 myschema1  | myTbl3   |       12402 |                   20
 myschema1  | mytbl1   |       12402 |                   30
 myschema1  | mytbl2   |       12402 |                    3
 myschema1  | mytbl2b  |       12402 |                    3
 myschema1  | mytbl4   |       12402 |                    8
 myschema1  | myTbl3   |       12601 |                   20
 myschema1  | mytbl1   |       12601 |                   32
 myschema1  | mytbl2   |       12601 |                    3
 myschema1  | mytbl2b  |       12601 |                    3
 myschema1  | mytbl4   |       12601 |                   12
 myschema1  | myTbl3   |       12602 |                   40
 myschema1  | mytbl1   |       12602 |                   33
 myschema1  | mytbl2   |       12602 |                    3
 myschema1  | mytbl2b  |       12602 |                    3
 myschema1  | mytbl4   |       12602 |                   14
 myschema1  | myTbl3   |       14000 |                   45
 myschema1  | mytbl1   |       14000 |                   33
 myschema1  | mytbl2   |       14000 |                    3
 myschema1  | mytbl2b  |       14000 |                    3
 myschema1  | mytbl4   |       14000 |                   14
 myschema1  | myTbl3   |       14001 |                   45
 myschema1  | mytbl1   |       14001 |                   33
 myschema1  | mytbl2   |       14001 |                    3
 myschema1  | mytbl2b  |       14001 |                    3
 myschema1  | mytbl4   |       14001 |                   14
 myschema1  | myTbl3   |       14007 |                   45
 myschema1  | mytbl1   |       14007 |                   33
 myschema1  | mytbl2   |       14007 |                    3
 myschema1  | mytbl2b  |       14007 |                    3
 myschema1  | mytbl4   |       14007 |                   14
 myschema1  | myTbl3   |       14009 |                   45
 myschema1  | mytbl1   |       14009 |                   33
 myschema1  | mytbl2   |       14009 |                    3
 myschema1  | mytbl2b  |       14009 |                    3
 myschema1  | mytbl4   |       14009 |                   14
 myschema1  | myTbl3   |       14600 |                   45
 myschema1  | mytbl1   |       14600 |                   53
 myschema1  | mytbl2   |       14600 |                    3
 myschema1  | mytbl2b  |       14600 |                   13
 myschema1  | mytbl4   |       14600 |                   14
 myschema1  | myTbl3   |       14700 |                   45
 myschema1  | mytbl1   |       14700 |                   53
 myschema1  | mytbl2   |       14700 |                    3
 myschema1  | mytbl2b  |       14700 |                   13
 myschema1  | mytbl4   |       14700 |                   14
 myschema1  | myTbl3   |       14701 |                   45
 myschema1  | mytbl1   |       14701 |                   53
 myschema1  | mytbl2   |       14701 |                    3
 myschema1  | mytbl2b  |       14701 |                   13
 myschema1  | mytbl4   |       14701 |                   14
 myschema1  | myTbl3   |       14704 |                   45
 myschema1  | mytbl1   |       14704 |                   79
 myschema1  | mytbl2   |       14704 |                    6
 myschema1  | mytbl2b  |       14704 |                   17
 myschema1  | mytbl4   |       14704 |                   14
 myschema1  | myTbl3   |       14705 |                   45
 myschema1  | mytbl1   |       14705 |                   79
 myschema1  | mytbl2   |       14705 |                    7
 myschema1  | mytbl2b  |       14705 |                   18
 myschema1  | mytbl4   |       14705 |                   14
 myschema1  | myTbl3   |       14709 |                   65
 myschema1  | mytbl1   |       14709 |                   79
 myschema1  | mytbl2   |       14709 |                    7
 myschema1  | mytbl2b  |       14709 |                   18
 myschema1  | mytbl4   |       14709 |                   17
 myschema1  | myTbl3   |       14710 |                   65
 myschema1  | mytbl1   |       14710 |                   79
 myschema1  | mytbl2   |       14710 |                    7
 myschema1  | mytbl2b  |       14710 |                   18
 myschema1  | mytbl4   |       14710 |                   17
 myschema1  | myTbl3   |       14717 |                   85
 myschema1  | mytbl1   |       14717 |                  105
 myschema1  | mytbl2   |       14717 |                   12
 myschema1  | mytbl2b  |       14717 |                   24
 myschema1  | mytbl4   |       14717 |                   20
 myschema1  | myTbl3   |       14718 |                   85
 myschema1  | mytbl1   |       14718 |                  105
 myschema1  | mytbl2   |       14718 |                   12
 myschema1  | mytbl2b  |       14718 |                   24
 myschema1  | mytbl4   |       14718 |                   20
 myschema1  | myTbl3   |       14723 |                   85
 myschema1  | mytbl1   |       14723 |                  127
 myschema1  | mytbl2   |       14723 |                   12
 myschema1  | mytbl2b  |       14723 |                   24
 myschema1  | mytbl4   |       14723 |                   23
 myschema1  | myTbl3   |       14724 |                   85
 myschema1  | mytbl1   |       14724 |                  127
 myschema1  | mytbl2   |       14724 |                   12
 myschema1  | mytbl2b  |       14724 |                   24
 myschema1  | mytbl4   |       14724 |                   23
 myschema1  | myTbl3   |       14727 |                   85
 myschema1  | mytbl1   |       14727 |                  153
 myschema1  | mytbl2   |       14727 |                   15
 myschema1  | mytbl2b  |       14727 |                   28
 myschema1  | mytbl4   |       14727 |                   23
 myschema1  | myTbl3   |       14728 |                   85
 myschema1  | mytbl1   |       14728 |                  153
 myschema1  | mytbl2   |       14728 |                   15
 myschema1  | mytbl2b  |       14728 |                   28
 myschema1  | mytbl4   |       14728 |                   23
 myschema1  | myTbl3   |       14729 |                   85
 myschema1  | mytbl1   |       14729 |                  153
 myschema1  | mytbl2   |       14729 |                   16
 myschema1  | mytbl2b  |       14729 |                   29
 myschema1  | mytbl4   |       14729 |                   23
 myschema1  | myTbl3   |       14730 |                   85
 myschema1  | mytbl1   |       14730 |                  164
 myschema1  | mytbl2   |       14730 |                   18
 myschema1  | mytbl2b  |       14730 |                   31
 myschema1  | mytbl4   |       14730 |                   23
(115 rows)

select sqhl_schema, sqhl_table, sqhl_begin_time_id, sqhl_end_time_id, sqhl_hole_size from emaj.emaj_seq_hole where sqhl_schema = 'myschema1' order by 1,2,3;
 sqhl_schema | sqhl_table | sqhl_begin_time_id | sqhl_end_time_id | sqhl_hole_size 
-------------+------------+--------------------+------------------+----------------
 myschema1   | myTbl3     |              14705 |            14709 |             20
 myschema1   | myTbl3     |              14710 |            14717 |             20
 myschema1   | mytbl1     |              12402 |            12600 |              1
 myschema1   | mytbl1     |              14009 |            14300 |             20
 myschema1   | mytbl1     |              14701 |            14704 |             26
 myschema1   | mytbl1     |              14710 |            14717 |             26
 myschema1   | mytbl1     |              14718 |            14723 |             22
 myschema1   | mytbl1     |              14724 |            14727 |             26
 myschema1   | mytbl2     |              14701 |            14704 |              3
 myschema1   | mytbl2     |              14710 |            14717 |              5
 myschema1   | mytbl2     |              14724 |            14727 |              3
 myschema1   | mytbl2b    |              14701 |            14704 |              4
 myschema1   | mytbl2b    |              14710 |            14717 |              6
 myschema1   | mytbl2b    |              14724 |            14727 |              4
 myschema1   | mytbl4     |              12402 |            12600 |              2
 myschema1   | mytbl4     |              14705 |            14709 |              3
 myschema1   | mytbl4     |              14710 |            14717 |              3
 myschema1   | mytbl4     |              14718 |            14723 |              3
(18 rows)

select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 14700 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
   14700 |           14700000 | A
   14701 |           14700000 | M
   14702 |           14700017 | M
   14703 |           14700019 | R
   14704 |           14700033 | M
   14705 |           14700035 | M
   14706 |           14700047 | M
   14707 |           14700047 | M
   14708 |           14700047 | R
   14709 |           14700058 | M
   14710 |           14700058 | M
   14711 |           14700075 | M
   14712 |           14700077 | M
   14713 |           14700079 | R
   14714 |           14700081 | M
   14715 |           14700081 | M
   14716 |           14700093 | R
   14717 |           14700118 | M
   14718 |           14700118 | M
   14719 |           14700134 | R
   14720 |           14700140 | M
   14721 |           14700140 | M
   14722 |           14700142 | R
   14723 |           14700143 | M
   14724 |           14700143 | M
   14725 |           14700160 | M
   14726 |           14700162 | R
   14727 |           14700176 | M
   14728 |           14700176 | M
   14729 |           14700178 | R
   14730 |           14700193 | M
(31 rows)

select hist_function, hist_event, hist_object,
       regexp_replace(regexp_replace(regexp_replace(hist_wording,
            E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),
            E'\\d\\d\\d\\d/\\d\\d\\/\\d\\d\\ \\d\\d\\:\\d\\d:\\d\\d .*?\\)','<timestamp>)','g'),
            E'\\[.+\\]','(timestamp)','g'), 
       hist_user
  from emaj.emaj_hist where hist_id >= 14700 order by hist_id;
     hist_function      |         hist_event         |         hist_object          |                                           regexp_replace                                           | hist_user 
------------------------+----------------------------+------------------------------+----------------------------------------------------------------------------------------------------+-----------
 MODIFY_TABLE           | BEGIN                      |                              |                                                                                                    | postgres
 MODIFY_TABLE           | TIME STAMP SET             | 14700                        |                                                                                                    | postgres
 LOCK_GROUP             | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | END                        | myGroup1                     | 5 tables locked, 0 deadlock(s)                                                                     | postgres
 SET_MARK_GROUPS        | BEGIN                      | myGroup1                     | MODIFY_%                                                                                           | postgres
 SET_MARK_GROUPS        | END                        | myGroup1                     | MODIFY_%                                                                                           | postgres
 MODIFY_TABLE           | TRIGGERS TO IGNORE CHANGED | myschema1.mytbl2             | none => {mytbl2trg2}                                                                               | postgres
 MODIFY_TABLE           | END                        |                              | 1 tables effectively modified                                                                      | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | END                        | myGroup1                     | 5 tables locked, 0 deadlock(s)                                                                     | postgres
 SET_MARK_GROUP         | TIME STAMP SET             | 14701                        |                                                                                                    | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | MC1                                                                                                | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | END                        | myGroup1                     | 5 tables locked, 0 deadlock(s)                                                                     | postgres
 SET_MARK_GROUP         | TIME STAMP SET             | 14702                        |                                                                                                    | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | MC2                                                                                                | postgres
 ROLLBACK_GROUP         | BEGIN                      | myGroup1                     | Logged rollback to mark MC1 (timestamp)                                                            | postgres
 DBLINK_OPEN_CNX        |                            | rlbk#1                       | Status = 1                                                                                         | postgres
 LOCK_GROUP             | BEGIN                      | myGroup1                     | Rollback session #1                                                                                | postgres
 LOCK_GROUP             | END                        | myGroup1                     | Rollback session #1: 5 tables locked, 0 deadlock(s)                                                | postgres
 ROLLBACK_GROUP         | TIME STAMP SET             | 14703                        |                                                                                                    | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     | RLBK_14700_START                                                                                   | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | RLBK_14700_START                                                                                   | postgres
 ROLLBACK_SEQUENCE      |                            | myschema1.mytbl2b_col20_seq  | RESTART 8                                                                                          | postgres
 ROLLBACK_TABLE         | BEGIN                      | myschema1.mytbl1             | All log rows where emaj_gid > 14700000 and <= 14700019, in session_replication_role = replica mode | postgres
 ROLLBACK_TABLE         | END                        | myschema1.mytbl1             | 13 rolled back primary keys                                                                        | postgres
 ROLLBACK_TABLE         | BEGIN                      | myschema1.mytbl2             | All log rows where emaj_gid > 14700000 and <= 14700019, in session_replication_role = replica mode | postgres
 ROLLBACK_TABLE         | END                        | myschema1.mytbl2             | 1 rolled back primary keys                                                                         | postgres
 ROLLBACK_TABLE         | BEGIN                      | myschema1.mytbl2b            | All log rows where emaj_gid > 14700000 and <= 14700019                                             | postgres
 ROLLBACK_TABLE         | END                        | myschema1.mytbl2b            | 2 rolled back primary keys                                                                         | postgres
 ROLLBACK_GROUP         | TIME STAMP SET             | 14704                        |                                                                                                    | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     | RLBK_14700_DONE                                                                                    | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | RLBK_14700_DONE                                                                                    | postgres
 ROLLBACK_GROUP         | NOTICE                     | Rollback id 14700            | Rollback id = 14700.                                                                               | postgres
 ROLLBACK_GROUP         | NOTICE                     | Rollback id 14700            | 3 / 5 tables effectively processed.                                                                | postgres
 ROLLBACK_GROUP         | NOTICE                     | Rollback id 14700            | 1 / 2 sequences effectively processed.                                                             | postgres
 DBLINK_CLOSE_CNX       |                            | rlbk#1                       |                                                                                                    | postgres
 ROLLBACK_GROUP         | END                        | myGroup1                     | Rollback_id 14700                                                                                  | postgres
 RENAME_MARK_GROUP      | BEGIN                      | myGroup1                     | EMAJ_LAST_MARK                                                                                     | postgres
 RENAME_MARK_GROUP      | END                        | myGroup1                     | RLBK_14700_DONE renamed RLBK_MC1_DONE                                                              | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | END                        | myGroup1                     | 5 tables locked, 0 deadlock(s)                                                                     | postgres
 SET_MARK_GROUP         | TIME STAMP SET             | 14705                        |                                                                                                    | postgres
 CLEANUP_RLBK_STATE     |                            | Rollback id 14700            | set to COMMITTED                                                                                   | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | MC3                                                                                                | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | END                        | myGroup1                     | 5 tables locked, 0 deadlock(s)                                                                     | postgres
 SET_MARK_GROUP         | TIME STAMP SET             | 14706                        |                                                                                                    | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | MC4                                                                                                | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | END                        | myGroup1                     | 5 tables locked, 0 deadlock(s)                                                                     | postgres
 SET_MARK_GROUP         | TIME STAMP SET             | 14707                        |                                                                                                    | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | MC5                                                                                                | postgres
 ROLLBACK_GROUP         | BEGIN                      | myGroup1                     | Logged rollback to mark MC3 (timestamp)                                                            | postgres
 DBLINK_OPEN_CNX        |                            | rlbk#1                       | Status = 1                                                                                         | postgres
 LOCK_GROUP             | BEGIN                      | myGroup1                     | Rollback session #1                                                                                | postgres
 LOCK_GROUP             | END                        | myGroup1                     | Rollback session #1: 5 tables locked, 0 deadlock(s)                                                | postgres
 ROLLBACK_GROUP         | TIME STAMP SET             | 14708                        |                                                                                                    | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     | RLBK_14701_START                                                                                   | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | RLBK_14701_START                                                                                   | postgres
 ROLLBACK_SEQUENCE      |                            | myschema1."myTbl3_col31_seq" | RESTART 21                                                                                         | postgres
 ROLLBACK_TABLE         | BEGIN                      | myschema1."myTbl3"           | All log rows where emaj_gid > 14700035 and <= 14700047                                             | postgres
 ROLLBACK_TABLE         | END                        | myschema1."myTbl3"           | 10 rolled back primary keys                                                                        | postgres
 ROLLBACK_TABLE         | BEGIN                      | myschema1.mytbl4             | All log rows where emaj_gid > 14700035 and <= 14700047, in session_replication_role = replica mode | postgres
 ROLLBACK_TABLE         | END                        | myschema1.mytbl4             | 1 rolled back primary keys                                                                         | postgres
 ROLLBACK_GROUP         | TIME STAMP SET             | 14709                        |                                                                                                    | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     | RLBK_14701_DONE                                                                                    | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | RLBK_14701_DONE                                                                                    | postgres
 ROLLBACK_GROUP         | NOTICE                     | Rollback id 14701            | Rollback id = 14701.                                                                               | postgres
 ROLLBACK_GROUP         | NOTICE                     | Rollback id 14701            | 2 / 5 tables effectively processed.                                                                | postgres
 ROLLBACK_GROUP         | NOTICE                     | Rollback id 14701            | 1 / 2 sequences effectively processed.                                                             | postgres
 DBLINK_CLOSE_CNX       |                            | rlbk#1                       |                                                                                                    | postgres
 ROLLBACK_GROUP         | END                        | myGroup1                     | Rollback_id 14701                                                                                  | postgres
 CONSOLIDATE_RLBK_GROUP | BEGIN                      | myGroup1                     | Erase all between marks MC1 and RLBK_MC1_DONE                                                      | postgres
 CONSOLIDATE_RLBK_GROUP | END                        | myGroup1                     | 3 tables and 2 sequences processed ; 2 marks deleted                                               | postgres
 CONSOLIDATE_RLBK_GROUP | BEGIN                      | myGroup1                     | Erase all between marks MC3 and RLBK_14701_DONE                                                    | postgres
 CONSOLIDATE_RLBK_GROUP | END                        | myGroup1                     | 2 tables and 2 sequences processed ; 3 marks deleted                                               | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | END                        | myGroup1                     | 5 tables locked, 0 deadlock(s)                                                                     | postgres
 SET_MARK_GROUP         | TIME STAMP SET             | 14710                        |                                                                                                    | postgres
 CLEANUP_RLBK_STATE     |                            | Rollback id 14701            | set to COMMITTED                                                                                   | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | MC6                                                                                                | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | END                        | myGroup1                     | 5 tables locked, 0 deadlock(s)                                                                     | postgres
 SET_MARK_GROUP         | TIME STAMP SET             | 14711                        |                                                                                                    | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | MC7                                                                                                | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | END                        | myGroup1                     | 5 tables locked, 0 deadlock(s)                                                                     | postgres
 SET_MARK_GROUP         | TIME STAMP SET             | 14712                        |                                                                                                    | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | MC8                                                                                                | postgres
 ROLLBACK_GROUP         | BEGIN                      | myGroup1                     | Logged rollback to mark MC8 (timestamp)                                                            | postgres
 DBLINK_OPEN_CNX        |                            | rlbk#1                       | Status = 1                                                                                         | postgres
 LOCK_GROUP             | BEGIN                      | myGroup1                     | Rollback session #1                                                                                | postgres
 LOCK_GROUP             | END                        | myGroup1                     | Rollback session #1: 5 tables locked, 0 deadlock(s)                                                | postgres
 ROLLBACK_GROUP         | TIME STAMP SET             | 14713                        |                                                                                                    | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     | RLBK_14702_START                                                                                   | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | RLBK_14702_START                                                                                   | postgres
 ROLLBACK_SEQUENCE      |                            | myschema1.mytbl2b_col20_seq  | RESTART 11                                                                                         | postgres
 ROLLBACK_TABLE         | BEGIN                      | myschema1.mytbl2             | All log rows where emaj_gid > 14700077 and <= 14700079, in session_replication_role = replica mode | postgres
 ROLLBACK_TABLE         | END                        | myschema1.mytbl2             | 1 rolled back primary keys                                                                         | postgres
 ROLLBACK_TABLE         | BEGIN                      | myschema1.mytbl2b            | All log rows where emaj_gid > 14700077 and <= 14700079                                             | postgres
 ROLLBACK_TABLE         | END                        | myschema1.mytbl2b            | 1 rolled back primary keys                                                                         | postgres
 ROLLBACK_GROUP         | TIME STAMP SET             | 14714                        |                                                                                                    | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     | RLBK_14702_DONE                                                                                    | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | RLBK_14702_DONE                                                                                    | postgres
 ROLLBACK_GROUP         | NOTICE                     | Rollback id 14702            | Rollback id = 14702.                                                                               | postgres
 ROLLBACK_GROUP         | NOTICE                     | Rollback id 14702            | 2 / 5 tables effectively processed.                                                                | postgres
 ROLLBACK_GROUP         | NOTICE                     | Rollback id 14702            | 1 / 2 sequences effectively processed.                                                             | postgres
 DBLINK_CLOSE_CNX       |                            | rlbk#1                       |                                                                                                    | postgres
 ROLLBACK_GROUP         | END                        | myGroup1                     | Rollback_id 14702                                                                                  | postgres
 CONSOLIDATE_RLBK_GROUP | BEGIN                      | myGroup1                     | Erase all between marks MC8 and RLBK_14702_DONE                                                    | postgres
 CONSOLIDATE_RLBK_GROUP | END                        | myGroup1                     | 2 tables and 2 sequences processed ; 1 marks deleted                                               | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | END                        | myGroup1                     | 5 tables locked, 0 deadlock(s)                                                                     | postgres
 SET_MARK_GROUP         | TIME STAMP SET             | 14715                        |                                                                                                    | postgres
 CLEANUP_RLBK_STATE     |                            | Rollback id 14702            | set to COMMITTED                                                                                   | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | MC9                                                                                                | postgres
 ROLLBACK_GROUP         | BEGIN                      | myGroup1                     | Logged rollback to mark MC6 (timestamp)                                                            | postgres
 DBLINK_OPEN_CNX        |                            | rlbk#1                       | Status = 1                                                                                         | postgres
 LOCK_GROUP             | BEGIN                      | myGroup1                     | Rollback session #1                                                                                | postgres
 LOCK_GROUP             | END                        | myGroup1                     | Rollback session #1: 5 tables locked, 0 deadlock(s)                                                | postgres
 ROLLBACK_GROUP         | TIME STAMP SET             | 14716                        |                                                                                                    | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     | RLBK_14703_START                                                                                   | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | RLBK_14703_START                                                                                   | postgres
 ROLLBACK_SEQUENCE      |                            | myschema1."myTbl3_col31_seq" | RESTART 21                                                                                         | postgres
 ROLLBACK_SEQUENCE      |                            | myschema1.mytbl2b_col20_seq  | RESTART 9                                                                                          | postgres
 ROLLBACK_TABLE         | BEGIN                      | myschema1.mytbl1             | All log rows where emaj_gid > 14700058 and <= 14700093, in session_replication_role = replica mode | postgres
 ROLLBACK_TABLE         | END                        | myschema1.mytbl1             | 13 rolled back primary keys                                                                        | postgres
 ROLLBACK_TABLE         | BEGIN                      | myschema1."myTbl3"           | All log rows where emaj_gid > 14700058 and <= 14700093                                             | postgres
 ROLLBACK_TABLE         | END                        | myschema1."myTbl3"           | 10 rolled back primary keys                                                                        | postgres
 ROLLBACK_TABLE         | BEGIN                      | myschema1.mytbl2             | All log rows where emaj_gid > 14700058 and <= 14700093, in session_replication_role = replica mode | postgres
 ROLLBACK_TABLE         | END                        | myschema1.mytbl2             | 1 rolled back primary keys                                                                         | postgres
 ROLLBACK_TABLE         | BEGIN                      | myschema1.mytbl2b            | All log rows where emaj_gid > 14700058 and <= 14700093                                             | postgres
 ROLLBACK_TABLE         | END                        | myschema1.mytbl2b            | 2 rolled back primary keys                                                                         | postgres
 ROLLBACK_TABLE         | BEGIN                      | myschema1.mytbl4             | All log rows where emaj_gid > 14700058 and <= 14700093, in session_replication_role = replica mode | postgres
 ROLLBACK_TABLE         | END                        | myschema1.mytbl4             | 1 rolled back primary keys                                                                         | postgres
 ROLLBACK_GROUP         | TIME STAMP SET             | 14717                        |                                                                                                    | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     | RLBK_14703_DONE                                                                                    | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | RLBK_14703_DONE                                                                                    | postgres
 ROLLBACK_GROUP         | NOTICE                     | Rollback id 14703            | Rollback id = 14703.                                                                               | postgres
 ROLLBACK_GROUP         | NOTICE                     | Rollback id 14703            | 5 / 5 tables effectively processed.                                                                | postgres
 ROLLBACK_GROUP         | NOTICE                     | Rollback id 14703            | 2 / 2 sequences effectively processed.                                                             | postgres
 DBLINK_CLOSE_CNX       |                            | rlbk#1                       |                                                                                                    | postgres
 ROLLBACK_GROUP         | END                        | myGroup1                     | Rollback_id 14703                                                                                  | postgres
 CONSOLIDATE_RLBK_GROUP | BEGIN                      | myGroup1                     | Erase all between marks MC6 and RLBK_14703_DONE                                                    | postgres
 CONSOLIDATE_RLBK_GROUP | END                        | myGroup1                     | 5 tables and 2 sequences processed ; 5 marks deleted                                               | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | END                        | myGroup1                     | 5 tables locked, 0 deadlock(s)                                                                     | postgres
 SET_MARK_GROUP         | TIME STAMP SET             | 14718                        |                                                                                                    | postgres
 CLEANUP_RLBK_STATE     |                            | Rollback id 14703            | set to COMMITTED                                                                                   | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | MC10                                                                                               | postgres
 ROLLBACK_GROUP         | BEGIN                      | myGroup1                     | Logged rollback to mark MC10 (timestamp)                                                           | postgres
 DBLINK_OPEN_CNX        |                            | rlbk#1                       | Status = 1                                                                                         | postgres
 LOCK_GROUP             | BEGIN                      | myGroup1                     | Rollback session #1                                                                                | postgres
 LOCK_GROUP             | END                        | myGroup1                     | Rollback session #1: 5 tables locked, 0 deadlock(s)                                                | postgres
 ROLLBACK_GROUP         | TIME STAMP SET             | 14719                        |                                                                                                    | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     | RLBK_14704_START                                                                                   | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | RLBK_14704_START                                                                                   | postgres
 ROLLBACK_TABLE         | BEGIN                      | myschema1.mytbl1             | All log rows where emaj_gid > 14700118 and <= 14700134, in session_replication_role = replica mode | postgres
 ROLLBACK_TABLE         | END                        | myschema1.mytbl1             | 11 rolled back primary keys                                                                        | postgres
 ROLLBACK_GROUP         | TIME STAMP SET             | 14720                        |                                                                                                    | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     | RLBK_14704_DONE                                                                                    | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | RLBK_14704_DONE                                                                                    | postgres
 ROLLBACK_GROUP         | NOTICE                     | Rollback id 14704            | Rollback id = 14704.                                                                               | postgres
 ROLLBACK_GROUP         | NOTICE                     | Rollback id 14704            | 1 / 5 tables effectively processed.                                                                | postgres
 ROLLBACK_GROUP         | NOTICE                     | Rollback id 14704            | 0 / 2 sequences effectively processed.                                                             | postgres
 DBLINK_CLOSE_CNX       |                            | rlbk#1                       |                                                                                                    | postgres
 ROLLBACK_GROUP         | END                        | myGroup1                     | Rollback_id 14704                                                                                  | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | END                        | myGroup1                     | 5 tables locked, 0 deadlock(s)                                                                     | postgres
 SET_MARK_GROUP         | TIME STAMP SET             | 14721                        |                                                                                                    | postgres
 CLEANUP_RLBK_STATE     |                            | Rollback id 14704            | set to COMMITTED                                                                                   | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | MC11                                                                                               | postgres
 ROLLBACK_GROUP         | BEGIN                      | myGroup1                     | Logged rollback to mark MC10 (timestamp)                                                           | postgres
 DBLINK_OPEN_CNX        |                            | rlbk#1                       | Status = 1                                                                                         | postgres
 LOCK_GROUP             | BEGIN                      | myGroup1                     | Rollback session #1                                                                                | postgres
 LOCK_GROUP             | END                        | myGroup1                     | Rollback session #1: 5 tables locked, 0 deadlock(s)                                                | postgres
 ROLLBACK_GROUP         | TIME STAMP SET             | 14722                        |                                                                                                    | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     | RLBK_14705_START                                                                                   | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | RLBK_14705_START                                                                                   | postgres
 ROLLBACK_TABLE         | BEGIN                      | myschema1.mytbl1             | All log rows where emaj_gid > 14700118 and <= 14700142, in session_replication_role = replica mode | postgres
 ROLLBACK_TABLE         | END                        | myschema1.mytbl1             | 11 rolled back primary keys                                                                        | postgres
 ROLLBACK_TABLE         | BEGIN                      | myschema1.mytbl4             | All log rows where emaj_gid > 14700118 and <= 14700142, in session_replication_role = replica mode | postgres
 ROLLBACK_TABLE         | END                        | myschema1.mytbl4             | 1 rolled back primary keys                                                                         | postgres
 ROLLBACK_GROUP         | TIME STAMP SET             | 14723                        |                                                                                                    | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     | RLBK_14705_DONE                                                                                    | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | RLBK_14705_DONE                                                                                    | postgres
 ROLLBACK_GROUP         | NOTICE                     | Rollback id 14705            | Rollback id = 14705.                                                                               | postgres
 ROLLBACK_GROUP         | NOTICE                     | Rollback id 14705            | 2 / 5 tables effectively processed.                                                                | postgres
 ROLLBACK_GROUP         | NOTICE                     | Rollback id 14705            | 0 / 2 sequences effectively processed.                                                             | postgres
 DBLINK_CLOSE_CNX       |                            | rlbk#1                       |                                                                                                    | postgres
 ROLLBACK_GROUP         | END                        | myGroup1                     | Rollback_id 14705                                                                                  | postgres
 CONSOLIDATE_RLBK_GROUP | BEGIN                      | myGroup1                     | Erase all between marks MC10 and RLBK_14705_DONE                                                   | postgres
 CONSOLIDATE_RLBK_GROUP | END                        | myGroup1                     | 2 tables and 2 sequences processed ; 4 marks deleted                                               | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | END                        | myGroup1                     | 5 tables locked, 0 deadlock(s)                                                                     | postgres
 SET_MARK_GROUP         | TIME STAMP SET             | 14724                        |                                                                                                    | postgres
 CLEANUP_RLBK_STATE     |                            | Rollback id 14705            | set to COMMITTED                                                                                   | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | MC15                                                                                               | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | END                        | myGroup1                     | 5 tables locked, 0 deadlock(s)                                                                     | postgres
 SET_MARK_GROUP         | TIME STAMP SET             | 14725                        |                                                                                                    | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | MC16                                                                                               | postgres
 ROLLBACK_GROUP         | BEGIN                      | myGroup1                     | Logged rollback to mark MC15 (timestamp)                                                           | postgres
 DBLINK_OPEN_CNX        |                            | rlbk#1                       | Status = 1                                                                                         | postgres
 LOCK_GROUP             | BEGIN                      | myGroup1                     | Rollback session #1                                                                                | postgres
 LOCK_GROUP             | END                        | myGroup1                     | Rollback session #1: 5 tables locked, 0 deadlock(s)                                                | postgres
 ROLLBACK_GROUP         | TIME STAMP SET             | 14726                        |                                                                                                    | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     | RLBK_14706_START                                                                                   | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | RLBK_14706_START                                                                                   | postgres
 ROLLBACK_SEQUENCE      |                            | myschema1.mytbl2b_col20_seq  | RESTART 9                                                                                          | postgres
 ROLLBACK_TABLE         | BEGIN                      | myschema1.mytbl1             | All log rows where emaj_gid > 14700143 and <= 14700162, in session_replication_role = replica mode | postgres
 ROLLBACK_TABLE         | END                        | myschema1.mytbl1             | 13 rolled back primary keys                                                                        | postgres
 ROLLBACK_TABLE         | BEGIN                      | myschema1.mytbl2             | All log rows where emaj_gid > 14700143 and <= 14700162, in session_replication_role = replica mode | postgres
 ROLLBACK_TABLE         | END                        | myschema1.mytbl2             | 1 rolled back primary keys                                                                         | postgres
 ROLLBACK_TABLE         | BEGIN                      | myschema1.mytbl2b            | All log rows where emaj_gid > 14700143 and <= 14700162                                             | postgres
 ROLLBACK_TABLE         | END                        | myschema1.mytbl2b            | 2 rolled back primary keys                                                                         | postgres
 ROLLBACK_GROUP         | TIME STAMP SET             | 14727                        |                                                                                                    | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     | RLBK_14706_DONE                                                                                    | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | RLBK_14706_DONE                                                                                    | postgres
 ROLLBACK_GROUP         | NOTICE                     | Rollback id 14706            | Rollback id = 14706.                                                                               | postgres
 ROLLBACK_GROUP         | NOTICE                     | Rollback id 14706            | 3 / 5 tables effectively processed.                                                                | postgres
 ROLLBACK_GROUP         | NOTICE                     | Rollback id 14706            | 1 / 2 sequences effectively processed.                                                             | postgres
 DBLINK_CLOSE_CNX       |                            | rlbk#1                       |                                                                                                    | postgres
 ROLLBACK_GROUP         | END                        | myGroup1                     | Rollback_id 14706                                                                                  | postgres
 RENAME_MARK_GROUP      | BEGIN                      | myGroup1                     | EMAJ_LAST_MARK                                                                                     | postgres
 RENAME_MARK_GROUP      | END                        | myGroup1                     | RLBK_14706_DONE renamed RLBK_MC15_DONE                                                             | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | BEGIN                      | myGroup1                     |                                                                                                    | postgres
 LOCK_GROUP             | END                        | myGroup1                     | 5 tables locked, 0 deadlock(s)                                                                     | postgres
 SET_MARK_GROUP         | TIME STAMP SET             | 14728                        |                                                                                                    | postgres
 CLEANUP_RLBK_STATE     |                            | Rollback id 14706            | set to COMMITTED                                                                                   | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | MC17                                                                                               | postgres
 ROLLBACK_GROUP         | BEGIN                      | myGroup1                     | Logged rollback to mark MC16 (timestamp)                                                           | postgres
 DBLINK_OPEN_CNX        |                            | rlbk#1                       | Status = 1                                                                                         | postgres
 LOCK_GROUP             | BEGIN                      | myGroup1                     | Rollback session #1                                                                                | postgres
 LOCK_GROUP             | END                        | myGroup1                     | Rollback session #1: 5 tables locked, 0 deadlock(s)                                                | postgres
 ROLLBACK_GROUP         | TIME STAMP SET             | 14729                        |                                                                                                    | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     | RLBK_14707_START                                                                                   | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | RLBK_14707_START                                                                                   | postgres
 ROLLBACK_TABLE         | BEGIN                      | myschema1.mytbl1             | All log rows where emaj_gid > 14700160 and <= 14700178, in session_replication_role = replica mode | postgres
 ROLLBACK_TABLE         | END                        | myschema1.mytbl1             | 11 rolled back primary keys                                                                        | postgres
 ROLLBACK_TABLE         | BEGIN                      | myschema1.mytbl2b            | All log rows where emaj_gid > 14700160 and <= 14700178                                             | postgres
 ROLLBACK_TABLE         | END                        | myschema1.mytbl2b            | 2 rolled back primary keys                                                                         | postgres
 ROLLBACK_TABLE         | BEGIN                      | myschema1.mytbl2             | All log rows where emaj_gid > 14700160 and <= 14700178, in session_replication_role = replica mode | postgres
 ROLLBACK_TABLE         | END                        | myschema1.mytbl2             | 2 rolled back primary keys                                                                         | postgres
 ROLLBACK_GROUP         | TIME STAMP SET             | 14730                        |                                                                                                    | postgres
 SET_MARK_GROUP         | BEGIN                      | myGroup1                     | RLBK_14707_DONE                                                                                    | postgres
 SET_MARK_GROUP         | END                        | myGroup1                     | RLBK_14707_DONE                                                                                    | postgres
 ROLLBACK_GROUP         | NOTICE                     | Rollback id 14707            | Rollback id = 14707.                                                                               | postgres
 ROLLBACK_GROUP         | NOTICE                     | Rollback id 14707            | 3 / 5 tables effectively processed.                                                                | postgres
 ROLLBACK_GROUP         | NOTICE                     | Rollback id 14707            | 0 / 2 sequences effectively processed.                                                             | postgres
 DBLINK_CLOSE_CNX       |                            | rlbk#1                       |                                                                                                    | postgres
 ROLLBACK_GROUP         | END                        | myGroup1                     | Rollback_id 14707                                                                                  | postgres
 CONSOLIDATE_RLBK_GROUP | BEGIN                      | myGroup1                     | Erase all between marks MC15 and RLBK_MC15_DONE                                                    | postgres
 CONSOLIDATE_RLBK_GROUP | END                        | myGroup1                     | 3 tables and 2 sequences processed ; 2 marks deleted                                               | postgres
(269 rows)

select * from emaj.emaj_rollback_group('myGroup1','Multi-1',true) order by 1,2;
 rlbk_severity |                                  rlbk_message                                   
---------------+---------------------------------------------------------------------------------
 Notice        | 2 / 2 sequences effectively processed.
 Notice        | 3 / 5 tables effectively processed.
 Notice        | Rollback id = 14708.
 Warning       | Tables group change not rolled back: ignored triggers list for myschema1.mytbl2
(4 rows)

-- remove the temp directory
\! rm -R $EMAJTESTTMPDIR
reset role;
