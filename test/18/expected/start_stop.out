-- start_stop.sql : test emaj_start_group(), emaj_start_groups(),
--                      emaj_is_logging_group(), emaj_get_logging_groups(), emaj_get_idle_groups(),
--                      emaj_stop_group(), emaj_stop_groups(), emaj_force_stop_group(),
--                      emaj_protect_group() and emaj_unprotect_group() functions
--
-- do not display DETAIL and CONTEXT outputs when an error is raised (\errverbose can be used to debug a statement)
\set VERBOSITY terse
-- set sequence restart value
-- define and create the temp file directory to be used by the script
\setenv EMAJTESTTMPDIR '/tmp/emaj_'`echo $PGVER`'/create_drop'
\set EMAJTESTTMPDIR `echo $EMAJTESTTMPDIR`
\! mkdir -p $EMAJTESTTMPDIR
select public.handle_emaj_sequences(2000);
 handle_emaj_sequences 
-----------------------
 
(1 row)

-- build original groups
select emaj.emaj_import_groups_configuration(:'EMAJTESTTMPDIR' || '/../all_groups_config.json', array['myGroup1','myGroup2','emptyGroup'], true);
WARNING:  _create_tbl: The table "myschema1.mytbl2" has triggers that will be automatically disabled during E-Maj rollback operations (mytbl2trg1, mytbl2trg2). Use the emaj_modify_table() function to change this behaviour.
 emaj_import_groups_configuration 
----------------------------------
                                3
(1 row)

-- disable event triggers 
-- this is done to allow tests with missing or renamed or altered components
select emaj.emaj_disable_protection_by_event_triggers();
 emaj_disable_protection_by_event_triggers 
-------------------------------------------
                                         3
(1 row)

-----------------------------
-- emaj_start_group(), emaj_is_logging_group(), emaj_get_logging_groups() and emaj_get_idle_groups() tests
-----------------------------
-- group is unknown in emaj_group
select emaj.emaj_start_group(NULL,NULL);
ERROR:  _check_group_names: No group to process.
select emaj.emaj_start_group('unknownGroup',NULL,NULL);
ERROR:  _check_group_names: The group "unknownGroup" does not exist.
select emaj.emaj_start_groups(array['unknownGroup1','unknownGroup2'],NULL,NULL);
ERROR:  _check_group_names: The groups "unknownGroup1, unknownGroup2" do not exist.
-- reserved mark name
select emaj.emaj_start_group('myGroup1','EMAJ_LAST_MARK');
ERROR:  _check_new_mark: "EMAJ_LAST_MARK" is not an allowed name for a new mark.
-- detection of a missing application schema
SET client_min_messages TO WARNING;
begin;
  drop schema myschema1 cascade;
  select emaj.emaj_start_group('myGroup1','M1');
ERROR:  _verify_groups (1): In tables group "myGroup1", the table "myschema1"."myTbl3" does not exist anymore. You may use "SELECT * FROM emaj.emaj_verify_all()" to look for other issues.
rollback;
RESET client_min_messages;
-- detection of a missing application relation
begin;
  drop table myschema1.mytbl4;
  select emaj.emaj_start_group('myGroup1','M1');
ERROR:  _verify_groups (1): In tables group "myGroup1", the table "myschema1"."mytbl4" does not exist anymore. You may use "SELECT * FROM emaj.emaj_verify_all()" to look for other issues.
rollback;
-- detection of relation type change (a table is now a sequence!)
begin;
  update emaj.emaj_relation set rel_kind = 'S' where rel_schema = 'myschema1' and rel_tblseq = 'mytbl1' and upper_inf(rel_time_range);
  select emaj.emaj_start_group('myGroup1','M1');
ERROR:  _verify_groups (1): In tables group "myGroup1", the sequence "myschema1"."mytbl1" does not exist anymore. You may use "SELECT * FROM emaj.emaj_verify_all()" to look for other issues.
rollback;
-- detection of a missing E-Maj log schema
SET client_min_messages TO WARNING;
begin;
  drop schema emaj_myschema1 cascade;
  select emaj.emaj_start_group('myGroup1','M1');
ERROR:  _verify_groups (2): In tables group "myGroup1", the log table "emaj_myschema1"."myTbl3_log" is not found. You may use "SELECT * FROM emaj.emaj_verify_all()" to look for other issues.
rollback;
RESET client_min_messages;
-- detection of a missing log trigger
begin;
  drop trigger emaj_log_trg on myschema1.mytbl1;
  select emaj.emaj_start_group('myGroup1','M1');
ERROR:  _verify_groups (4): In tables group "myGroup1", the log trigger "emaj_log_trg" on table "myschema1"."mytbl1" is not found. You may use "SELECT * FROM emaj.emaj_verify_all()" to look for other issues.
rollback;
-- detection of a missing log function
begin;
  drop function emaj_myschema1.mytbl1_log_fnct() cascade;
NOTICE:  drop cascades to trigger emaj_log_trg on table myschema1.mytbl1
  select emaj.emaj_start_group('myGroup1','M1');
ERROR:  _verify_groups (3): In tables group "myGroup1", the log function "emaj_myschema1"."mytbl1_log_fnct" is not found. You may use "SELECT * FROM emaj.emaj_verify_all()" to look for other issues.
rollback;
-- detection of a missing truncate trigger
begin;
  drop trigger emaj_trunc_trg on myschema1.mytbl1;
  select emaj.emaj_start_group('myGroup1','M1');
ERROR:  _verify_groups (5): In tables group "myGroup1", the truncate trigger "emaj_trunc_trg" on table "myschema1"."mytbl1" is not found. You may use "SELECT * FROM emaj.emaj_verify_all()" to look for other issues.
rollback;
-- detection of a missing log table
begin;
  drop table emaj_myschema1.mytbl1_log;
  select emaj.emaj_start_group('myGroup1','M1');
ERROR:  _verify_groups (2): In tables group "myGroup1", the log table "emaj_myschema1"."mytbl1_log" is not found. You may use "SELECT * FROM emaj.emaj_verify_all()" to look for other issues.
rollback;
-- detection of a change in the application table structure (new column)
begin;
  alter table myschema1.mytbl1 add column newcol int;
  alter table myschema1.mytbl1 add column othernewcol text;
  alter table myschema1.mytbl2 add column newcol int;
  select emaj.emaj_start_group('myGroup1','M1');
ERROR:  _verify_groups (6): In tables group "myGroup1", the structure of the application table "myschema1"."mytbl1" is not coherent with its log table ("emaj_myschema1"."mytbl1_log"). You may use "SELECT * FROM emaj.emaj_verify_all()" to look for other issues.
rollback;
-- detection of a change in the application table structure (column type change)
begin;
  alter table myschema1.mytbl4 drop column col42;
  alter table myschema1.mytbl4 alter column col45 type varchar(15);
  select emaj.emaj_start_group('myGroup1','M1');
ERROR:  _verify_groups (6): In tables group "myGroup1", the structure of the application table "myschema1"."mytbl4" is not coherent with its log table ("emaj_myschema1"."mytbl4_log"). You may use "SELECT * FROM emaj.emaj_verify_all()" to look for other issues.
rollback;
-- detection of a missing primary key
begin;
  alter table myschema1.mytbl4 drop constraint mytbl4_pkey;
  select emaj.emaj_start_group('myGroup1','M1');
ERROR:  _verify_groups (7): In the rollbackable tables group "myGroup1", the table "myschema1"."mytbl4" has no primary key anymore. You may use "SELECT * FROM emaj.emaj_verify_all()" to look for other issues.
rollback;
-- detection of a table altered as UNLOGGED
begin;
  alter table myschema1."myTbl3" set unlogged;                        -- needs 9.5+
  select emaj.emaj_start_group('myGroup1','M1');
ERROR:  _verify_groups (8): In the rollbackable tables group "myGroup1", the table "myschema1"."myTbl3" is UNLOGGED or TEMP. You may use "SELECT * FROM emaj.emaj_verify_all()" to look for other issues.
rollback;
-- detection of a primary key structure change
begin;
  alter table myschema1.mytbl4 drop constraint mytbl4_pkey;
  alter table myschema1.mytbl4 add primary key (col41, col42);
  select emaj.emaj_start_group('myGroup1','M1');
ERROR:  _verify_groups (9): In the rollbackable tables group "myGroup1", the primary key of the table "myschema1"."mytbl4" has changed (col43,col41 => col41,col42). You may use "SELECT * FROM emaj.emaj_verify_all()" to look for other issues.
rollback;
-- detection of STORED generated column whose expression has been dropped
begin;
  alter table myschema1.mytbl2b alter column col22 drop expression;
  select emaj.emaj_start_group('myGroup1','M1');
ERROR:  _verify_groups (10): In tables group "myGroup1", the "GENERATED AS expression" columns list of the table "myschema1"."mytbl2b" has changed (col22,col23 => col23). You may use "SELECT * FROM emaj.emaj_verify_all()" to look for other issues.
rollback;
-- detection of a column transformed into generated column
begin;
  alter table myschema1.mytbl2b drop column col24, add column col24 BOOLEAN GENERATED ALWAYS AS (col21 > 3) STORED;
  select emaj.emaj_start_group('myGroup1','M1');
ERROR:  _verify_groups (10): In tables group "myGroup1", the "GENERATED AS expression" columns list of the table "myschema1"."mytbl2b" has changed (col22,col23 => col22,col23,col24). You may use "SELECT * FROM emaj.emaj_verify_all()" to look for other issues.
rollback;
-- detection of a bad trigger in a "triggers to ignore at rollback time" array
begin;
  update emaj.emaj_relation set rel_ignored_triggers = '{"dummy1","dummy2"}'
    where rel_schema = 'myschema1' and rel_tblseq = 'mytbl1' and upper_inf(rel_time_range);
  select emaj.emaj_start_group('myGroup1','M1');
ERROR:  _verify_groups (11): Error: In group "myGroup1", the trigger "dummy1" for table "myschema1"."mytbl1" is missing. Use the emaj_modify_table() function to adjust the list of application triggers that should not be automatically disabled at rollback time. You may use "SELECT * FROM emaj.emaj_verify_all()" to look for other issues.
rollback;
-- detection of a log table missing a technical column
begin;
  alter table emaj_myschema1.mytbl1_log drop column emaj_verb;
  select emaj.emaj_start_group('myGroup1','M1');
ERROR:  _verify_groups (12): In tables group "myGroup1", the log table "emaj_myschema1"."mytbl1_log" miss some technical columns (emaj_verb). You may use "SELECT * FROM emaj.emaj_verify_all()" to look for other issues.
rollback;
-- should be OK
-- use the first correct emaj_start_group() function call to test the emaj_hist purge
INSERT INTO emaj.emaj_param (param_key, param_value_interval) VALUES ('history_retention','0.1 second'::interval);
select pg_sleep(0.2);
 pg_sleep 
----------
 
(1 row)

select emaj.emaj_start_group('myGroup1','Mark1');
 emaj_start_group 
------------------
                7
(1 row)

-- check old events are deleted
select hist_function, hist_event, hist_object,
       regexp_replace(regexp_replace(hist_wording,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),E'\\[.+\\]','(timestamp)','g'),
       hist_user
  from emaj.emaj_hist order by hist_id;
  hist_function  |   hist_event   | hist_object |                                                                     regexp_replace                                                                      | hist_user 
-----------------+----------------+-------------+---------------------------------------------------------------------------------------------------------------------------------------------------------+-----------
 START_GROUP     | BEGIN          | myGroup1    | With log reset                                                                                                                                          | postgres
 START_GROUP     | TIME STAMP SET | 2002        |                                                                                                                                                         | postgres
 PURGE_HISTORIES |                |             | 351 emaj_hist rows deleted ; 1 log session rows deleted ; 9 group history rows deleted ; 45 relation history rows deleted ; 34 relation changes deleted | postgres
 LOCK_GROUP      | BEGIN          | myGroup1    |                                                                                                                                                         | postgres
 LOCK_GROUP      | END            | myGroup1    | 5 tables locked, 0 deadlock(s)                                                                                                                          | postgres
 SET_MARK_GROUP  | BEGIN          | myGroup1    | Mark1                                                                                                                                                   | postgres
 SET_MARK_GROUP  | END            | myGroup1    | Mark1                                                                                                                                                   | postgres
 START_GROUP     | END            | myGroup1    | 7 tables/sequences processed                                                                                                                            | postgres
(8 rows)

-- test the smallest history_retention value that means infinity
update emaj.emaj_param set param_value_interval = '100 years'::interval where param_key = 'history_retention';
select emaj.emaj_start_group('myGroup2','Mark2',true);
 emaj_start_group 
------------------
               10
(1 row)

delete from emaj.emaj_param where param_key = 'history_retention';
select emaj.emaj_start_group('phil''s group#3",','Mark3',false);
 emaj_start_group 
------------------
                4
(1 row)

select emaj.emaj_start_group('emptyGroup','Mark1');
 emaj_start_group 
------------------
                0
(1 row)

select emaj.emaj_stop_group('myGroup1');
 emaj_stop_group 
-----------------
               7
(1 row)

select emaj.emaj_stop_group('myGroup2');
 emaj_stop_group 
-----------------
              10
(1 row)

-- check group state
select emaj.emaj_is_logging_group('unknownGroup');
 emaj_is_logging_group 
-----------------------
 f
(1 row)

select emaj.emaj_is_logging_group('emptyGroup');
 emaj_is_logging_group 
-----------------------
 t
(1 row)

select emaj.emaj_is_logging_group('myGroup1');
 emaj_is_logging_group 
-----------------------
 f
(1 row)

-- get group names array
select emaj.emaj_get_logging_groups();
     emaj_get_logging_groups      
----------------------------------
 {emptyGroup,"phil's group#3\","}
(1 row)

select emaj.emaj_get_logging_groups('Group');
 emaj_get_logging_groups 
-------------------------
 {emptyGroup}
(1 row)

select emaj.emaj_get_logging_groups(null, 'empty');
 emaj_get_logging_groups 
-------------------------
 {"phil's group#3\","}
(1 row)

select emaj.emaj_get_logging_groups('\d', 'my');
 emaj_get_logging_groups 
-------------------------
 {"phil's group#3\","}
(1 row)

select emaj.emaj_get_idle_groups();
     emaj_get_idle_groups     
------------------------------
 {myGroup1,myGroup2,myGroup4}
(1 row)

select emaj.emaj_get_idle_groups('Group');
     emaj_get_idle_groups     
------------------------------
 {myGroup1,myGroup2,myGroup4}
(1 row)

select emaj.emaj_get_idle_groups(null, 'my');
 emaj_get_idle_groups 
----------------------
 
(1 row)

select emaj.emaj_get_idle_groups('\d', '2');
 emaj_get_idle_groups 
----------------------
 {myGroup1,myGroup4}
(1 row)

-- Warnings on FK
-- warning on fkey between tables from different groups
begin;
  alter table myschema2.myTbl4 drop constraint mytbl4_col44_fkey, add constraint mytbl4_col44_fkey 
    foreign key (col44,col45) references myschema1.myTbl1 (col11,col12) on delete cascade on update set null;
  select emaj.emaj_start_group('myGroup2','Mark2');
WARNING:  _check_fk_groups: The foreign key "mytbl4_col44_fkey" on the table "myschema2.mytbl4" references the table "myschema1.mytbl1" that is outside the groups (myGroup2).
 emaj_start_group 
------------------
               10
(1 row)

rollback;
-- Warning on non deferrable fkey set on partitionned table
begin;
  alter table myschema4.myTblP drop constraint mytblp_col1_fkey, add foreign key (col1) references myschema4.mytblr1(col1);
  select emaj.emaj_start_group('myGroup4','Mark1');
WARNING:  _check_fk_groups: The foreign key "mytblp_col1_fkey" on the table "myschema4.mypartp1a" references the table "myschema4.mytblr1" that is outside the groups (myGroup4).
WARNING:  _check_fk_groups: The foreign key "mytblp_col1_fkey" on the table "myschema4.mypartp1b" references the table "myschema4.mytblr1" that is outside the groups (myGroup4).
WARNING:  _check_fk_groups: The foreign key "mytblp_col1_fkey" on the table "myschema4.mypartp2" references the table "myschema4.mytblr1" that is outside the groups (myGroup4).
WARNING:  _check_fk_groups: The table "myschema4.mypartp1a" is referenced by the foreign key "mytblr2_col2_col3_fkey_2" on the table "myschema4.mytblr2" that is outside the groups (myGroup4).
WARNING:  _check_fk_groups: The table "myschema4.mypartp1b" is referenced by the foreign key "mytblr2_col2_col3_fkey_3" on the table "myschema4.mytblr2" that is outside the groups (myGroup4).
WARNING:  _check_fk_groups: The table "myschema4.mypartp2" is referenced by the foreign key "mytblr2_col2_col3_fkey_4" on the table "myschema4.mytblr2" that is outside the groups (myGroup4).
WARNING:  _check_fk_groups: The foreign key "mytblp_col1_fkey" on the table "myschema4.mypartp1a" is inherited from a partitionned table. It should be set as DEFERRABLE to avoid E-Maj rollback failure.
WARNING:  _check_fk_groups: The foreign key "mytblp_col1_fkey" on the table "myschema4.mypartp1b" is inherited from a partitionned table. It should be set as DEFERRABLE to avoid E-Maj rollback failure.
WARNING:  _check_fk_groups: The foreign key "mytblp_col1_fkey" on the table "myschema4.mypartp2" is inherited from a partitionned table. It should be set as DEFERRABLE to avoid E-Maj rollback failure.
 emaj_start_group 
------------------
                6
(1 row)

rollback;
-- Warning on fkey set on partitionned table with ON UPDATE|DELETE clause
begin;
  alter table myschema4.myTblP drop constraint mytblp_col1_fkey, add foreign key (col1) references myschema4.mytblr1(col1)
    on update set null;
  select emaj.emaj_start_group('myGroup4','Mark1');
WARNING:  _check_fk_groups: The foreign key "mytblp_col1_fkey" on the table "myschema4.mypartp1a" references the table "myschema4.mytblr1" that is outside the groups (myGroup4).
WARNING:  _check_fk_groups: The foreign key "mytblp_col1_fkey" on the table "myschema4.mypartp1b" references the table "myschema4.mytblr1" that is outside the groups (myGroup4).
WARNING:  _check_fk_groups: The foreign key "mytblp_col1_fkey" on the table "myschema4.mypartp2" references the table "myschema4.mytblr1" that is outside the groups (myGroup4).
WARNING:  _check_fk_groups: The table "myschema4.mypartp1a" is referenced by the foreign key "mytblr2_col2_col3_fkey_2" on the table "myschema4.mytblr2" that is outside the groups (myGroup4).
WARNING:  _check_fk_groups: The table "myschema4.mypartp1b" is referenced by the foreign key "mytblr2_col2_col3_fkey_3" on the table "myschema4.mytblr2" that is outside the groups (myGroup4).
WARNING:  _check_fk_groups: The table "myschema4.mypartp2" is referenced by the foreign key "mytblr2_col2_col3_fkey_4" on the table "myschema4.mytblr2" that is outside the groups (myGroup4).
WARNING:  _check_fk_groups: The foreign key "mytblp_col1_fkey" on the table "myschema4.mypartp1a" is inherited from a partitionned table. An E-Maj rollback targeting a mark set before the latest table assignement could fail.
WARNING:  _check_fk_groups: The foreign key "mytblp_col1_fkey" on the table "myschema4.mypartp1b" is inherited from a partitionned table. An E-Maj rollback targeting a mark set before the latest table assignement could fail.
WARNING:  _check_fk_groups: The foreign key "mytblp_col1_fkey" on the table "myschema4.mypartp2" is inherited from a partitionned table. An E-Maj rollback targeting a mark set before the latest table assignement could fail.
 emaj_start_group 
------------------
                6
(1 row)

rollback;
-- start with generated mark name
select emaj.emaj_start_group('myGroup1','%abc%',true);
 emaj_start_group 
------------------
                7
(1 row)

select emaj.emaj_start_group('myGroup2','',false);
 emaj_start_group 
------------------
               10
(1 row)

-- group already started
select emaj.emaj_start_group('myGroup2','Mark3');
ERROR:  _check_group_names: The group "myGroup2" is not in IDLE state.
select emaj.emaj_start_group('myGroup2','Mark3') where not emaj.emaj_is_logging_group('myGroup2');
 emaj_start_group 
------------------
(0 rows)

-- use of % in start mark name
select emaj.emaj_start_group('myGroup1','Foo%Bar');
ERROR:  _check_group_names: The group "myGroup1" is not in IDLE state.
select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_time_id, mark_group;
    mark_group    | regexp_replace | mark_time_id | mark_is_rlbk_protected | mark_comment | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------------+----------------+--------------+------------------------+--------------+---------------------------+------------------------------
 myGroup2         | Mark2          |         2003 | f                      |              |                         0 | 
 phil's group#3", | Mark3          |         2004 | f                      |              |                           | 
 emptyGroup       | Mark1          |         2005 | f                      |              |                           | 
 myGroup2         | STOP_%         |         2007 | f                      |              |                         0 | 
 myGroup1         | %abc%          |         2011 | f                      |              |                           | 
 myGroup2         | START_%        |         2012 | f                      |              |                           | 
(6 rows)

-- multiple emaj_start_group() using the same generated start mark name => fails
-- this test is commented because the generated error message differs from one run to another
--begin;
--  select emaj.emaj_start_group('myGroup4');
--  select emaj.emaj_stop_group('myGroup4');
--  select emaj.emaj_start_group('myGroup4',NULL,false);
--rollback;
-- check for emaj_start_group()
select group_name, group_is_logging, group_is_rlbk_protected from emaj.emaj_group order by group_name;
    group_name    | group_is_logging | group_is_rlbk_protected 
------------------+------------------+-------------------------
 emptyGroup       | t                | f
 myGroup1         | t                | f
 myGroup2         | t                | f
 myGroup4         | f                | f
 phil's group#3", | t                | t
(5 rows)

select * from emaj.emaj_log_session order by lses_group, lses_time_range;
    lses_group    | lses_time_range | lses_marks | lses_log_rows 
------------------+-----------------+------------+---------------
 emptyGroup       | [2005,)         |          1 |             0
 myGroup1         | [2002,2007)     |          2 |             0
 myGroup1         | [2011,)         |          1 |             0
 myGroup2         | [2003,2008)     |          2 |             0
 myGroup2         | [2012,)         |          1 |             0
 phil's group#3", | [2004,)         |          1 |             0
(6 rows)

select * from emaj.emaj_group_hist order by grph_group, grph_time_range;
    grph_group    | grph_time_range | grph_is_rollbackable | grph_log_sessions 
------------------+-----------------+----------------------+-------------------
 emptyGroup       | [2000,)         | t                    |                 1
 myGroup1         | [2000,)         | t                    |                 2
 myGroup2         | [2000,)         | t                    |                 2
 myGroup4         | [1004,)         | t                    |                 0
 phil's group#3", | [1043,)         | f                    |                 1
(5 rows)

select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark
  from emaj.emaj_mark where mark_time_id >= 2000 order by mark_time_id, mark_group;
    mark_group    | regexp_replace | mark_time_id | mark_is_rlbk_protected | mark_comment | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------------+----------------+--------------+------------------------+--------------+---------------------------+------------------------------
 myGroup2         | Mark2          |         2003 | f                      |              |                         0 | 
 phil's group#3", | Mark3          |         2004 | f                      |              |                           | 
 emptyGroup       | Mark1          |         2005 | f                      |              |                           | 
 myGroup2         | STOP_%         |         2007 | f                      |              |                         0 | 
 myGroup1         | %abc%          |         2011 | f                      |              |                           | 
 myGroup2         | START_%        |         2012 | f                      |              |                           | 
(6 rows)

select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 2000 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
    2000 |            2000000 | I
    2002 |            2000000 | S
    2003 |            2000000 | S
    2004 |            2000000 | S
    2005 |            2000000 | S
    2006 |            2000000 | X
    2007 |            2000000 | X
    2011 |            2000000 | S
    2012 |            2000000 | S
(9 rows)

select hist_id, hist_function, hist_event, hist_object, 
  regexp_replace(regexp_replace(hist_wording,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),E'\\[.+\\]','(timestamp)','g'),
  hist_user from emaj.emaj_hist where hist_id >= 2000 order by hist_id;
 hist_id |  hist_function  |    hist_event     |    hist_object    |                                                                     regexp_replace                                                                      | hist_user 
---------+-----------------+-------------------+-------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------+-----------
    2049 | START_GROUP     | BEGIN             | myGroup1          | With log reset                                                                                                                                          | postgres
    2050 | START_GROUP     | TIME STAMP SET    | 2002              |                                                                                                                                                         | postgres
    2051 | PURGE_HISTORIES |                   |                   | 351 emaj_hist rows deleted ; 1 log session rows deleted ; 9 group history rows deleted ; 45 relation history rows deleted ; 34 relation changes deleted | postgres
    2052 | LOCK_GROUP      | BEGIN             | myGroup1          |                                                                                                                                                         | postgres
    2053 | LOCK_GROUP      | END               | myGroup1          | 5 tables locked, 0 deadlock(s)                                                                                                                          | postgres
    2054 | SET_MARK_GROUP  | BEGIN             | myGroup1          | Mark1                                                                                                                                                   | postgres
    2055 | SET_MARK_GROUP  | END               | myGroup1          | Mark1                                                                                                                                                   | postgres
    2056 | START_GROUP     | END               | myGroup1          | 7 tables/sequences processed                                                                                                                            | postgres
    2057 |                 | UPDATED PARAMETER | history_retention | @ 100 years                                                                                                                                             | postgres
    2058 | START_GROUP     | BEGIN             | myGroup2          | With log reset                                                                                                                                          | postgres
    2059 | START_GROUP     | TIME STAMP SET    | 2003              |                                                                                                                                                         | postgres
    2060 | LOCK_GROUP      | BEGIN             | myGroup2          |                                                                                                                                                         | postgres
    2061 | LOCK_GROUP      | END               | myGroup2          | 8 tables locked, 0 deadlock(s)                                                                                                                          | postgres
    2062 | SET_MARK_GROUP  | BEGIN             | myGroup2          | Mark2                                                                                                                                                   | postgres
    2063 | SET_MARK_GROUP  | END               | myGroup2          | Mark2                                                                                                                                                   | postgres
    2064 | START_GROUP     | END               | myGroup2          | 10 tables/sequences processed                                                                                                                           | postgres
    2065 |                 | DELETED PARAMETER | history_retention |                                                                                                                                                         | postgres
    2066 | START_GROUP     | BEGIN             | phil's group#3",  | Without log reset                                                                                                                                       | postgres
    2067 | START_GROUP     | TIME STAMP SET    | 2004              |                                                                                                                                                         | postgres
    2068 | LOCK_GROUP      | BEGIN             | phil's group#3",  |                                                                                                                                                         | postgres
    2069 | LOCK_GROUP      | END               | phil's group#3",  | 2 tables locked, 0 deadlock(s)                                                                                                                          | postgres
    2070 | SET_MARK_GROUP  | BEGIN             | phil's group#3",  | Mark3                                                                                                                                                   | postgres
    2071 | SET_MARK_GROUP  | END               | phil's group#3",  | Mark3                                                                                                                                                   | postgres
    2072 | START_GROUP     | END               | phil's group#3",  | 4 tables/sequences processed                                                                                                                            | postgres
    2073 | START_GROUP     | BEGIN             | emptyGroup        | With log reset                                                                                                                                          | postgres
    2074 | START_GROUP     | TIME STAMP SET    | 2005              |                                                                                                                                                         | postgres
    2075 | LOCK_GROUP      | BEGIN             | emptyGroup        |                                                                                                                                                         | postgres
    2076 | LOCK_GROUP      | END               | emptyGroup        | 0 tables locked, 0 deadlock(s)                                                                                                                          | postgres
    2077 | SET_MARK_GROUP  | BEGIN             | emptyGroup        | Mark1                                                                                                                                                   | postgres
    2078 | SET_MARK_GROUP  | END               | emptyGroup        | Mark1                                                                                                                                                   | postgres
    2079 | START_GROUP     | END               | emptyGroup        | 0 tables/sequences processed                                                                                                                            | postgres
    2080 | STOP_GROUP      | BEGIN             | myGroup1          |                                                                                                                                                         | postgres
    2081 | STOP_GROUP      | TIME STAMP SET    | 2006              |                                                                                                                                                         | postgres
    2082 | LOCK_GROUP      | BEGIN             | myGroup1          |                                                                                                                                                         | postgres
    2083 | LOCK_GROUP      | END               | myGroup1          | 5 tables locked, 0 deadlock(s)                                                                                                                          | postgres
    2084 | SET_MARK_GROUP  | BEGIN             | myGroup1          | STOP_%                                                                                                                                                  | postgres
    2085 | SET_MARK_GROUP  | END               | myGroup1          | STOP_%                                                                                                                                                  | postgres
    2086 | STOP_GROUP      | END               | myGroup1          | 7 tables/sequences processed                                                                                                                            | postgres
    2087 | STOP_GROUP      | BEGIN             | myGroup2          |                                                                                                                                                         | postgres
    2088 | STOP_GROUP      | TIME STAMP SET    | 2007              |                                                                                                                                                         | postgres
    2089 | LOCK_GROUP      | BEGIN             | myGroup2          |                                                                                                                                                         | postgres
    2090 | LOCK_GROUP      | END               | myGroup2          | 8 tables locked, 0 deadlock(s)                                                                                                                          | postgres
    2091 | SET_MARK_GROUP  | BEGIN             | myGroup2          | STOP_%                                                                                                                                                  | postgres
    2092 | SET_MARK_GROUP  | END               | myGroup2          | STOP_%                                                                                                                                                  | postgres
    2093 | STOP_GROUP      | END               | myGroup2          | 10 tables/sequences processed                                                                                                                           | postgres
    2115 | START_GROUP     | BEGIN             | myGroup1          | With log reset                                                                                                                                          | postgres
    2116 | START_GROUP     | TIME STAMP SET    | 2011              |                                                                                                                                                         | postgres
    2117 | LOCK_GROUP      | BEGIN             | myGroup1          |                                                                                                                                                         | postgres
    2118 | LOCK_GROUP      | END               | myGroup1          | 5 tables locked, 0 deadlock(s)                                                                                                                          | postgres
    2119 | SET_MARK_GROUP  | BEGIN             | myGroup1          | %abc%                                                                                                                                                   | postgres
    2120 | SET_MARK_GROUP  | END               | myGroup1          | %abc%                                                                                                                                                   | postgres
    2121 | START_GROUP     | END               | myGroup1          | 7 tables/sequences processed                                                                                                                            | postgres
    2122 | START_GROUP     | BEGIN             | myGroup2          | Without log reset                                                                                                                                       | postgres
    2123 | START_GROUP     | TIME STAMP SET    | 2012              |                                                                                                                                                         | postgres
    2124 | LOCK_GROUP      | BEGIN             | myGroup2          |                                                                                                                                                         | postgres
    2125 | LOCK_GROUP      | END               | myGroup2          | 8 tables locked, 0 deadlock(s)                                                                                                                          | postgres
    2126 | SET_MARK_GROUP  | BEGIN             | myGroup2          | START_%                                                                                                                                                 | postgres
    2127 | SET_MARK_GROUP  | END               | myGroup2          | START_%                                                                                                                                                 | postgres
    2128 | START_GROUP     | END               | myGroup2          | 10 tables/sequences processed                                                                                                                           | postgres
(59 rows)

select public.handle_emaj_sequences(2200);
 handle_emaj_sequences 
-----------------------
 
(1 row)

-----------------------------
-- emaj_stop_group() tests
-----------------------------
-- unknown group
select emaj.emaj_stop_group(NULL);
ERROR:  _check_group_names: No group to process.
select emaj.emaj_stop_group('unknownGroup');
ERROR:  _check_group_names: The group "unknownGroup" does not exist.
select emaj.emaj_stop_group(NULL,NULL);
ERROR:  _check_group_names: No group to process.
select emaj.emaj_stop_group('unknownGroup',NULL);
ERROR:  _check_group_names: The group "unknownGroup" does not exist.
-- invalid mark
select emaj.emaj_stop_group('myGroup1','EMAJ_LAST_MARK');
ERROR:  _check_new_mark: "EMAJ_LAST_MARK" is not an allowed name for a new mark.
-- already existing mark
select emaj.emaj_stop_group('phil''s group#3",','Mark3');
ERROR:  _check_new_mark: The group "phil's group#3"," already contains a mark named "Mark3".
-- missing application table
begin;
  drop table mySchema2."myTbl3" cascade;
  select emaj.emaj_stop_group('myGroup2');
ERROR:  _stop_groups: The table "myschema2.myTbl3" does not exist anymore.
rollback;
-- should be OK
select emaj.emaj_stop_group('myGroup1');
 emaj_stop_group 
-----------------
               7
(1 row)

select emaj.emaj_stop_group('emptyGroup');
 emaj_stop_group 
-----------------
               0
(1 row)

-- should be OK with a stop mark
select emaj.emaj_stop_group('myGroup2','Stop mark');
 emaj_stop_group 
-----------------
              10
(1 row)

-- warning, already stopped
select emaj.emaj_stop_group('myGroup2');
WARNING:  _stop_groups: The group "myGroup2" is already in IDLE state.
 emaj_stop_group 
-----------------
               0
(1 row)

select emaj.emaj_stop_group('myGroup2','Stop mark 2');
WARNING:  _stop_groups: The group "myGroup2" is already in IDLE state.
 emaj_stop_group 
-----------------
               0
(1 row)

select emaj.emaj_stop_group('myGroup2') where emaj.emaj_is_logging_group('myGroup2');
 emaj_stop_group 
-----------------
(0 rows)

-- start with auto-mark in a single transaction
begin transaction;
  select emaj.emaj_start_group('myGroup1');
 emaj_start_group 
------------------
                7
(1 row)

  select emaj.emaj_start_group('myGroup2','');
 emaj_start_group 
------------------
               10
(1 row)

commit;
select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_time_id, mark_group;
    mark_group    | regexp_replace | mark_time_id | mark_is_rlbk_protected | mark_comment | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------------+----------------+--------------+------------------------+--------------+---------------------------+------------------------------
 phil's group#3", | Mark3          |         2004 | f                      |              |                           | 
 emptyGroup       | Mark1          |         2005 | f                      |              |                         0 | 
 emptyGroup       | STOP_%         |         2202 | f                      |              |                         0 | 
 myGroup1         | START_%        |         2204 | f                      |              |                           | 
 myGroup2         | START_%        |         2205 | f                      |              |                           | 
(5 rows)

begin transaction;
  select emaj.emaj_stop_group('myGroup1');
 emaj_stop_group 
-----------------
               7
(1 row)

  select emaj.emaj_stop_group('myGroup2','');
 emaj_stop_group 
-----------------
              10
(1 row)

commit;
-- multiple emaj_stop_group() using the same generated start mark name => fails
-- this test is commented because the generated error message differs from one run to another
--begin;
--  select emaj.emaj_start_group('myGroup4','a_first_start_mark');
--  select emaj.emaj_stop_group('myGroup4','%');
--  select emaj.emaj_start_group('myGroup4','another_start_mark',false);
--  select emaj.emaj_stop_group('myGroup4','%');
--rollback;
-- check for emaj_stop_group()
select group_name, group_is_logging, group_is_rlbk_protected from emaj.emaj_group order by group_name;
    group_name    | group_is_logging | group_is_rlbk_protected 
------------------+------------------+-------------------------
 emptyGroup       | f                | f
 myGroup1         | f                | f
 myGroup2         | f                | f
 myGroup4         | f                | f
 phil's group#3", | t                | t
(5 rows)

select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark
  from emaj.emaj_mark where mark_time_id >= 2200 order by mark_time_id, mark_group;
 mark_group | regexp_replace | mark_time_id | mark_is_rlbk_protected | mark_comment | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------+----------------+--------------+------------------------+--------------+---------------------------+------------------------------
 emptyGroup | STOP_%         |         2202 | f                      |              |                         0 | 
 myGroup1   | START_%        |         2204 | f                      |              |                         0 | 
 myGroup2   | START_%        |         2205 | f                      |              |                         0 | 
 myGroup1   | STOP_%         |         2206 | f                      |              |                         0 | 
 myGroup2   | STOP_%         |         2207 | f                      |              |                         0 | 
(5 rows)

select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 2200 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
    2201 |            2200000 | X
    2202 |            2200000 | X
    2203 |            2200000 | X
    2204 |            2200000 | S
    2205 |            2200000 | S
    2206 |            2200000 | X
    2207 |            2200000 | X
(7 rows)

select hist_id, hist_function, hist_event, hist_object, 
  regexp_replace(regexp_replace(hist_wording,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),E'\\[.+\\]','(timestamp)','g'),
  hist_user from emaj.emaj_hist where hist_id >= 2200 order by hist_id;
 hist_id | hist_function  |   hist_event   | hist_object |         regexp_replace         | hist_user 
---------+----------------+----------------+-------------+--------------------------------+-----------
    2210 | STOP_GROUP     | BEGIN          | myGroup1    |                                | postgres
    2211 | STOP_GROUP     | TIME STAMP SET | 2201        |                                | postgres
    2212 | LOCK_GROUP     | BEGIN          | myGroup1    |                                | postgres
    2213 | LOCK_GROUP     | END            | myGroup1    | 5 tables locked, 0 deadlock(s) | postgres
    2214 | SET_MARK_GROUP | BEGIN          | myGroup1    | STOP_%                         | postgres
    2215 | SET_MARK_GROUP | END            | myGroup1    | STOP_%                         | postgres
    2216 | STOP_GROUP     | END            | myGroup1    | 7 tables/sequences processed   | postgres
    2217 | STOP_GROUP     | BEGIN          | emptyGroup  |                                | postgres
    2218 | STOP_GROUP     | TIME STAMP SET | 2202        |                                | postgres
    2219 | LOCK_GROUP     | BEGIN          | emptyGroup  |                                | postgres
    2220 | LOCK_GROUP     | END            | emptyGroup  | 0 tables locked, 0 deadlock(s) | postgres
    2221 | SET_MARK_GROUP | BEGIN          | emptyGroup  | STOP_%                         | postgres
    2222 | SET_MARK_GROUP | END            | emptyGroup  | STOP_%                         | postgres
    2223 | STOP_GROUP     | END            | emptyGroup  | 0 tables/sequences processed   | postgres
    2224 | STOP_GROUP     | BEGIN          | myGroup2    |                                | postgres
    2225 | STOP_GROUP     | TIME STAMP SET | 2203        |                                | postgres
    2226 | LOCK_GROUP     | BEGIN          | myGroup2    |                                | postgres
    2227 | LOCK_GROUP     | END            | myGroup2    | 8 tables locked, 0 deadlock(s) | postgres
    2228 | SET_MARK_GROUP | BEGIN          | myGroup2    | Stop mark                      | postgres
    2229 | SET_MARK_GROUP | END            | myGroup2    | Stop mark                      | postgres
    2230 | STOP_GROUP     | END            | myGroup2    | 10 tables/sequences processed  | postgres
    2231 | STOP_GROUP     | BEGIN          | myGroup2    |                                | postgres
    2232 | STOP_GROUP     | END            |             | 0 tables/sequences processed   | postgres
    2233 | STOP_GROUP     | BEGIN          | myGroup2    |                                | postgres
    2234 | STOP_GROUP     | END            |             | 0 tables/sequences processed   | postgres
    2235 | START_GROUP    | BEGIN          | myGroup1    | With log reset                 | postgres
    2236 | START_GROUP    | TIME STAMP SET | 2204        |                                | postgres
    2237 | LOCK_GROUP     | BEGIN          | myGroup1    |                                | postgres
    2238 | LOCK_GROUP     | END            | myGroup1    | 5 tables locked, 0 deadlock(s) | postgres
    2239 | SET_MARK_GROUP | BEGIN          | myGroup1    | START_%                        | postgres
    2240 | SET_MARK_GROUP | END            | myGroup1    | START_%                        | postgres
    2241 | START_GROUP    | END            | myGroup1    | 7 tables/sequences processed   | postgres
    2242 | START_GROUP    | BEGIN          | myGroup2    | With log reset                 | postgres
    2243 | START_GROUP    | TIME STAMP SET | 2205        |                                | postgres
    2244 | LOCK_GROUP     | BEGIN          | myGroup2    |                                | postgres
    2245 | LOCK_GROUP     | END            | myGroup2    | 8 tables locked, 0 deadlock(s) | postgres
    2246 | SET_MARK_GROUP | BEGIN          | myGroup2    | START_%                        | postgres
    2247 | SET_MARK_GROUP | END            | myGroup2    | START_%                        | postgres
    2248 | START_GROUP    | END            | myGroup2    | 10 tables/sequences processed  | postgres
    2249 | STOP_GROUP     | BEGIN          | myGroup1    |                                | postgres
    2250 | STOP_GROUP     | TIME STAMP SET | 2206        |                                | postgres
    2251 | LOCK_GROUP     | BEGIN          | myGroup1    |                                | postgres
    2252 | LOCK_GROUP     | END            | myGroup1    | 5 tables locked, 0 deadlock(s) | postgres
    2253 | SET_MARK_GROUP | BEGIN          | myGroup1    | STOP_%                         | postgres
    2254 | SET_MARK_GROUP | END            | myGroup1    | STOP_%                         | postgres
    2255 | STOP_GROUP     | END            | myGroup1    | 7 tables/sequences processed   | postgres
    2256 | STOP_GROUP     | BEGIN          | myGroup2    |                                | postgres
    2257 | STOP_GROUP     | TIME STAMP SET | 2207        |                                | postgres
    2258 | LOCK_GROUP     | BEGIN          | myGroup2    |                                | postgres
    2259 | LOCK_GROUP     | END            | myGroup2    | 8 tables locked, 0 deadlock(s) | postgres
    2260 | SET_MARK_GROUP | BEGIN          | myGroup2    | STOP_%                         | postgres
    2261 | SET_MARK_GROUP | END            | myGroup2    | STOP_%                         | postgres
    2262 | STOP_GROUP     | END            | myGroup2    | 10 tables/sequences processed  | postgres
(53 rows)

select public.handle_emaj_sequences(2400);
 handle_emaj_sequences 
-----------------------
 
(1 row)

-----------------------------
-- emaj_start_groups() tests
-----------------------------
select emaj.emaj_stop_group('myGroup1',NULL);
WARNING:  _stop_groups: The group "myGroup1" is already in IDLE state.
 emaj_stop_group 
-----------------
               0
(1 row)

-- NULL group names array
select emaj.emaj_start_groups(NULL,NULL,NULL);
WARNING:  _check_group_names: No group to process.
 emaj_start_groups 
-------------------
                 0
(1 row)

-- at least one group is unknown
select emaj.emaj_start_groups('{""}',NULL);
WARNING:  _check_group_names: No group to process.
 emaj_start_groups 
-------------------
                 0
(1 row)

select emaj.emaj_start_groups('{"unknownGroup",""}',NULL,true);
ERROR:  _check_group_names: The group "unknownGroup" does not exist.
select emaj.emaj_start_groups('{"myGroup1","unknownGroup"}',NULL,false);
ERROR:  _check_group_names: The group "unknownGroup" does not exist.
-- reserved mark name
select emaj.emaj_start_groups('{"myGroup1"}','EMAJ_LAST_MARK');
ERROR:  _check_new_mark: "EMAJ_LAST_MARK" is not an allowed name for a new mark.
-- 2 groups already started
select emaj.emaj_start_groups('{"myGroup1","myGroup2"}','Mark1',true);
 emaj_start_groups 
-------------------
                17
(1 row)

select emaj.emaj_start_groups('{"myGroup1","myGroup2"}','Mark1',false);
ERROR:  _check_group_names: The groups "myGroup1, myGroup2" are not in IDLE state.
select emaj.emaj_stop_groups('{"myGroup1","myGroup2"}');
 emaj_stop_groups 
------------------
               17
(1 row)

-- missing application table
begin;
  drop table mySchema2."myTbl3" cascade;
  select emaj.emaj_start_groups(array['myGroup1','myGroup2'],'Mark1',true);
ERROR:  _verify_groups (1): In tables group "myGroup2", the table "myschema2"."myTbl3" does not exist anymore. You may use "SELECT * FROM emaj.emaj_verify_all()" to look for other issues.
rollback;
-- should be OK, with a warning on fkey between tables from different groups and warning on group names array content
begin;
  alter table myschema2.myTbl4 drop constraint mytbl4_col44_fkey;
  alter table myschema2.myTbl4 add constraint mytbl4_col44_fkey 
    FOREIGN KEY (col44,col45) REFERENCES myschema1.myTbl1 (col11,col12) ON DELETE CASCADE ON UPDATE SET NULL;
  select emaj.emaj_start_groups(array['myGroup1',NULL,'myGroup2','','myGroup2','myGroup2','myGroup1'],'Mark1');
 emaj_start_groups 
-------------------
                17
(1 row)

rollback;
-- check for emaj_start_groups()
select emaj.emaj_start_groups(array['myGroup1','myGroup2'],'Mark1',true);
 emaj_start_groups 
-------------------
                17
(1 row)

select group_name, group_is_logging, group_is_rlbk_protected from emaj.emaj_group order by group_name;
    group_name    | group_is_logging | group_is_rlbk_protected 
------------------+------------------+-------------------------
 emptyGroup       | f                | f
 myGroup1         | t                | f
 myGroup2         | t                | f
 myGroup4         | f                | f
 phil's group#3", | t                | t
(5 rows)

select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark
  from emaj.emaj_mark where mark_time_id >= 2400 order by mark_time_id, mark_group;
 mark_group | regexp_replace | mark_time_id | mark_is_rlbk_protected | mark_comment | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------+----------------+--------------+------------------------+--------------+---------------------------+------------------------------
 myGroup1   | Mark1          |         2404 | f                      |              |                           | 
 myGroup2   | Mark1          |         2404 | f                      |              |                           | 
(2 rows)

select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 2400 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
    2401 |            2400000 | S
    2402 |            2400000 | X
    2404 |            2400000 | S
(3 rows)

select hist_id, hist_function, hist_event, hist_object, 
  regexp_replace(regexp_replace(hist_wording,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),E'\\[.+\\]','(timestamp)','g'),
  hist_user from emaj.emaj_hist where hist_id >= 2400 order by hist_id;
 hist_id |  hist_function  |   hist_event   |    hist_object    |         regexp_replace          | hist_user 
---------+-----------------+----------------+-------------------+---------------------------------+-----------
    2400 | STOP_GROUP      | BEGIN          | myGroup1          |                                 | postgres
    2401 | STOP_GROUP      | END            |                   | 0 tables/sequences processed    | postgres
    2402 | START_GROUPS    | BEGIN          |                   | Without log reset               | postgres
    2403 | START_GROUPS    | END            |                   | 0 tables/sequences processed    | postgres
    2404 | START_GROUPS    | BEGIN          |                   | With log reset                  | postgres
    2405 | START_GROUPS    | END            |                   | 0 tables/sequences processed    | postgres
    2410 | START_GROUPS    | BEGIN          | myGroup1,myGroup2 | With log reset                  | postgres
    2411 | START_GROUPS    | TIME STAMP SET | 2401              |                                 | postgres
    2412 | LOCK_GROUPS     | BEGIN          | myGroup1,myGroup2 |                                 | postgres
    2413 | LOCK_GROUPS     | END            | myGroup1,myGroup2 | 13 tables locked, 0 deadlock(s) | postgres
    2414 | SET_MARK_GROUPS | BEGIN          | myGroup1,myGroup2 | Mark1                           | postgres
    2415 | SET_MARK_GROUPS | END            | myGroup1,myGroup2 | Mark1                           | postgres
    2416 | START_GROUPS    | END            | myGroup1,myGroup2 | 17 tables/sequences processed   | postgres
    2418 | STOP_GROUPS     | BEGIN          | myGroup1,myGroup2 |                                 | postgres
    2419 | STOP_GROUPS     | TIME STAMP SET | 2402              |                                 | postgres
    2420 | LOCK_GROUPS     | BEGIN          | myGroup1,myGroup2 |                                 | postgres
    2421 | LOCK_GROUPS     | END            | myGroup1,myGroup2 | 13 tables locked, 0 deadlock(s) | postgres
    2422 | SET_MARK_GROUPS | BEGIN          | myGroup1,myGroup2 | STOP_%                          | postgres
    2423 | SET_MARK_GROUPS | END            | myGroup1,myGroup2 | STOP_%                          | postgres
    2424 | STOP_GROUPS     | END            | myGroup1,myGroup2 | 17 tables/sequences processed   | postgres
    2433 | START_GROUPS    | BEGIN          | myGroup1,myGroup2 | With log reset                  | postgres
    2434 | START_GROUPS    | TIME STAMP SET | 2404              |                                 | postgres
    2435 | LOCK_GROUPS     | BEGIN          | myGroup1,myGroup2 |                                 | postgres
    2436 | LOCK_GROUPS     | END            | myGroup1,myGroup2 | 13 tables locked, 0 deadlock(s) | postgres
    2437 | SET_MARK_GROUPS | BEGIN          | myGroup1,myGroup2 | Mark1                           | postgres
    2438 | SET_MARK_GROUPS | END            | myGroup1,myGroup2 | Mark1                           | postgres
    2439 | START_GROUPS    | END            | myGroup1,myGroup2 | 17 tables/sequences processed   | postgres
(27 rows)

select public.handle_emaj_sequences(2500);
 handle_emaj_sequences 
-----------------------
 
(1 row)

-----------------------------
-- emaj_stop_groups() tests
-----------------------------
-- NULL group names array
select emaj.emaj_stop_groups(NULL);
WARNING:  _check_group_names: No group to process.
 emaj_stop_groups 
------------------
                0
(1 row)

-- at least one group is unknown
select emaj.emaj_stop_groups('{""}');
WARNING:  _check_group_names: No group to process.
 emaj_stop_groups 
------------------
                0
(1 row)

select emaj.emaj_stop_groups('{"unknownGroup",""}');
ERROR:  _check_group_names: The group "unknownGroup" does not exist.
select emaj.emaj_stop_groups('{"myGroup1","unknownGroup"}');
ERROR:  _check_group_names: The group "unknownGroup" does not exist.
-- missing application table
begin;
  drop table mySchema2."myTbl3" cascade;
  select emaj.emaj_stop_groups(array['myGroup1','myGroup2']);
ERROR:  _stop_groups: The table "myschema2.myTbl3" does not exist anymore.
rollback;
-- should be OK
select emaj.emaj_stop_groups(array['myGroup1','myGroup2'],'Global Stop at %');
 emaj_stop_groups 
------------------
               17
(1 row)

select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_time_id, mark_group;
    mark_group    |  regexp_replace  | mark_time_id | mark_is_rlbk_protected | mark_comment | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------------+------------------+--------------+------------------------+--------------+---------------------------+------------------------------
 phil's group#3", | Mark3            |         2004 | f                      |              |                           | 
 emptyGroup       | Mark1            |         2005 | f                      |              |                         0 | 
 emptyGroup       | STOP_%           |         2202 | f                      |              |                         0 | 
 myGroup1         | Mark1            |         2404 | f                      |              |                         0 | 
 myGroup2         | Mark1            |         2404 | f                      |              |                         0 | 
 myGroup1         | Global Stop at % |         2501 | f                      |              |                         0 | 
 myGroup2         | Global Stop at % |         2501 | f                      |              |                         0 | 
(7 rows)

-- with warning about group names array content
select emaj.emaj_stop_groups(array['myGroup1',NULL,'myGroup2','','myGroup2','myGroup2','myGroup1']);
WARNING:  _stop_groups: The groups "myGroup1, myGroup2" are already in IDLE state.
 emaj_stop_groups 
------------------
                0
(1 row)

-----------------------------
-- emaj_force_stop_group() tests
-----------------------------
select emaj.emaj_start_groups(array['myGroup1','myGroup2'],'Mark1',true);
 emaj_start_groups 
-------------------
                17
(1 row)

-- unknown group
select emaj.emaj_force_stop_group(NULL);
ERROR:  _check_group_names: No group to process.
select emaj.emaj_force_stop_group('unknownGroup');
ERROR:  _check_group_names: The group "unknownGroup" does not exist.
-- should be OK
-- missing application schema
SET client_min_messages TO WARNING;
begin;
  drop schema mySchema2 cascade;
  select emaj.emaj_force_stop_group('myGroup2');
WARNING:  _stop_groups: The schema "myschema2" does not exist anymore.
WARNING:  _stop_groups: The table "myschema2.myTbl3" does not exist anymore.
WARNING:  _stop_groups: The table "myschema2.mytbl1" does not exist anymore.
WARNING:  _stop_groups: The table "myschema2.mytbl2" does not exist anymore.
WARNING:  _stop_groups: The table "myschema2.mytbl4" does not exist anymore.
WARNING:  _stop_groups: The table "myschema2.mytbl5" does not exist anymore.
WARNING:  _stop_groups: The table "myschema2.mytbl6" does not exist anymore.
WARNING:  _stop_groups: The table "myschema2.mytbl7" does not exist anymore.
WARNING:  _stop_groups: The table "myschema2.mytbl8" does not exist anymore.
 emaj_force_stop_group 
-----------------------
                    10
(1 row)

rollback;
RESET client_min_messages;
-- missing application table
begin;
  drop table mySchema2."myTbl3" cascade;
  select emaj.emaj_force_stop_group('myGroup2');
WARNING:  _stop_groups: The table "myschema2.myTbl3" does not exist anymore.
 emaj_force_stop_group 
-----------------------
                    10
(1 row)

rollback;
-- missing log trigger
begin;
  drop trigger emaj_log_trg on myschema2.mytbl4;
  select emaj.emaj_force_stop_group('myGroup2');
WARNING:  _stop_groups: The log trigger "emaj_log_trg" on table "myschema2.mytbl4" does not exist anymore.
 emaj_force_stop_group 
-----------------------
                    10
(1 row)

rollback;
-- missing truncate trigger
begin;
  drop trigger emaj_trunc_trg on myschema2.mytbl4;
  select emaj.emaj_force_stop_group('myGroup2');
WARNING:  _stop_groups: The truncate trigger "emaj_trunc_trg" on table "myschema2.mytbl4" does not exist anymore.
 emaj_force_stop_group 
-----------------------
                    10
(1 row)

rollback;
-- sane group
select emaj.emaj_force_stop_group('myGroup2');
 emaj_force_stop_group 
-----------------------
                    10
(1 row)

select emaj.emaj_force_stop_group('myGroup1');
 emaj_force_stop_group 
-----------------------
                     7
(1 row)

-- warning, already stopped
select emaj.emaj_force_stop_group('myGroup2');
WARNING:  _stop_groups: The group "myGroup2" is already in IDLE state.
 emaj_force_stop_group 
-----------------------
                     0
(1 row)

-- check for emaj_stop_groups() and emaj_force_stop_group()
-- impact of stopped groups
select group_name, group_is_logging, group_is_rlbk_protected from emaj.emaj_group order by group_name;
    group_name    | group_is_logging | group_is_rlbk_protected 
------------------+------------------+-------------------------
 emptyGroup       | f                | f
 myGroup1         | f                | f
 myGroup2         | f                | f
 myGroup4         | f                | f
 phil's group#3", | t                | t
(5 rows)

select * from emaj.emaj_log_session order by lses_group, lses_time_range;
    lses_group    | lses_time_range | lses_marks | lses_log_rows 
------------------+-----------------+------------+---------------
 emptyGroup       | [2005,2203)     |          2 |             0
 myGroup1         | [2002,2007)     |          2 |             0
 myGroup1         | [2011,2202)     |          2 |             0
 myGroup1         | [2204,2207)     |          2 |             0
 myGroup1         | [2401,2403)     |          2 |             0
 myGroup1         | [2404,2502)     |          2 |             0
 myGroup1         | [2502,2509)     |          1 |             0
 myGroup2         | [2003,2008)     |          2 |             0
 myGroup2         | [2012,2204)     |          2 |             0
 myGroup2         | [2205,2208)     |          2 |             0
 myGroup2         | [2401,2403)     |          2 |             0
 myGroup2         | [2404,2502)     |          2 |             0
 myGroup2         | [2502,2508)     |          1 |             0
 phil's group#3", | [2004,)         |          1 |             0
(14 rows)

select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark
  from emaj.emaj_mark where mark_time_id >= 2500 order by mark_time_id, mark_group;
 mark_group | regexp_replace | mark_time_id | mark_is_rlbk_protected | mark_comment | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------+----------------+--------------+------------------------+--------------+---------------------------+------------------------------
 myGroup1   | Mark1          |         2502 | f                      |              |                           | 
 myGroup2   | Mark1          |         2502 | f                      |              |                           | 
(2 rows)

select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 2500 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
    2501 |            2500000 | X
    2502 |            2500000 | S
    2507 |            2500000 | X
    2508 |            2500000 | X
(4 rows)

select hist_id, hist_function, hist_event, hist_object, 
  regexp_replace(regexp_replace(hist_wording,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),E'\\[.+\\]','(timestamp)','g'),
  hist_user from emaj.emaj_hist where hist_id >= 2500 order by hist_id;
 hist_id |  hist_function   |   hist_event   |                  hist_object                  |         regexp_replace          | hist_user 
---------+------------------+----------------+-----------------------------------------------+---------------------------------+-----------
    2500 | STOP_GROUPS      | BEGIN          |                                               |                                 | postgres
    2501 | STOP_GROUPS      | END            |                                               | 0 tables/sequences processed    | postgres
    2502 | STOP_GROUPS      | BEGIN          |                                               |                                 | postgres
    2503 | STOP_GROUPS      | END            |                                               | 0 tables/sequences processed    | postgres
    2510 | STOP_GROUPS      | BEGIN          | myGroup1,myGroup2                             |                                 | postgres
    2511 | STOP_GROUPS      | TIME STAMP SET | 2501                                          |                                 | postgres
    2512 | LOCK_GROUPS      | BEGIN          | myGroup1,myGroup2                             |                                 | postgres
    2513 | LOCK_GROUPS      | END            | myGroup1,myGroup2                             | 13 tables locked, 0 deadlock(s) | postgres
    2514 | SET_MARK_GROUPS  | BEGIN          | myGroup1,myGroup2                             | Global Stop at %                | postgres
    2515 | SET_MARK_GROUPS  | END            | myGroup1,myGroup2                             | Global Stop at %                | postgres
    2516 | STOP_GROUPS      | END            | myGroup1,myGroup2                             | 17 tables/sequences processed   | postgres
    2517 | STOP_GROUPS      | BEGIN          | myGroup1,myGroup2,,myGroup2,myGroup2,myGroup1 |                                 | postgres
    2518 | STOP_GROUPS      | END            |                                               | 0 tables/sequences processed    | postgres
    2519 | START_GROUPS     | BEGIN          | myGroup1,myGroup2                             | With log reset                  | postgres
    2520 | START_GROUPS     | TIME STAMP SET | 2502                                          |                                 | postgres
    2521 | LOCK_GROUPS      | BEGIN          | myGroup1,myGroup2                             |                                 | postgres
    2522 | LOCK_GROUPS      | END            | myGroup1,myGroup2                             | 13 tables locked, 0 deadlock(s) | postgres
    2523 | SET_MARK_GROUPS  | BEGIN          | myGroup1,myGroup2                             | Mark1                           | postgres
    2524 | SET_MARK_GROUPS  | END            | myGroup1,myGroup2                             | Mark1                           | postgres
    2525 | START_GROUPS     | END            | myGroup1,myGroup2                             | 17 tables/sequences processed   | postgres
    2548 | FORCE_STOP_GROUP | BEGIN          | myGroup2                                      |                                 | postgres
    2549 | FORCE_STOP_GROUP | TIME STAMP SET | 2507                                          |                                 | postgres
    2550 | LOCK_GROUP       | BEGIN          | myGroup2                                      |                                 | postgres
    2551 | LOCK_GROUP       | END            | myGroup2                                      | 8 tables locked, 0 deadlock(s)  | postgres
    2552 | FORCE_STOP_GROUP | END            | myGroup2                                      | 10 tables/sequences processed   | postgres
    2553 | FORCE_STOP_GROUP | BEGIN          | myGroup1                                      |                                 | postgres
    2554 | FORCE_STOP_GROUP | TIME STAMP SET | 2508                                          |                                 | postgres
    2555 | LOCK_GROUP       | BEGIN          | myGroup1                                      |                                 | postgres
    2556 | LOCK_GROUP       | END            | myGroup1                                      | 5 tables locked, 0 deadlock(s)  | postgres
    2557 | FORCE_STOP_GROUP | END            | myGroup1                                      | 7 tables/sequences processed    | postgres
    2558 | FORCE_STOP_GROUP | BEGIN          | myGroup2                                      |                                 | postgres
    2559 | FORCE_STOP_GROUP | END            |                                               | 0 tables/sequences processed    | postgres
(32 rows)

select public.handle_emaj_sequences(2600);
 handle_emaj_sequences 
-----------------------
 
(1 row)

-----------------------------
-- emaj_protect_group() tests
-----------------------------
-- group is unknown
select emaj.emaj_protect_group(NULL);
ERROR:  _check_group_names: No group to process.
select emaj.emaj_protect_group('unknownGroup');
ERROR:  _check_group_names: The group "unknownGroup" does not exist.
-- group is not rollbackable
select emaj.emaj_protect_group('phil''s group#3",');
ERROR:  _check_group_names: The group "phil's group#3"," has been created as AUDIT_ONLY.
-- group is not in logging state
select emaj.emaj_protect_group('myGroup1');
ERROR:  _check_group_names: The group "myGroup1" is not in LOGGING state.
-- should be ok
select emaj.emaj_start_group('myGroup1','M1');
 emaj_start_group 
------------------
                7
(1 row)

select emaj.emaj_protect_group('myGroup1');
 emaj_protect_group 
--------------------
                  1
(1 row)

select group_is_logging, group_is_rlbk_protected from emaj.emaj_group where group_name = 'myGroup1';
 group_is_logging | group_is_rlbk_protected 
------------------+-------------------------
 t                | t
(1 row)

-- protect an already protected group
select emaj.emaj_protect_group('myGroup1');
 emaj_protect_group 
--------------------
                  0
(1 row)

select group_is_logging, group_is_rlbk_protected from emaj.emaj_group where group_name = 'myGroup1';
 group_is_logging | group_is_rlbk_protected 
------------------+-------------------------
 t                | t
(1 row)

-- stop should reset the protection
select emaj.emaj_stop_group('myGroup1');
 emaj_stop_group 
-----------------
               7
(1 row)

select group_is_logging, group_is_rlbk_protected from emaj.emaj_group where group_name = 'myGroup1';
 group_is_logging | group_is_rlbk_protected 
------------------+-------------------------
 f                | f
(1 row)

-----------------------------
-- emaj_unprotect_group() tests
-----------------------------
-- group is unknown
select emaj.emaj_unprotect_group(NULL);
ERROR:  _check_group_names: No group to process.
select emaj.emaj_unprotect_group('unknownGroup');
ERROR:  _check_group_names: The group "unknownGroup" does not exist.
-- group is not rollbackable
select emaj.emaj_unprotect_group('phil''s group#3",');
ERROR:  _check_group_names: The group "phil's group#3"," has been created as AUDIT_ONLY.
-- group is not in logging state
select emaj.emaj_unprotect_group('myGroup1');
 emaj_unprotect_group 
----------------------
                    0
(1 row)

-- should be ok
select emaj.emaj_start_group('myGroup1','M1');
 emaj_start_group 
------------------
                7
(1 row)

select emaj.emaj_protect_group('myGroup1');
 emaj_protect_group 
--------------------
                  1
(1 row)

select emaj.emaj_unprotect_group('myGroup1');
 emaj_unprotect_group 
----------------------
                    1
(1 row)

select group_is_logging, group_is_rlbk_protected from emaj.emaj_group where group_name = 'myGroup1';
 group_is_logging | group_is_rlbk_protected 
------------------+-------------------------
 t                | f
(1 row)

-- unprotect an already unprotected group
select emaj.emaj_unprotect_group('myGroup1');
 emaj_unprotect_group 
----------------------
                    0
(1 row)

select group_is_logging, group_is_rlbk_protected from emaj.emaj_group where group_name = 'myGroup1';
 group_is_logging | group_is_rlbk_protected 
------------------+-------------------------
 t                | f
(1 row)

select emaj.emaj_stop_group('myGroup1');
 emaj_stop_group 
-----------------
               7
(1 row)

select group_is_logging, group_is_rlbk_protected from emaj.emaj_group where group_name = 'myGroup1';
 group_is_logging | group_is_rlbk_protected 
------------------+-------------------------
 f                | f
(1 row)

select emaj.emaj_enable_protection_by_event_triggers();
 emaj_enable_protection_by_event_triggers 
------------------------------------------
                                        3
(1 row)

-- check for emaj_protect_group() and emaj_unprotect_group()
select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 2600 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
    2600 |            2600000 | S
    2601 |            2600000 | X
    2602 |            2600000 | S
    2603 |            2600000 | X
(4 rows)

select hist_id, hist_function, hist_event, hist_object, 
  regexp_replace(regexp_replace(hist_wording,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),E'\\[.+\\]','(timestamp)','g'),
  hist_user from emaj.emaj_hist where hist_id >= 2600 order by hist_id;
 hist_id |   hist_function   |       hist_event       | hist_object |                         regexp_replace                         | hist_user 
---------+-------------------+------------------------+-------------+----------------------------------------------------------------+-----------
    2600 | START_GROUP       | BEGIN                  | myGroup1    | With log reset                                                 | postgres
    2601 | START_GROUP       | TIME STAMP SET         | 2600        |                                                                | postgres
    2602 | LOCK_GROUP        | BEGIN                  | myGroup1    |                                                                | postgres
    2603 | LOCK_GROUP        | END                    | myGroup1    | 5 tables locked, 0 deadlock(s)                                 | postgres
    2604 | SET_MARK_GROUP    | BEGIN                  | myGroup1    | M1                                                             | postgres
    2605 | SET_MARK_GROUP    | END                    | myGroup1    | M1                                                             | postgres
    2606 | START_GROUP       | END                    | myGroup1    | 7 tables/sequences processed                                   | postgres
    2607 | PROTECT_GROUP     |                        | myGroup1    | Status 1                                                       | postgres
    2608 | PROTECT_GROUP     |                        | myGroup1    | Status 0                                                       | postgres
    2609 | STOP_GROUP        | BEGIN                  | myGroup1    |                                                                | postgres
    2610 | STOP_GROUP        | TIME STAMP SET         | 2601        |                                                                | postgres
    2611 | LOCK_GROUP        | BEGIN                  | myGroup1    |                                                                | postgres
    2612 | LOCK_GROUP        | END                    | myGroup1    | 5 tables locked, 0 deadlock(s)                                 | postgres
    2613 | SET_MARK_GROUP    | BEGIN                  | myGroup1    | STOP_%                                                         | postgres
    2614 | SET_MARK_GROUP    | END                    | myGroup1    | STOP_%                                                         | postgres
    2615 | STOP_GROUP        | END                    | myGroup1    | 7 tables/sequences processed                                   | postgres
    2616 | UNPROTECT_GROUP   |                        | myGroup1    | Status 0                                                       | postgres
    2617 | START_GROUP       | BEGIN                  | myGroup1    | With log reset                                                 | postgres
    2618 | START_GROUP       | TIME STAMP SET         | 2602        |                                                                | postgres
    2619 | LOCK_GROUP        | BEGIN                  | myGroup1    |                                                                | postgres
    2620 | LOCK_GROUP        | END                    | myGroup1    | 5 tables locked, 0 deadlock(s)                                 | postgres
    2621 | SET_MARK_GROUP    | BEGIN                  | myGroup1    | M1                                                             | postgres
    2622 | SET_MARK_GROUP    | END                    | myGroup1    | M1                                                             | postgres
    2623 | START_GROUP       | END                    | myGroup1    | 7 tables/sequences processed                                   | postgres
    2624 | PROTECT_GROUP     |                        | myGroup1    | Status 1                                                       | postgres
    2625 | UNPROTECT_GROUP   |                        | myGroup1    | Status 1                                                       | postgres
    2626 | UNPROTECT_GROUP   |                        | myGroup1    | Status 0                                                       | postgres
    2627 | STOP_GROUP        | BEGIN                  | myGroup1    |                                                                | postgres
    2628 | STOP_GROUP        | TIME STAMP SET         | 2603        |                                                                | postgres
    2629 | LOCK_GROUP        | BEGIN                  | myGroup1    |                                                                | postgres
    2630 | LOCK_GROUP        | END                    | myGroup1    | 5 tables locked, 0 deadlock(s)                                 | postgres
    2631 | SET_MARK_GROUP    | BEGIN                  | myGroup1    | STOP_%                                                         | postgres
    2632 | SET_MARK_GROUP    | END                    | myGroup1    | STOP_%                                                         | postgres
    2633 | STOP_GROUP        | END                    | myGroup1    | 7 tables/sequences processed                                   | postgres
    2634 | ENABLE_PROTECTION | EVENT TRIGGERS ENABLED |             | emaj_protection_trg, emaj_sql_drop_trg, emaj_table_rewrite_trg | postgres
(35 rows)

-- remove the temp directory
\! rm -R $EMAJTESTTMPDIR
