-- before_upg_while_logging.sql : complex scenario executed by an emaj_adm role
-- The E-Maj version is changed while groups are in logging state
-- This script is the part of operations performed before the upgrade
--
SET datestyle TO ymd;
-----------------------------
-- grant emaj_adm role 
-----------------------------
grant emaj_adm to emaj_regression_tests_adm_user1, emaj_regression_tests_adm_user2;
-- Give rights while we are in an emaj version 4.5.0 or earlier.
grant all on schema mySchema1, mySchema2, "phil's schema""3", mySchema4, mySchema5, mySchema6
  to emaj_regression_tests_adm_user1, emaj_regression_tests_adm_user2;
grant all on all tables in schema mySchema1, mySchema2, "phil's schema""3", mySchema4, mySchema5, mySchema6
  to emaj_regression_tests_adm_user1, emaj_regression_tests_adm_user2;
grant all on all sequences in schema mySchema1, mySchema2, "phil's schema""3", mySchema4, mySchema5, mySchema6
  to emaj_regression_tests_adm_user1, emaj_regression_tests_adm_user2;
-----------------------------
-- create groups
-----------------------------
set role emaj_regression_tests_adm_user1;
select emaj.emaj_create_group('myGroup1');
 emaj_create_group 
-------------------
                 1
(1 row)

select emaj.emaj_create_group('myGroup2',true);
 emaj_create_group 
-------------------
                 1
(1 row)

select emaj.emaj_create_group('phil''s group#3",',false);
 emaj_create_group 
-------------------
                 1
(1 row)

select emaj.emaj_create_group('myGroup6');
 emaj_create_group 
-------------------
                 1
(1 row)

-----------------------------
-- prepare groups
-----------------------------
select emaj.emaj_assign_tables('myschema1','.*',NULL,'myGroup1');
NOTICE:  table "myTbl3_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema1.myTbl3" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema1.myTbl3" does not exist, skipping
NOTICE:  table "mytbl1_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema1.mytbl1" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema1.mytbl1" does not exist, skipping
NOTICE:  table "mytbl2_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema1.mytbl2" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema1.mytbl2" does not exist, skipping
WARNING:  _create_tbl: The table "myschema1.mytbl2" has triggers that will be automatically disabled during E-Maj rollback operations (mytbl2trg1, mytbl2trg2). Use the emaj_modify_table() function to change this behaviour.
NOTICE:  table "mytbl2b_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema1.mytbl2b" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema1.mytbl2b" does not exist, skipping
NOTICE:  table "mytbl4_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema1.mytbl4" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema1.mytbl4" does not exist, skipping
 emaj_assign_tables 
--------------------
                  5
(1 row)

select emaj.emaj_modify_table('myschema1','mytbl1','{"priority":20}'::jsonb);
 emaj_modify_table 
-------------------
                 1
(1 row)

select emaj.emaj_modify_table('myschema1','myTbl3','{"priority":10}'::jsonb);
 emaj_modify_table 
-------------------
                 1
(1 row)

select emaj.emaj_modify_table('myschema1','mytbl4','{"priority":20}'::jsonb);
 emaj_modify_table 
-------------------
                 1
(1 row)

select emaj.emaj_assign_sequence('myschema1','myTbl3_col31_seq','myGroup1');
 emaj_assign_sequence 
----------------------
                    1
(1 row)

select emaj.emaj_assign_tables('myschema2','{"mytbl1", "mytbl2", "myTbl3", "mytbl4"}','myGroup2');
NOTICE:  table "myTbl3_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema2.myTbl3" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema2.myTbl3" does not exist, skipping
NOTICE:  table "mytbl1_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema2.mytbl1" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema2.mytbl1" does not exist, skipping
NOTICE:  table "mytbl2_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema2.mytbl2" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema2.mytbl2" does not exist, skipping
NOTICE:  table "mytbl4_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema2.mytbl4" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema2.mytbl4" does not exist, skipping
 emaj_assign_tables 
--------------------
                  4
(1 row)

select emaj.emaj_assign_sequences('myschema2','{"myTbl3_col31_seq","myseq1"}','myGroup2');
 emaj_assign_sequences 
-----------------------
                     2
(1 row)

-- The third group name contains space, comma # and '
select emaj.emaj_assign_tables('phil''s schema"3','.*','my"tbl4','phil''s group#3",');
NOTICE:  table "myTbl2\_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "phil's schema"3.myTbl2\" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "phil's schema"3.myTbl2\" does not exist, skipping
NOTICE:  table "phil's tbl1_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "phil's schema"3.phil's tbl1" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "phil's schema"3.phil's tbl1" does not exist, skipping
 emaj_assign_tables 
--------------------
                  2
(1 row)

select emaj.emaj_assign_sequence('phil''s schema"3',E'phil''s"seq\\1','phil''s group#3",');
 emaj_assign_sequence 
----------------------
                    1
(1 row)

-- Group with long name tables
select emaj.emaj_assign_tables('myschema6','.*',NULL,'myGroup6');
NOTICE:  table "table_with_50_characters_long_name_____0_________0_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema6.table_with_50_characters_long_name_____0_________0" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema6.table_with_50_characters_long_name_____0_________0" does not exist, skipping
NOTICE:  table "table_with_51_characters_long_name_____0_________0#1_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema6.table_with_51_characters_long_name_____0_________0a" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema6.table_with_51_characters_long_name_____0_________0a" does not exist, skipping
NOTICE:  table "table_with_55_characters_long_name_____0_________0#1_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema6.table_with_55_characters_long_name_____0_________0abcde" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema6.table_with_55_characters_long_name_____0_________0abcde" does not exist, skipping
NOTICE:  table "table_with_55_characters_long_name_____0_________0#2_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema6.table_with_55_characters_long_name_____0_________0fghij" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema6.table_with_55_characters_long_name_____0_________0fghij" does not exist, skipping
 emaj_assign_tables 
--------------------
                  4
(1 row)

-----------------------------
-- set the default_tablespace parameter to tspemaj to log tables and indexes into this tablespace
-----------------------------
SET default_tablespace TO tspemaj;
-----------------------------
-- start groups in a single transaction
-----------------------------
begin;
  select emaj.emaj_start_groups('{"myGroup1","myGroup2"}','M1');
 emaj_start_groups 
-------------------
                12
(1 row)

  select emaj.emaj_start_group('phil''s group#3",','M1');
 emaj_start_group 
------------------
                3
(1 row)

commit;
-----------------------------
-- Step 1 : for myGroup1, update tables, set 2 marks, perform 2 unlogged rollbacks and protect the group and its last mark
-----------------------------
--
reset role;
set search_path=myschema1;
insert into myTbl1 select i, 'ABC', E'\\014'::bytea from generate_series (1,11) as i;
update myTbl1 set col13=E'\\034'::bytea where col11 <= 3;
insert into myTbl2 values (1,'ABC','2010-12-31');
delete from myTbl1 where col11 > 10;
insert into myTbl2 values (2,'DEF',NULL);
insert into "myTbl3" (col33) select generate_series(1000,1039,4)/100;
--
set role emaj_regression_tests_adm_user1;
select emaj.emaj_set_mark_group('myGroup1','M2');
 emaj_set_mark_group 
---------------------
                   6
(1 row)

--
reset role;
insert into myTbl4 values (1,'FK...',1,1,'ABC');
insert into myTbl4 values (2,'FK...',1,1,'ABC');
update myTbl4 set col43 = 2;
insert into myTbl4 values (3,'FK...',1,10,'ABC');
delete from myTbl1 where col11 = 10;
update myTbl1 set col12='DEF' where col11 <= 2;
--
set role emaj_regression_tests_adm_user1;
select emaj.emaj_set_mark_group('myGroup1','M3');
 emaj_set_mark_group 
---------------------
                   6
(1 row)

select emaj.emaj_comment_mark_group('myGroup1','M3','Third mark set');
 emaj_comment_mark_group 
-------------------------
 
(1 row)

--
reset role;
delete from myTbl1 where col11 > 3;
select * from emaj.emaj_rollback_group('myGroup1','M3');
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | Rollback id = 1.
 Notice        | 1 / 5 tables effectively processed.
 Notice        | 0 / 1 sequences effectively processed.
(3 rows)

insert into myTbl2 values (3,'GHI',NULL);
update myTbl4 set col43 = 3 where col41 = 2;
select * from emaj.emaj_rollback_group('myGroup1','M3');
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | Rollback id = 2.
 Notice        | 3 / 5 tables effectively processed.
 Notice        | 0 / 1 sequences effectively processed.
(3 rows)

--
set role emaj_regression_tests_adm_user1;
select emaj.emaj_protect_mark_group('myGroup1','M3');
 emaj_protect_mark_group 
-------------------------
                       1
(1 row)

select emaj.emaj_protect_group('myGroup1');
 emaj_protect_group 
--------------------
                  1
(1 row)

-----------------------------
-- Step 2 : for myGroup2, start, update tables and set 2 marks 
-----------------------------
reset role;
set search_path=myschema2;
insert into myTbl1 select i, 'ABC', E'\\014'::bytea from generate_series (1,11) as i;
update myTbl1 set col13=E'\\034'::bytea where col11 <= 3;
insert into myTbl2 values (1,'ABC','2010-01-01');
delete from myTbl1 where col11 > 10;
select nextval('myschema2.myseq1');
 nextval 
---------
    1000
(1 row)

insert into myTbl2 values (2,'DEF',NULL);
insert into "myTbl3" (col33) select generate_series(1000,1039,4)/100;
--
set role emaj_regression_tests_adm_user1;
select emaj.emaj_set_mark_group('myGroup2','M2');
 emaj_set_mark_group 
---------------------
                   6
(1 row)

--
reset role;
set search_path=myschema2;
select nextval('myschema2.myseq1');
 nextval 
---------
    1001
(1 row)

select nextval('myschema2.myseq1');
 nextval 
---------
    1002
(1 row)

select nextval('myschema2.myseq1');
 nextval 
---------
    1003
(1 row)

--
alter sequence mySeq1 NO MAXVALUE NO CYCLE;
set role emaj_regression_tests_adm_user1;
--
insert into myTbl4 values (1,'FK...',1,1,'ABC');
insert into myTbl4 values (2,'FK...',1,1,'ABC');
update myTbl4 set col43 = 2;
--
set role emaj_regression_tests_adm_user1;
select emaj.emaj_set_mark_group('myGroup2','M3');
 emaj_set_mark_group 
---------------------
                   6
(1 row)

-----------------------------
-- Step 3 : for myGroup2, double logged rollback
-----------------------------
select * from emaj.emaj_logged_rollback_group('myGroup2','M2');
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | Rollback id = 3.
 Notice        | 1 / 4 tables effectively processed.
 Notice        | 1 / 2 sequences effectively processed.
(3 rows)

select * from emaj.emaj_logged_rollback_group('myGroup2','M3');
 rlbk_severity |              rlbk_message              
---------------+----------------------------------------
 Notice        | Rollback id = 4.
 Notice        | 1 / 4 tables effectively processed.
 Notice        | 1 / 2 sequences effectively processed.
(3 rows)

-----------------------------
-- Step 4 : for both myGroup1 and myGroup2, set a common mark
-----------------------------
select emaj.emaj_set_mark_groups('{"myGroup1","myGroup2"}','Common');
 emaj_set_mark_groups 
----------------------
                   12
(1 row)

-----------------------------
-- Step 5 : alter group myGroup1 by removing a table
-----------------------------
select emaj.emaj_remove_table('myschema1', 'myTbl3');
 emaj_remove_table 
-------------------
                 1
(1 row)

-----------------------------
-- Step 6 : managing a group with long name tables
-----------------------------
select emaj.emaj_start_group('myGroup6', 'Start G6');
 emaj_start_group 
------------------
                4
(1 row)

select emaj.emaj_remove_table('myschema6', 'table_with_55_characters_long_name_____0_________0abcde');
 emaj_remove_table 
-------------------
                 1
(1 row)

select emaj.emaj_stop_group('myGroup6');
 emaj_stop_group 
-----------------
               3
(1 row)

-----------------------------
-- Checking steps 1 to 6
-----------------------------
-- emaj tables
select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
       1 |                  0 | C
       2 |                  0 | C
       3 |                  0 | C
       4 |                  0 | C
       5 |                  0 | A
       6 |                  0 | A
       7 |                  0 | A
       8 |                  0 | A
       9 |                  0 | A
      10 |                  0 | A
      11 |                  0 | A
      12 |                  0 | A
      13 |                  0 | A
      14 |                  0 | A
      15 |                  0 | S
      16 |                  0 | S
      17 |                 29 | M
      18 |                 40 | M
      19 |                 46 | R
      20 |                 49 | R
      21 |                 76 | M
      22 |                 80 | M
      23 |                 80 | R
      24 |                 82 | M
      25 |                 82 | R
      26 |                 84 | M
      27 |                 84 | M
      28 |                 84 | A
      29 |                 84 | S
      30 |                 84 | A
      31 |                 84 | X
(31 rows)

select group_name, group_is_rollbackable, group_last_alter_time_id, group_is_logging, 
       group_is_rlbk_protected, group_nb_table, group_nb_sequence, group_comment
  from emaj.emaj_group order by group_name;
    group_name    | group_is_rollbackable | group_last_alter_time_id | group_is_logging | group_is_rlbk_protected | group_nb_table | group_nb_sequence | group_comment 
------------------+-----------------------+--------------------------+------------------+-------------------------+----------------+-------------------+---------------
 myGroup1         | t                     |                       28 | t                | t                       |              4 |                 1 | 
 myGroup2         | t                     |                       11 | t                | f                       |              4 |                 2 | 
 myGroup6         | t                     |                       30 | f                | f                       |              3 |                 0 | 
 phil's group#3", | f                     |                       13 | t                | t                       |              2 |                 1 | 
(4 rows)

select * from emaj.emaj_group_hist order by grph_group, grph_time_range;
    grph_group    | grph_time_range | grph_is_rollbackable | grph_log_sessions 
------------------+-----------------+----------------------+-------------------
 myGroup1         | [1,)            | t                    |                 1
 myGroup2         | [2,)            | t                    |                 1
 myGroup6         | [4,)            | t                    |                 1
 phil's group#3", | [3,)            | f                    |                 1
(4 rows)

select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, 
       mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark 
  from emaj.emaj_mark order by mark_time_id, mark_group;
    mark_group    | regexp_replace | mark_time_id | mark_is_rlbk_protected |                  mark_comment                  | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------------+----------------+--------------+------------------------+------------------------------------------------+---------------------------+------------------------------
 myGroup1         | M1             |           15 | f                      |                                                |                        29 | 
 myGroup2         | M1             |           15 | f                      |                                                |                        27 | 
 phil's group#3", | M1             |           16 | f                      |                                                |                           | 
 myGroup1         | M2             |           17 | f                      |                                                |                        11 | 
 myGroup1         | M3             |           18 | t                      | Third mark set                                 |                         0 | 
 myGroup2         | M2             |           21 | f                      |                                                |                         4 | 
 myGroup2         | M3             |           22 | f                      |                                                |                         0 | 
 myGroup2         | RLBK_3_START   |           23 | f                      | Automatically set at rollback to mark M2 start |                         2 | 
 myGroup2         | RLBK_3_DONE    |           24 | f                      | Automatically set at rollback to mark M2 end   |                         0 | M2
 myGroup2         | RLBK_4_START   |           25 | f                      | Automatically set at rollback to mark M3 start |                         2 | 
 myGroup2         | RLBK_4_DONE    |           26 | f                      | Automatically set at rollback to mark M3 end   |                         0 | M3
 myGroup1         | Common         |           27 | f                      |                                                |                         0 | 
 myGroup2         | Common         |           27 | f                      |                                                |                           | 
 myGroup1         | REMOVE_%       |           28 | f                      |                                                |                           | 
 myGroup6         | Start G6       |           29 | f                      |                                                |                         0 | 
 myGroup6         | REMOVE_%       |           30 | f                      |                                                |                         0 | 
 myGroup6         | STOP_%         |           31 | f                      |                                                |                         0 | 
(17 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called
  from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
   sequ_schema   |    sequ_name     | sequ_time_id | sequ_last_val | sequ_is_called 
-----------------+------------------+--------------+---------------+----------------
 myschema1       | myTbl3_col31_seq |           15 |             1 | f
 myschema2       | myTbl3_col31_seq |           15 |             1 | f
 myschema2       | myseq1           |           15 |          1000 | f
 phil's schema"3 | phil's"seq\1     |           16 |          1000 | f
 myschema1       | myTbl3_col31_seq |           17 |            10 | t
 myschema1       | myTbl3_col31_seq |           18 |            10 | t
 myschema2       | myTbl3_col31_seq |           21 |            10 | t
 myschema2       | myseq1           |           21 |          1000 | t
 myschema2       | myTbl3_col31_seq |           22 |            10 | t
 myschema2       | myseq1           |           22 |          1003 | t
 myschema2       | myTbl3_col31_seq |           23 |            10 | t
 myschema2       | myseq1           |           23 |          1003 | t
 myschema2       | myTbl3_col31_seq |           24 |            10 | t
 myschema2       | myseq1           |           24 |          1001 | f
 myschema2       | myTbl3_col31_seq |           25 |            10 | t
 myschema2       | myseq1           |           25 |          1001 | f
 myschema2       | myTbl3_col31_seq |           26 |            10 | t
 myschema2       | myseq1           |           26 |          1004 | f
 myschema1       | myTbl3_col31_seq |           27 |            10 | t
 myschema2       | myTbl3_col31_seq |           27 |            10 | t
 myschema2       | myseq1           |           27 |          1004 | f
 myschema1       | myTbl3_col31_seq |           28 |            10 | t
(22 rows)

select tbl_schema, tbl_name, tbl_time_id, tbl_tuples, tbl_pages, tbl_log_seq_last_val
  from emaj.emaj_table order by tbl_time_id, tbl_schema, tbl_name;
   tbl_schema    |                        tbl_name                         | tbl_time_id | tbl_tuples | tbl_pages | tbl_log_seq_last_val 
-----------------+---------------------------------------------------------+-------------+------------+-----------+----------------------
 myschema1       | myTbl3                                                  |          15 |          0 |         0 |                    0
 myschema1       | mytbl1                                                  |          15 |          0 |         0 |                    0
 myschema1       | mytbl2                                                  |          15 |          0 |         0 |                    0
 myschema1       | mytbl2b                                                 |          15 |          0 |         0 |                    0
 myschema1       | mytbl4                                                  |          15 |          0 |         0 |                    0
 myschema2       | myTbl3                                                  |          15 |          0 |         0 |                    0
 myschema2       | mytbl1                                                  |          15 |          0 |         0 |                    0
 myschema2       | mytbl2                                                  |          15 |          0 |         0 |                    0
 myschema2       | mytbl4                                                  |          15 |          0 |         0 |                    0
 phil's schema"3 | myTbl2\                                                 |          16 |          0 |         0 |                    0
 phil's schema"3 | phil's tbl1                                             |          16 |          0 |         0 |                    0
 myschema1       | myTbl3                                                  |          17 |          0 |         0 |                   10
 myschema1       | mytbl1                                                  |          17 |          0 |         0 |                   15
 myschema1       | mytbl2                                                  |          17 |          0 |         0 |                    2
 myschema1       | mytbl2b                                                 |          17 |          0 |         0 |                    2
 myschema1       | mytbl4                                                  |          17 |          0 |         0 |                    0
 myschema1       | myTbl3                                                  |          18 |          0 |         0 |                   10
 myschema1       | mytbl1                                                  |          18 |          0 |         0 |                   18
 myschema1       | mytbl2                                                  |          18 |          0 |         0 |                    2
 myschema1       | mytbl2b                                                 |          18 |          0 |         0 |                    2
 myschema1       | mytbl4                                                  |          18 |          0 |         0 |                    8
 myschema2       | myTbl3                                                  |          21 |          0 |         0 |                   10
 myschema2       | mytbl1                                                  |          21 |          0 |         0 |                   15
 myschema2       | mytbl2                                                  |          21 |          0 |         0 |                    2
 myschema2       | mytbl4                                                  |          21 |          0 |         0 |                    0
 myschema2       | myTbl3                                                  |          22 |          0 |         0 |                   10
 myschema2       | mytbl1                                                  |          22 |          0 |         0 |                   15
 myschema2       | mytbl2                                                  |          22 |          0 |         0 |                    2
 myschema2       | mytbl4                                                  |          22 |          0 |         0 |                    4
 myschema2       | myTbl3                                                  |          23 |          0 |         0 |                   10
 myschema2       | mytbl1                                                  |          23 |          0 |         0 |                   15
 myschema2       | mytbl2                                                  |          23 |          0 |         0 |                    2
 myschema2       | mytbl4                                                  |          23 |          0 |         0 |                    4
 myschema2       | myTbl3                                                  |          24 |          0 |         0 |                   10
 myschema2       | mytbl1                                                  |          24 |          0 |         0 |                   15
 myschema2       | mytbl2                                                  |          24 |          0 |         0 |                    2
 myschema2       | mytbl4                                                  |          24 |          0 |         0 |                    6
 myschema2       | myTbl3                                                  |          25 |          0 |         0 |                   10
 myschema2       | mytbl1                                                  |          25 |          0 |         0 |                   15
 myschema2       | mytbl2                                                  |          25 |          0 |         0 |                    2
 myschema2       | mytbl4                                                  |          25 |          0 |         0 |                    6
 myschema2       | myTbl3                                                  |          26 |          0 |         0 |                   10
 myschema2       | mytbl1                                                  |          26 |          0 |         0 |                   15
 myschema2       | mytbl2                                                  |          26 |          0 |         0 |                    2
 myschema2       | mytbl4                                                  |          26 |          0 |         0 |                    8
 myschema1       | myTbl3                                                  |          27 |          0 |         0 |                   10
 myschema1       | mytbl1                                                  |          27 |          0 |         0 |                   24
 myschema1       | mytbl2                                                  |          27 |          0 |         0 |                    3
 myschema1       | mytbl2b                                                 |          27 |          0 |         0 |                    3
 myschema1       | mytbl4                                                  |          27 |          0 |         0 |                    9
 myschema2       | myTbl3                                                  |          27 |          0 |         0 |                   10
 myschema2       | mytbl1                                                  |          27 |          0 |         0 |                   15
 myschema2       | mytbl2                                                  |          27 |          0 |         0 |                    2
 myschema2       | mytbl4                                                  |          27 |          0 |         0 |                    8
 myschema1       | myTbl3                                                  |          28 |          0 |         0 |                   10
 myschema1       | mytbl1                                                  |          28 |          0 |         0 |                   24
 myschema1       | mytbl2                                                  |          28 |          0 |         0 |                    3
 myschema1       | mytbl2b                                                 |          28 |          0 |         0 |                    3
 myschema1       | mytbl4                                                  |          28 |          0 |         0 |                    9
 myschema6       | table_with_50_characters_long_name_____0_________0      |          29 |          0 |         0 |                    0
 myschema6       | table_with_51_characters_long_name_____0_________0a     |          29 |          0 |         0 |                    0
 myschema6       | table_with_55_characters_long_name_____0_________0abcde |          29 |          0 |         0 |                    0
 myschema6       | table_with_55_characters_long_name_____0_________0fghij |          29 |          0 |         0 |                    0
 myschema6       | table_with_50_characters_long_name_____0_________0      |          30 |          0 |         0 |                    0
 myschema6       | table_with_51_characters_long_name_____0_________0a     |          30 |          0 |         0 |                    0
 myschema6       | table_with_55_characters_long_name_____0_________0abcde |          30 |          0 |         0 |                    0
 myschema6       | table_with_55_characters_long_name_____0_________0fghij |          30 |          0 |         0 |                    0
 myschema6       | table_with_50_characters_long_name_____0_________0      |          31 |          0 |         0 |                    0
 myschema6       | table_with_51_characters_long_name_____0_________0a     |          31 |          0 |         0 |                    0
 myschema6       | table_with_55_characters_long_name_____0_________0fghij |          31 |          0 |         0 |                    0
(70 rows)

select sqhl_schema, sqhl_table, sqhl_begin_time_id, sqhl_end_time_id, sqhl_hole_size
  from emaj.emaj_seq_hole order by 1,2,3;
 sqhl_schema | sqhl_table | sqhl_begin_time_id | sqhl_end_time_id | sqhl_hole_size 
-------------+------------+--------------------+------------------+----------------
 myschema1   | mytbl1     |                 18 |               19 |              6
 myschema1   | mytbl2     |                 18 |               20 |              1
 myschema1   | mytbl2b    |                 18 |               20 |              1
 myschema1   | mytbl4     |                 18 |               20 |              1
(4 rows)

select * from emaj.emaj_relation_change order by 1,2,3,4,5;
 rlchg_time_id |  rlchg_schema   |                      rlchg_tblseq                       | rlchg_change_kind |   rlchg_group    | rlchg_new_schema | rlchg_new_tblseq | rlchg_new_group | rlchg_priority | rlchg_new_priority | rlchg_log_data_tsp | rlchg_new_log_data_tsp | rlchg_log_index_tsp | rlchg_new_log_index_tsp | rlchg_ignored_triggers | rlchg_new_ignored_triggers 
---------------+-----------------+---------------------------------------------------------+-------------------+------------------+------------------+------------------+-----------------+----------------+--------------------+--------------------+------------------------+---------------------+-------------------------+------------------------+----------------------------
             5 | myschema1       | myTbl3                                                  | ADD_TABLE         | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        | 
             5 | myschema1       | mytbl1                                                  | ADD_TABLE         | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        | 
             5 | myschema1       | mytbl2                                                  | ADD_TABLE         | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        | 
             5 | myschema1       | mytbl2b                                                 | ADD_TABLE         | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        | 
             5 | myschema1       | mytbl4                                                  | ADD_TABLE         | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        | 
             6 | myschema1       | mytbl1                                                  | CHANGE_PRIORITY   | myGroup1         |                  |                  |                 |                |                 20 |                    |                        |                     |                         |                        | 
             7 | myschema1       | myTbl3                                                  | CHANGE_PRIORITY   | myGroup1         |                  |                  |                 |                |                 10 |                    |                        |                     |                         |                        | 
             8 | myschema1       | mytbl4                                                  | CHANGE_PRIORITY   | myGroup1         |                  |                  |                 |                |                 20 |                    |                        |                     |                         |                        | 
             9 | myschema1       | myTbl3_col31_seq                                        | ADD_SEQUENCE      | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        | 
            10 | myschema2       | myTbl3                                                  | ADD_TABLE         | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        | 
            10 | myschema2       | mytbl1                                                  | ADD_TABLE         | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        | 
            10 | myschema2       | mytbl2                                                  | ADD_TABLE         | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        | 
            10 | myschema2       | mytbl4                                                  | ADD_TABLE         | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        | 
            11 | myschema2       | myTbl3_col31_seq                                        | ADD_SEQUENCE      | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        | 
            11 | myschema2       | myseq1                                                  | ADD_SEQUENCE      | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        | 
            12 | phil's schema"3 | myTbl2\                                                 | ADD_TABLE         | phil's group#3", |                  |                  |                 |                |                    |                    |                        |                     |                         |                        | 
            12 | phil's schema"3 | phil's tbl1                                             | ADD_TABLE         | phil's group#3", |                  |                  |                 |                |                    |                    |                        |                     |                         |                        | 
            13 | phil's schema"3 | phil's"seq\1                                            | ADD_SEQUENCE      | phil's group#3", |                  |                  |                 |                |                    |                    |                        |                     |                         |                        | 
            14 | myschema6       | table_with_50_characters_long_name_____0_________0      | ADD_TABLE         | myGroup6         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        | 
            14 | myschema6       | table_with_51_characters_long_name_____0_________0a     | ADD_TABLE         | myGroup6         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        | 
            14 | myschema6       | table_with_55_characters_long_name_____0_________0abcde | ADD_TABLE         | myGroup6         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        | 
            14 | myschema6       | table_with_55_characters_long_name_____0_________0fghij | ADD_TABLE         | myGroup6         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        | 
            28 | myschema1       | myTbl3                                                  | REMOVE_TABLE      | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        | 
            30 | myschema6       | table_with_55_characters_long_name_____0_________0abcde | REMOVE_TABLE      | myGroup6         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        | 
(24 rows)

-- log tables
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid 
-------+------------+-------+-----------+------------+----------
     1 | ABC        | \x0c  | INS       | NEW        |        1
     2 | ABC        | \x0c  | INS       | NEW        |        2
     3 | ABC        | \x0c  | INS       | NEW        |        3
     4 | ABC        | \x0c  | INS       | NEW        |        4
     5 | ABC        | \x0c  | INS       | NEW        |        5
     6 | ABC        | \x0c  | INS       | NEW        |        6
     7 | ABC        | \x0c  | INS       | NEW        |        7
     8 | ABC        | \x0c  | INS       | NEW        |        8
     9 | ABC        | \x0c  | INS       | NEW        |        9
    10 | ABC        | \x0c  | INS       | NEW        |       10
    11 | ABC        | \x0c  | INS       | NEW        |       11
     1 | ABC        | \x0c  | UPD       | OLD        |       12
     1 | ABC        | \x1c  | UPD       | NEW        |       12
     2 | ABC        | \x0c  | UPD       | OLD        |       13
     2 | ABC        | \x1c  | UPD       | NEW        |       13
     3 | ABC        | \x0c  | UPD       | OLD        |       14
     3 | ABC        | \x1c  | UPD       | NEW        |       14
    11 | ABC        | \x0c  | DEL       | OLD        |       17
    10 | ABC        | \x0c  | DEL       | OLD        |       35
     1 | ABC        | \x1c  | UPD       | OLD        |       37
     1 | DEF        | \x1c  | UPD       | NEW        |       37
     2 | ABC        | \x1c  | UPD       | OLD        |       38
     2 | DEF        | \x1c  | UPD       | NEW        |       38
(23 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 |   col23    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+------------+-----------+------------+----------
     1 | ABC   | 12-31-2010 | INS       | NEW        |       15
     2 | DEF   |            | INS       | NEW        |       18
(2 rows)

select col20, col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl2b_log order by emaj_gid, emaj_tuple desc;
 col20 | col21 | col22 | col23 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+-----------+------------+----------
     1 |     1 |     1 | t     | INS       | NEW        |       16
     2 |     2 |   0.5 | t     | INS       | NEW        |       19
(2 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema1."myTbl3_log_1" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
     1 | 10.00 | INS       | NEW        |       20
     2 | 10.00 | INS       | NEW        |       21
     3 | 10.00 | INS       | NEW        |       22
     4 | 10.00 | INS       | NEW        |       23
     5 | 10.00 | INS       | NEW        |       24
     6 | 10.00 | INS       | NEW        |       25
     7 | 10.00 | INS       | NEW        |       26
     8 | 10.00 | INS       | NEW        |       27
     9 | 10.00 | INS       | NEW        |       28
    10 | 10.00 | INS       | NEW        |       29
(10 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 |   col45    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+------------+-----------+------------+----------
     1 | FK... |     1 |     1 | ABC        | INS       | NEW        |       30
     2 | FK... |     1 |     1 | ABC        | INS       | NEW        |       31
     1 | FK... |     1 |     1 | ABC        | UPD       | OLD        |       32
     1 | FK... |     2 |     1 | ABC        | UPD       | NEW        |       32
     2 | FK... |     1 |     1 | ABC        | UPD       | OLD        |       33
     2 | FK... |     2 |     1 | ABC        | UPD       | NEW        |       33
     3 | FK... |     1 |    10 | ABC        | INS       | NEW        |       34
     3 | FK... |     1 |    10 | ABC        | DEL       | OLD        |       36
     1 | FK... |     2 |     1 | ABC        | UPD       | OLD        |       39
     1 | FK... |     2 |       |            | UPD       | NEW        |       39
     2 | FK... |     2 |     1 | ABC        | UPD       | OLD        |       40
     2 | FK... |     2 |       |            | UPD       | NEW        |       40
(12 rows)

--
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid 
-------+------------+-------+-----------+------------+----------
     1 | ABC        | \x0c  | INS       | NEW        |       50
     2 | ABC        | \x0c  | INS       | NEW        |       51
     3 | ABC        | \x0c  | INS       | NEW        |       52
     4 | ABC        | \x0c  | INS       | NEW        |       53
     5 | ABC        | \x0c  | INS       | NEW        |       54
     6 | ABC        | \x0c  | INS       | NEW        |       55
     7 | ABC        | \x0c  | INS       | NEW        |       56
     8 | ABC        | \x0c  | INS       | NEW        |       57
     9 | ABC        | \x0c  | INS       | NEW        |       58
    10 | ABC        | \x0c  | INS       | NEW        |       59
    11 | ABC        | \x0c  | INS       | NEW        |       60
     1 | ABC        | \x0c  | UPD       | OLD        |       61
     1 | ABC        | \x1c  | UPD       | NEW        |       61
     2 | ABC        | \x0c  | UPD       | OLD        |       62
     2 | ABC        | \x1c  | UPD       | NEW        |       62
     3 | ABC        | \x0c  | UPD       | OLD        |       63
     3 | ABC        | \x1c  | UPD       | NEW        |       63
    11 | ABC        | \x0c  | DEL       | OLD        |       65
(18 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 |   col23    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+------------+-----------+------------+----------
     1 | ABC   | 01-01-2010 | INS       | NEW        |       64
     2 | DEF   |            | INS       | NEW        |       66
(2 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema2."myTbl3_log" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
     1 | 10.00 | INS       | NEW        |       67
     2 | 10.00 | INS       | NEW        |       68
     3 | 10.00 | INS       | NEW        |       69
     4 | 10.00 | INS       | NEW        |       70
     5 | 10.00 | INS       | NEW        |       71
     6 | 10.00 | INS       | NEW        |       72
     7 | 10.00 | INS       | NEW        |       73
     8 | 10.00 | INS       | NEW        |       74
     9 | 10.00 | INS       | NEW        |       75
    10 | 10.00 | INS       | NEW        |       76
(10 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 |   col45    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+------------+-----------+------------+----------
     1 | FK... |     1 |     1 | ABC        | INS       | NEW        |       77
     2 | FK... |     1 |     1 | ABC        | INS       | NEW        |       78
     1 | FK... |     1 |     1 | ABC        | UPD       | OLD        |       79
     1 | FK... |     2 |     1 | ABC        | UPD       | NEW        |       79
     2 | FK... |     1 |     1 | ABC        | UPD       | OLD        |       80
     2 | FK... |     2 |     1 | ABC        | UPD       | NEW        |       80
     1 | FK... |     2 |     1 | ABC        | DEL       | OLD        |       81
     2 | FK... |     2 |     1 | ABC        | DEL       | OLD        |       82
     1 | FK... |     2 |     1 | ABC        | INS       | NEW        |       83
     2 | FK... |     2 |     1 | ABC        | INS       | NEW        |       84
(10 rows)

-------------------------------
-- Specific tests for this upgrade
-------------------------------
-- There is no specific test for this version
reset role;
