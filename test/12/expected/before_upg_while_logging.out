-- before_upg_while_logging.sql : complex scenario executed by an emaj_adm role
-- The E-Maj version is changed while groups are in logging state
-- This script is the part of operations performed before the upgrade
--
SET datestyle TO ymd;
-----------------------------
-- grant emaj_adm role 
-----------------------------
grant emaj_adm to emaj_regression_tests_adm_user;
set role emaj_regression_tests_adm_user;
-----------------------------
-- prepare groups
-----------------------------
delete from emaj.emaj_group_def;
insert into emaj.emaj_group_def values ('myGroup1','myschema1','mytbl1',20);
insert into emaj.emaj_group_def values ('myGroup1','myschema1','mytbl2',NULL);
insert into emaj.emaj_group_def values ('myGroup1','myschema1','mytbl2b',NULL);
insert into emaj.emaj_group_def values ('myGroup1','myschema1','myTbl3_col31_seq');
insert into emaj.emaj_group_def values ('myGroup1','myschema1','myTbl3',10);
insert into emaj.emaj_group_def values ('myGroup1','myschema1','mytbl4',20);
insert into emaj.emaj_group_def values ('myGroup2','myschema2','mytbl1');
insert into emaj.emaj_group_def values ('myGroup2','myschema2','mytbl2');
insert into emaj.emaj_group_def values ('myGroup2','myschema2','myTbl3_col31_seq');
insert into emaj.emaj_group_def values ('myGroup2','myschema2','myTbl3');
insert into emaj.emaj_group_def values ('myGroup2','myschema2','mytbl4');
insert into emaj.emaj_group_def values ('myGroup2','myschema2','myseq1');
-- The third group name contains space, comma # and '
insert into emaj.emaj_group_def values ('phil''s group#3",','phil''s schema3','phil''s tbl1');
insert into emaj.emaj_group_def values ('phil''s group#3",','phil''s schema3',E'myTbl2\\');
insert into emaj.emaj_group_def values ('phil''s group#3",','phil''s schema3',E'phil''s seq\\1');
insert into emaj.emaj_group_def values ('dummyGrp1','dummySchema','mytbl4');
insert into emaj.emaj_group_def values ('dummyGrp2','myschema1','dummyTable');
insert into emaj.emaj_group_def values ('dummyGrp3','myschema1','mytbl1');
insert into emaj.emaj_group_def values ('dummyGrp3','myschema2','mytbl2');
-- Group with long name tables
insert into emaj.emaj_group_def values ('myGroup6','myschema6','table_with_50_characters_long_name_____0_________0');
insert into emaj.emaj_group_def values ('myGroup6','myschema6','table_with_51_characters_long_name_____0_________0a');
insert into emaj.emaj_group_def values ('myGroup6','myschema6','table_with_55_characters_long_name_____0_________0abcde');
insert into emaj.emaj_group_def values ('myGroup6','myschema6','table_with_55_characters_long_name_____0_________0fghij');
-----------------------------
-- set the default_tablespace parameter to tspemaj to log tables and indexes into this tablespace
-----------------------------
SET default_tablespace TO tspemaj;
-----------------------------
-- create and start groups
-----------------------------
select emaj.emaj_create_group('myGroup1');
NOTICE:  table "myTbl3_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema1.myTbl3" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema1.myTbl3" does not exist, skipping
NOTICE:  table "mytbl1_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema1.mytbl1" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema1.mytbl1" does not exist, skipping
NOTICE:  table "mytbl4_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema1.mytbl4" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema1.mytbl4" does not exist, skipping
NOTICE:  table "mytbl2_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema1.mytbl2" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema1.mytbl2" does not exist, skipping
WARNING:  _create_tbl: The table "myschema1.mytbl2" has triggers (mytbl2trg1, mytbl2trg2). They will be automatically disabled during E-Maj rollback operations, unless they have been recorded into the list of triggers that may be kept enabled, with the emaj_ignore_app_trigger() function.
NOTICE:  table "mytbl2b_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema1.mytbl2b" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema1.mytbl2b" does not exist, skipping
 emaj_create_group 
-------------------
                 6
(1 row)

select emaj.emaj_create_group('myGroup2',true);
NOTICE:  table "myTbl3_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema2.myTbl3" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema2.myTbl3" does not exist, skipping
NOTICE:  table "mytbl1_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema2.mytbl1" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema2.mytbl1" does not exist, skipping
NOTICE:  table "mytbl2_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema2.mytbl2" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema2.mytbl2" does not exist, skipping
NOTICE:  table "mytbl4_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema2.mytbl4" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema2.mytbl4" does not exist, skipping
 emaj_create_group 
-------------------
                 6
(1 row)

select emaj.emaj_create_group('phil''s group#3",',false);
NOTICE:  table "myTbl2\_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "phil's schema3.myTbl2\" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "phil's schema3.myTbl2\" does not exist, skipping
NOTICE:  table "phil's tbl1_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "phil's schema3.phil's tbl1" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "phil's schema3.phil's tbl1" does not exist, skipping
 emaj_create_group 
-------------------
                 3
(1 row)

select emaj.emaj_start_group('myGroup1','M1');
 emaj_start_group 
------------------
                6
(1 row)

select emaj.emaj_start_group('myGroup2','M1');
 emaj_start_group 
------------------
                6
(1 row)

select emaj.emaj_start_group('phil''s group#3",','M1');
 emaj_start_group 
------------------
                3
(1 row)

-----------------------------
-- Step 1 : for myGroup1, update tables, set 2 marks, perform 2 unlogged rollbacks and protect the group and its last mark
-----------------------------
-- 
set search_path=myschema1;
insert into myTbl1 select i, 'ABC', E'\\014'::bytea from generate_series (1,11) as i;
update myTbl1 set col13=E'\\034'::bytea where col11 <= 3;
insert into myTbl2 values (1,'ABC','2010-12-31');
delete from myTbl1 where col11 > 10;
insert into myTbl2 values (2,'DEF',NULL);
insert into "myTbl3" (col33) select generate_series(1000,1039,4)/100;
--
select emaj.emaj_set_mark_group('myGroup1','M2');
 emaj_set_mark_group 
---------------------
                   6
(1 row)

--
insert into myTbl4 values (1,'FK...',1,1,'ABC');
insert into myTbl4 values (2,'FK...',1,1,'ABC');
update myTbl4 set col43 = 2;
insert into myTbl4 values (3,'FK...',1,10,'ABC');
delete from myTbl1 where col11 = 10;
update myTbl1 set col12='DEF' where col11 <= 2;
--
select emaj.emaj_set_mark_group('myGroup1','M3');
 emaj_set_mark_group 
---------------------
                   6
(1 row)

select emaj.emaj_comment_mark_group('myGroup1','M3','Third mark set');
 emaj_comment_mark_group 
-------------------------
 
(1 row)

--
delete from myTbl1 where col11 > 3;
select emaj.emaj_rollback_group('myGroup1','M3');
 emaj_rollback_group 
---------------------
                   2
(1 row)

insert into myTbl2 values (3,'GHI',NULL);
update myTbl4 set col43 = 3 where col41 = 2;
-- note that this rollback fails with PG12 in E-Maj 3.2.0, but should succeed in later version (comment to delete then)
select emaj.emaj_rollback_group('myGroup1','M3');
ERROR:  cannot insert into column "col22"
DETAIL:  Column "col22" is a generated column.
CONTEXT:  SQL statement "INSERT INTO myschema1.mytbl2b  OVERRIDING SYSTEM VALUE  SELECT tbl.col20,tbl.col21,tbl.col22,tbl.col23 FROM emaj_myschema1.mytbl2b_log tbl, emaj_tmp_7648 keys     WHERE tbl.col20 = keys.col20 AND tbl.emaj_gid = keys.emaj_gid AND tbl.emaj_tuple = 'OLD'      AND tbl.emaj_gid > 40 AND tbl.emaj_gid <= 49"
PL/pgSQL function emaj._rlbk_tbl(emaj.emaj_relation,bigint,bigint,integer,boolean) line 55 at EXECUTE
SQL statement "SELECT emaj._rlbk_tbl(emaj_relation.*,
                                CASE WHEN v_rlbkMarkTimeId = r_step.rlbp_target_time_id THEN v_lastGlobalSeq      -- common case
                                     ELSE (SELECT time_last_emaj_gid FROM emaj.emaj_time_stamp WHERE time_id = r_step.rlbp_target_time_id)
                                END,
                                v_maxGlobalSeq, v_nbSession, v_isLoggedRlbk)                           FROM emaj.emaj_relation
            WHERE rel_schema = r_step.rlbp_schema AND rel_tblseq = r_step.rlbp_table AND upper_inf(rel_time_range)"
PL/pgSQL function emaj._rlbk_session_exec(integer,integer) line 73 at SQL statement
SQL statement "SELECT emaj._rlbk_session_exec(v_rlbkId, 1)"
PL/pgSQL function emaj._rlbk_groups(text[],text,boolean,boolean,boolean) line 31 at PERFORM
SQL statement "SELECT rlbk_message::INT FROM emaj._rlbk_groups(array[v_groupName], v_mark, FALSE, FALSE, NULL) WHERE rlbk_severity = 'Notice'"
PL/pgSQL function emaj.emaj_rollback_group(text,text) line 7 at RETURN
--
select emaj.emaj_protect_mark_group('myGroup1','M3');
 emaj_protect_mark_group 
-------------------------
                       1
(1 row)

select emaj.emaj_protect_group('myGroup1');
 emaj_protect_group 
--------------------
                  1
(1 row)

-----------------------------
-- Step 2 : for myGroup2, start, update tables and set 2 marks 
-----------------------------
set search_path=myschema2;
insert into myTbl1 select i, 'ABC', E'\\014'::bytea from generate_series (1,11) as i;
update myTbl1 set col13=E'\\034'::bytea where col11 <= 3;
insert into myTbl2 values (1,'ABC','2010-01-01');
delete from myTbl1 where col11 > 10;
select nextval('myschema2.myseq1');
 nextval 
---------
    1000
(1 row)

insert into myTbl2 values (2,'DEF',NULL);
insert into "myTbl3" (col33) select generate_series(1000,1039,4)/100;
--
select emaj.emaj_set_mark_group('myGroup2','M2');
 emaj_set_mark_group 
---------------------
                   6
(1 row)

--
set search_path=myschema2;
select nextval('myschema2.myseq1');
 nextval 
---------
    1001
(1 row)

select nextval('myschema2.myseq1');
 nextval 
---------
    1002
(1 row)

select nextval('myschema2.myseq1');
 nextval 
---------
    1003
(1 row)

--
reset role;
alter sequence mySeq1 NO MAXVALUE NO CYCLE;
set role emaj_regression_tests_adm_user;
--
insert into myTbl4 values (1,'FK...',1,1,'ABC');
insert into myTbl4 values (2,'FK...',1,1,'ABC');
update myTbl4 set col43 = 2;
--
select emaj.emaj_set_mark_group('myGroup2','M3');
 emaj_set_mark_group 
---------------------
                   6
(1 row)

-----------------------------
-- Step 3 : for myGroup2, double logged rollback
-----------------------------
select emaj.emaj_logged_rollback_group('myGroup2','M2');
 emaj_logged_rollback_group 
----------------------------
                          3
(1 row)

select emaj.emaj_logged_rollback_group('myGroup2','M3');
 emaj_logged_rollback_group 
----------------------------
                          3
(1 row)

-----------------------------
-- Step 4 : for both myGroup1 and myGroup2, set a common mark
-----------------------------
select emaj.emaj_set_mark_groups('{"myGroup1","myGroup2"}','Common');
 emaj_set_mark_groups 
----------------------
                   12
(1 row)

-----------------------------
-- Step 5 : alter group myGroup1 by removing a table
-----------------------------
delete from emaj.emaj_group_def where grpdef_schema = 'myschema1' and grpdef_tblseq = 'myTbl3';
reset role;
select emaj.emaj_alter_group('myGroup1');
 emaj_alter_group 
------------------
                5
(1 row)

set role emaj_regression_tests_adm_user;
-----------------------------
-- Step 6 : managing a group with long name tables
-----------------------------
select emaj.emaj_create_group('myGroup6');
NOTICE:  table "table_with_50_characters_long_name_____0_________0_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema6.table_with_50_characters_long_name_____0_________0" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema6.table_with_50_characters_long_name_____0_________0" does not exist, skipping
NOTICE:  table "table_with_51_characters_long_name_____0_________0#1_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema6.table_with_51_characters_long_name_____0_________0a" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema6.table_with_51_characters_long_name_____0_________0a" does not exist, skipping
NOTICE:  table "table_with_55_characters_long_name_____0_________0#1_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema6.table_with_55_characters_long_name_____0_________0abcde" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema6.table_with_55_characters_long_name_____0_________0abcde" does not exist, skipping
NOTICE:  table "table_with_55_characters_long_name_____0_________0#2_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema6.table_with_55_characters_long_name_____0_________0fghij" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema6.table_with_55_characters_long_name_____0_________0fghij" does not exist, skipping
 emaj_create_group 
-------------------
                 4
(1 row)

select emaj.emaj_start_group('myGroup6', 'Start G6');
 emaj_start_group 
------------------
                4
(1 row)

delete from emaj.emaj_group_def where grpdef_schema = 'myschema6' and grpdef_tblseq = 'table_with_55_characters_long_name_____0_________0abcde';
select emaj.emaj_alter_group('myGroup6');
 emaj_alter_group 
------------------
                3
(1 row)

select emaj.emaj_stop_group('myGroup6');
 emaj_stop_group 
-----------------
               3
(1 row)

-----------------------------
-- Checking steps 1 to 6
-----------------------------
-- emaj tables
select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
       1 |                  0 | C
       2 |                  0 | C
       3 |                  0 | C
       4 |                  0 | M
       5 |                  0 | M
       6 |                  0 | M
       7 |                 29 | M
       8 |                 40 | M
       9 |                 46 | R
      11 |                 76 | M
      12 |                 80 | M
      13 |                 80 | R
      14 |                 82 | M
      15 |                 82 | R
      16 |                 84 | M
      17 |                 84 | M
      18 |                 84 | A
      19 |                 84 | C
      20 |                 84 | M
      21 |                 84 | A
      22 |                 84 | M
(21 rows)

select group_name, group_is_rollbackable, group_creation_time_id,
       group_last_alter_time_id, group_has_waiting_changes, group_is_logging, 
       group_is_rlbk_protected, group_nb_table, group_nb_sequence, group_comment
  from emaj.emaj_group order by group_name;
    group_name    | group_is_rollbackable | group_creation_time_id | group_last_alter_time_id | group_has_waiting_changes | group_is_logging | group_is_rlbk_protected | group_nb_table | group_nb_sequence | group_comment 
------------------+-----------------------+------------------------+--------------------------+---------------------------+------------------+-------------------------+----------------+-------------------+---------------
 myGroup1         | t                     |                      1 |                       18 | f                         | t                | t                       |              4 |                 1 | 
 myGroup2         | t                     |                      2 |                          | f                         | t                | f                       |              4 |                 2 | 
 myGroup6         | t                     |                     19 |                       21 | f                         | f                | f                       |              3 |                 0 | 
 phil's group#3", | f                     |                      3 |                          | f                         | t                | t                       |              2 |                 1 | 
(4 rows)

select mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'), mark_time_id, 
       mark_is_deleted, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark 
  from emaj.emaj_mark order by mark_time_id, mark_group;
    mark_group    | regexp_replace  | mark_time_id | mark_is_deleted | mark_is_rlbk_protected |  mark_comment  | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------------+-----------------+--------------+-----------------+------------------------+----------------+---------------------------+------------------------------
 myGroup1         | M1              |            4 | f               | f                      |                |                        29 | 
 myGroup2         | M1              |            5 | f               | f                      |                |                        27 | 
 phil's group#3", | M1              |            6 | f               | f                      |                |                         0 | 
 myGroup1         | M2              |            7 | f               | f                      |                |                        11 | 
 myGroup1         | M3              |            8 | f               | t                      | Third mark set |                         3 | 
 myGroup2         | M2              |           11 | f               | f                      |                |                         4 | 
 myGroup2         | M3              |           12 | f               | f                      |                |                         0 | 
 myGroup2         | RLBK_M2_%_START |           13 | f               | f                      |                |                         2 | 
 myGroup2         | RLBK_M2_%_DONE  |           14 | f               | f                      |                |                         0 | M2
 myGroup2         | RLBK_M3_%_START |           15 | f               | f                      |                |                         2 | 
 myGroup2         | RLBK_M3_%_DONE  |           16 | f               | f                      |                |                         0 | M3
 myGroup1         | Common          |           17 | f               | f                      |                |                         0 | 
 myGroup2         | Common          |           17 | f               | f                      |                |                         0 | 
 myGroup1         | ALTER_%         |           18 | f               | f                      |                |                         0 | 
 myGroup6         | Start G6        |           20 | t               | f                      |                |                         0 | 
 myGroup6         | ALTER_%         |           21 | t               | f                      |                |                         0 | 
 myGroup6         | STOP_%          |           22 | t               | f                      |                |                         0 | 
(17 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called
  from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
     sequ_schema     |                          sequ_name                           | sequ_time_id | sequ_last_val | sequ_is_called 
---------------------+--------------------------------------------------------------+--------------+---------------+----------------
 emaj_myschema1      | myTbl3_log_seq                                               |            4 |             1 | f
 emaj_myschema1      | mytbl1_log_seq                                               |            4 |             1 | f
 emaj_myschema1      | mytbl2_log_seq                                               |            4 |             1 | f
 emaj_myschema1      | mytbl2b_log_seq                                              |            4 |             1 | f
 emaj_myschema1      | mytbl4_log_seq                                               |            4 |             1 | f
 myschema1           | myTbl3_col31_seq                                             |            4 |             1 | f
 emaj_myschema2      | myTbl3_log_seq                                               |            5 |             1 | f
 emaj_myschema2      | mytbl1_log_seq                                               |            5 |             1 | f
 emaj_myschema2      | mytbl2_log_seq                                               |            5 |             1 | f
 emaj_myschema2      | mytbl4_log_seq                                               |            5 |             1 | f
 myschema2           | myTbl3_col31_seq                                             |            5 |             1 | f
 myschema2           | myseq1                                                       |            5 |          1000 | f
 emaj_phil's schema3 | myTbl2\_log_seq                                              |            6 |             1 | f
 emaj_phil's schema3 | phil's tbl1_log_seq                                          |            6 |             1 | f
 phil's schema3      | phil's seq\1                                                 |            6 |          1000 | f
 emaj_myschema1      | myTbl3_log_seq                                               |            7 |            10 | t
 emaj_myschema1      | mytbl1_log_seq                                               |            7 |            15 | t
 emaj_myschema1      | mytbl2_log_seq                                               |            7 |             2 | t
 emaj_myschema1      | mytbl2b_log_seq                                              |            7 |             2 | t
 emaj_myschema1      | mytbl4_log_seq                                               |            7 |             1 | f
 myschema1           | myTbl3_col31_seq                                             |            7 |            10 | t
 emaj_myschema1      | myTbl3_log_seq                                               |            8 |            10 | t
 emaj_myschema1      | mytbl1_log_seq                                               |            8 |            18 | t
 emaj_myschema1      | mytbl2_log_seq                                               |            8 |             2 | t
 emaj_myschema1      | mytbl2b_log_seq                                              |            8 |             2 | t
 emaj_myschema1      | mytbl4_log_seq                                               |            8 |             8 | t
 myschema1           | myTbl3_col31_seq                                             |            8 |            10 | t
 emaj_myschema2      | myTbl3_log_seq                                               |           11 |            10 | t
 emaj_myschema2      | mytbl1_log_seq                                               |           11 |            15 | t
 emaj_myschema2      | mytbl2_log_seq                                               |           11 |             2 | t
 emaj_myschema2      | mytbl4_log_seq                                               |           11 |             1 | f
 myschema2           | myTbl3_col31_seq                                             |           11 |            10 | t
 myschema2           | myseq1                                                       |           11 |          1000 | t
 emaj_myschema2      | myTbl3_log_seq                                               |           12 |            10 | t
 emaj_myschema2      | mytbl1_log_seq                                               |           12 |            15 | t
 emaj_myschema2      | mytbl2_log_seq                                               |           12 |             2 | t
 emaj_myschema2      | mytbl4_log_seq                                               |           12 |             4 | t
 myschema2           | myTbl3_col31_seq                                             |           12 |            10 | t
 myschema2           | myseq1                                                       |           12 |          1003 | t
 emaj_myschema2      | myTbl3_log_seq                                               |           13 |            10 | t
 emaj_myschema2      | mytbl1_log_seq                                               |           13 |            15 | t
 emaj_myschema2      | mytbl2_log_seq                                               |           13 |             2 | t
 emaj_myschema2      | mytbl4_log_seq                                               |           13 |             4 | t
 myschema2           | myTbl3_col31_seq                                             |           13 |            10 | t
 myschema2           | myseq1                                                       |           13 |          1003 | t
 emaj_myschema2      | myTbl3_log_seq                                               |           14 |            10 | t
 emaj_myschema2      | mytbl1_log_seq                                               |           14 |            15 | t
 emaj_myschema2      | mytbl2_log_seq                                               |           14 |             2 | t
 emaj_myschema2      | mytbl4_log_seq                                               |           14 |             6 | t
 myschema2           | myTbl3_col31_seq                                             |           14 |            10 | t
 myschema2           | myseq1                                                       |           14 |          1001 | f
 emaj_myschema2      | myTbl3_log_seq                                               |           15 |            10 | t
 emaj_myschema2      | mytbl1_log_seq                                               |           15 |            15 | t
 emaj_myschema2      | mytbl2_log_seq                                               |           15 |             2 | t
 emaj_myschema2      | mytbl4_log_seq                                               |           15 |             6 | t
 myschema2           | myTbl3_col31_seq                                             |           15 |            10 | t
 myschema2           | myseq1                                                       |           15 |          1001 | f
 emaj_myschema2      | myTbl3_log_seq                                               |           16 |            10 | t
 emaj_myschema2      | mytbl1_log_seq                                               |           16 |            15 | t
 emaj_myschema2      | mytbl2_log_seq                                               |           16 |             2 | t
 emaj_myschema2      | mytbl4_log_seq                                               |           16 |             8 | t
 myschema2           | myTbl3_col31_seq                                             |           16 |            10 | t
 myschema2           | myseq1                                                       |           16 |          1004 | f
 emaj_myschema1      | myTbl3_log_seq                                               |           17 |            10 | t
 emaj_myschema1      | mytbl1_log_seq                                               |           17 |            24 | t
 emaj_myschema1      | mytbl2_log_seq                                               |           17 |             3 | t
 emaj_myschema1      | mytbl2b_log_seq                                              |           17 |             3 | t
 emaj_myschema1      | mytbl4_log_seq                                               |           17 |             9 | t
 emaj_myschema2      | myTbl3_log_seq                                               |           17 |            10 | t
 emaj_myschema2      | mytbl1_log_seq                                               |           17 |            15 | t
 emaj_myschema2      | mytbl2_log_seq                                               |           17 |             2 | t
 emaj_myschema2      | mytbl4_log_seq                                               |           17 |             8 | t
 myschema1           | myTbl3_col31_seq                                             |           17 |            10 | t
 myschema2           | myTbl3_col31_seq                                             |           17 |            10 | t
 myschema2           | myseq1                                                       |           17 |          1004 | f
 emaj_myschema1      | myTbl3_log_seq                                               |           18 |            10 | t
 emaj_myschema1      | mytbl1_log_seq                                               |           18 |            24 | t
 emaj_myschema1      | mytbl2_log_seq                                               |           18 |             3 | t
 emaj_myschema1      | mytbl2b_log_seq                                              |           18 |             3 | t
 emaj_myschema1      | mytbl4_log_seq                                               |           18 |             9 | t
 myschema1           | myTbl3_col31_seq                                             |           18 |            10 | t
 emaj_myschema6      | table_with_50_characters_long_name_____0_________0_log_seq   |           20 |             1 | f
 emaj_myschema6      | table_with_51_characters_long_name_____0_________0#1_log_seq |           20 |             1 | f
 emaj_myschema6      | table_with_55_characters_long_name_____0_________0#1_log_seq |           20 |             1 | f
 emaj_myschema6      | table_with_55_characters_long_name_____0_________0#2_log_seq |           20 |             1 | f
 emaj_myschema6      | table_with_50_characters_long_name_____0_________0_log_seq   |           21 |             1 | f
 emaj_myschema6      | table_with_51_characters_long_name_____0_________0#1_log_seq |           21 |             1 | f
 emaj_myschema6      | table_with_55_characters_long_name_____0_________0#1_log_seq |           21 |             1 | f
 emaj_myschema6      | table_with_55_characters_long_name_____0_________0#2_log_seq |           21 |             1 | f
 emaj_myschema6      | table_with_50_characters_long_name_____0_________0_log_seq   |           22 |             1 | f
 emaj_myschema6      | table_with_51_characters_long_name_____0_________0#1_log_seq |           22 |             1 | f
 emaj_myschema6      | table_with_55_characters_long_name_____0_________0#2_log_seq |           22 |             1 | f
(92 rows)

select sqhl_schema, sqhl_table, sqhl_begin_time_id, sqhl_end_time_id, sqhl_hole_size
  from emaj.emaj_seq_hole order by 1,2,3;
 sqhl_schema | sqhl_table | sqhl_begin_time_id | sqhl_end_time_id | sqhl_hole_size 
-------------+------------+--------------------+------------------+----------------
 myschema1   | mytbl1     |                  8 |                9 |              6
(1 row)

select * from emaj.emaj_alter_plan order by 1,2,3,4,5;
 altr_time_id | altr_step  | altr_schema |                       altr_tblseq                       | altr_group | altr_priority | altr_group_is_logging | altr_new_group | altr_new_group_is_logging | altr_rlbk_id 
--------------+------------+-------------+---------------------------------------------------------+------------+---------------+-----------------------+----------------+---------------------------+--------------
           18 | REMOVE_TBL | myschema1   | myTbl3                                                  | myGroup1   |            10 | t                     |                |                           |             
           21 | REMOVE_TBL | myschema6   | table_with_55_characters_long_name_____0_________0abcde | myGroup6   |               | t                     |                |                           |             
(2 rows)

-- log tables
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid 
-------+------------+-------+-----------+------------+----------
     1 | ABC        | \x0c  | INS       | NEW        |        1
     2 | ABC        | \x0c  | INS       | NEW        |        2
     3 | ABC        | \x0c  | INS       | NEW        |        3
     4 | ABC        | \x0c  | INS       | NEW        |        4
     5 | ABC        | \x0c  | INS       | NEW        |        5
     6 | ABC        | \x0c  | INS       | NEW        |        6
     7 | ABC        | \x0c  | INS       | NEW        |        7
     8 | ABC        | \x0c  | INS       | NEW        |        8
     9 | ABC        | \x0c  | INS       | NEW        |        9
    10 | ABC        | \x0c  | INS       | NEW        |       10
    11 | ABC        | \x0c  | INS       | NEW        |       11
     1 | ABC        | \x0c  | UPD       | OLD        |       12
     1 | ABC        | \x1c  | UPD       | NEW        |       12
     2 | ABC        | \x0c  | UPD       | OLD        |       13
     2 | ABC        | \x1c  | UPD       | NEW        |       13
     3 | ABC        | \x0c  | UPD       | OLD        |       14
     3 | ABC        | \x1c  | UPD       | NEW        |       14
    11 | ABC        | \x0c  | DEL       | OLD        |       17
    10 | ABC        | \x0c  | DEL       | OLD        |       35
     1 | ABC        | \x1c  | UPD       | OLD        |       37
     1 | DEF        | \x1c  | UPD       | NEW        |       37
     2 | ABC        | \x1c  | UPD       | OLD        |       38
     2 | DEF        | \x1c  | UPD       | NEW        |       38
(23 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 |   col23    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+------------+-----------+------------+----------
     1 | ABC   | 12-31-2010 | INS       | NEW        |       15
     2 | DEF   |            | INS       | NEW        |       18
     3 | GHI   |            | INS       | NEW        |       47
(3 rows)

select col20, col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl2b_log order by emaj_gid, emaj_tuple desc;
 col20 | col21 |       col22        | col23 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+--------------------+-------+-----------+------------+----------
     1 |     1 |                  1 | t     | INS       | NEW        |       16
     2 |     2 |                0.5 | t     | INS       | NEW        |       19
     3 |     3 | 0.3333333333333333 | t     | INS       | NEW        |       48
(3 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema1."myTbl3_log_1" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
     1 | 10.00 | INS       | NEW        |       20
     2 | 10.00 | INS       | NEW        |       21
     3 | 10.00 | INS       | NEW        |       22
     4 | 10.00 | INS       | NEW        |       23
     5 | 10.00 | INS       | NEW        |       24
     6 | 10.00 | INS       | NEW        |       25
     7 | 10.00 | INS       | NEW        |       26
     8 | 10.00 | INS       | NEW        |       27
     9 | 10.00 | INS       | NEW        |       28
    10 | 10.00 | INS       | NEW        |       29
(10 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema1.myTbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 |   col45    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+------------+-----------+------------+----------
     1 | FK... |     1 |     1 | ABC        | INS       | NEW        |       30
     2 | FK... |     1 |     1 | ABC        | INS       | NEW        |       31
     1 | FK... |     1 |     1 | ABC        | UPD       | OLD        |       32
     1 | FK... |     2 |     1 | ABC        | UPD       | NEW        |       32
     2 | FK... |     1 |     1 | ABC        | UPD       | OLD        |       33
     2 | FK... |     2 |     1 | ABC        | UPD       | NEW        |       33
     3 | FK... |     1 |    10 | ABC        | INS       | NEW        |       34
     3 | FK... |     1 |    10 | ABC        | DEL       | OLD        |       36
     1 | FK... |     2 |     1 | ABC        | UPD       | OLD        |       39
     1 | FK... |     2 |       |            | UPD       | NEW        |       39
     2 | FK... |     2 |     1 | ABC        | UPD       | OLD        |       40
     2 | FK... |     2 |       |            | UPD       | NEW        |       40
     2 | FK... |     2 |       |            | UPD       | OLD        |       49
     2 | FK... |     3 |       |            | UPD       | NEW        |       49
(14 rows)

--
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid 
-------+------------+-------+-----------+------------+----------
     1 | ABC        | \x0c  | INS       | NEW        |       50
     2 | ABC        | \x0c  | INS       | NEW        |       51
     3 | ABC        | \x0c  | INS       | NEW        |       52
     4 | ABC        | \x0c  | INS       | NEW        |       53
     5 | ABC        | \x0c  | INS       | NEW        |       54
     6 | ABC        | \x0c  | INS       | NEW        |       55
     7 | ABC        | \x0c  | INS       | NEW        |       56
     8 | ABC        | \x0c  | INS       | NEW        |       57
     9 | ABC        | \x0c  | INS       | NEW        |       58
    10 | ABC        | \x0c  | INS       | NEW        |       59
    11 | ABC        | \x0c  | INS       | NEW        |       60
     1 | ABC        | \x0c  | UPD       | OLD        |       61
     1 | ABC        | \x1c  | UPD       | NEW        |       61
     2 | ABC        | \x0c  | UPD       | OLD        |       62
     2 | ABC        | \x1c  | UPD       | NEW        |       62
     3 | ABC        | \x0c  | UPD       | OLD        |       63
     3 | ABC        | \x1c  | UPD       | NEW        |       63
    11 | ABC        | \x0c  | DEL       | OLD        |       65
(18 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 |   col23    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+------------+-----------+------------+----------
     1 | ABC   | 01-01-2010 | INS       | NEW        |       64
     2 | DEF   |            | INS       | NEW        |       66
(2 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid from emaj_myschema2."myTbl3_log" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
     1 | 10.00 | INS       | NEW        |       67
     2 | 10.00 | INS       | NEW        |       68
     3 | 10.00 | INS       | NEW        |       69
     4 | 10.00 | INS       | NEW        |       70
     5 | 10.00 | INS       | NEW        |       71
     6 | 10.00 | INS       | NEW        |       72
     7 | 10.00 | INS       | NEW        |       73
     8 | 10.00 | INS       | NEW        |       74
     9 | 10.00 | INS       | NEW        |       75
    10 | 10.00 | INS       | NEW        |       76
(10 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid from emaj_mySchema2.myTbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 |   col45    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+------------+-----------+------------+----------
     1 | FK... |     1 |     1 | ABC        | INS       | NEW        |       77
     2 | FK... |     1 |     1 | ABC        | INS       | NEW        |       78
     1 | FK... |     1 |     1 | ABC        | UPD       | OLD        |       79
     1 | FK... |     2 |     1 | ABC        | UPD       | NEW        |       79
     2 | FK... |     1 |     1 | ABC        | UPD       | OLD        |       80
     2 | FK... |     2 |     1 | ABC        | UPD       | NEW        |       80
     1 | FK... |     2 |     1 | ABC        | DEL       | OLD        |       81
     2 | FK... |     2 |     1 | ABC        | DEL       | OLD        |       82
     1 | FK... |     2 |     1 | ABC        | INS       | NEW        |       83
     2 | FK... |     2 |     1 | ABC        | INS       | NEW        |       84
(10 rows)

-------------------------------
-- Specific tests for this upgrade
-------------------------------
