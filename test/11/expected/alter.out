-- alter.sql : tests groups structure changes with groups in IDLE state
-- test emaj_remove_table(), emaj_remove_tables(), emaj_remove_sequence(), emaj_remove_sequences(),
--      emaj_move_table(), emaj_move_tables(), emaj_move_sequence(), emaj_move_sequences(),
--      emaj_modify_table() and emaj_modify_tables() functions
--
-- define the temp file directory to be used by the script
\setenv EMAJTESTTMPDIR '/tmp/emaj_'`echo $PGVER`'/alter'
\set EMAJTESTTMPDIR `echo $EMAJTESTTMPDIR`
\! mkdir -p $EMAJTESTTMPDIR
-- set sequence restart value
select public.handle_emaj_sequences(8000);
 handle_emaj_sequences 
-----------------------
 
(1 row)

-----------------------------
-- stop, reset and drop and recreate groups
-----------------------------
select emaj.emaj_stop_group('myGroup1');
 emaj_stop_group 
-----------------
               7
(1 row)

select emaj.emaj_reset_group('myGroup1');
 emaj_reset_group 
------------------
                7
(1 row)

select emaj.emaj_drop_group('myGroup1');
 emaj_drop_group 
-----------------
               7
(1 row)

select emaj.emaj_force_drop_group('myGroup2');
 emaj_force_drop_group 
-----------------------
                    10
(1 row)

select emaj.emaj_stop_group('phil''s group#3",','Simple stop mark');
 emaj_stop_group 
-----------------
               4
(1 row)

select emaj.emaj_drop_group('phil''s group#3",');
 emaj_drop_group 
-----------------
               4
(1 row)

select emaj.emaj_force_stop_group('myGroup4');
 emaj_force_stop_group 
-----------------------
                     6
(1 row)

select emaj.emaj_drop_group('myGroup4');
 emaj_drop_group 
-----------------
               6
(1 row)

select emaj.emaj_force_stop_group('emptyGroup');
 emaj_force_stop_group 
-----------------------
                     0
(1 row)

select emaj.emaj_drop_group('emptyGroup');
 emaj_drop_group 
-----------------
               0
(1 row)

select emaj.emaj_create_group('myGroup1');
 emaj_create_group 
-------------------
                 1
(1 row)

-- rebuild all original groups
SET client_min_messages TO WARNING;
select emaj.emaj_import_groups_configuration(:'EMAJTESTTMPDIR' || '/../all_groups_config.json', array['myGroup1','myGroup2','emptyGroup','myGroup4','myGroup5'], true);
WARNING:  _create_tbl: The table "myschema1.mytbl2" has triggers that will be automatically disabled during E-Maj rollback operations (mytbl2trg1, mytbl2trg2). Use the emaj_modify_table() function to change this behaviour.
WARNING:  _create_tbl: The table "myschema4.mytblm" has triggers that will be automatically disabled during E-Maj rollback operations (mytblm_insert_trigger). Use the emaj_modify_table() function to change this behaviour.
 emaj_import_groups_configuration 
----------------------------------
                                5
(1 row)

-- add a table without PK to the audit_only group
select emaj.emaj_assign_table('phil''s schema3', 'myTbl2\', 'myGroup5');
 emaj_assign_table 
-------------------
                 1
(1 row)

RESET client_min_messages;
-----------------------------------
-- emaj_remove_table
-----------------------------------
-- error cases
-- table not in a group
select emaj.emaj_remove_table('dummySchema','mytbl1');
ERROR:  _remove_tables: some tables ("dummySchema".mytbl1) do not currently belong to any tables group.
CONTEXT:  PL/pgSQL function emaj._remove_tables(text,text[],text,boolean,boolean) line 49 at RAISE
PL/pgSQL function emaj.emaj_remove_table(text,text,text) line 6 at RETURN
select emaj.emaj_remove_table('myschema1','dummyTable');
ERROR:  _remove_tables: some tables (myschema1."dummyTable") do not currently belong to any tables group.
CONTEXT:  PL/pgSQL function emaj._remove_tables(text,text[],text,boolean,boolean) line 49 at RAISE
PL/pgSQL function emaj.emaj_remove_table(text,text,text) line 6 at RETURN
-- bad mark
select emaj.emaj_remove_table('myschema1','mytbl1','EMAJ_LAST_MARK');
ERROR:  _check_new_mark: "EMAJ_LAST_MARK" is not an allowed name for a new mark.
CONTEXT:  PL/pgSQL function emaj._check_new_mark(text[],text) line 14 at RAISE
SQL statement "SELECT emaj._check_new_mark(v_loggingGroups, p_mark)"
PL/pgSQL function emaj._remove_tables(text,text[],text,boolean,boolean) line 70 at SQL statement
PL/pgSQL function emaj.emaj_remove_table(text,text,text) line 6 at RETURN
-- ok
select emaj.emaj_remove_table('myschema1','mytbl1');
 emaj_remove_table 
-------------------
                 1
(1 row)

-----------------------------------
-- emaj_remove_tables with array
-----------------------------------
-- error cases
-- empty tables array
select emaj.emaj_remove_tables('myschema1',array[]::text[]);
WARNING:  _remove_tables: No table to process.
 emaj_remove_tables 
--------------------
                  0
(1 row)

select emaj.emaj_remove_tables('myschema1',null);
WARNING:  _remove_tables: No table to process.
 emaj_remove_tables 
--------------------
                  0
(1 row)

select emaj.emaj_remove_tables('myschema1',array['']);
WARNING:  _remove_tables: No table to process.
 emaj_remove_tables 
--------------------
                  0
(1 row)

-- table not in a group
select emaj.emaj_remove_tables('myschema1',array['dummyTable','mytbl1','mytbl2']);
ERROR:  _remove_tables: some tables (myschema1.mytbl1, myschema1."dummyTable") do not currently belong to any tables group.
CONTEXT:  PL/pgSQL function emaj._remove_tables(text,text[],text,boolean,boolean) line 49 at RAISE
PL/pgSQL function emaj.emaj_remove_tables(text,text[],text) line 6 at RETURN
-- ok (with a duplicate table name)
select emaj.emaj_remove_tables('myschema1',array['mytbl2','mytbl2b','mytbl2']);
 emaj_remove_tables 
--------------------
                  2
(1 row)

-----------------------------------
-- emaj_remove_tables with filters
-----------------------------------
-- empty tables array
select emaj.emaj_remove_tables('myschema1',null,null);
WARNING:  _remove_tables: No table to process.
 emaj_remove_tables 
--------------------
                  0
(1 row)

select emaj.emaj_remove_tables('myschema1','','');
WARNING:  _remove_tables: No table to process.
 emaj_remove_tables 
--------------------
                  0
(1 row)

select emaj.emaj_remove_tables('myschema1','mytbl1','mytbl1');
WARNING:  _remove_tables: No table to process.
 emaj_remove_tables 
--------------------
                  0
(1 row)

-- ok
select emaj.emaj_remove_tables('myschema1','my(t|T)bl\d$','mytbl2');
 emaj_remove_tables 
--------------------
                  2
(1 row)

select group_last_alter_time_id, group_nb_table, group_nb_sequence from emaj.emaj_group where group_name = 'myGroup1';
 group_last_alter_time_id | group_nb_table | group_nb_sequence 
--------------------------+----------------+-------------------
                     8014 |              0 |                 2
(1 row)

-----------------------------------
-- emaj_remove_sequence
-----------------------------------
-- error cases
-- sequence not in a group
select emaj.emaj_remove_sequence('dummySchema','myseq1');
ERROR:  _remove_sequences: some sequences ("dummySchema".myseq1) do not currently belong to any tables group.
CONTEXT:  PL/pgSQL function emaj._remove_sequences(text,text[],text,boolean,boolean) line 50 at RAISE
PL/pgSQL function emaj.emaj_remove_sequence(text,text,text) line 6 at RETURN
select emaj.emaj_remove_sequence('myschema2','dummySequence');
ERROR:  _remove_sequences: some sequences (myschema2."dummySequence") do not currently belong to any tables group.
CONTEXT:  PL/pgSQL function emaj._remove_sequences(text,text[],text,boolean,boolean) line 50 at RAISE
PL/pgSQL function emaj.emaj_remove_sequence(text,text,text) line 6 at RETURN
-- bad mark
select emaj.emaj_remove_sequence('myschema2','myseq1','EMAJ_LAST_MARK');
ERROR:  _check_new_mark: "EMAJ_LAST_MARK" is not an allowed name for a new mark.
CONTEXT:  PL/pgSQL function emaj._check_new_mark(text[],text) line 14 at RAISE
SQL statement "SELECT emaj._check_new_mark(v_loggingGroups, p_mark)"
PL/pgSQL function emaj._remove_sequences(text,text[],text,boolean,boolean) line 73 at SQL statement
PL/pgSQL function emaj.emaj_remove_sequence(text,text,text) line 6 at RETURN
-- ok
select emaj.emaj_remove_sequence('myschema2','myseq1');
 emaj_remove_sequence 
----------------------
                    1
(1 row)

-----------------------------------
-- emaj_remove_sequences with array
-----------------------------------
-- error cases
-- empty sequences array
select emaj.emaj_remove_sequences('myschema2',array[]::text[]);
WARNING:  _remove_sequences: No sequence to process.
 emaj_remove_sequences 
-----------------------
                     0
(1 row)

select emaj.emaj_remove_sequences('myschema2',null);
WARNING:  _remove_sequences: No sequence to process.
 emaj_remove_sequences 
-----------------------
                     0
(1 row)

select emaj.emaj_remove_sequences('myschema2',array['']);
WARNING:  _remove_sequences: No sequence to process.
 emaj_remove_sequences 
-----------------------
                     0
(1 row)

-- sequence not in a group
select emaj.emaj_remove_sequences('myschema2',array['dummyTable','myseq2']);
ERROR:  _remove_sequences: some sequences (myschema2.myseq2, myschema2."dummyTable") do not currently belong to any tables group.
CONTEXT:  PL/pgSQL function emaj._remove_sequences(text,text[],text,boolean,boolean) line 50 at RAISE
PL/pgSQL function emaj.emaj_remove_sequences(text,text[],text) line 6 at RETURN
-- ok (with a duplicate sequence name)
select emaj.emaj_assign_sequence('myschema2','myseq2','myGroup2');
 emaj_assign_sequence 
----------------------
                    1
(1 row)

select emaj.emaj_remove_sequences('myschema2',array['myseq2','myseq2']);
 emaj_remove_sequences 
-----------------------
                     1
(1 row)

-----------------------------------
-- emaj_remove_sequences with filters
-----------------------------------
-- empty tables array
select emaj.emaj_remove_sequences('myschema2',null,null);
WARNING:  _remove_sequences: No sequence to process.
 emaj_remove_sequences 
-----------------------
                     0
(1 row)

select emaj.emaj_remove_sequences('myschema2','','');
WARNING:  _remove_sequences: No sequence to process.
 emaj_remove_sequences 
-----------------------
                     0
(1 row)

select emaj.emaj_remove_sequences('myschema2','myseq1','myseq1');
WARNING:  _remove_sequences: No sequence to process.
 emaj_remove_sequences 
-----------------------
                     0
(1 row)

-- ok
select emaj.emaj_remove_sequences('myschema2','.*','');
 emaj_remove_sequences 
-----------------------
                     1
(1 row)

select group_last_alter_time_id, group_nb_table, group_nb_sequence from emaj.emaj_group where group_name = 'myGroup2';
 group_last_alter_time_id | group_nb_table | group_nb_sequence 
--------------------------+----------------+-------------------
                     8018 |              8 |                 0
(1 row)

-- rebuild all original groups
SET client_min_messages TO WARNING;
select emaj.emaj_import_groups_configuration(:'EMAJTESTTMPDIR' || '/../all_groups_config.json', array['myGroup1','myGroup2','emptyGroup','myGroup4'], true);
WARNING:  _create_tbl: The table "myschema1.mytbl2" has triggers that will be automatically disabled during E-Maj rollback operations (mytbl2trg1, mytbl2trg2). Use the emaj_modify_table() function to change this behaviour.
 emaj_import_groups_configuration 
----------------------------------
                                4
(1 row)

RESET client_min_messages;
-- check for emaj_remove_table() and emaj_remove_sequence() functions family
select * from emaj.emaj_relation_change where rlchg_time_id >= 8000 order by 1,2,3,4;
 rlchg_time_id |  rlchg_schema  |   rlchg_tblseq    | rlchg_change_kind |   rlchg_group    | rlchg_new_schema | rlchg_new_tblseq | rlchg_new_group | rlchg_priority | rlchg_new_priority | rlchg_log_data_tsp | rlchg_new_log_data_tsp | rlchg_log_index_tsp | rlchg_new_log_index_tsp | rlchg_ignored_triggers | rlchg_new_ignored_triggers | rlchg_rlbk_id 
---------------+----------------+-------------------+-------------------+------------------+------------------+------------------+-----------------+----------------+--------------------+--------------------+------------------------+---------------------+-------------------------+------------------------+----------------------------+---------------
          8001 | myschema1      | myTbl3            | REMOVE_TABLE      | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8001 | myschema1      | myTbl3_col31_seq  | REMOVE_SEQUENCE   | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8001 | myschema1      | mytbl1            | REMOVE_TABLE      | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8001 | myschema1      | mytbl2            | REMOVE_TABLE      | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8001 | myschema1      | mytbl2b           | REMOVE_TABLE      | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8001 | myschema1      | mytbl2b_col20_seq | REMOVE_SEQUENCE   | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8001 | myschema1      | mytbl4            | REMOVE_TABLE      | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8002 | myschema2      | myTbl3            | REMOVE_TABLE      | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8002 | myschema2      | myTbl3_col31_seq  | REMOVE_SEQUENCE   | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8002 | myschema2      | myseq1            | REMOVE_SEQUENCE   | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8002 | myschema2      | mytbl1            | REMOVE_TABLE      | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8002 | myschema2      | mytbl2            | REMOVE_TABLE      | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8002 | myschema2      | mytbl4            | REMOVE_TABLE      | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8002 | myschema2      | mytbl5            | REMOVE_TABLE      | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8002 | myschema2      | mytbl6            | REMOVE_TABLE      | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8002 | myschema2      | mytbl7            | REMOVE_TABLE      | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8002 | myschema2      | mytbl8            | REMOVE_TABLE      | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8004 | phil's schema3 | myTbl2\           | REMOVE_TABLE      | phil's group#3", |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8004 | phil's schema3 | myTbl2\_col21_seq | REMOVE_SEQUENCE   | phil's group#3", |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8004 | phil's schema3 | phil's seq\1      | REMOVE_SEQUENCE   | phil's group#3", |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8004 | phil's schema3 | phil's tbl1       | REMOVE_TABLE      | phil's group#3", |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8006 | myschema4      | mypartp1          | REMOVE_TABLE      | myGroup4         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8006 | myschema4      | mypartp2          | REMOVE_TABLE      | myGroup4         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8006 | myschema4      | mytblc1           | REMOVE_TABLE      | myGroup4         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8006 | myschema4      | mytblc2           | REMOVE_TABLE      | myGroup4         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8006 | myschema4      | mytblm            | REMOVE_TABLE      | myGroup4         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8006 | myschema4      | mytblr            | REMOVE_TABLE      | myGroup4         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8010 | myschema1      | myTbl3            | ADD_TABLE         | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8010 | myschema1      | myTbl3_col31_seq  | ADD_SEQUENCE      | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8010 | myschema1      | mytbl1            | ADD_TABLE         | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8010 | myschema1      | mytbl2            | ADD_TABLE         | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8010 | myschema1      | mytbl2b           | ADD_TABLE         | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8010 | myschema1      | mytbl2b_col20_seq | ADD_SEQUENCE      | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8010 | myschema1      | mytbl4            | ADD_TABLE         | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8010 | myschema2      | myTbl3            | ADD_TABLE         | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8010 | myschema2      | myTbl3_col31_seq  | ADD_SEQUENCE      | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8010 | myschema2      | myseq1            | ADD_SEQUENCE      | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8010 | myschema2      | mytbl1            | ADD_TABLE         | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8010 | myschema2      | mytbl2            | ADD_TABLE         | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8010 | myschema2      | mytbl4            | ADD_TABLE         | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8010 | myschema2      | mytbl5            | ADD_TABLE         | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8010 | myschema2      | mytbl6            | ADD_TABLE         | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8010 | myschema2      | mytbl7            | ADD_TABLE         | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8010 | myschema2      | mytbl8            | ADD_TABLE         | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8010 | myschema4      | mypartp1          | ADD_TABLE         | myGroup4         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8010 | myschema4      | mypartp2          | ADD_TABLE         | myGroup4         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8010 | myschema4      | mytblc1           | ADD_TABLE         | myGroup4         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8010 | myschema4      | mytblc2           | ADD_TABLE         | myGroup4         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8010 | myschema4      | mytblm            | ADD_TABLE         | myGroup4         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8010 | myschema5      | myoidstbl         | ADD_TABLE         | myGroup5         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8010 | myschema5      | myunloggedtbl     | ADD_TABLE         | myGroup5         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8011 | phil's schema3 | myTbl2\           | ADD_TABLE         | myGroup5         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8012 | myschema1      | mytbl1            | REMOVE_TABLE      | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8013 | myschema1      | mytbl2            | REMOVE_TABLE      | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8013 | myschema1      | mytbl2b           | REMOVE_TABLE      | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8014 | myschema1      | myTbl3            | REMOVE_TABLE      | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8014 | myschema1      | mytbl4            | REMOVE_TABLE      | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8015 | myschema2      | myseq1            | REMOVE_SEQUENCE   | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8016 | myschema2      | myseq2            | ADD_SEQUENCE      | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8017 | myschema2      | myseq2            | REMOVE_SEQUENCE   | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8018 | myschema2      | myTbl3_col31_seq  | REMOVE_SEQUENCE   | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8019 | myschema1      | myTbl3            | ADD_TABLE         | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8019 | myschema1      | mytbl1            | ADD_TABLE         | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8019 | myschema1      | mytbl2            | ADD_TABLE         | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8019 | myschema1      | mytbl2b           | ADD_TABLE         | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8019 | myschema1      | mytbl4            | ADD_TABLE         | myGroup1         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8019 | myschema2      | myTbl3_col31_seq  | ADD_SEQUENCE      | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
          8019 | myschema2      | myseq1            | ADD_SEQUENCE      | myGroup2         |                  |                  |                 |                |                    |                    |                        |                     |                         |                        |                            |              
(68 rows)

select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 8000 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
    8000 |            8000000 | X
    8001 |            8000000 | D
    8002 |            8000000 | D
    8003 |            8000000 | X
    8004 |            8000000 | D
    8005 |            8000000 | X
    8006 |            8000000 | D
    8007 |            8000000 | X
    8008 |            8000000 | D
    8009 |            8000000 | C
    8010 |            8000000 | I
    8011 |            8000000 | A
    8012 |            8000000 | A
    8013 |            8000000 | A
    8014 |            8000000 | A
    8015 |            8000000 | A
    8016 |            8000000 | A
    8017 |            8000000 | A
    8018 |            8000000 | A
    8019 |            8000000 | I
(20 rows)

select hist_function, hist_event, hist_object,
       regexp_replace(regexp_replace(regexp_replace(hist_wording,
            E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),
            E'\\d\\d\\d\\d/\\d\\d\\/\\d\\d\\ \\d\\d\\:\\d\\d:\\d\\d .*?\\)','<timestamp>)','g'),
            E'\\[.+\\]','(timestamp)','g'), 
       hist_user 
  from emaj.emaj_hist where hist_id >= 8000 order by hist_id;
  hist_function   |     hist_event     |                    hist_object                     |                       regexp_replace                       | hist_user 
------------------+--------------------+----------------------------------------------------+------------------------------------------------------------+-----------
 STOP_GROUP       | BEGIN              | myGroup1                                           |                                                            | postgres
 LOCK_GROUP       | BEGIN              | myGroup1                                           |                                                            | postgres
 LOCK_GROUP       | END                | myGroup1                                           | 5 tables locked, 0 deadlock(s)                             | postgres
 SET_MARK_GROUP   | BEGIN              | myGroup1                                           | STOP_%                                                     | postgres
 SET_MARK_GROUP   | END                | myGroup1                                           | STOP_%                                                     | postgres
 STOP_GROUP       | END                | myGroup1                                           | 7 tables/sequences processed                               | postgres
 RESET_GROUP      | BEGIN              | myGroup1                                           |                                                            | postgres
 RESET_GROUP      | END                | myGroup1                                           | 7 tables/sequences processed                               | postgres
 DROP_GROUP       | BEGIN              | myGroup1                                           |                                                            | postgres
 DROP_GROUP       | LOG_SCHEMA DROPPED | emaj_myschema1                                     |                                                            | postgres
 DROP_GROUP       | END                | myGroup1                                           | 7 tables/sequences processed                               | postgres
 FORCE_DROP_GROUP | BEGIN              | myGroup2                                           |                                                            | postgres
 FORCE_DROP_GROUP | LOG_SCHEMA DROPPED | emaj_myschema2                                     |                                                            | postgres
 FORCE_DROP_GROUP | END                | myGroup2                                           | 10 tables/sequences processed                              | postgres
 STOP_GROUP       | BEGIN              | phil's group#3",                                   |                                                            | postgres
 LOCK_GROUP       | BEGIN              | phil's group#3",                                   |                                                            | postgres
 LOCK_GROUP       | END                | phil's group#3",                                   | 2 tables locked, 0 deadlock(s)                             | postgres
 SET_MARK_GROUP   | BEGIN              | phil's group#3",                                   | Simple stop mark                                           | postgres
 SET_MARK_GROUP   | END                | phil's group#3",                                   | Simple stop mark                                           | postgres
 STOP_GROUP       | END                | phil's group#3",                                   | 4 tables/sequences processed                               | postgres
 DROP_GROUP       | BEGIN              | phil's group#3",                                   |                                                            | postgres
 DROP_GROUP       | LOG_SCHEMA DROPPED | "emaj_phil's schema3"                              |                                                            | postgres
 DROP_GROUP       | END                | phil's group#3",                                   | 4 tables/sequences processed                               | postgres
 FORCE_STOP_GROUP | BEGIN              | myGroup4                                           |                                                            | postgres
 LOCK_GROUP       | BEGIN              | myGroup4                                           |                                                            | postgres
 LOCK_GROUP       | END                | myGroup4                                           | 6 tables locked, 0 deadlock(s)                             | postgres
 FORCE_STOP_GROUP | END                | myGroup4                                           | 6 tables/sequences processed                               | postgres
 DROP_GROUP       | BEGIN              | myGroup4                                           |                                                            | postgres
 DROP_GROUP       | LOG_SCHEMA DROPPED | emaj_myschema4                                     |                                                            | postgres
 DROP_GROUP       | END                | myGroup4                                           | 6 tables/sequences processed                               | postgres
 FORCE_STOP_GROUP | BEGIN              | emptyGroup                                         |                                                            | postgres
 LOCK_GROUP       | BEGIN              | emptyGroup                                         |                                                            | postgres
 LOCK_GROUP       | END                | emptyGroup                                         | 0 tables locked, 0 deadlock(s)                             | postgres
 FORCE_STOP_GROUP | END                | emptyGroup                                         | 0 tables/sequences processed                               | postgres
 DROP_GROUP       | BEGIN              | emptyGroup                                         |                                                            | postgres
 DROP_GROUP       | END                | emptyGroup                                         | 0 tables/sequences processed                               | postgres
 CREATE_GROUP     | BEGIN              | myGroup1                                           | rollbackable                                               | postgres
 CREATE_GROUP     | END                | myGroup1                                           |                                                            | postgres
 IMPORT_GROUPS    | BEGIN              | myGroup1, myGroup2, emptyGroup, myGroup4, myGroup5 | Input file: '/tmp/emaj_11/alter/../all_groups_config.json' | postgres
 IMPORT_GROUPS    | GROUP CREATED      | emptyGroup                                         | rollbackable                                               | postgres
 IMPORT_GROUPS    | GROUP CREATED      | myGroup2                                           | rollbackable                                               | postgres
 IMPORT_GROUPS    | GROUP CREATED      | myGroup4                                           | rollbackable                                               | postgres
 IMPORT_GROUPS    | GROUP CREATED      | myGroup5                                           | audit_only                                                 | postgres
 IMPORT_GROUPS    | LOG_SCHEMA CREATED | emaj_myschema1                                     |                                                            | postgres
 IMPORT_GROUPS    | LOG_SCHEMA CREATED | emaj_myschema2                                     |                                                            | postgres
 IMPORT_GROUPS    | LOG_SCHEMA CREATED | emaj_myschema4                                     |                                                            | postgres
 IMPORT_GROUPS    | LOG_SCHEMA CREATED | emaj_myschema5                                     |                                                            | postgres
 IMPORT_GROUPS    | TABLE ADDED        | myschema1."myTbl3"                                 | To the idle group myGroup1                                 | postgres
 IMPORT_GROUPS    | TABLE ADDED        | myschema1.mytbl1                                   | To the idle group myGroup1                                 | postgres
 IMPORT_GROUPS    | TABLE ADDED        | myschema1.mytbl4                                   | To the idle group myGroup1                                 | postgres
 IMPORT_GROUPS    | TABLE ADDED        | myschema1.mytbl2                                   | To the idle group myGroup1                                 | postgres
 IMPORT_GROUPS    | TABLE ADDED        | myschema1.mytbl2b                                  | To the idle group myGroup1                                 | postgres
 IMPORT_GROUPS    | TABLE ADDED        | myschema2."myTbl3"                                 | To the idle group myGroup2                                 | postgres
 IMPORT_GROUPS    | TABLE ADDED        | myschema2.mytbl1                                   | To the idle group myGroup2                                 | postgres
 IMPORT_GROUPS    | TABLE ADDED        | myschema2.mytbl2                                   | To the idle group myGroup2                                 | postgres
 IMPORT_GROUPS    | TABLE ADDED        | myschema2.mytbl4                                   | To the idle group myGroup2                                 | postgres
 IMPORT_GROUPS    | TABLE ADDED        | myschema2.mytbl5                                   | To the idle group myGroup2                                 | postgres
 IMPORT_GROUPS    | TABLE ADDED        | myschema2.mytbl6                                   | To the idle group myGroup2                                 | postgres
 IMPORT_GROUPS    | TABLE ADDED        | myschema2.mytbl7                                   | To the idle group myGroup2                                 | postgres
 IMPORT_GROUPS    | TABLE ADDED        | myschema2.mytbl8                                   | To the idle group myGroup2                                 | postgres
 IMPORT_GROUPS    | TABLE ADDED        | myschema4.mypartp1                                 | To the idle group myGroup4                                 | postgres
 IMPORT_GROUPS    | TABLE ADDED        | myschema4.mypartp2                                 | To the idle group myGroup4                                 | postgres
 IMPORT_GROUPS    | TABLE ADDED        | myschema4.mytblc1                                  | To the idle group myGroup4                                 | postgres
 IMPORT_GROUPS    | TABLE ADDED        | myschema4.mytblc2                                  | To the idle group myGroup4                                 | postgres
 IMPORT_GROUPS    | TABLE ADDED        | myschema4.mytblm                                   | To the idle group myGroup4                                 | postgres
 IMPORT_GROUPS    | TABLE ADDED        | myschema5.myoidstbl                                | To the idle group myGroup5                                 | postgres
 IMPORT_GROUPS    | TABLE ADDED        | myschema5.myunloggedtbl                            | To the idle group myGroup5                                 | postgres
 IMPORT_GROUPS    | SEQUENCE ADDED     | myschema1."myTbl3_col31_seq"                       | To the idle group myGroup1                                 | postgres
 IMPORT_GROUPS    | SEQUENCE ADDED     | myschema1.mytbl2b_col20_seq                        | To the idle group myGroup1                                 | postgres
 IMPORT_GROUPS    | SEQUENCE ADDED     | myschema2."myTbl3_col31_seq"                       | To the idle group myGroup2                                 | postgres
 IMPORT_GROUPS    | SEQUENCE ADDED     | myschema2.myseq1                                   | To the idle group myGroup2                                 | postgres
 IMPORT_GROUPS    | END                |                                                    | 5 created or altered tables groups                         | postgres
 ASSIGN_TABLE     | BEGIN              |                                                    |                                                            | postgres
 ASSIGN_TABLE     | LOG_SCHEMA CREATED | "emaj_phil's schema3"                              |                                                            | postgres
 ASSIGN_TABLE     | TABLE ADDED        | "phil's schema3"."myTbl2\"                         | To the idle group myGroup5                                 | postgres
 ASSIGN_TABLE     | END                |                                                    | 1 tables assigned to the group myGroup5                    | postgres
 REMOVE_TABLE     | BEGIN              |                                                    |                                                            | postgres
 REMOVE_TABLE     | TABLE REMOVED      | myschema1.mytbl1                                   | From the idle group myGroup1                               | postgres
 REMOVE_TABLE     | END                |                                                    | 1 tables removed from their groups                         | postgres
 REMOVE_TABLES    | BEGIN              |                                                    |                                                            | postgres
 REMOVE_TABLES    | END                |                                                    | 0 tables removed from their groups                         | postgres
 REMOVE_TABLES    | BEGIN              |                                                    |                                                            | postgres
 REMOVE_TABLES    | END                |                                                    | 0 tables removed from their groups                         | postgres
 REMOVE_TABLES    | BEGIN              |                                                    |                                                            | postgres
 REMOVE_TABLES    | END                |                                                    | 0 tables removed from their groups                         | postgres
 REMOVE_TABLES    | BEGIN              |                                                    |                                                            | postgres
 REMOVE_TABLES    | TABLE REMOVED      | myschema1.mytbl2                                   | From the idle group myGroup1                               | postgres
 REMOVE_TABLES    | TABLE REMOVED      | myschema1.mytbl2b                                  | From the idle group myGroup1                               | postgres
 REMOVE_TABLES    | END                |                                                    | 2 tables removed from their groups                         | postgres
 REMOVE_TABLES    | BEGIN              |                                                    |                                                            | postgres
 REMOVE_TABLES    | END                |                                                    | 0 tables removed from their groups                         | postgres
 REMOVE_TABLES    | BEGIN              |                                                    |                                                            | postgres
 REMOVE_TABLES    | END                |                                                    | 0 tables removed from their groups                         | postgres
 REMOVE_TABLES    | BEGIN              |                                                    |                                                            | postgres
 REMOVE_TABLES    | END                |                                                    | 0 tables removed from their groups                         | postgres
 REMOVE_TABLES    | BEGIN              |                                                    |                                                            | postgres
 REMOVE_TABLES    | TABLE REMOVED      | myschema1."myTbl3"                                 | From the idle group myGroup1                               | postgres
 REMOVE_TABLES    | TABLE REMOVED      | myschema1.mytbl4                                   | From the idle group myGroup1                               | postgres
 REMOVE_TABLES    | LOG_SCHEMA DROPPED | emaj_myschema1                                     |                                                            | postgres
 REMOVE_TABLES    | END                |                                                    | 2 tables removed from their groups                         | postgres
 REMOVE_SEQUENCE  | BEGIN              |                                                    |                                                            | postgres
 REMOVE_SEQUENCE  | SEQUENCE REMOVED   | myschema2.myseq1                                   | From the idle group myGroup2                               | postgres
 REMOVE_SEQUENCE  | END                |                                                    | 1 sequences removed from their groups                      | postgres
 REMOVE_SEQUENCES | BEGIN              |                                                    |                                                            | postgres
 REMOVE_SEQUENCES | END                |                                                    | 0 sequences removed from their groups                      | postgres
 REMOVE_SEQUENCES | BEGIN              |                                                    |                                                            | postgres
 REMOVE_SEQUENCES | END                |                                                    | 0 sequences removed from their groups                      | postgres
 REMOVE_SEQUENCES | BEGIN              |                                                    |                                                            | postgres
 REMOVE_SEQUENCES | END                |                                                    | 0 sequences removed from their groups                      | postgres
 ASSIGN_SEQUENCE  | BEGIN              |                                                    |                                                            | postgres
 ASSIGN_SEQUENCE  | SEQUENCE ADDED     | myschema2.myseq2                                   | To the idle group myGroup2                                 | postgres
 ASSIGN_SEQUENCE  | END                |                                                    | 1 sequences assigned to the group myGroup2                 | postgres
 REMOVE_SEQUENCES | BEGIN              |                                                    |                                                            | postgres
 REMOVE_SEQUENCES | SEQUENCE REMOVED   | myschema2.myseq2                                   | From the idle group myGroup2                               | postgres
 REMOVE_SEQUENCES | END                |                                                    | 1 sequences removed from their groups                      | postgres
 REMOVE_SEQUENCES | BEGIN              |                                                    |                                                            | postgres
 REMOVE_SEQUENCES | END                |                                                    | 0 sequences removed from their groups                      | postgres
 REMOVE_SEQUENCES | BEGIN              |                                                    |                                                            | postgres
 REMOVE_SEQUENCES | END                |                                                    | 0 sequences removed from their groups                      | postgres
 REMOVE_SEQUENCES | BEGIN              |                                                    |                                                            | postgres
 REMOVE_SEQUENCES | END                |                                                    | 0 sequences removed from their groups                      | postgres
 REMOVE_SEQUENCES | BEGIN              |                                                    |                                                            | postgres
 REMOVE_SEQUENCES | SEQUENCE REMOVED   | myschema2."myTbl3_col31_seq"                       | From the idle group myGroup2                               | postgres
 REMOVE_SEQUENCES | END                |                                                    | 1 sequences removed from their groups                      | postgres
 IMPORT_GROUPS    | BEGIN              | myGroup1, myGroup2, emptyGroup, myGroup4           | Input file: '/tmp/emaj_11/alter/../all_groups_config.json' | postgres
 IMPORT_GROUPS    | LOG_SCHEMA CREATED | emaj_myschema1                                     |                                                            | postgres
 IMPORT_GROUPS    | TABLE ADDED        | myschema1."myTbl3"                                 | To the idle group myGroup1                                 | postgres
 IMPORT_GROUPS    | TABLE ADDED        | myschema1.mytbl1                                   | To the idle group myGroup1                                 | postgres
 IMPORT_GROUPS    | TABLE ADDED        | myschema1.mytbl4                                   | To the idle group myGroup1                                 | postgres
 IMPORT_GROUPS    | TABLE ADDED        | myschema1.mytbl2                                   | To the idle group myGroup1                                 | postgres
 IMPORT_GROUPS    | TABLE ADDED        | myschema1.mytbl2b                                  | To the idle group myGroup1                                 | postgres
 IMPORT_GROUPS    | SEQUENCE ADDED     | myschema2."myTbl3_col31_seq"                       | To the idle group myGroup2                                 | postgres
 IMPORT_GROUPS    | SEQUENCE ADDED     | myschema2.myseq1                                   | To the idle group myGroup2                                 | postgres
 IMPORT_GROUPS    | END                |                                                    | 4 created or altered tables groups                         | postgres
(134 rows)

-- set sequence restart value
select public.handle_emaj_sequences(8200);
 handle_emaj_sequences 
-----------------------
 
(1 row)

-----------------------------------
-- emaj_move_table
-----------------------------------
-- error cases
-- table not in a group
select emaj.emaj_move_table('dummySchema','mytbl1','myGroup2');
ERROR:  _move_tables: some tables ("dummySchema".mytbl1) do not currently belong to any tables group.
CONTEXT:  PL/pgSQL function emaj._move_tables(text,text[],text,text,boolean,boolean) line 58 at RAISE
PL/pgSQL function emaj.emaj_move_table(text,text,text,text) line 6 at RETURN
select emaj.emaj_move_table('myschema1','dummyTable','myGroup2');
ERROR:  _move_tables: some tables (myschema1."dummyTable") do not currently belong to any tables group.
CONTEXT:  PL/pgSQL function emaj._move_tables(text,text[],text,text,boolean,boolean) line 58 at RAISE
PL/pgSQL function emaj.emaj_move_table(text,text,text,text) line 6 at RETURN
-- bad new group
select emaj.emaj_move_table('myschema1','mytbl1','dummyGroup');
ERROR:  _check_group_names: The group "dummyGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,boolean,boolean,boolean,boolean) line 42 at RAISE
SQL statement "SELECT emaj._check_group_names(p_groupNames := ARRAY[p_newGroup], p_mayBeNull := FALSE, p_lockGroups := TRUE)"
PL/pgSQL function emaj._move_tables(text,text[],text,text,boolean,boolean) line 28 at PERFORM
PL/pgSQL function emaj.emaj_move_table(text,text,text,text) line 6 at RETURN
-- bad mark
select emaj.emaj_move_table('myschema1','mytbl1','myGroup2','EMAJ_LAST_MARK');
ERROR:  _check_new_mark: "EMAJ_LAST_MARK" is not an allowed name for a new mark.
CONTEXT:  PL/pgSQL function emaj._check_new_mark(text[],text) line 14 at RAISE
SQL statement "SELECT emaj._check_new_mark(v_loggingGroups, p_mark)"
PL/pgSQL function emaj._move_tables(text,text[],text,text,boolean,boolean) line 99 at SQL statement
PL/pgSQL function emaj.emaj_move_table(text,text,text,text) line 6 at RETURN
-- bad table type for target rollbackable group
select emaj.emaj_move_table('myschema5', 'myunloggedtbl', 'myGroup1');
ERROR:  _move_tables: In schema myschema5, some tables (myunloggedtbl) are UNLOGGED tables.
CONTEXT:  PL/pgSQL function emaj._check_tables_for_rollbackable_group(text,text[],boolean,text) line 49 at RAISE
PL/pgSQL function emaj._move_tables(text,text[],text,text,boolean,boolean) line 96 at assignment
PL/pgSQL function emaj.emaj_move_table(text,text,text,text) line 6 at RETURN
select emaj.emaj_move_table('phil''s schema3', 'myTbl2\', 'myGroup1');
ERROR:  _move_tables: In schema "phil's schema3", some tables ("myTbl2\") have no PRIMARY KEY.
CONTEXT:  PL/pgSQL function emaj._check_tables_for_rollbackable_group(text,text[],boolean,text) line 27 at RAISE
PL/pgSQL function emaj._move_tables(text,text[],text,text,boolean,boolean) line 96 at assignment
PL/pgSQL function emaj.emaj_move_table(text,text,text,text) line 6 at RETURN
-- move to the same group
select emaj.emaj_move_table('myschema1','mytbl1','myGroup1');
WARNING:  _move_tables: some tables (myschema1.mytbl1) already belong to the tables group myGroup1.
WARNING:  _move_tables: No table to process.
 emaj_move_table 
-----------------
               0
(1 row)

-- ok
select emaj.emaj_move_table('myschema1','mytbl1','myGroup2');
 emaj_move_table 
-----------------
               1
(1 row)

-----------------------------------
-- emaj_move_tables with array
-----------------------------------
-- error cases
-- table not in a group
select emaj.emaj_move_tables('myschema1',array['dummyTable','mytbl1','mytbl2'],'myGroup1');
ERROR:  _move_tables: some tables (myschema1."dummyTable") do not currently belong to any tables group.
CONTEXT:  PL/pgSQL function emaj._move_tables(text,text[],text,text,boolean,boolean) line 58 at RAISE
PL/pgSQL function emaj.emaj_move_tables(text,text[],text,text) line 6 at RETURN
-- empty tables array
select emaj.emaj_move_tables('myschema1',array[]::text[],'myGroup1');
WARNING:  _move_tables: No table to process.
 emaj_move_tables 
------------------
                0
(1 row)

select emaj.emaj_move_tables('myschema1',null,'myGroup1');
WARNING:  _move_tables: No table to process.
 emaj_move_tables 
------------------
                0
(1 row)

select emaj.emaj_move_tables('myschema1',array[''],'myGroup1');
WARNING:  _move_tables: No table to process.
 emaj_move_tables 
------------------
                0
(1 row)

-- bad table type for target rollbackable group
select emaj.emaj_move_tables('myschema5', array['myunloggedtbl'], 'myGroup1');
ERROR:  _move_tables: In schema myschema5, some tables (myunloggedtbl) are UNLOGGED tables.
CONTEXT:  PL/pgSQL function emaj._check_tables_for_rollbackable_group(text,text[],boolean,text) line 49 at RAISE
PL/pgSQL function emaj._move_tables(text,text[],text,text,boolean,boolean) line 96 at assignment
PL/pgSQL function emaj.emaj_move_tables(text,text[],text,text) line 6 at RETURN
-- move to the same group
select emaj.emaj_move_tables('myschema1',array['mytbl2','mytbl2b'],'myGroup1');
WARNING:  _move_tables: some tables (myschema1.mytbl2, myschema1.mytbl2b) already belong to the tables group myGroup1.
WARNING:  _move_tables: No table to process.
 emaj_move_tables 
------------------
                0
(1 row)

-- ok (with a duplicate table name)
select emaj.emaj_move_tables('myschema1',array['mytbl2','mytbl2b','mytbl2'],'myGroup2');
 emaj_move_tables 
------------------
                2
(1 row)

select rel_schema, rel_tblseq, rel_group from emaj.emaj_relation
  where rel_schema = 'myschema1' and rel_kind = 'r' and upper_inf(rel_time_range)
  order by 1,2,3;
 rel_schema | rel_tblseq | rel_group 
------------+------------+-----------
 myschema1  | myTbl3     | myGroup1
 myschema1  | mytbl1     | myGroup2
 myschema1  | mytbl2     | myGroup2
 myschema1  | mytbl2b    | myGroup2
 myschema1  | mytbl4     | myGroup1
(5 rows)

-----------------------------------
-- emaj_move_tables with filters
-----------------------------------
-- empty tables array
select emaj.emaj_move_tables('myschema1',null,null,'myGroup1');
WARNING:  _move_tables: No table to process.
 emaj_move_tables 
------------------
                0
(1 row)

select emaj.emaj_move_tables('myschema1','','','myGroup1');
WARNING:  _move_tables: No table to process.
 emaj_move_tables 
------------------
                0
(1 row)

select emaj.emaj_move_tables('myschema1','mytbl1','mytbl1','myGroup1');
WARNING:  _move_tables: No table to process.
 emaj_move_tables 
------------------
                0
(1 row)

-- ok and go back to myGroup1
select emaj.emaj_move_tables('myschema1','my(t|T)bl.*','mytbl2$','myGroup1');
 emaj_move_tables 
------------------
                2
(1 row)

select emaj.emaj_move_tables('myschema1','.*','','myGroup1');
 emaj_move_tables 
------------------
                1
(1 row)

-- bad table type for target rollbackable group
select emaj.emaj_move_tables('myschema5', '.*', 'oids', 'myGroup1');     -- to exclude 'myoidstbl'
WARNING:  _move_tables: Some UNLOGGED tables (myunloggedtbl) are not selected.
WARNING:  _move_tables: No table to process.
 emaj_move_tables 
------------------
                0
(1 row)

select emaj.emaj_move_tables('phil''s schema3', 'bl2', '', 'myGroup1');  -- to select 'mytbl2\'
WARNING:  _move_tables: Some tables without PRIMARY KEY ("myTbl2\") are not selected.
WARNING:  _move_tables: No table to process.
 emaj_move_tables 
------------------
                0
(1 row)

select * from emaj.emaj_relation_change where rlchg_time_id > 8000 order by 1 desc,2,3,4 limit 6;
 rlchg_time_id | rlchg_schema | rlchg_tblseq | rlchg_change_kind | rlchg_group | rlchg_new_schema | rlchg_new_tblseq | rlchg_new_group | rlchg_priority | rlchg_new_priority | rlchg_log_data_tsp | rlchg_new_log_data_tsp | rlchg_log_index_tsp | rlchg_new_log_index_tsp | rlchg_ignored_triggers | rlchg_new_ignored_triggers | rlchg_rlbk_id 
---------------+--------------+--------------+-------------------+-------------+------------------+------------------+-----------------+----------------+--------------------+--------------------+------------------------+---------------------+-------------------------+------------------------+----------------------------+---------------
          8203 | myschema1    | mytbl2       | MOVE_TABLE        | myGroup2    |                  |                  | myGroup1        |                |                    |                    |                        |                     |                         |                        |                            |              
          8202 | myschema1    | mytbl1       | MOVE_TABLE        | myGroup2    |                  |                  | myGroup1        |                |                    |                    |                        |                     |                         |                        |                            |              
          8202 | myschema1    | mytbl2b      | MOVE_TABLE        | myGroup2    |                  |                  | myGroup1        |                |                    |                    |                        |                     |                         |                        |                            |              
          8201 | myschema1    | mytbl2       | MOVE_TABLE        | myGroup1    |                  |                  | myGroup2        |                |                    |                    |                        |                     |                         |                        |                            |              
          8201 | myschema1    | mytbl2b      | MOVE_TABLE        | myGroup1    |                  |                  | myGroup2        |                |                    |                    |                        |                     |                         |                        |                            |              
          8200 | myschema1    | mytbl1       | MOVE_TABLE        | myGroup1    |                  |                  | myGroup2        |                |                    |                    |                        |                     |                         |                        |                            |              
(6 rows)

select group_last_alter_time_id, group_nb_table, group_nb_sequence from emaj.emaj_group 
  where group_name in ('myGroup1','myGroup2') order by 1 desc ,2,3;
 group_last_alter_time_id | group_nb_table | group_nb_sequence 
--------------------------+----------------+-------------------
                     8203 |              5 |                 2
                     8203 |              8 |                 2
(2 rows)

-----------------------------------
-- emaj_move_sequence
-----------------------------------
-- error cases
-- sequence not in a group
select emaj.emaj_move_sequence('dummySchema','myseq1','myGroup1');
ERROR:  _move_sequences: some sequences ("dummySchema".myseq1) do not currently belong to any tables group.
CONTEXT:  PL/pgSQL function emaj._move_sequences(text,text[],text,text,boolean,boolean) line 56 at RAISE
PL/pgSQL function emaj.emaj_move_sequence(text,text,text,text) line 6 at RETURN
select emaj.emaj_move_sequence('myschema2','dummySequence','myGroup1');
ERROR:  _move_sequences: some sequences (myschema2."dummySequence") do not currently belong to any tables group.
CONTEXT:  PL/pgSQL function emaj._move_sequences(text,text[],text,text,boolean,boolean) line 56 at RAISE
PL/pgSQL function emaj.emaj_move_sequence(text,text,text,text) line 6 at RETURN
-- bad new group
select emaj.emaj_move_sequence('myschema2','myseq1','dummyGroup');
ERROR:  _check_group_names: The group "dummyGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj._check_group_names(text[],boolean,boolean,boolean,boolean,boolean,boolean) line 42 at RAISE
SQL statement "SELECT emaj._check_group_names(p_groupNames := ARRAY[p_newGroup], p_mayBeNull := FALSE, p_lockGroups := TRUE)"
PL/pgSQL function emaj._move_sequences(text,text[],text,text,boolean,boolean) line 26 at PERFORM
PL/pgSQL function emaj.emaj_move_sequence(text,text,text,text) line 6 at RETURN
-- bad mark
select emaj.emaj_move_sequence('myschema2','myseq1','myGroup1','EMAJ_LAST_MARK');
ERROR:  _check_new_mark: "EMAJ_LAST_MARK" is not an allowed name for a new mark.
CONTEXT:  PL/pgSQL function emaj._check_new_mark(text[],text) line 14 at RAISE
SQL statement "SELECT emaj._check_new_mark(v_loggingGroups, p_mark)"
PL/pgSQL function emaj._move_sequences(text,text[],text,text,boolean,boolean) line 94 at SQL statement
PL/pgSQL function emaj.emaj_move_sequence(text,text,text,text) line 6 at RETURN
-- move to the same group
select emaj.emaj_move_sequence('myschema2','myseq1','myGroup2');
WARNING:  _move_sequences: some sequences (myschema2.myseq1) already belong to the tables group myGroup2.
WARNING:  _move_sequences: No sequence to process.
 emaj_move_sequence 
--------------------
                  0
(1 row)

-- ok
select emaj.emaj_move_sequence('myschema2','myseq1','myGroup1');
 emaj_move_sequence 
--------------------
                  1
(1 row)

-----------------------------------
-- emaj_move_sequences with array
-----------------------------------
-- error cases
-- sequence not in a group
select emaj.emaj_move_sequences('myschema2',array['dummySequence','myseq1'],'myGroup1');
ERROR:  _move_sequences: some sequences (myschema2."dummySequence") do not currently belong to any tables group.
CONTEXT:  PL/pgSQL function emaj._move_sequences(text,text[],text,text,boolean,boolean) line 56 at RAISE
PL/pgSQL function emaj.emaj_move_sequences(text,text[],text,text) line 6 at RETURN
-- empty tables array
select emaj.emaj_move_sequences('myschema2',array[]::text[],'myGroup1');
WARNING:  _move_sequences: No sequence to process.
 emaj_move_sequences 
---------------------
                   0
(1 row)

select emaj.emaj_move_sequences('myschema2',null,'myGroup1');
WARNING:  _move_sequences: No sequence to process.
 emaj_move_sequences 
---------------------
                   0
(1 row)

select emaj.emaj_move_sequences('myschema2',array[''],'myGroup1');
WARNING:  _move_sequences: No sequence to process.
 emaj_move_sequences 
---------------------
                   0
(1 row)

-- move to the same group
select emaj.emaj_move_sequences('myschema2',array['myseq1','myTbl3_col31_seq'],'myGroup2');
WARNING:  _move_sequences: some sequences (myschema2."myTbl3_col31_seq") already belong to the tables group myGroup2.
 emaj_move_sequences 
---------------------
                   1
(1 row)

select emaj.emaj_move_sequences('myschema2',array['myseq1','myTbl3_col31_seq'],'myGroup2');
WARNING:  _move_sequences: some sequences (myschema2."myTbl3_col31_seq", myschema2.myseq1) already belong to the tables group myGroup2.
WARNING:  _move_sequences: No sequence to process.
 emaj_move_sequences 
---------------------
                   0
(1 row)

-- ok (with a duplicate sequence name)
select emaj.emaj_move_sequences('myschema2',array['myseq1','myseq1'],'myGroup4');
 emaj_move_sequences 
---------------------
                   1
(1 row)

select rel_schema, rel_tblseq, rel_group from emaj.emaj_relation
  where rel_schema = 'myschema2' and rel_kind = 'S' and upper_inf(rel_time_range)
  order by 1,2,3;
 rel_schema |    rel_tblseq    | rel_group 
------------+------------------+-----------
 myschema2  | myTbl3_col31_seq | myGroup2
 myschema2  | myseq1           | myGroup4
(2 rows)

-----------------------------------
-- emaj_move_sequences with filters
-----------------------------------
-- empty sequences array
select emaj.emaj_move_sequences('myschema21',null,null,'myGroup2');
WARNING:  _move_sequences: No sequence to process.
 emaj_move_sequences 
---------------------
                   0
(1 row)

select emaj.emaj_move_sequences('myschema21','','','myGroup2');
WARNING:  _move_sequences: No sequence to process.
 emaj_move_sequences 
---------------------
                   0
(1 row)

select emaj.emaj_move_sequences('myschema21','myseq1','myseq1','myGroup2');
WARNING:  _move_sequences: No sequence to process.
 emaj_move_sequences 
---------------------
                   0
(1 row)

-- ok and go back to myGroup2
select emaj.emaj_move_sequences('myschema2','.*','','myGroup2');
 emaj_move_sequences 
---------------------
                   1
(1 row)

select * from emaj.emaj_relation_change where rlchg_time_id > 8000 order by 1 desc,2,3,4 limit 3;
 rlchg_time_id | rlchg_schema | rlchg_tblseq | rlchg_change_kind | rlchg_group | rlchg_new_schema | rlchg_new_tblseq | rlchg_new_group | rlchg_priority | rlchg_new_priority | rlchg_log_data_tsp | rlchg_new_log_data_tsp | rlchg_log_index_tsp | rlchg_new_log_index_tsp | rlchg_ignored_triggers | rlchg_new_ignored_triggers | rlchg_rlbk_id 
---------------+--------------+--------------+-------------------+-------------+------------------+------------------+-----------------+----------------+--------------------+--------------------+------------------------+---------------------+-------------------------+------------------------+----------------------------+---------------
          8207 | myschema2    | myseq1       | MOVE_SEQUENCE     | myGroup4    |                  |                  | myGroup2        |                |                    |                    |                        |                     |                         |                        |                            |              
          8206 | myschema2    | myseq1       | MOVE_SEQUENCE     | myGroup2    |                  |                  | myGroup4        |                |                    |                    |                        |                     |                         |                        |                            |              
          8205 | myschema2    | myseq1       | MOVE_SEQUENCE     | myGroup1    |                  |                  | myGroup2        |                |                    |                    |                        |                     |                         |                        |                            |              
(3 rows)

select group_last_alter_time_id, group_nb_table, group_nb_sequence from emaj.emaj_group 
  where group_name in ('myGroup1','myGroup2','myGroup4') order by 1 desc ,2,3;
 group_last_alter_time_id | group_nb_table | group_nb_sequence 
--------------------------+----------------+-------------------
                     8207 |              5 |                 0
                     8207 |              8 |                 2
                     8205 |              5 |                 2
(3 rows)

-- check for emaj_move_table() and emaj_move_sequence() functions family
select * from emaj.emaj_relation_change where rlchg_time_id >= 8200 order by 1,2,3,4;
 rlchg_time_id | rlchg_schema | rlchg_tblseq | rlchg_change_kind | rlchg_group | rlchg_new_schema | rlchg_new_tblseq | rlchg_new_group | rlchg_priority | rlchg_new_priority | rlchg_log_data_tsp | rlchg_new_log_data_tsp | rlchg_log_index_tsp | rlchg_new_log_index_tsp | rlchg_ignored_triggers | rlchg_new_ignored_triggers | rlchg_rlbk_id 
---------------+--------------+--------------+-------------------+-------------+------------------+------------------+-----------------+----------------+--------------------+--------------------+------------------------+---------------------+-------------------------+------------------------+----------------------------+---------------
          8200 | myschema1    | mytbl1       | MOVE_TABLE        | myGroup1    |                  |                  | myGroup2        |                |                    |                    |                        |                     |                         |                        |                            |              
          8201 | myschema1    | mytbl2       | MOVE_TABLE        | myGroup1    |                  |                  | myGroup2        |                |                    |                    |                        |                     |                         |                        |                            |              
          8201 | myschema1    | mytbl2b      | MOVE_TABLE        | myGroup1    |                  |                  | myGroup2        |                |                    |                    |                        |                     |                         |                        |                            |              
          8202 | myschema1    | mytbl1       | MOVE_TABLE        | myGroup2    |                  |                  | myGroup1        |                |                    |                    |                        |                     |                         |                        |                            |              
          8202 | myschema1    | mytbl2b      | MOVE_TABLE        | myGroup2    |                  |                  | myGroup1        |                |                    |                    |                        |                     |                         |                        |                            |              
          8203 | myschema1    | mytbl2       | MOVE_TABLE        | myGroup2    |                  |                  | myGroup1        |                |                    |                    |                        |                     |                         |                        |                            |              
          8204 | myschema2    | myseq1       | MOVE_SEQUENCE     | myGroup2    |                  |                  | myGroup1        |                |                    |                    |                        |                     |                         |                        |                            |              
          8205 | myschema2    | myseq1       | MOVE_SEQUENCE     | myGroup1    |                  |                  | myGroup2        |                |                    |                    |                        |                     |                         |                        |                            |              
          8206 | myschema2    | myseq1       | MOVE_SEQUENCE     | myGroup2    |                  |                  | myGroup4        |                |                    |                    |                        |                     |                         |                        |                            |              
          8207 | myschema2    | myseq1       | MOVE_SEQUENCE     | myGroup4    |                  |                  | myGroup2        |                |                    |                    |                        |                     |                         |                        |                            |              
(10 rows)

select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 8200 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
    8200 |            8200000 | A
    8201 |            8200000 | A
    8202 |            8200000 | A
    8203 |            8200000 | A
    8204 |            8200000 | A
    8205 |            8200000 | A
    8206 |            8200000 | A
    8207 |            8200000 | A
(8 rows)

select hist_function, hist_event, hist_object,
       regexp_replace(regexp_replace(regexp_replace(hist_wording,
            E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),
            E'\\d\\d\\d\\d/\\d\\d\\/\\d\\d\\ \\d\\d\\:\\d\\d:\\d\\d .*?\\)','<timestamp>)','g'),
            E'\\[.+\\]','(timestamp)','g'), 
       hist_user 
  from emaj.emaj_hist where hist_id >= 8200 order by hist_id;
 hist_function  |   hist_event   |    hist_object    |                     regexp_replace                      | hist_user 
----------------+----------------+-------------------+---------------------------------------------------------+-----------
 MOVE_TABLE     | BEGIN          |                   |                                                         | postgres
 MOVE_TABLE     | END            |                   | 0 tables moved to the tables group myGroup1             | postgres
 MOVE_TABLE     | BEGIN          |                   |                                                         | postgres
 MOVE_TABLE     | TABLE MOVED    | myschema1.mytbl1  | From the idle group myGroup1 to the idle group myGroup2 | postgres
 MOVE_TABLE     | END            |                   | 1 tables moved to the tables group myGroup2             | postgres
 MOVE_TABLES    | BEGIN          |                   |                                                         | postgres
 MOVE_TABLES    | END            |                   | 0 tables moved to the tables group myGroup1             | postgres
 MOVE_TABLES    | BEGIN          |                   |                                                         | postgres
 MOVE_TABLES    | END            |                   | 0 tables moved to the tables group myGroup1             | postgres
 MOVE_TABLES    | BEGIN          |                   |                                                         | postgres
 MOVE_TABLES    | END            |                   | 0 tables moved to the tables group myGroup1             | postgres
 MOVE_TABLES    | BEGIN          |                   |                                                         | postgres
 MOVE_TABLES    | END            |                   | 0 tables moved to the tables group myGroup1             | postgres
 MOVE_TABLES    | BEGIN          |                   |                                                         | postgres
 MOVE_TABLES    | TABLE MOVED    | myschema1.mytbl2  | From the idle group myGroup1 to the idle group myGroup2 | postgres
 MOVE_TABLES    | TABLE MOVED    | myschema1.mytbl2b | From the idle group myGroup1 to the idle group myGroup2 | postgres
 MOVE_TABLES    | END            |                   | 2 tables moved to the tables group myGroup2             | postgres
 MOVE_TABLES    | BEGIN          |                   |                                                         | postgres
 MOVE_TABLES    | END            |                   | 0 tables moved to the tables group myGroup1             | postgres
 MOVE_TABLES    | BEGIN          |                   |                                                         | postgres
 MOVE_TABLES    | END            |                   | 0 tables moved to the tables group myGroup1             | postgres
 MOVE_TABLES    | BEGIN          |                   |                                                         | postgres
 MOVE_TABLES    | END            |                   | 0 tables moved to the tables group myGroup1             | postgres
 MOVE_TABLES    | BEGIN          |                   |                                                         | postgres
 MOVE_TABLES    | TABLE MOVED    | myschema1.mytbl1  | From the idle group myGroup2 to the idle group myGroup1 | postgres
 MOVE_TABLES    | TABLE MOVED    | myschema1.mytbl2b | From the idle group myGroup2 to the idle group myGroup1 | postgres
 MOVE_TABLES    | END            |                   | 2 tables moved to the tables group myGroup1             | postgres
 MOVE_TABLES    | BEGIN          |                   |                                                         | postgres
 MOVE_TABLES    | TABLE MOVED    | myschema1.mytbl2  | From the idle group myGroup2 to the idle group myGroup1 | postgres
 MOVE_TABLES    | END            |                   | 1 tables moved to the tables group myGroup1             | postgres
 MOVE_TABLES    | BEGIN          |                   |                                                         | postgres
 MOVE_TABLES    | END            |                   | 0 tables moved to the tables group myGroup1             | postgres
 MOVE_TABLES    | BEGIN          |                   |                                                         | postgres
 MOVE_TABLES    | END            |                   | 0 tables moved to the tables group myGroup1             | postgres
 MOVE_SEQUENCE  | BEGIN          |                   |                                                         | postgres
 MOVE_SEQUENCE  | END            |                   | 0 sequences moved to the tables group myGroup2          | postgres
 MOVE_SEQUENCE  | BEGIN          |                   |                                                         | postgres
 MOVE_SEQUENCE  | SEQUENCE MOVED | myschema2.myseq1  | From the idle group myGroup2 to the idle group myGroup1 | postgres
 MOVE_SEQUENCE  | END            |                   | 1 sequences moved to the tables group myGroup1          | postgres
 MOVE_SEQUENCES | BEGIN          |                   |                                                         | postgres
 MOVE_SEQUENCES | END            |                   | 0 sequences moved to the tables group myGroup1          | postgres
 MOVE_SEQUENCES | BEGIN          |                   |                                                         | postgres
 MOVE_SEQUENCES | END            |                   | 0 sequences moved to the tables group myGroup1          | postgres
 MOVE_SEQUENCES | BEGIN          |                   |                                                         | postgres
 MOVE_SEQUENCES | END            |                   | 0 sequences moved to the tables group myGroup1          | postgres
 MOVE_SEQUENCES | BEGIN          |                   |                                                         | postgres
 MOVE_SEQUENCES | SEQUENCE MOVED | myschema2.myseq1  | From the idle group myGroup1 to the idle group myGroup2 | postgres
 MOVE_SEQUENCES | END            |                   | 1 sequences moved to the tables group myGroup2          | postgres
 MOVE_SEQUENCES | BEGIN          |                   |                                                         | postgres
 MOVE_SEQUENCES | END            |                   | 0 sequences moved to the tables group myGroup2          | postgres
 MOVE_SEQUENCES | BEGIN          |                   |                                                         | postgres
 MOVE_SEQUENCES | SEQUENCE MOVED | myschema2.myseq1  | From the idle group myGroup2 to the idle group myGroup4 | postgres
 MOVE_SEQUENCES | END            |                   | 1 sequences moved to the tables group myGroup4          | postgres
 MOVE_SEQUENCES | BEGIN          |                   |                                                         | postgres
 MOVE_SEQUENCES | END            |                   | 0 sequences moved to the tables group myGroup2          | postgres
 MOVE_SEQUENCES | BEGIN          |                   |                                                         | postgres
 MOVE_SEQUENCES | END            |                   | 0 sequences moved to the tables group myGroup2          | postgres
 MOVE_SEQUENCES | BEGIN          |                   |                                                         | postgres
 MOVE_SEQUENCES | END            |                   | 0 sequences moved to the tables group myGroup2          | postgres
 MOVE_SEQUENCES | BEGIN          |                   |                                                         | postgres
 MOVE_SEQUENCES | SEQUENCE MOVED | myschema2.myseq1  | From the idle group myGroup4 to the idle group myGroup2 | postgres
 MOVE_SEQUENCES | END            |                   | 1 sequences moved to the tables group myGroup2          | postgres
(62 rows)

-- set sequence restart value
select public.handle_emaj_sequences(8400);
 handle_emaj_sequences 
-----------------------
 
(1 row)

-----------------------------------
-- emaj_modify_table
-----------------------------------
-- error cases
-- table not in a group
select emaj.emaj_modify_table('dummySchema','mytbl1',null);
ERROR:  _modify_tables: some tables ("dummySchema".mytbl1) do not currently belong to any tables group.
CONTEXT:  PL/pgSQL function emaj._modify_tables(text,text[],jsonb,text,boolean,boolean) line 60 at RAISE
PL/pgSQL function emaj.emaj_modify_table(text,text,jsonb,text) line 7 at RETURN
select emaj.emaj_modify_table('myschema1','dummyTable',null);
ERROR:  _modify_tables: some tables (myschema1."dummyTable") do not currently belong to any tables group.
CONTEXT:  PL/pgSQL function emaj._modify_tables(text,text[],jsonb,text,boolean,boolean) line 60 at RAISE
PL/pgSQL function emaj.emaj_modify_table(text,text,jsonb,text) line 7 at RETURN
-- invalid priority
select emaj.emaj_modify_table('myschema1','mytbl1','{"priority":"not_numeric"}'::jsonb);
ERROR:  _check_json_table_properties: the "priority" property must be numeric.
CONTEXT:  PL/pgSQL function emaj._check_json_table_properties(jsonb) line 18 at RAISE
SQL statement "SELECT *                                                                                                     FROM emaj._check_json_table_properties(p_changedProperties)"
PL/pgSQL function emaj._modify_tables(text,text[],jsonb,text,boolean,boolean) line 70 at SQL statement
PL/pgSQL function emaj.emaj_modify_table(text,text,jsonb,text) line 7 at RETURN
-- invalid tablespace
select emaj.emaj_modify_table('myschema1','mytbl1','{"log_data_tablespace":"dummytsp"}'::jsonb);
ERROR:  _check_json_table_properties: the log data tablespace "dummytsp" does not exists.
CONTEXT:  PL/pgSQL function emaj._check_json_table_properties(jsonb) line 30 at RAISE
SQL statement "SELECT *                                                                                                     FROM emaj._check_json_table_properties(p_changedProperties)"
PL/pgSQL function emaj._modify_tables(text,text[],jsonb,text,boolean,boolean) line 70 at SQL statement
PL/pgSQL function emaj.emaj_modify_table(text,text,jsonb,text) line 7 at RETURN
select emaj.emaj_modify_table('myschema1','mytbl1','{"log_index_tablespace":"dummytsp"}'::jsonb);
ERROR:  _check_json_table_properties: the log index tablespace "dummytsp" does not exists.
CONTEXT:  PL/pgSQL function emaj._check_json_table_properties(jsonb) line 44 at RAISE
SQL statement "SELECT *                                                                                                     FROM emaj._check_json_table_properties(p_changedProperties)"
PL/pgSQL function emaj._modify_tables(text,text[],jsonb,text,boolean,boolean) line 70 at SQL statement
PL/pgSQL function emaj.emaj_modify_table(text,text,jsonb,text) line 7 at RETURN
-- unknown property
select emaj.emaj_modify_table('myschema1','mytbl1','{"unknown_property":null}'::jsonb);
ERROR:  _check_json_table_properties: properties "{"unknown_property": null}" are unknown.
CONTEXT:  PL/pgSQL function emaj._check_json_table_properties(jsonb) line 92 at RAISE
SQL statement "SELECT *                                                                                                     FROM emaj._check_json_table_properties(p_changedProperties)"
PL/pgSQL function emaj._modify_tables(text,text[],jsonb,text,boolean,boolean) line 70 at SQL statement
PL/pgSQL function emaj.emaj_modify_table(text,text,jsonb,text) line 7 at RETURN
-- bad mark
select emaj.emaj_modify_table('myschema1','mytbl1',null,'EMAJ_LAST_MARK');
ERROR:  _check_new_mark: "EMAJ_LAST_MARK" is not an allowed name for a new mark.
CONTEXT:  PL/pgSQL function emaj._check_new_mark(text[],text) line 14 at RAISE
SQL statement "SELECT emaj._check_new_mark(v_loggingGroups, p_mark)"
PL/pgSQL function emaj._modify_tables(text,text[],jsonb,text,boolean,boolean) line 93 at SQL statement
PL/pgSQL function emaj.emaj_modify_table(text,text,jsonb,text) line 7 at RETURN
-- ok
-- no property
select emaj.emaj_modify_table('myschema1','mytbl2',NULL);
WARNING:  _modified_tables: No property change to process.
 emaj_modify_table 
-------------------
                 0
(1 row)

select emaj.emaj_modify_table('myschema1','mytbl2','{ }');
WARNING:  _modified_tables: No property change to process.
 emaj_modify_table 
-------------------
                 0
(1 row)

-- change a priority
select emaj.emaj_modify_table('myschema1','mytbl2','{"priority":1}');
 emaj_modify_table 
-------------------
                 1
(1 row)

-- change a log data tablespace
select emaj.emaj_modify_table('myschema1','mytbl1','{"log_data_tablespace":"tsp log''2"}');
 emaj_modify_table 
-------------------
                 1
(1 row)

-- change a log index tablespace
select emaj.emaj_modify_table('myschema1','mytbl1','{"log_index_tablespace":"tsp log''2"}');
 emaj_modify_table 
-------------------
                 1
(1 row)

-- change a triggers list, by adding 1 trigger
select emaj.emaj_modify_table('myschema1','mytbl2','{"ignored_triggers":["mytbl2trg1"]}');
 emaj_modify_table 
-------------------
                 1
(1 row)

select rel_schema, rel_tblseq, rel_time_range, rel_ignored_triggers from emaj.emaj_relation where rel_ignored_triggers is not null order by 1,2,3;
 rel_schema | rel_tblseq | rel_time_range | rel_ignored_triggers 
------------+------------+----------------+----------------------
 myschema1  | mytbl2     | [8203,)        | {mytbl2trg1}
(1 row)

-- add the same
select emaj.emaj_modify_table('myschema1','mytbl2','{"ignored_triggers":["mytbl2trg1"]}');
 emaj_modify_table 
-------------------
                 0
(1 row)

-- add all triggers for a table
select emaj.emaj_modify_table('myschema1','mytbl2','{"ignored_triggers_profiles":[".*"]}');
 emaj_modify_table 
-------------------
                 1
(1 row)

select rel_schema, rel_tblseq, rel_time_range, rel_ignored_triggers from emaj.emaj_relation where rel_ignored_triggers is not null order by 1,2,3;
 rel_schema | rel_tblseq | rel_time_range |  rel_ignored_triggers   
------------+------------+----------------+-------------------------
 myschema1  | mytbl2     | [8203,)        | {mytbl2trg1,mytbl2trg2}
(1 row)

select rel_schema, rel_tblseq, rel_time_range, rel_priority from emaj.emaj_relation
  where rel_schema = 'myschema1' and rel_tblseq = 'mytbl2' order by 3 desc ,1,2 limit 2;
 rel_schema | rel_tblseq | rel_time_range | rel_priority 
------------+------------+----------------+--------------
 myschema1  | mytbl2     | [8203,)        |            1
 myschema1  | mytbl2     | [8201,8203)    |             
(2 rows)

select rel_schema, rel_tblseq, rel_time_range, rel_log_dat_tsp, rel_log_idx_tsp from emaj.emaj_relation
  where rel_schema = 'myschema1' and rel_tblseq = 'mytbl1' order by 3 desc ,1,2 limit 2;
 rel_schema | rel_tblseq | rel_time_range | rel_log_dat_tsp | rel_log_idx_tsp 
------------+------------+----------------+-----------------+-----------------
 myschema1  | mytbl1     | [8202,)        | tsp log'2       | tsp log'2
 myschema1  | mytbl1     | [8200,8202)    |                 | 
(2 rows)

-- revert changes
select emaj.emaj_modify_table('myschema1','mytbl2','{"priority":null}');
 emaj_modify_table 
-------------------
                 1
(1 row)

select emaj.emaj_modify_table('myschema1','mytbl1','{"log_data_tablespace":null, "log_index_tablespace":null}');
 emaj_modify_table 
-------------------
                 1
(1 row)

select emaj.emaj_modify_table('myschema1','mytbl2','{"ignored_triggers":null}');
 emaj_modify_table 
-------------------
                 1
(1 row)

select rel_schema, rel_tblseq, rel_time_range, rel_priority from emaj.emaj_relation
  where rel_schema = 'myschema1' and rel_tblseq = 'mytbl2' order by 3 desc ,1,2 limit 2;
 rel_schema | rel_tblseq | rel_time_range | rel_priority 
------------+------------+----------------+--------------
 myschema1  | mytbl2     | [8203,)        |             
 myschema1  | mytbl2     | [8201,8203)    |             
(2 rows)

select rel_schema, rel_tblseq, rel_time_range, rel_log_dat_tsp, rel_log_idx_tsp from emaj.emaj_relation
  where rel_schema = 'myschema1' and rel_tblseq = 'mytbl1' order by 3 desc ,1,2 limit 2;
 rel_schema | rel_tblseq | rel_time_range | rel_log_dat_tsp | rel_log_idx_tsp 
------------+------------+----------------+-----------------+-----------------
 myschema1  | mytbl1     | [8202,)        |                 | 
 myschema1  | mytbl1     | [8200,8202)    |                 | 
(2 rows)

-------------------------------------
---- emaj_modify_tables with array
-------------------------------------
-- error cases
-- table not in a group
select emaj.emaj_modify_tables('myschema2',array['dummyTable','mytbl1','mytbl2'],null);
ERROR:  _modify_tables: some tables (myschema2."dummyTable") do not currently belong to any tables group.
CONTEXT:  PL/pgSQL function emaj._modify_tables(text,text[],jsonb,text,boolean,boolean) line 60 at RAISE
PL/pgSQL function emaj.emaj_modify_tables(text,text[],jsonb,text) line 7 at RETURN
-- empty tables array
select emaj.emaj_modify_tables('myschema2',array[]::text[],null);
WARNING:  _modified_tables: No table to process.
 emaj_modify_tables 
--------------------
                  0
(1 row)

select emaj.emaj_modify_tables('myschema2',null,null);
WARNING:  _modified_tables: No table to process.
 emaj_modify_tables 
--------------------
                  0
(1 row)

select emaj.emaj_modify_tables('myschema2',array[''],null);
WARNING:  _modified_tables: No table to process.
 emaj_modify_tables 
--------------------
                  0
(1 row)

---- ok (with a duplicate table name)
select emaj.emaj_modify_tables('myschema2',array['mytbl1','mytbl2','mytbl2'],'{"priority":10,"log_data_tablespace":"tsplog1"}');
 emaj_modify_tables 
--------------------
                  2
(1 row)

select rel_schema, rel_tblseq, rel_time_range, rel_priority, rel_log_dat_tsp from emaj.emaj_relation
  where rel_schema = 'myschema2' and rel_tblseq in ('mytbl1','mytbl2') order by 1,2,3;
 rel_schema | rel_tblseq | rel_time_range | rel_priority | rel_log_dat_tsp 
------------+------------+----------------+--------------+-----------------
 myschema2  | mytbl1     | [8010,)        |           10 | tsplog1
 myschema2  | mytbl2     | [8010,)        |           10 | tsplog1
(2 rows)

-----------------------------------
-- emaj_modify_tables with filters
-----------------------------------
-- empty tables array
select emaj.emaj_modify_tables('myschema2',null,null,null::jsonb);
WARNING:  _modified_tables: No table to process.
 emaj_modify_tables 
--------------------
                  0
(1 row)

select emaj.emaj_modify_tables('myschema2','','',null::jsonb);
WARNING:  _modified_tables: No table to process.
 emaj_modify_tables 
--------------------
                  0
(1 row)

select emaj.emaj_modify_tables('myschema2','mytbl1','mytbl1',null::jsonb);
WARNING:  _modified_tables: No table to process.
 emaj_modify_tables 
--------------------
                  0
(1 row)

-- ok and revert the previous changes
select emaj.emaj_modify_tables('myschema2','mytbl.*','','{"priority":null,"log_data_tablespace":null}'::jsonb);
 emaj_modify_tables 
--------------------
                  2
(1 row)

select rel_schema, rel_tblseq, rel_time_range, rel_priority, rel_log_dat_tsp, rel_log_idx_tsp from emaj.emaj_relation
  where rel_schema = 'myschema2' and rel_tblseq like 'mytbl%' order by 1,2,3;
 rel_schema | rel_tblseq | rel_time_range | rel_priority | rel_log_dat_tsp | rel_log_idx_tsp 
------------+------------+----------------+--------------+-----------------+-----------------
 myschema2  | mytbl1     | [8010,)        |              |                 | 
 myschema2  | mytbl2     | [8010,)        |              |                 | 
 myschema2  | mytbl4     | [8010,)        |              |                 | 
 myschema2  | mytbl5     | [8010,)        |              |                 | 
 myschema2  | mytbl6     | [8010,)        |              |                 | 
 myschema2  | mytbl7     | [8010,)        |              |                 | 
 myschema2  | mytbl8     | [8010,)        |              |                 | 
(7 rows)

-- check for emaj_modify_table() functions family
select * from emaj.emaj_relation_change where rlchg_time_id >= 8400 order by 1,2,3,4;
 rlchg_time_id | rlchg_schema | rlchg_tblseq |      rlchg_change_kind      | rlchg_group | rlchg_new_schema | rlchg_new_tblseq | rlchg_new_group | rlchg_priority | rlchg_new_priority | rlchg_log_data_tsp | rlchg_new_log_data_tsp | rlchg_log_index_tsp | rlchg_new_log_index_tsp | rlchg_ignored_triggers  | rlchg_new_ignored_triggers | rlchg_rlbk_id 
---------------+--------------+--------------+-----------------------------+-------------+------------------+------------------+-----------------+----------------+--------------------+--------------------+------------------------+---------------------+-------------------------+-------------------------+----------------------------+---------------
          8400 | myschema1    | mytbl2       | CHANGE_PRIORITY             | myGroup1    |                  |                  |                 |                |                  1 |                    |                        |                     |                         |                         |                            |              
          8401 | myschema1    | mytbl1       | CHANGE_LOG_DATA_TABLESPACE  | myGroup1    |                  |                  |                 |                |                    |                    | tsp log'2              |                     |                         |                         |                            |              
          8402 | myschema1    | mytbl1       | CHANGE_LOG_INDEX_TABLESPACE | myGroup1    |                  |                  |                 |                |                    |                    |                        |                     | tsp log'2               |                         |                            |              
          8403 | myschema1    | mytbl2       | CHANGE_IGNORED_TRIGGERS     | myGroup1    |                  |                  |                 |                |                    |                    |                        |                     |                         |                         | {mytbl2trg1}               |              
          8405 | myschema1    | mytbl2       | CHANGE_IGNORED_TRIGGERS     | myGroup1    |                  |                  |                 |                |                    |                    |                        |                     |                         | {mytbl2trg1}            | {mytbl2trg1,mytbl2trg2}    |              
          8406 | myschema1    | mytbl2       | CHANGE_PRIORITY             | myGroup1    |                  |                  |                 |              1 |                    |                    |                        |                     |                         |                         |                            |              
          8407 | myschema1    | mytbl1       | CHANGE_LOG_DATA_TABLESPACE  | myGroup1    |                  |                  |                 |                |                    | tsp log'2          |                        |                     |                         |                         |                            |              
          8407 | myschema1    | mytbl1       | CHANGE_LOG_INDEX_TABLESPACE | myGroup1    |                  |                  |                 |                |                    |                    |                        | tsp log'2           |                         |                         |                            |              
          8408 | myschema1    | mytbl2       | CHANGE_IGNORED_TRIGGERS     | myGroup1    |                  |                  |                 |                |                    |                    |                        |                     |                         | {mytbl2trg1,mytbl2trg2} |                            |              
          8409 | myschema2    | mytbl1       | CHANGE_LOG_DATA_TABLESPACE  | myGroup2    |                  |                  |                 |                |                    |                    | tsplog1                |                     |                         |                         |                            |              
          8409 | myschema2    | mytbl1       | CHANGE_PRIORITY             | myGroup2    |                  |                  |                 |                |                 10 |                    |                        |                     |                         |                         |                            |              
          8409 | myschema2    | mytbl2       | CHANGE_LOG_DATA_TABLESPACE  | myGroup2    |                  |                  |                 |                |                    |                    | tsplog1                |                     |                         |                         |                            |              
          8409 | myschema2    | mytbl2       | CHANGE_PRIORITY             | myGroup2    |                  |                  |                 |                |                 10 |                    |                        |                     |                         |                         |                            |              
          8410 | myschema2    | mytbl1       | CHANGE_LOG_DATA_TABLESPACE  | myGroup2    |                  |                  |                 |                |                    | tsplog1            |                        |                     |                         |                         |                            |              
          8410 | myschema2    | mytbl1       | CHANGE_PRIORITY             | myGroup2    |                  |                  |                 |             10 |                    |                    |                        |                     |                         |                         |                            |              
          8410 | myschema2    | mytbl2       | CHANGE_LOG_DATA_TABLESPACE  | myGroup2    |                  |                  |                 |                |                    | tsplog1            |                        |                     |                         |                         |                            |              
          8410 | myschema2    | mytbl2       | CHANGE_PRIORITY             | myGroup2    |                  |                  |                 |             10 |                    |                    |                        |                     |                         |                         |                            |              
(17 rows)

select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 8400 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
    8400 |            8400000 | A
    8401 |            8400000 | A
    8402 |            8400000 | A
    8403 |            8400000 | A
    8404 |            8400000 | A
    8405 |            8400000 | A
    8406 |            8400000 | A
    8407 |            8400000 | A
    8408 |            8400000 | A
    8409 |            8400000 | A
    8410 |            8400000 | A
(11 rows)

select hist_function, hist_event, hist_object,
       regexp_replace(regexp_replace(regexp_replace(hist_wording,
            E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d\\d','%','g'),
            E'\\d\\d\\d\\d/\\d\\d\\/\\d\\d\\ \\d\\d\\:\\d\\d:\\d\\d .*?\\)','<timestamp>)','g'),
            E'\\[.+\\]','(timestamp)','g'), 
       hist_user 
  from emaj.emaj_hist where hist_id >= 8400 order by hist_id;
 hist_function |          hist_event          |   hist_object    |             regexp_replace              | hist_user 
---------------+------------------------------+------------------+-----------------------------------------+-----------
 MODIFY_TABLE  | BEGIN                        |                  |                                         | postgres
 MODIFY_TABLE  | END                          |                  | 0 tables effectively modified           | postgres
 MODIFY_TABLE  | BEGIN                        |                  |                                         | postgres
 MODIFY_TABLE  | END                          |                  | 0 tables effectively modified           | postgres
 MODIFY_TABLE  | BEGIN                        |                  |                                         | postgres
 MODIFY_TABLE  | PRIORITY CHANGED             | myschema1.mytbl2 | NULL => 1                               | postgres
 MODIFY_TABLE  | END                          |                  | 1 tables effectively modified           | postgres
 MODIFY_TABLE  | BEGIN                        |                  |                                         | postgres
 MODIFY_TABLE  | LOG DATA TABLESPACE CHANGED  | myschema1.mytbl1 | Default tablespace => tsp log'2         | postgres
 MODIFY_TABLE  | END                          |                  | 1 tables effectively modified           | postgres
 MODIFY_TABLE  | BEGIN                        |                  |                                         | postgres
 MODIFY_TABLE  | LOG INDEX TABLESPACE CHANGED | myschema1.mytbl1 | Default tablespace => tsp log'2         | postgres
 MODIFY_TABLE  | END                          |                  | 1 tables effectively modified           | postgres
 MODIFY_TABLE  | BEGIN                        |                  |                                         | postgres
 MODIFY_TABLE  | TRIGGERS TO IGNORE CHANGED   | myschema1.mytbl2 | none => {mytbl2trg1}                    | postgres
 MODIFY_TABLE  | END                          |                  | 1 tables effectively modified           | postgres
 MODIFY_TABLE  | BEGIN                        |                  |                                         | postgres
 MODIFY_TABLE  | END                          |                  | 0 tables effectively modified           | postgres
 MODIFY_TABLE  | BEGIN                        |                  |                                         | postgres
 MODIFY_TABLE  | TRIGGERS TO IGNORE CHANGED   | myschema1.mytbl2 | {mytbl2trg1} => {mytbl2trg1,mytbl2trg2} | postgres
 MODIFY_TABLE  | END                          |                  | 1 tables effectively modified           | postgres
 MODIFY_TABLE  | BEGIN                        |                  |                                         | postgres
 MODIFY_TABLE  | PRIORITY CHANGED             | myschema1.mytbl2 | 1 => NULL                               | postgres
 MODIFY_TABLE  | END                          |                  | 1 tables effectively modified           | postgres
 MODIFY_TABLE  | BEGIN                        |                  |                                         | postgres
 MODIFY_TABLE  | LOG DATA TABLESPACE CHANGED  | myschema1.mytbl1 | tsp log'2 => Default tablespace         | postgres
 MODIFY_TABLE  | LOG INDEX TABLESPACE CHANGED | myschema1.mytbl1 | tsp log'2 => Default tablespace         | postgres
 MODIFY_TABLE  | END                          |                  | 1 tables effectively modified           | postgres
 MODIFY_TABLE  | BEGIN                        |                  |                                         | postgres
 MODIFY_TABLE  | TRIGGERS TO IGNORE CHANGED   | myschema1.mytbl2 | {mytbl2trg1,mytbl2trg2} => none         | postgres
 MODIFY_TABLE  | END                          |                  | 1 tables effectively modified           | postgres
 MODIFY_TABLES | BEGIN                        |                  |                                         | postgres
 MODIFY_TABLES | END                          |                  | 0 tables effectively modified           | postgres
 MODIFY_TABLES | BEGIN                        |                  |                                         | postgres
 MODIFY_TABLES | END                          |                  | 0 tables effectively modified           | postgres
 MODIFY_TABLES | BEGIN                        |                  |                                         | postgres
 MODIFY_TABLES | END                          |                  | 0 tables effectively modified           | postgres
 MODIFY_TABLES | BEGIN                        |                  |                                         | postgres
 MODIFY_TABLES | PRIORITY CHANGED             | myschema2.mytbl1 | NULL => 10                              | postgres
 MODIFY_TABLES | LOG DATA TABLESPACE CHANGED  | myschema2.mytbl1 | Default tablespace => tsplog1           | postgres
 MODIFY_TABLES | PRIORITY CHANGED             | myschema2.mytbl2 | NULL => 10                              | postgres
 MODIFY_TABLES | LOG DATA TABLESPACE CHANGED  | myschema2.mytbl2 | Default tablespace => tsplog1           | postgres
 MODIFY_TABLES | END                          |                  | 2 tables effectively modified           | postgres
 MODIFY_TABLES | BEGIN                        |                  |                                         | postgres
 MODIFY_TABLES | END                          |                  | 0 tables effectively modified           | postgres
 MODIFY_TABLES | BEGIN                        |                  |                                         | postgres
 MODIFY_TABLES | END                          |                  | 0 tables effectively modified           | postgres
 MODIFY_TABLES | BEGIN                        |                  |                                         | postgres
 MODIFY_TABLES | END                          |                  | 0 tables effectively modified           | postgres
 MODIFY_TABLES | BEGIN                        |                  |                                         | postgres
 MODIFY_TABLES | PRIORITY CHANGED             | myschema2.mytbl1 | 10 => NULL                              | postgres
 MODIFY_TABLES | LOG DATA TABLESPACE CHANGED  | myschema2.mytbl1 | tsplog1 => Default tablespace           | postgres
 MODIFY_TABLES | PRIORITY CHANGED             | myschema2.mytbl2 | 10 => NULL                              | postgres
 MODIFY_TABLES | LOG DATA TABLESPACE CHANGED  | myschema2.mytbl2 | tsplog1 => Default tablespace           | postgres
 MODIFY_TABLES | END                          |                  | 2 tables effectively modified           | postgres
(55 rows)

-- remove the temp directory
\! rm -R $EMAJTESTTMPDIR
