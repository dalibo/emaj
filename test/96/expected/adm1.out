-- adm1.sql : complex scenario executed by an emaj_adm role
--            playing with both myGroup1 and myGroup2 tables groups
--
SET datestyle TO ymd;
-- set sequence restart value
truncate emaj.emaj_hist;
alter sequence emaj.emaj_hist_hist_id_seq restart 10000;
alter sequence emaj.emaj_time_stamp_time_id_seq restart 10000;
alter sequence emaj.emaj_mark_mark_id_seq restart 10000;
alter sequence emaj.emaj_rlbk_rlbk_id_seq restart 10000;
select * from emaj.emaj_global_seq;
  sequence_name  | last_value | start_value | increment_by |      max_value      | min_value | cache_value | log_cnt | is_cycled | is_called 
-----------------+------------+-------------+--------------+---------------------+-----------+-------------+---------+-----------+-----------
 emaj_global_seq |      11861 |           1 |            1 | 9223372036854775807 |         1 |           1 |      19 | f         | t
(1 row)

alter sequence emaj.emaj_global_seq restart 100000;
-----------------------------
-- grant emaj_adm role 
-----------------------------
grant emaj_adm to emaj_regression_tests_adm_user;
--
set role emaj_regression_tests_adm_user;
-----------------------------
-- authorized table accesses
-----------------------------
select count(*) from emaj.emaj_param;
 count 
-------
     3
(1 row)

select count(*) from emaj.emaj_visible_param;
 count 
-------
     3
(1 row)

select count(*) from emaj.emaj_hist;
 count 
-------
     0
(1 row)

select count(*) from emaj.emaj_group_def;
 count 
-------
    30
(1 row)

select count(*) from emaj.emaj_group;
 count 
-------
     3
(1 row)

select count(*) from emaj.emaj_relation;
 count 
-------
    15
(1 row)

select count(*) from emaj.emaj_mark;
 count 
-------
     2
(1 row)

select count(*) from emaj.emaj_sequence;
 count 
-------
     7
(1 row)

select count(*) from emaj.emaj_seq_hole;
 count 
-------
     0
(1 row)

select count(*) from emaj.emaj_rlbk;
 count 
-------
    27
(1 row)

select count(*) from emaj.emaj_rlbk_session;
 count 
-------
    27
(1 row)

select count(*) from emaj.emaj_rlbk_plan;
 count 
-------
   108
(1 row)

select count(*) from emaj.emaj_rlbk_stat;
 count 
-------
     0
(1 row)

select count(*) from emaj.mySchema1_myTbl1_log;
 count 
-------
     0
(1 row)

-----------------------------
-- stop, reset and drop existing groups
-----------------------------
select emaj.emaj_stop_group('myGroup1','Simple stop mark');
 emaj_stop_group 
-----------------
               7
(1 row)

select emaj.emaj_reset_group('myGroup1');
 emaj_reset_group 
------------------
                7
(1 row)

select emaj.emaj_drop_group('myGroup1');
 emaj_drop_group 
-----------------
               7
(1 row)

select emaj.emaj_force_drop_group('myGroup2');
 emaj_force_drop_group 
-----------------------
                     8
(1 row)

select emaj.emaj_force_stop_group('emptyGroup');
 emaj_force_stop_group 
-----------------------
                     0
(1 row)

select emaj.emaj_drop_group('emptyGroup');
 emaj_drop_group 
-----------------
               0
(1 row)

-- emaj tables
select * from emaj.emaj_group;
 group_name | group_is_logging | group_is_rlbk_protected | group_nb_table | group_nb_sequence | group_is_rollbackable | group_creation_time_id | group_last_alter_time_id | group_pg_version | group_comment 
------------+------------------+-------------------------+----------------+-------------------+-----------------------+------------------------+--------------------------+------------------+---------------
(0 rows)

select * from emaj.emaj_relation;
 rel_schema | rel_tblseq | rel_group | rel_kind | rel_priority | rel_log_schema | rel_log_table | rel_log_dat_tsp | rel_log_index | rel_log_idx_tsp | rel_log_sequence | rel_log_function | rel_sql_columns | rel_sql_pk_columns | rel_sql_pk_eq_conditions 
------------+------------+-----------+----------+--------------+----------------+---------------+-----------------+---------------+-----------------+------------------+------------------+-----------------+--------------------+--------------------------
(0 rows)

select * from emaj.emaj_mark;
 mark_group | mark_name | mark_id | mark_time_id | mark_is_deleted | mark_is_rlbk_protected | mark_comment | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
------------+-----------+---------+--------------+-----------------+------------------------+--------------+---------------------------+------------------------------
(0 rows)

select * from emaj.emaj_sequence;
 sequ_schema | sequ_name | sequ_time_id | sequ_last_val | sequ_start_val | sequ_increment | sequ_max_val | sequ_min_val | sequ_cache_val | sequ_is_cycled | sequ_is_called 
-------------+-----------+--------------+---------------+----------------+----------------+--------------+--------------+----------------+----------------+----------------
(0 rows)

select * from emaj.emaj_seq_hole;
 sqhl_schema | sqhl_table | sqhl_begin_time_id | sqhl_end_time_id | sqhl_hole_size 
-------------+------------+--------------------+------------------+----------------
(0 rows)

select count(*) from emaj.emaj_rlbk;
 count 
-------
    27
(1 row)

select count(*) from emaj.emaj_rlbk_session;
 count 
-------
    27
(1 row)

select count(*) from emaj.emaj_rlbk_plan;
 count 
-------
   108
(1 row)

select count(*) from emaj.emaj_rlbk_stat;
 count 
-------
     0
(1 row)

-----------------------------
-- cleanup application tables
-----------------------------
reset role;
truncate mySchema1.myTbl1, mySchema1.myTbl2, mySchema1."myTbl3", mySchema1.myTbl4, mySchema1.myTbl2b; 
truncate mySchema2.myTbl1, mySchema2.myTbl2, mySchema2."myTbl3", mySchema2.myTbl4, mySchema2.myTbl5, mySchema2.myTbl6, mySchema2.myTbl7, mySchema2.myTbl8;
insert into myschema2.myTbl7 select i from generate_series(0,100,1) i;
insert into myschema2.myTbl6 (col61) values (0);
insert into myschema2.myTbl8 (col81) values (0);
alter sequence mySchema2.mySeq1 restart 1000;
truncate mySchema4.myTblM, mySchema4.myTblC1, mySchema4.myTblC2;
truncate mySchema4.myTblP, mySchema4.myPartP1, mySchema4.myPartP2;
-- starting from this point, disable the trigger on myTbl2
alter table mySchema1.myTbl2 disable trigger myTbl2trg;
set role emaj_regression_tests_adm_user;
-----------------------------
-- recreate and start groups
-----------------------------
select emaj.emaj_create_group('myGroup1');
NOTICE:  table "myschema1_myTbl3_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema1.myTbl3" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema1.myTbl3" does not exist, skipping
NOTICE:  table "myschema1_mytbl1_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema1.mytbl1" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema1.mytbl1" does not exist, skipping
NOTICE:  table "myschema1_mytbl4_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema1.mytbl4" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema1.mytbl4" does not exist, skipping
NOTICE:  table "myschema1_mytbl2_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema1.mytbl2" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema1.mytbl2" does not exist, skipping
WARNING:  _create_tbl: The table "myschema1.mytbl2" has triggers (mytbl2trg). Verify the compatibility with emaj rollback operations (in particular if triggers update one or several other tables). Triggers may have to be manualy disabled before rollback.
NOTICE:  table "myschema1_mytbl2b_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema1.mytbl2b" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema1.mytbl2b" does not exist, skipping
 emaj_create_group 
-------------------
                 7
(1 row)

select emaj.emaj_comment_group('myGroup1','This is group #1');
 emaj_comment_group 
--------------------
 
(1 row)

select emaj.emaj_create_group('myGroup2',true);
NOTICE:  table "myschema2_mytbl1_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema2.mytbl1" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema2.mytbl1" does not exist, skipping
NOTICE:  table "myschema2_mytbl2_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema2.mytbl2" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema2.mytbl2" does not exist, skipping
NOTICE:  table "myschema2_myTbl3_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema2.myTbl3" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema2.myTbl3" does not exist, skipping
NOTICE:  table "myschema2_mytbl4_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema2.mytbl4" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema2.mytbl4" does not exist, skipping
NOTICE:  table "otherPrefix4mytbl5_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema2.mytbl5" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema2.mytbl5" does not exist, skipping
NOTICE:  table "myschema2_mytbl6_log" does not exist, skipping
NOTICE:  trigger "emaj_log_trg" for relation "myschema2.mytbl6" does not exist, skipping
NOTICE:  trigger "emaj_trunc_trg" for relation "myschema2.mytbl6" does not exist, skipping
WARNING:  _check_fk_groups: The foreign key "mytbl6_col61_fkey" on the table "myschema2.mytbl6" references the table "myschema2.mytbl7" that is outside the groups (myGroup2).
WARNING:  _check_fk_groups: The table "myschema2.mytbl6" is referenced by the foreign key "mytbl8_col81_fkey" on the table "myschema2.mytbl8" that is outside the groups (myGroup2).
 emaj_create_group 
-------------------
                 8
(1 row)

-- force a purge of the history, the alter and the rollback tables
INSERT INTO emaj.emaj_param (param_key, param_value_interval) VALUES ('history_retention','1 second'::interval);
select pg_sleep(1);
 pg_sleep 
----------
 
(1 row)

select emaj.emaj_start_group('myGroup1','M1');
 emaj_start_group 
------------------
                7
(1 row)

delete from emaj.emaj_param where param_key = 'history_retention';
select emaj.emaj_start_group('myGroup2','M1');
WARNING:  _check_fk_groups: The foreign key "mytbl6_col61_fkey" on the table "myschema2.mytbl6" references the table "myschema2.mytbl7" that is outside the groups (myGroup2).
WARNING:  _check_fk_groups: The table "myschema2.mytbl6" is referenced by the foreign key "mytbl8_col81_fkey" on the table "myschema2.mytbl8" that is outside the groups (myGroup2).
 emaj_start_group 
------------------
                8
(1 row)

-----------------------------
-- Step 1 : for myGroup1, update tables and set 2 marks
-----------------------------
-- check how truncate reacts (must be blocked in pg 8.4+) - tables are empty anyway
truncate myschema1.mytbl1 cascade;
NOTICE:  truncate cascades to table "mytbl4"
ERROR:  emaj._forbid_truncate_fnct: TRUNCATE is not allowed while updates on this table (myschema1.mytbl1) are currently protected by E-Maj. Consider stopping the group before issuing a TRUNCATE.
CONTEXT:  PL/pgSQL function emaj._forbid_truncate_fnct() line 7 at RAISE
-- 
set search_path=public,myschema1;
insert into myTbl1 select i, 'ABC', E'\\014'::bytea from generate_series (1,11) as i;
update myTbl1 set col13=E'\\034'::bytea where col11 <= 3;
insert into myTbl2 values (1,'ABC','2010-12-31');
delete from myTbl1 where col11 > 10;
insert into myTbl2 values (2,'DEF',NULL);
insert into "myTbl3" (col33) select generate_series(1000,1039,4)/100;
--
select emaj.emaj_set_mark_group('myGroup1','M2');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

--
set search_path=public,myschema1;
insert into myTbl4 values (1,'FK...',1,1,'ABC');
insert into myTbl4 values (2,'FK...',1,1,'ABC');
update myTbl4 set col43 = 2;
insert into myTbl4 values (3,'FK...',1,10,'ABC');
-- the 2 next statements activate fkey on delete and on update clauses 
delete from myTbl1 where col11 = 10;
update myTbl1 set col12='DEF' where col11 <= 2;
--
select emaj.emaj_set_mark_group('myGroup1','M3');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

select emaj.emaj_comment_mark_group('myGroup1','M3','Third mark set');
 emaj_comment_mark_group 
-------------------------
 
(1 row)

-----------------------------
-- Checking step 1
-----------------------------
-- emaj tables
select group_name, group_is_logging, group_is_rlbk_protected, group_nb_table, group_nb_sequence, group_is_rollbackable, 
       group_creation_time_id, group_last_alter_time_id, group_comment
  from emaj.emaj_group order by group_name;
 group_name | group_is_logging | group_is_rlbk_protected | group_nb_table | group_nb_sequence | group_is_rollbackable | group_creation_time_id | group_last_alter_time_id |  group_comment   
------------+------------------+-------------------------+----------------+-------------------+-----------------------+------------------------+--------------------------+------------------
 myGroup1   | t                | f                       |              5 |                 2 | t                     |                  10001 |                          | This is group #1
 myGroup2   | t                | f                       |              6 |                 2 | t                     |                  10002 |                          | 
(2 rows)

select mark_id, mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d','%','g'), mark_time_id, mark_is_deleted, mark_is_rlbk_protected, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_id;
 mark_id | mark_group | regexp_replace | mark_time_id | mark_is_deleted | mark_is_rlbk_protected | mark_is_rlbk_protected |  mark_comment  | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
---------+------------+----------------+--------------+-----------------+------------------------+------------------------+----------------+---------------------------+------------------------------
   10001 | myGroup1   | M1             |        10003 | f               | f                      | f                      |                |                        27 | 
   10002 | myGroup2   | M1             |        10004 | f               | f                      | f                      |                |                           | 
   10003 | myGroup1   | M2             |        10005 | f               | f                      | f                      |                |                        11 | 
   10004 | myGroup1   | M3             |        10006 | f               | f                      | f                      | Third mark set |                           | 
(4 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
 sequ_schema |         sequ_name          | sequ_time_id | sequ_last_val | sequ_is_called 
-------------+----------------------------+--------------+---------------+----------------
 emaj        | myschema1_mytbl1_log_seq   |        10003 |             1 | f
 emaj        | myschema1_mytbl2_log_seq   |        10003 |             1 | f
 emaj        | myschema1_mytbl4_log_seq   |        10003 |             1 | f
 emajb       | myschema1_mytbl2b_log_seq  |        10003 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10003 |             1 | f
 myschema1   | mytbl2b_col20_seq          |        10003 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10003 |            11 | f
 emaj        | myschema2_mytbl1_log_seq   |        10004 |             1 | f
 emaj        | myschema2_mytbl2_log_seq   |        10004 |             1 | f
 emaj        | myschema2_mytbl4_log_seq   |        10004 |             1 | f
 emaj        | myschema2_mytbl6_log_seq   |        10004 |             1 | f
 emaj        | otherPrefix4mytbl5_log_seq |        10004 |             1 | f
 emajC       | myschema2_myTbl3_log_seq   |        10004 |             1 | f
 myschema2   | myseq1                     |        10004 |          1000 | f
 myschema2   | myTbl3_col31_seq           |        10004 |            10 | t
 emaj        | myschema1_mytbl1_log_seq   |        10005 |            15 | t
 emaj        | myschema1_mytbl2_log_seq   |        10005 |             2 | t
 emaj        | myschema1_mytbl4_log_seq   |        10005 |             1 | f
 emajb       | myschema1_mytbl2b_log_seq  |        10005 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10005 |            10 | t
 myschema1   | mytbl2b_col20_seq          |        10005 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10005 |            20 | t
 emaj        | myschema1_mytbl1_log_seq   |        10006 |            18 | t
 emaj        | myschema1_mytbl2_log_seq   |        10006 |             2 | t
 emaj        | myschema1_mytbl4_log_seq   |        10006 |             8 | t
 emajb       | myschema1_mytbl2b_log_seq  |        10006 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10006 |            10 | t
 myschema1   | mytbl2b_col20_seq          |        10006 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10006 |            20 | t
(29 rows)

-- user tables
select * from mySchema1.myTbl1 order by col11,col12;
 col11 |   col12    | col13 
-------+------------+-------
     1 | DEF        | \x1c
     2 | DEF        | \x1c
     3 | ABC        | \x1c
     4 | ABC        | \x0c
     5 | ABC        | \x0c
     6 | ABC        | \x0c
     7 | ABC        | \x0c
     8 | ABC        | \x0c
     9 | ABC        | \x0c
(9 rows)

select * from mySchema1.myTbl2 order by col21;
 col21 | col22 |   col23    
-------+-------+------------
     1 | ABC   | 12-31-2010
     2 | DEF   | 
(2 rows)

select * from mySchema1.myTbl2b order by col20;
 col20 | col21 
-------+-------
(0 rows)

select col31,col33 from mySchema1."myTbl3" order by col31;
 col31 | col33 
-------+-------
    11 | 10.00
    12 | 10.00
    13 | 10.00
    14 | 10.00
    15 | 10.00
    16 | 10.00
    17 | 10.00
    18 | 10.00
    19 | 10.00
    20 | 10.00
(10 rows)

select * from mySchema1.myTbl4 order by col41;
 col41 | col42 | col43 | col44 | col45 
-------+-------+-------+-------+-------
     1 | FK... |     2 |       | 
     2 | FK... |     2 |       | 
(2 rows)

-- log tables
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid, emaj_user, emaj_user_ip, emaj_user_port
    from emaj.mySchema1_myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid | emaj_user | emaj_user_ip | emaj_user_port 
-------+------------+-------+-----------+------------+----------+-----------+--------------+----------------
     1 | ABC        | \x0c  | INS       | NEW        |   100000 | postgres  |              |               
     2 | ABC        | \x0c  | INS       | NEW        |   100001 | postgres  |              |               
     3 | ABC        | \x0c  | INS       | NEW        |   100002 | postgres  |              |               
     4 | ABC        | \x0c  | INS       | NEW        |   100003 | postgres  |              |               
     5 | ABC        | \x0c  | INS       | NEW        |   100004 | postgres  |              |               
     6 | ABC        | \x0c  | INS       | NEW        |   100005 | postgres  |              |               
     7 | ABC        | \x0c  | INS       | NEW        |   100006 | postgres  |              |               
     8 | ABC        | \x0c  | INS       | NEW        |   100007 | postgres  |              |               
     9 | ABC        | \x0c  | INS       | NEW        |   100008 | postgres  |              |               
    10 | ABC        | \x0c  | INS       | NEW        |   100009 | postgres  |              |               
    11 | ABC        | \x0c  | INS       | NEW        |   100010 | postgres  |              |               
     1 | ABC        | \x0c  | UPD       | OLD        |   100011 | postgres  |              |               
     1 | ABC        | \x1c  | UPD       | NEW        |   100011 | postgres  |              |               
     2 | ABC        | \x0c  | UPD       | OLD        |   100012 | postgres  |              |               
     2 | ABC        | \x1c  | UPD       | NEW        |   100012 | postgres  |              |               
     3 | ABC        | \x0c  | UPD       | OLD        |   100013 | postgres  |              |               
     3 | ABC        | \x1c  | UPD       | NEW        |   100013 | postgres  |              |               
    11 | ABC        | \x0c  | DEL       | OLD        |   100015 | postgres  |              |               
    10 | ABC        | \x0c  | DEL       | OLD        |   100032 | postgres  |              |               
     1 | ABC        | \x1c  | UPD       | OLD        |   100034 | postgres  |              |               
     1 | DEF        | \x1c  | UPD       | NEW        |   100034 | postgres  |              |               
     2 | ABC        | \x1c  | UPD       | OLD        |   100035 | postgres  |              |               
     2 | DEF        | \x1c  | UPD       | NEW        |   100035 | postgres  |              |               
(23 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid, emaj_user, emaj_user_ip, emaj_user_port
    from emaj.mySchema1_myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 |   col23    | emaj_verb | emaj_tuple | emaj_gid | emaj_user | emaj_user_ip | emaj_user_port 
-------+-------+------------+-----------+------------+----------+-----------+--------------+----------------
     1 | ABC   | 12-31-2010 | INS       | NEW        |   100014 | postgres  |              |               
     2 | DEF   |            | INS       | NEW        |   100016 | postgres  |              |               
(2 rows)

select col20, col21, emaj_verb, emaj_tuple, emaj_gid, emaj_user, emaj_user_ip, emaj_user_port
    from emajb.mySchema1_myTbl2b_log order by emaj_gid, emaj_tuple desc;
 col20 | col21 | emaj_verb | emaj_tuple | emaj_gid | emaj_user | emaj_user_ip | emaj_user_port 
-------+-------+-----------+------------+----------+-----------+--------------+----------------
(0 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid, emaj_user, emaj_user_ip, emaj_user_port
    from "emajC"."myschema1_myTbl3_log" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid | emaj_user | emaj_user_ip | emaj_user_port 
-------+-------+-----------+------------+----------+-----------+--------------+----------------
    11 | 10.00 | INS       | NEW        |   100017 | postgres  |              |               
    12 | 10.00 | INS       | NEW        |   100018 | postgres  |              |               
    13 | 10.00 | INS       | NEW        |   100019 | postgres  |              |               
    14 | 10.00 | INS       | NEW        |   100020 | postgres  |              |               
    15 | 10.00 | INS       | NEW        |   100021 | postgres  |              |               
    16 | 10.00 | INS       | NEW        |   100022 | postgres  |              |               
    17 | 10.00 | INS       | NEW        |   100023 | postgres  |              |               
    18 | 10.00 | INS       | NEW        |   100024 | postgres  |              |               
    19 | 10.00 | INS       | NEW        |   100025 | postgres  |              |               
    20 | 10.00 | INS       | NEW        |   100026 | postgres  |              |               
(10 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid, emaj_user, emaj_user_ip, emaj_user_port
    from emaj.mySchema1_myTbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 |   col45    | emaj_verb | emaj_tuple | emaj_gid | emaj_user | emaj_user_ip | emaj_user_port 
-------+-------+-------+-------+------------+-----------+------------+----------+-----------+--------------+----------------
     1 | FK... |     1 |     1 | ABC        | INS       | NEW        |   100027 | postgres  |              |               
     2 | FK... |     1 |     1 | ABC        | INS       | NEW        |   100028 | postgres  |              |               
     1 | FK... |     1 |     1 | ABC        | UPD       | OLD        |   100029 | postgres  |              |               
     1 | FK... |     2 |     1 | ABC        | UPD       | NEW        |   100029 | postgres  |              |               
     2 | FK... |     1 |     1 | ABC        | UPD       | OLD        |   100030 | postgres  |              |               
     2 | FK... |     2 |     1 | ABC        | UPD       | NEW        |   100030 | postgres  |              |               
     3 | FK... |     1 |    10 | ABC        | INS       | NEW        |   100031 | postgres  |              |               
     3 | FK... |     1 |    10 | ABC        | DEL       | OLD        |   100033 | postgres  |              |               
     1 | FK... |     2 |     1 | ABC        | UPD       | OLD        |   100036 | postgres  |              |               
     1 | FK... |     2 |       |            | UPD       | NEW        |   100036 | postgres  |              |               
     2 | FK... |     2 |     1 | ABC        | UPD       | OLD        |   100037 | postgres  |              |               
     2 | FK... |     2 |       |            | UPD       | NEW        |   100037 | postgres  |              |               
(12 rows)

-----------------------------
-- Step 2 : for myGroup2, start, update tables and set 2 marks 
-----------------------------
set search_path=public,myschema2;
insert into myTbl1 select i, 'ABC', E'\\014'::bytea from generate_series (1,11) as i;
update myTbl1 set col13=E'\\034'::bytea where col11 <= 3;
insert into myTbl2 values (1,'ABC','2010-01-01');
delete from myTbl1 where col11 > 10;
select nextval('myschema2.myseq1');
 nextval 
---------
    1000
(1 row)

insert into myTbl2 values (2,'DEF',NULL);
insert into "myTbl3" (col33) select generate_series(1000,1039,4)/100;
insert into myTbl5 values (1,'{"abc","def","ghi"}','{1,2,3}',NULL);
insert into myTbl5 values (2,array['abc','def','ghi'],array[3,4,5],array['2000/02/01'::date,'2000/02/28'::date]);
update myTbl5 set col54 = '{"2010/11/28","2010/12/03"}' where col54 is null;
insert into myTbl6 select i, point(i,1.3), '((0,0),(2,2))', circle(point(5,5),i),'((-2,-2),(3,0),(1,4))','10.20.30.40/27' from generate_series (1,8) as i;
update myTbl6 set col64 = '<(5,6),3.5>', col65 = null where col61 between 1 and 3;
--
select emaj.emaj_set_mark_group('myGroup2','M2');
 emaj_set_mark_group 
---------------------
                   8
(1 row)

--
set search_path=public,myschema2;
select nextval('myschema2.myseq1');
 nextval 
---------
    1001
(1 row)

select nextval('myschema2.myseq1');
 nextval 
---------
    1002
(1 row)

select nextval('myschema2.myseq1');
 nextval 
---------
    1003
(1 row)

--
reset role;
alter sequence mySeq1 NO MAXVALUE NO CYCLE;
set role emaj_regression_tests_adm_user;
--
insert into myTbl4 values (1,'FK...',1,1,'ABC');
insert into myTbl4 values (2,'FK...',1,1,'ABC');
update myTbl4 set col43 = 2;
delete from mytbl5 where 4 = any(col53);
delete from myTbl6 where col65 is null and col61 <> 0;
--
select emaj.emaj_set_mark_group('myGroup2','M3');
 emaj_set_mark_group 
---------------------
                   8
(1 row)

-----------------------------
-- Checking step 2
-----------------------------
-- emaj tables
select mark_id, mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d','%','g'), mark_time_id, mark_is_deleted, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_id;
 mark_id | mark_group | regexp_replace | mark_time_id | mark_is_deleted | mark_is_rlbk_protected |  mark_comment  | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
---------+------------+----------------+--------------+-----------------+------------------------+----------------+---------------------------+------------------------------
   10001 | myGroup1   | M1             |        10003 | f               | f                      |                |                        27 | 
   10002 | myGroup2   | M1             |        10004 | f               | f                      |                |                        41 | 
   10003 | myGroup1   | M2             |        10005 | f               | f                      |                |                        11 | 
   10004 | myGroup1   | M3             |        10006 | f               | f                      | Third mark set |                           | 
   10005 | myGroup2   | M2             |        10007 | f               | f                      |                |                         8 | 
   10006 | myGroup2   | M3             |        10008 | f               | f                      |                |                           | 
(6 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
 sequ_schema |         sequ_name          | sequ_time_id | sequ_last_val | sequ_is_called 
-------------+----------------------------+--------------+---------------+----------------
 emaj        | myschema1_mytbl1_log_seq   |        10003 |             1 | f
 emaj        | myschema1_mytbl2_log_seq   |        10003 |             1 | f
 emaj        | myschema1_mytbl4_log_seq   |        10003 |             1 | f
 emajb       | myschema1_mytbl2b_log_seq  |        10003 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10003 |             1 | f
 myschema1   | mytbl2b_col20_seq          |        10003 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10003 |            11 | f
 emaj        | myschema2_mytbl1_log_seq   |        10004 |             1 | f
 emaj        | myschema2_mytbl2_log_seq   |        10004 |             1 | f
 emaj        | myschema2_mytbl4_log_seq   |        10004 |             1 | f
 emaj        | myschema2_mytbl6_log_seq   |        10004 |             1 | f
 emaj        | otherPrefix4mytbl5_log_seq |        10004 |             1 | f
 emajC       | myschema2_myTbl3_log_seq   |        10004 |             1 | f
 myschema2   | myseq1                     |        10004 |          1000 | f
 myschema2   | myTbl3_col31_seq           |        10004 |            10 | t
 emaj        | myschema1_mytbl1_log_seq   |        10005 |            15 | t
 emaj        | myschema1_mytbl2_log_seq   |        10005 |             2 | t
 emaj        | myschema1_mytbl4_log_seq   |        10005 |             1 | f
 emajb       | myschema1_mytbl2b_log_seq  |        10005 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10005 |            10 | t
 myschema1   | mytbl2b_col20_seq          |        10005 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10005 |            20 | t
 emaj        | myschema1_mytbl1_log_seq   |        10006 |            18 | t
 emaj        | myschema1_mytbl2_log_seq   |        10006 |             2 | t
 emaj        | myschema1_mytbl4_log_seq   |        10006 |             8 | t
 emajb       | myschema1_mytbl2b_log_seq  |        10006 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10006 |            10 | t
 myschema1   | mytbl2b_col20_seq          |        10006 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10006 |            20 | t
 emaj        | myschema2_mytbl1_log_seq   |        10007 |            15 | t
 emaj        | myschema2_mytbl2_log_seq   |        10007 |             2 | t
 emaj        | myschema2_mytbl4_log_seq   |        10007 |             1 | f
 emaj        | myschema2_mytbl6_log_seq   |        10007 |            11 | t
 emaj        | otherPrefix4mytbl5_log_seq |        10007 |             3 | t
 emajC       | myschema2_myTbl3_log_seq   |        10007 |            10 | t
 myschema2   | myseq1                     |        10007 |          1000 | t
 myschema2   | myTbl3_col31_seq           |        10007 |            20 | t
 emaj        | myschema2_mytbl1_log_seq   |        10008 |            15 | t
 emaj        | myschema2_mytbl2_log_seq   |        10008 |             2 | t
 emaj        | myschema2_mytbl4_log_seq   |        10008 |             4 | t
 emaj        | myschema2_mytbl6_log_seq   |        10008 |            14 | t
 emaj        | otherPrefix4mytbl5_log_seq |        10008 |             4 | t
 emajC       | myschema2_myTbl3_log_seq   |        10008 |            10 | t
 myschema2   | myseq1                     |        10008 |          1003 | t
 myschema2   | myTbl3_col31_seq           |        10008 |            20 | t
(45 rows)

-- user tables
select * from mySchema2.myTbl1 order by col11,col12;
 col11 |   col12    | col13 
-------+------------+-------
     1 | ABC        | \x1c
     2 | ABC        | \x1c
     3 | ABC        | \x1c
     4 | ABC        | \x0c
     5 | ABC        | \x0c
     6 | ABC        | \x0c
     7 | ABC        | \x0c
     8 | ABC        | \x0c
     9 | ABC        | \x0c
    10 | ABC        | \x0c
(10 rows)

select * from mySchema2.myTbl2 order by col21;
 col21 | col22 |   col23    
-------+-------+------------
     1 | ABC   | 01-01-2010
     2 | DEF   | 
(2 rows)

select col31,col33 from mySchema2."myTbl3" order by col31;
 col31 | col33 
-------+-------
    11 | 10.00
    12 | 10.00
    13 | 10.00
    14 | 10.00
    15 | 10.00
    16 | 10.00
    17 | 10.00
    18 | 10.00
    19 | 10.00
    20 | 10.00
(10 rows)

select * from mySchema2.myTbl4 order by col41;
 col41 | col42 | col43 | col44 |   col45    
-------+-------+-------+-------+------------
     1 | FK... |     2 |     1 | ABC       
     2 | FK... |     2 |     1 | ABC       
(2 rows)

select * from mySchema2.myTbl5 order by col51;
 col51 |     col52     |  col53  |          col54          
-------+---------------+---------+-------------------------
     1 | {abc,def,ghi} | {1,2,3} | {11-28-2010,12-03-2010}
(1 row)

select * from mySchema2.myTbl6 order by col61;
 col61 |  col62  |    col63    |   col64   |         col65         |     col66      
-------+---------+-------------+-----------+-----------------------+----------------
     0 |         |             |           |                       | 
     4 | (4,1.3) | (2,2),(0,0) | <(5,5),4> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
     5 | (5,1.3) | (2,2),(0,0) | <(5,5),5> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
     6 | (6,1.3) | (2,2),(0,0) | <(5,5),6> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
     7 | (7,1.3) | (2,2),(0,0) | <(5,5),7> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
     8 | (8,1.3) | (2,2),(0,0) | <(5,5),8> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
(6 rows)

-- log tables
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema2_myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid 
-------+------------+-------+-----------+------------+----------
     1 | ABC        | \x0c  | INS       | NEW        |   100038
     2 | ABC        | \x0c  | INS       | NEW        |   100039
     3 | ABC        | \x0c  | INS       | NEW        |   100040
     4 | ABC        | \x0c  | INS       | NEW        |   100041
     5 | ABC        | \x0c  | INS       | NEW        |   100042
     6 | ABC        | \x0c  | INS       | NEW        |   100043
     7 | ABC        | \x0c  | INS       | NEW        |   100044
     8 | ABC        | \x0c  | INS       | NEW        |   100045
     9 | ABC        | \x0c  | INS       | NEW        |   100046
    10 | ABC        | \x0c  | INS       | NEW        |   100047
    11 | ABC        | \x0c  | INS       | NEW        |   100048
     1 | ABC        | \x0c  | UPD       | OLD        |   100049
     1 | ABC        | \x1c  | UPD       | NEW        |   100049
     2 | ABC        | \x0c  | UPD       | OLD        |   100050
     2 | ABC        | \x1c  | UPD       | NEW        |   100050
     3 | ABC        | \x0c  | UPD       | OLD        |   100051
     3 | ABC        | \x1c  | UPD       | NEW        |   100051
    11 | ABC        | \x0c  | DEL       | OLD        |   100053
(18 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema2_myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 |   col23    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+------------+-----------+------------+----------
     1 | ABC   | 01-01-2010 | INS       | NEW        |   100052
     2 | DEF   |            | INS       | NEW        |   100054
(2 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid from "emajC"."myschema2_myTbl3_log" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
    11 | 10.00 | INS       | NEW        |   100055
    12 | 10.00 | INS       | NEW        |   100056
    13 | 10.00 | INS       | NEW        |   100057
    14 | 10.00 | INS       | NEW        |   100058
    15 | 10.00 | INS       | NEW        |   100059
    16 | 10.00 | INS       | NEW        |   100060
    17 | 10.00 | INS       | NEW        |   100061
    18 | 10.00 | INS       | NEW        |   100062
    19 | 10.00 | INS       | NEW        |   100063
    20 | 10.00 | INS       | NEW        |   100064
(10 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema2_myTbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 |   col45    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+------------+-----------+------------+----------
     1 | FK... |     1 |     1 | ABC        | INS       | NEW        |   100079
     2 | FK... |     1 |     1 | ABC        | INS       | NEW        |   100080
     1 | FK... |     1 |     1 | ABC        | UPD       | OLD        |   100081
     1 | FK... |     2 |     1 | ABC        | UPD       | NEW        |   100081
     2 | FK... |     1 |     1 | ABC        | UPD       | OLD        |   100082
     2 | FK... |     2 |     1 | ABC        | UPD       | NEW        |   100082
(6 rows)

select col51, col52, col53, col54, emaj_verb, emaj_tuple, emaj_gid from emaj."otherPrefix4mytbl5_log" order by emaj_gid, emaj_tuple desc;
 col51 |     col52     |  col53  |          col54          | emaj_verb | emaj_tuple | emaj_gid 
-------+---------------+---------+-------------------------+-----------+------------+----------
     1 | {abc,def,ghi} | {1,2,3} |                         | INS       | NEW        |   100065
     2 | {abc,def,ghi} | {3,4,5} | {02-01-2000,02-28-2000} | INS       | NEW        |   100066
     1 | {abc,def,ghi} | {1,2,3} |                         | UPD       | OLD        |   100067
     1 | {abc,def,ghi} | {1,2,3} | {11-28-2010,12-03-2010} | UPD       | NEW        |   100067
     2 | {abc,def,ghi} | {3,4,5} | {02-01-2000,02-28-2000} | DEL       | OLD        |   100083
(5 rows)

select col61, col62, col63, col64, col65, col66, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema2_myTbl6_log order by emaj_gid, emaj_tuple desc;
 col61 |  col62  |    col63    |    col64    |         col65         |     col66      | emaj_verb | emaj_tuple | emaj_gid 
-------+---------+-------------+-------------+-----------------------+----------------+-----------+------------+----------
     1 | (1,1.3) | (2,2),(0,0) | <(5,5),1>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100068
     2 | (2,1.3) | (2,2),(0,0) | <(5,5),2>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100069
     3 | (3,1.3) | (2,2),(0,0) | <(5,5),3>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100070
     4 | (4,1.3) | (2,2),(0,0) | <(5,5),4>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100071
     5 | (5,1.3) | (2,2),(0,0) | <(5,5),5>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100072
     6 | (6,1.3) | (2,2),(0,0) | <(5,5),6>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100073
     7 | (7,1.3) | (2,2),(0,0) | <(5,5),7>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100074
     8 | (8,1.3) | (2,2),(0,0) | <(5,5),8>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100075
     1 | (1,1.3) | (2,2),(0,0) | <(5,5),1>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | UPD       | OLD        |   100076
     1 | (1,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | UPD       | NEW        |   100076
     2 | (2,1.3) | (2,2),(0,0) | <(5,5),2>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | UPD       | OLD        |   100077
     2 | (2,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | UPD       | NEW        |   100077
     3 | (3,1.3) | (2,2),(0,0) | <(5,5),3>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | UPD       | OLD        |   100078
     3 | (3,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | UPD       | NEW        |   100078
     1 | (1,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        |   100084
     2 | (2,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        |   100085
     3 | (3,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        |   100086
(17 rows)

-----------------------------
-- Step 3 : for myGroup2, double logged rollback
-----------------------------
reset role;
analyze mytbl4;
-- rollback with dblink_connect_u not granted
revoke execute on function dblink_connect_u(text,text) from emaj_adm;
set role emaj_regression_tests_adm_user;
select * from emaj.emaj_logged_rollback_group('myGroup2','M2',false) order by 1,2;
WARNING:  _check_fk_groups: The foreign key "mytbl6_col61_fkey" on the table "myschema2.mytbl6" references the table "myschema2.mytbl7" that is outside the groups (myGroup2).
WARNING:  _check_fk_groups: The table "myschema2.mytbl6" is referenced by the foreign key "mytbl8_col81_fkey" on the table "myschema2.mytbl8" that is outside the groups (myGroup2).
 rlbk_severity |                  rlbk_message                   
---------------+-------------------------------------------------
 Notice        | 3 tables and 2 sequences effectively processed.
(1 row)

select * from emaj.emaj_logged_rollback_group('myGroup2','M3',false) order by 1,2;
WARNING:  _check_fk_groups: The foreign key "mytbl6_col61_fkey" on the table "myschema2.mytbl6" references the table "myschema2.mytbl7" that is outside the groups (myGroup2).
WARNING:  _check_fk_groups: The table "myschema2.mytbl6" is referenced by the foreign key "mytbl8_col81_fkey" on the table "myschema2.mytbl8" that is outside the groups (myGroup2).
 rlbk_severity |                  rlbk_message                   
---------------+-------------------------------------------------
 Notice        | 3 tables and 2 sequences effectively processed.
(1 row)

reset role;
grant execute on function dblink_connect_u(text,text) to emaj_adm;
set role emaj_regression_tests_adm_user;
-----------------------------
-- Checking step 3
-----------------------------
-- emaj tables
select mark_id, mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d','%','g'), mark_time_id, mark_is_deleted, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_id;
 mark_id | mark_group | regexp_replace  | mark_time_id | mark_is_deleted | mark_is_rlbk_protected |  mark_comment  | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
---------+------------+-----------------+--------------+-----------------+------------------------+----------------+---------------------------+------------------------------
   10001 | myGroup1   | M1              |        10003 | f               | f                      |                |                        27 | 
   10002 | myGroup2   | M1              |        10004 | f               | f                      |                |                        41 | 
   10003 | myGroup1   | M2              |        10005 | f               | f                      |                |                        11 | 
   10004 | myGroup1   | M3              |        10006 | f               | f                      | Third mark set |                           | 
   10005 | myGroup2   | M2              |        10007 | f               | f                      |                |                         8 | 
   10006 | myGroup2   | M3              |        10008 | f               | f                      |                |                         0 | 
   10007 | myGroup2   | RLBK_M2_%_START |        10009 | f               | f                      |                |                         6 | 
   10008 | myGroup2   | RLBK_M2_%_DONE  |        10010 | f               | f                      |                |                         0 | M2
   10009 | myGroup2   | RLBK_M3_%_START |        10011 | f               | f                      |                |                         6 | 
   10010 | myGroup2   | RLBK_M3_%_DONE  |        10012 | f               | f                      |                |                           | M3
(10 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
 sequ_schema |         sequ_name          | sequ_time_id | sequ_last_val | sequ_is_called 
-------------+----------------------------+--------------+---------------+----------------
 emaj        | myschema1_mytbl1_log_seq   |        10003 |             1 | f
 emaj        | myschema1_mytbl2_log_seq   |        10003 |             1 | f
 emaj        | myschema1_mytbl4_log_seq   |        10003 |             1 | f
 emajb       | myschema1_mytbl2b_log_seq  |        10003 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10003 |             1 | f
 myschema1   | mytbl2b_col20_seq          |        10003 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10003 |            11 | f
 emaj        | myschema2_mytbl1_log_seq   |        10004 |             1 | f
 emaj        | myschema2_mytbl2_log_seq   |        10004 |             1 | f
 emaj        | myschema2_mytbl4_log_seq   |        10004 |             1 | f
 emaj        | myschema2_mytbl6_log_seq   |        10004 |             1 | f
 emaj        | otherPrefix4mytbl5_log_seq |        10004 |             1 | f
 emajC       | myschema2_myTbl3_log_seq   |        10004 |             1 | f
 myschema2   | myseq1                     |        10004 |          1000 | f
 myschema2   | myTbl3_col31_seq           |        10004 |            10 | t
 emaj        | myschema1_mytbl1_log_seq   |        10005 |            15 | t
 emaj        | myschema1_mytbl2_log_seq   |        10005 |             2 | t
 emaj        | myschema1_mytbl4_log_seq   |        10005 |             1 | f
 emajb       | myschema1_mytbl2b_log_seq  |        10005 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10005 |            10 | t
 myschema1   | mytbl2b_col20_seq          |        10005 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10005 |            20 | t
 emaj        | myschema1_mytbl1_log_seq   |        10006 |            18 | t
 emaj        | myschema1_mytbl2_log_seq   |        10006 |             2 | t
 emaj        | myschema1_mytbl4_log_seq   |        10006 |             8 | t
 emajb       | myschema1_mytbl2b_log_seq  |        10006 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10006 |            10 | t
 myschema1   | mytbl2b_col20_seq          |        10006 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10006 |            20 | t
 emaj        | myschema2_mytbl1_log_seq   |        10007 |            15 | t
 emaj        | myschema2_mytbl2_log_seq   |        10007 |             2 | t
 emaj        | myschema2_mytbl4_log_seq   |        10007 |             1 | f
 emaj        | myschema2_mytbl6_log_seq   |        10007 |            11 | t
 emaj        | otherPrefix4mytbl5_log_seq |        10007 |             3 | t
 emajC       | myschema2_myTbl3_log_seq   |        10007 |            10 | t
 myschema2   | myseq1                     |        10007 |          1000 | t
 myschema2   | myTbl3_col31_seq           |        10007 |            20 | t
 emaj        | myschema2_mytbl1_log_seq   |        10008 |            15 | t
 emaj        | myschema2_mytbl2_log_seq   |        10008 |             2 | t
 emaj        | myschema2_mytbl4_log_seq   |        10008 |             4 | t
 emaj        | myschema2_mytbl6_log_seq   |        10008 |            14 | t
 emaj        | otherPrefix4mytbl5_log_seq |        10008 |             4 | t
 emajC       | myschema2_myTbl3_log_seq   |        10008 |            10 | t
 myschema2   | myseq1                     |        10008 |          1003 | t
 myschema2   | myTbl3_col31_seq           |        10008 |            20 | t
 emaj        | myschema2_mytbl1_log_seq   |        10009 |            15 | t
 emaj        | myschema2_mytbl2_log_seq   |        10009 |             2 | t
 emaj        | myschema2_mytbl4_log_seq   |        10009 |             4 | t
 emaj        | myschema2_mytbl6_log_seq   |        10009 |            14 | t
 emaj        | otherPrefix4mytbl5_log_seq |        10009 |             4 | t
 emajC       | myschema2_myTbl3_log_seq   |        10009 |            10 | t
 myschema2   | myseq1                     |        10009 |          1003 | t
 myschema2   | myTbl3_col31_seq           |        10009 |            20 | t
 emaj        | myschema2_mytbl1_log_seq   |        10010 |            15 | t
 emaj        | myschema2_mytbl2_log_seq   |        10010 |             2 | t
 emaj        | myschema2_mytbl4_log_seq   |        10010 |             6 | t
 emaj        | myschema2_mytbl6_log_seq   |        10010 |            17 | t
 emaj        | otherPrefix4mytbl5_log_seq |        10010 |             5 | t
 emajC       | myschema2_myTbl3_log_seq   |        10010 |            10 | t
 myschema2   | myseq1                     |        10010 |          1001 | f
 myschema2   | myTbl3_col31_seq           |        10010 |            20 | t
 emaj        | myschema2_mytbl1_log_seq   |        10011 |            15 | t
 emaj        | myschema2_mytbl2_log_seq   |        10011 |             2 | t
 emaj        | myschema2_mytbl4_log_seq   |        10011 |             6 | t
 emaj        | myschema2_mytbl6_log_seq   |        10011 |            17 | t
 emaj        | otherPrefix4mytbl5_log_seq |        10011 |             5 | t
 emajC       | myschema2_myTbl3_log_seq   |        10011 |            10 | t
 myschema2   | myseq1                     |        10011 |          1001 | f
 myschema2   | myTbl3_col31_seq           |        10011 |            20 | t
 emaj        | myschema2_mytbl1_log_seq   |        10012 |            15 | t
 emaj        | myschema2_mytbl2_log_seq   |        10012 |             2 | t
 emaj        | myschema2_mytbl4_log_seq   |        10012 |             8 | t
 emaj        | myschema2_mytbl6_log_seq   |        10012 |            20 | t
 emaj        | otherPrefix4mytbl5_log_seq |        10012 |             6 | t
 emajC       | myschema2_myTbl3_log_seq   |        10012 |            10 | t
 myschema2   | myseq1                     |        10012 |          1004 | f
 myschema2   | myTbl3_col31_seq           |        10012 |            20 | t
(77 rows)

-- user tables
select * from mySchema2.myTbl1 order by col11,col12;
 col11 |   col12    | col13 
-------+------------+-------
     1 | ABC        | \x1c
     2 | ABC        | \x1c
     3 | ABC        | \x1c
     4 | ABC        | \x0c
     5 | ABC        | \x0c
     6 | ABC        | \x0c
     7 | ABC        | \x0c
     8 | ABC        | \x0c
     9 | ABC        | \x0c
    10 | ABC        | \x0c
(10 rows)

select * from mySchema2.myTbl2 order by col21;
 col21 | col22 |   col23    
-------+-------+------------
     1 | ABC   | 01-01-2010
     2 | DEF   | 
(2 rows)

select col31,col33 from mySchema2."myTbl3" order by col31;
 col31 | col33 
-------+-------
    11 | 10.00
    12 | 10.00
    13 | 10.00
    14 | 10.00
    15 | 10.00
    16 | 10.00
    17 | 10.00
    18 | 10.00
    19 | 10.00
    20 | 10.00
(10 rows)

select * from mySchema2.myTbl4 order by col41;
 col41 | col42 | col43 | col44 |   col45    
-------+-------+-------+-------+------------
     1 | FK... |     2 |     1 | ABC       
     2 | FK... |     2 |     1 | ABC       
(2 rows)

select * from mySchema2.myTbl5 order by col51;
 col51 |     col52     |  col53  |          col54          
-------+---------------+---------+-------------------------
     1 | {abc,def,ghi} | {1,2,3} | {11-28-2010,12-03-2010}
(1 row)

select * from mySchema2.myTbl6 order by col61;
 col61 |  col62  |    col63    |   col64   |         col65         |     col66      
-------+---------+-------------+-----------+-----------------------+----------------
     0 |         |             |           |                       | 
     4 | (4,1.3) | (2,2),(0,0) | <(5,5),4> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
     5 | (5,1.3) | (2,2),(0,0) | <(5,5),5> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
     6 | (6,1.3) | (2,2),(0,0) | <(5,5),6> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
     7 | (7,1.3) | (2,2),(0,0) | <(5,5),7> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
     8 | (8,1.3) | (2,2),(0,0) | <(5,5),8> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
(6 rows)

-- log tables
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema2_myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid 
-------+------------+-------+-----------+------------+----------
     1 | ABC        | \x0c  | INS       | NEW        |   100038
     2 | ABC        | \x0c  | INS       | NEW        |   100039
     3 | ABC        | \x0c  | INS       | NEW        |   100040
     4 | ABC        | \x0c  | INS       | NEW        |   100041
     5 | ABC        | \x0c  | INS       | NEW        |   100042
     6 | ABC        | \x0c  | INS       | NEW        |   100043
     7 | ABC        | \x0c  | INS       | NEW        |   100044
     8 | ABC        | \x0c  | INS       | NEW        |   100045
     9 | ABC        | \x0c  | INS       | NEW        |   100046
    10 | ABC        | \x0c  | INS       | NEW        |   100047
    11 | ABC        | \x0c  | INS       | NEW        |   100048
     1 | ABC        | \x0c  | UPD       | OLD        |   100049
     1 | ABC        | \x1c  | UPD       | NEW        |   100049
     2 | ABC        | \x0c  | UPD       | OLD        |   100050
     2 | ABC        | \x1c  | UPD       | NEW        |   100050
     3 | ABC        | \x0c  | UPD       | OLD        |   100051
     3 | ABC        | \x1c  | UPD       | NEW        |   100051
    11 | ABC        | \x0c  | DEL       | OLD        |   100053
(18 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema2_myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 |   col23    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+------------+-----------+------------+----------
     1 | ABC   | 01-01-2010 | INS       | NEW        |   100052
     2 | DEF   |            | INS       | NEW        |   100054
(2 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid from "emajC"."myschema2_myTbl3_log" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
    11 | 10.00 | INS       | NEW        |   100055
    12 | 10.00 | INS       | NEW        |   100056
    13 | 10.00 | INS       | NEW        |   100057
    14 | 10.00 | INS       | NEW        |   100058
    15 | 10.00 | INS       | NEW        |   100059
    16 | 10.00 | INS       | NEW        |   100060
    17 | 10.00 | INS       | NEW        |   100061
    18 | 10.00 | INS       | NEW        |   100062
    19 | 10.00 | INS       | NEW        |   100063
    20 | 10.00 | INS       | NEW        |   100064
(10 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema2_myTbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 |   col45    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+------------+-----------+------------+----------
     1 | FK... |     1 |     1 | ABC        | INS       | NEW        |   100079
     2 | FK... |     1 |     1 | ABC        | INS       | NEW        |   100080
     1 | FK... |     1 |     1 | ABC        | UPD       | OLD        |   100081
     1 | FK... |     2 |     1 | ABC        | UPD       | NEW        |   100081
     2 | FK... |     1 |     1 | ABC        | UPD       | OLD        |   100082
     2 | FK... |     2 |     1 | ABC        | UPD       | NEW        |   100082
     1 | FK... |     2 |     1 | ABC        | DEL       | OLD        |   100087
     2 | FK... |     2 |     1 | ABC        | DEL       | OLD        |   100088
     1 | FK... |     2 |     1 | ABC        | INS       | NEW        |   100096
     2 | FK... |     2 |     1 | ABC        | INS       | NEW        |   100097
(10 rows)

select col51, col52, col53, col54, emaj_verb, emaj_tuple, emaj_gid from emaj."otherPrefix4mytbl5_log" order by emaj_gid, emaj_tuple desc;
 col51 |     col52     |  col53  |          col54          | emaj_verb | emaj_tuple | emaj_gid 
-------+---------------+---------+-------------------------+-----------+------------+----------
     1 | {abc,def,ghi} | {1,2,3} |                         | INS       | NEW        |   100065
     2 | {abc,def,ghi} | {3,4,5} | {02-01-2000,02-28-2000} | INS       | NEW        |   100066
     1 | {abc,def,ghi} | {1,2,3} |                         | UPD       | OLD        |   100067
     1 | {abc,def,ghi} | {1,2,3} | {11-28-2010,12-03-2010} | UPD       | NEW        |   100067
     2 | {abc,def,ghi} | {3,4,5} | {02-01-2000,02-28-2000} | DEL       | OLD        |   100083
     2 | {abc,def,ghi} | {3,4,5} | {02-01-2000,02-28-2000} | INS       | NEW        |   100092
     2 | {abc,def,ghi} | {3,4,5} | {02-01-2000,02-28-2000} | DEL       | OLD        |   100098
(7 rows)

select col61, col62, col63, col64, col65, col66, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema2_myTbl6_log order by emaj_gid, emaj_tuple desc;
 col61 |  col62  |    col63    |    col64    |         col65         |     col66      | emaj_verb | emaj_tuple | emaj_gid 
-------+---------+-------------+-------------+-----------------------+----------------+-----------+------------+----------
     1 | (1,1.3) | (2,2),(0,0) | <(5,5),1>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100068
     2 | (2,1.3) | (2,2),(0,0) | <(5,5),2>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100069
     3 | (3,1.3) | (2,2),(0,0) | <(5,5),3>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100070
     4 | (4,1.3) | (2,2),(0,0) | <(5,5),4>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100071
     5 | (5,1.3) | (2,2),(0,0) | <(5,5),5>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100072
     6 | (6,1.3) | (2,2),(0,0) | <(5,5),6>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100073
     7 | (7,1.3) | (2,2),(0,0) | <(5,5),7>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100074
     8 | (8,1.3) | (2,2),(0,0) | <(5,5),8>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100075
     1 | (1,1.3) | (2,2),(0,0) | <(5,5),1>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | UPD       | OLD        |   100076
     1 | (1,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | UPD       | NEW        |   100076
     2 | (2,1.3) | (2,2),(0,0) | <(5,5),2>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | UPD       | OLD        |   100077
     2 | (2,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | UPD       | NEW        |   100077
     3 | (3,1.3) | (2,2),(0,0) | <(5,5),3>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | UPD       | OLD        |   100078
     3 | (3,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | UPD       | NEW        |   100078
     1 | (1,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        |   100084
     2 | (2,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        |   100085
     3 | (3,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        |   100086
     1 | (1,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | INS       | NEW        |   100089
     2 | (2,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | INS       | NEW        |   100090
     3 | (3,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | INS       | NEW        |   100091
     1 | (1,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        |   100093
     2 | (2,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        |   100094
     3 | (3,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        |   100095
(23 rows)

-----------------------------
-- Step 4 : for myGroup1, rollback then update tables then set 3 marks
-----------------------------
select * from emaj.emaj_rollback_group('myGroup1','M2',false) order by 1,2;
 rlbk_severity |                  rlbk_message                   
---------------+-------------------------------------------------
 Notice        | 2 tables and 2 sequences effectively processed.
(1 row)

--
set search_path=public,myschema1;
insert into myTbl1 select i, 'DEF', E'\\000'::bytea from generate_series (100,110) as i;
insert into myTbl2 values (3,'GHI','2010-01-02');
delete from myTbl1 where col11 = 1;
--
select emaj.emaj_set_mark_group('myGroup1','M4');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

--
update "myTbl3" set col33 = col33 / 2;
--
select emaj.emaj_set_mark_group('myGroup1','M5');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

--
update myTbl1 set col11 = 99 where col11 = 1;
--
select emaj.emaj_set_mark_group('myGroup1','M6');
 emaj_set_mark_group 
---------------------
                   7
(1 row)

-----------------------------
-- Checking step 4
-----------------------------
-- emaj tables
select mark_id, mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d','%','g'), mark_time_id, mark_is_deleted, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_id;
 mark_id | mark_group | regexp_replace  | mark_time_id | mark_is_deleted | mark_is_rlbk_protected | mark_comment | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
---------+------------+-----------------+--------------+-----------------+------------------------+--------------+---------------------------+------------------------------
   10001 | myGroup1   | M1              |        10003 | f               | f                      |              |                        27 | 
   10002 | myGroup2   | M1              |        10004 | f               | f                      |              |                        41 | 
   10003 | myGroup1   | M2              |        10005 | f               | f                      |              |                        13 | 
   10005 | myGroup2   | M2              |        10007 | f               | f                      |              |                         8 | 
   10006 | myGroup2   | M3              |        10008 | f               | f                      |              |                         0 | 
   10007 | myGroup2   | RLBK_M2_%_START |        10009 | f               | f                      |              |                         6 | 
   10008 | myGroup2   | RLBK_M2_%_DONE  |        10010 | f               | f                      |              |                         0 | M2
   10009 | myGroup2   | RLBK_M3_%_START |        10011 | f               | f                      |              |                         6 | 
   10010 | myGroup2   | RLBK_M3_%_DONE  |        10012 | f               | f                      |              |                           | M3
   10011 | myGroup1   | M4              |        10014 | f               | f                      |              |                        10 | 
   10012 | myGroup1   | M5              |        10015 | f               | f                      |              |                         0 | 
   10013 | myGroup1   | M6              |        10016 | f               | f                      |              |                           | 
(12 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
 sequ_schema |         sequ_name          | sequ_time_id | sequ_last_val | sequ_is_called 
-------------+----------------------------+--------------+---------------+----------------
 emaj        | myschema1_mytbl1_log_seq   |        10003 |             1 | f
 emaj        | myschema1_mytbl2_log_seq   |        10003 |             1 | f
 emaj        | myschema1_mytbl4_log_seq   |        10003 |             1 | f
 emajb       | myschema1_mytbl2b_log_seq  |        10003 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10003 |             1 | f
 myschema1   | mytbl2b_col20_seq          |        10003 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10003 |            11 | f
 emaj        | myschema2_mytbl1_log_seq   |        10004 |             1 | f
 emaj        | myschema2_mytbl2_log_seq   |        10004 |             1 | f
 emaj        | myschema2_mytbl4_log_seq   |        10004 |             1 | f
 emaj        | myschema2_mytbl6_log_seq   |        10004 |             1 | f
 emaj        | otherPrefix4mytbl5_log_seq |        10004 |             1 | f
 emajC       | myschema2_myTbl3_log_seq   |        10004 |             1 | f
 myschema2   | myseq1                     |        10004 |          1000 | f
 myschema2   | myTbl3_col31_seq           |        10004 |            10 | t
 emaj        | myschema1_mytbl1_log_seq   |        10005 |            15 | t
 emaj        | myschema1_mytbl2_log_seq   |        10005 |             2 | t
 emaj        | myschema1_mytbl4_log_seq   |        10005 |             1 | f
 emajb       | myschema1_mytbl2b_log_seq  |        10005 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10005 |            10 | t
 myschema1   | mytbl2b_col20_seq          |        10005 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10005 |            20 | t
 emaj        | myschema2_mytbl1_log_seq   |        10007 |            15 | t
 emaj        | myschema2_mytbl2_log_seq   |        10007 |             2 | t
 emaj        | myschema2_mytbl4_log_seq   |        10007 |             1 | f
 emaj        | myschema2_mytbl6_log_seq   |        10007 |            11 | t
 emaj        | otherPrefix4mytbl5_log_seq |        10007 |             3 | t
 emajC       | myschema2_myTbl3_log_seq   |        10007 |            10 | t
 myschema2   | myseq1                     |        10007 |          1000 | t
 myschema2   | myTbl3_col31_seq           |        10007 |            20 | t
 emaj        | myschema2_mytbl1_log_seq   |        10008 |            15 | t
 emaj        | myschema2_mytbl2_log_seq   |        10008 |             2 | t
 emaj        | myschema2_mytbl4_log_seq   |        10008 |             4 | t
 emaj        | myschema2_mytbl6_log_seq   |        10008 |            14 | t
 emaj        | otherPrefix4mytbl5_log_seq |        10008 |             4 | t
 emajC       | myschema2_myTbl3_log_seq   |        10008 |            10 | t
 myschema2   | myseq1                     |        10008 |          1003 | t
 myschema2   | myTbl3_col31_seq           |        10008 |            20 | t
 emaj        | myschema2_mytbl1_log_seq   |        10009 |            15 | t
 emaj        | myschema2_mytbl2_log_seq   |        10009 |             2 | t
 emaj        | myschema2_mytbl4_log_seq   |        10009 |             4 | t
 emaj        | myschema2_mytbl6_log_seq   |        10009 |            14 | t
 emaj        | otherPrefix4mytbl5_log_seq |        10009 |             4 | t
 emajC       | myschema2_myTbl3_log_seq   |        10009 |            10 | t
 myschema2   | myseq1                     |        10009 |          1003 | t
 myschema2   | myTbl3_col31_seq           |        10009 |            20 | t
 emaj        | myschema2_mytbl1_log_seq   |        10010 |            15 | t
 emaj        | myschema2_mytbl2_log_seq   |        10010 |             2 | t
 emaj        | myschema2_mytbl4_log_seq   |        10010 |             6 | t
 emaj        | myschema2_mytbl6_log_seq   |        10010 |            17 | t
 emaj        | otherPrefix4mytbl5_log_seq |        10010 |             5 | t
 emajC       | myschema2_myTbl3_log_seq   |        10010 |            10 | t
 myschema2   | myseq1                     |        10010 |          1001 | f
 myschema2   | myTbl3_col31_seq           |        10010 |            20 | t
 emaj        | myschema2_mytbl1_log_seq   |        10011 |            15 | t
 emaj        | myschema2_mytbl2_log_seq   |        10011 |             2 | t
 emaj        | myschema2_mytbl4_log_seq   |        10011 |             6 | t
 emaj        | myschema2_mytbl6_log_seq   |        10011 |            17 | t
 emaj        | otherPrefix4mytbl5_log_seq |        10011 |             5 | t
 emajC       | myschema2_myTbl3_log_seq   |        10011 |            10 | t
 myschema2   | myseq1                     |        10011 |          1001 | f
 myschema2   | myTbl3_col31_seq           |        10011 |            20 | t
 emaj        | myschema2_mytbl1_log_seq   |        10012 |            15 | t
 emaj        | myschema2_mytbl2_log_seq   |        10012 |             2 | t
 emaj        | myschema2_mytbl4_log_seq   |        10012 |             8 | t
 emaj        | myschema2_mytbl6_log_seq   |        10012 |            20 | t
 emaj        | otherPrefix4mytbl5_log_seq |        10012 |             6 | t
 emajC       | myschema2_myTbl3_log_seq   |        10012 |            10 | t
 myschema2   | myseq1                     |        10012 |          1004 | f
 myschema2   | myTbl3_col31_seq           |        10012 |            20 | t
 emaj        | myschema1_mytbl1_log_seq   |        10014 |            30 | t
 emaj        | myschema1_mytbl2_log_seq   |        10014 |             3 | t
 emaj        | myschema1_mytbl4_log_seq   |        10014 |             8 | t
 emajb       | myschema1_mytbl2b_log_seq  |        10014 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10014 |            10 | t
 myschema1   | mytbl2b_col20_seq          |        10014 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10014 |            20 | t
 emaj        | myschema1_mytbl1_log_seq   |        10015 |            30 | t
 emaj        | myschema1_mytbl2_log_seq   |        10015 |             3 | t
 emaj        | myschema1_mytbl4_log_seq   |        10015 |             8 | t
 emajb       | myschema1_mytbl2b_log_seq  |        10015 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10015 |            20 | t
 myschema1   | mytbl2b_col20_seq          |        10015 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10015 |            20 | t
 emaj        | myschema1_mytbl1_log_seq   |        10016 |            30 | t
 emaj        | myschema1_mytbl2_log_seq   |        10016 |             3 | t
 emaj        | myschema1_mytbl4_log_seq   |        10016 |             8 | t
 emajb       | myschema1_mytbl2b_log_seq  |        10016 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10016 |            20 | t
 myschema1   | mytbl2b_col20_seq          |        10016 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10016 |            20 | t
(91 rows)

-- user tables
select * from mySchema1.myTbl1 order by col11,col12;
 col11 |   col12    | col13 
-------+------------+-------
     2 | ABC        | \x1c
     3 | ABC        | \x1c
     4 | ABC        | \x0c
     5 | ABC        | \x0c
     6 | ABC        | \x0c
     7 | ABC        | \x0c
     8 | ABC        | \x0c
     9 | ABC        | \x0c
    10 | ABC        | \x0c
   100 | DEF        | \x00
   101 | DEF        | \x00
   102 | DEF        | \x00
   103 | DEF        | \x00
   104 | DEF        | \x00
   105 | DEF        | \x00
   106 | DEF        | \x00
   107 | DEF        | \x00
   108 | DEF        | \x00
   109 | DEF        | \x00
   110 | DEF        | \x00
(20 rows)

select * from mySchema1.myTbl2 order by col21;
 col21 | col22 |   col23    
-------+-------+------------
     1 | ABC   | 12-31-2010
     2 | DEF   | 
     3 | GHI   | 01-02-2010
(3 rows)

select * from mySchema1.myTbl2b order by col20;
 col20 | col21 
-------+-------
(0 rows)

select col31,col33 from mySchema1."myTbl3" order by col31;
 col31 | col33 
-------+-------
    11 |  5.00
    12 |  5.00
    13 |  5.00
    14 |  5.00
    15 |  5.00
    16 |  5.00
    17 |  5.00
    18 |  5.00
    19 |  5.00
    20 |  5.00
(10 rows)

select * from mySchema1.myTbl4 order by col41;
 col41 | col42 | col43 | col44 | col45 
-------+-------+-------+-------+-------
(0 rows)

-- log tables
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema1_myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid 
-------+------------+-------+-----------+------------+----------
     1 | ABC        | \x0c  | INS       | NEW        |   100000
     2 | ABC        | \x0c  | INS       | NEW        |   100001
     3 | ABC        | \x0c  | INS       | NEW        |   100002
     4 | ABC        | \x0c  | INS       | NEW        |   100003
     5 | ABC        | \x0c  | INS       | NEW        |   100004
     6 | ABC        | \x0c  | INS       | NEW        |   100005
     7 | ABC        | \x0c  | INS       | NEW        |   100006
     8 | ABC        | \x0c  | INS       | NEW        |   100007
     9 | ABC        | \x0c  | INS       | NEW        |   100008
    10 | ABC        | \x0c  | INS       | NEW        |   100009
    11 | ABC        | \x0c  | INS       | NEW        |   100010
     1 | ABC        | \x0c  | UPD       | OLD        |   100011
     1 | ABC        | \x1c  | UPD       | NEW        |   100011
     2 | ABC        | \x0c  | UPD       | OLD        |   100012
     2 | ABC        | \x1c  | UPD       | NEW        |   100012
     3 | ABC        | \x0c  | UPD       | OLD        |   100013
     3 | ABC        | \x1c  | UPD       | NEW        |   100013
    11 | ABC        | \x0c  | DEL       | OLD        |   100015
   100 | DEF        | \x00  | INS       | NEW        |   100099
   101 | DEF        | \x00  | INS       | NEW        |   100100
   102 | DEF        | \x00  | INS       | NEW        |   100101
   103 | DEF        | \x00  | INS       | NEW        |   100102
   104 | DEF        | \x00  | INS       | NEW        |   100103
   105 | DEF        | \x00  | INS       | NEW        |   100104
   106 | DEF        | \x00  | INS       | NEW        |   100105
   107 | DEF        | \x00  | INS       | NEW        |   100106
   108 | DEF        | \x00  | INS       | NEW        |   100107
   109 | DEF        | \x00  | INS       | NEW        |   100108
   110 | DEF        | \x00  | INS       | NEW        |   100109
     1 | ABC        | \x1c  | DEL       | OLD        |   100111
(30 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema1_myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 |   col23    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+------------+-----------+------------+----------
     1 | ABC   | 12-31-2010 | INS       | NEW        |   100014
     2 | DEF   |            | INS       | NEW        |   100016
     3 | GHI   | 01-02-2010 | INS       | NEW        |   100110
(3 rows)

select col20, col21, emaj_verb, emaj_tuple, emaj_gid from emajb.mySchema1_myTbl2b_log order by emaj_gid, emaj_tuple desc;
 col20 | col21 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
(0 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid from "emajC"."myschema1_myTbl3_log" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
    11 | 10.00 | INS       | NEW        |   100017
    12 | 10.00 | INS       | NEW        |   100018
    13 | 10.00 | INS       | NEW        |   100019
    14 | 10.00 | INS       | NEW        |   100020
    15 | 10.00 | INS       | NEW        |   100021
    16 | 10.00 | INS       | NEW        |   100022
    17 | 10.00 | INS       | NEW        |   100023
    18 | 10.00 | INS       | NEW        |   100024
    19 | 10.00 | INS       | NEW        |   100025
    20 | 10.00 | INS       | NEW        |   100026
    11 | 10.00 | UPD       | OLD        |   100112
    11 |  5.00 | UPD       | NEW        |   100112
    12 | 10.00 | UPD       | OLD        |   100113
    12 |  5.00 | UPD       | NEW        |   100113
    13 | 10.00 | UPD       | OLD        |   100114
    13 |  5.00 | UPD       | NEW        |   100114
    14 | 10.00 | UPD       | OLD        |   100115
    14 |  5.00 | UPD       | NEW        |   100115
    15 | 10.00 | UPD       | OLD        |   100116
    15 |  5.00 | UPD       | NEW        |   100116
    16 | 10.00 | UPD       | OLD        |   100117
    16 |  5.00 | UPD       | NEW        |   100117
    17 | 10.00 | UPD       | OLD        |   100118
    17 |  5.00 | UPD       | NEW        |   100118
    18 | 10.00 | UPD       | OLD        |   100119
    18 |  5.00 | UPD       | NEW        |   100119
    19 | 10.00 | UPD       | OLD        |   100120
    19 |  5.00 | UPD       | NEW        |   100120
    20 | 10.00 | UPD       | OLD        |   100121
    20 |  5.00 | UPD       | NEW        |   100121
(30 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema1_myTbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 | col45 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+-------+-----------+------------+----------
(0 rows)

-----------------------------
-- Step 5 : for myGroup2, logged rollback again then unlogged rollback 
-----------------------------
select * from emaj.emaj_logged_rollback_group('myGroup2','M2',false) order by 1,2;
WARNING:  _check_fk_groups: The foreign key "mytbl6_col61_fkey" on the table "myschema2.mytbl6" references the table "myschema2.mytbl7" that is outside the groups (myGroup2).
WARNING:  _check_fk_groups: The table "myschema2.mytbl6" is referenced by the foreign key "mytbl8_col81_fkey" on the table "myschema2.mytbl8" that is outside the groups (myGroup2).
 rlbk_severity |                  rlbk_message                   
---------------+-------------------------------------------------
 Notice        | 3 tables and 2 sequences effectively processed.
(1 row)

--
select * from emaj.emaj_rollback_group('myGroup2','M3',false) order by 1,2;
WARNING:  _check_fk_groups: The foreign key "mytbl6_col61_fkey" on the table "myschema2.mytbl6" references the table "myschema2.mytbl7" that is outside the groups (myGroup2).
WARNING:  _check_fk_groups: The table "myschema2.mytbl6" is referenced by the foreign key "mytbl8_col81_fkey" on the table "myschema2.mytbl8" that is outside the groups (myGroup2).
 rlbk_severity |                  rlbk_message                   
---------------+-------------------------------------------------
 Notice        | 3 tables and 2 sequences effectively processed.
(1 row)

-----------------------------
-- Checking step 5
-----------------------------
-- emaj tables
select mark_id, mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d','%','g'), mark_time_id, mark_is_deleted, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_id;
 mark_id | mark_group | regexp_replace | mark_time_id | mark_is_deleted | mark_is_rlbk_protected | mark_comment | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
---------+------------+----------------+--------------+-----------------+------------------------+--------------+---------------------------+------------------------------
   10001 | myGroup1   | M1             |        10003 | f               | f                      |              |                        27 | 
   10002 | myGroup2   | M1             |        10004 | f               | f                      |              |                        41 | 
   10003 | myGroup1   | M2             |        10005 | f               | f                      |              |                        13 | 
   10005 | myGroup2   | M2             |        10007 | f               | f                      |              |                         8 | 
   10006 | myGroup2   | M3             |        10008 | f               | f                      |              |                           | 
   10011 | myGroup1   | M4             |        10014 | f               | f                      |              |                        10 | 
   10012 | myGroup1   | M5             |        10015 | f               | f                      |              |                         0 | 
   10013 | myGroup1   | M6             |        10016 | f               | f                      |              |                           | 
(8 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
 sequ_schema |         sequ_name          | sequ_time_id | sequ_last_val | sequ_is_called 
-------------+----------------------------+--------------+---------------+----------------
 emaj        | myschema1_mytbl1_log_seq   |        10003 |             1 | f
 emaj        | myschema1_mytbl2_log_seq   |        10003 |             1 | f
 emaj        | myschema1_mytbl4_log_seq   |        10003 |             1 | f
 emajb       | myschema1_mytbl2b_log_seq  |        10003 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10003 |             1 | f
 myschema1   | mytbl2b_col20_seq          |        10003 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10003 |            11 | f
 emaj        | myschema2_mytbl1_log_seq   |        10004 |             1 | f
 emaj        | myschema2_mytbl2_log_seq   |        10004 |             1 | f
 emaj        | myschema2_mytbl4_log_seq   |        10004 |             1 | f
 emaj        | myschema2_mytbl6_log_seq   |        10004 |             1 | f
 emaj        | otherPrefix4mytbl5_log_seq |        10004 |             1 | f
 emajC       | myschema2_myTbl3_log_seq   |        10004 |             1 | f
 myschema2   | myseq1                     |        10004 |          1000 | f
 myschema2   | myTbl3_col31_seq           |        10004 |            10 | t
 emaj        | myschema1_mytbl1_log_seq   |        10005 |            15 | t
 emaj        | myschema1_mytbl2_log_seq   |        10005 |             2 | t
 emaj        | myschema1_mytbl4_log_seq   |        10005 |             1 | f
 emajb       | myschema1_mytbl2b_log_seq  |        10005 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10005 |            10 | t
 myschema1   | mytbl2b_col20_seq          |        10005 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10005 |            20 | t
 emaj        | myschema2_mytbl1_log_seq   |        10007 |            15 | t
 emaj        | myschema2_mytbl2_log_seq   |        10007 |             2 | t
 emaj        | myschema2_mytbl4_log_seq   |        10007 |             1 | f
 emaj        | myschema2_mytbl6_log_seq   |        10007 |            11 | t
 emaj        | otherPrefix4mytbl5_log_seq |        10007 |             3 | t
 emajC       | myschema2_myTbl3_log_seq   |        10007 |            10 | t
 myschema2   | myseq1                     |        10007 |          1000 | t
 myschema2   | myTbl3_col31_seq           |        10007 |            20 | t
 emaj        | myschema2_mytbl1_log_seq   |        10008 |            15 | t
 emaj        | myschema2_mytbl2_log_seq   |        10008 |             2 | t
 emaj        | myschema2_mytbl4_log_seq   |        10008 |             4 | t
 emaj        | myschema2_mytbl6_log_seq   |        10008 |            14 | t
 emaj        | otherPrefix4mytbl5_log_seq |        10008 |             4 | t
 emajC       | myschema2_myTbl3_log_seq   |        10008 |            10 | t
 myschema2   | myseq1                     |        10008 |          1003 | t
 myschema2   | myTbl3_col31_seq           |        10008 |            20 | t
 emaj        | myschema1_mytbl1_log_seq   |        10014 |            30 | t
 emaj        | myschema1_mytbl2_log_seq   |        10014 |             3 | t
 emaj        | myschema1_mytbl4_log_seq   |        10014 |             8 | t
 emajb       | myschema1_mytbl2b_log_seq  |        10014 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10014 |            10 | t
 myschema1   | mytbl2b_col20_seq          |        10014 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10014 |            20 | t
 emaj        | myschema1_mytbl1_log_seq   |        10015 |            30 | t
 emaj        | myschema1_mytbl2_log_seq   |        10015 |             3 | t
 emaj        | myschema1_mytbl4_log_seq   |        10015 |             8 | t
 emajb       | myschema1_mytbl2b_log_seq  |        10015 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10015 |            20 | t
 myschema1   | mytbl2b_col20_seq          |        10015 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10015 |            20 | t
 emaj        | myschema1_mytbl1_log_seq   |        10016 |            30 | t
 emaj        | myschema1_mytbl2_log_seq   |        10016 |             3 | t
 emaj        | myschema1_mytbl4_log_seq   |        10016 |             8 | t
 emajb       | myschema1_mytbl2b_log_seq  |        10016 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10016 |            20 | t
 myschema1   | mytbl2b_col20_seq          |        10016 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10016 |            20 | t
(59 rows)

select sqhl_schema, sqhl_table, sqhl_begin_time_id, sqhl_end_time_id, sqhl_hole_size from emaj.emaj_seq_hole order by 1,2,3;
 sqhl_schema | sqhl_table | sqhl_begin_time_id | sqhl_end_time_id | sqhl_hole_size 
-------------+------------+--------------------+------------------+----------------
 myschema1   | mytbl1     |              10005 |            10013 |              3
 myschema1   | mytbl4     |              10005 |            10013 |              8
 myschema2   | mytbl4     |              10008 |            10019 |              6
 myschema2   | mytbl5     |              10008 |            10019 |              3
 myschema2   | mytbl6     |              10008 |            10019 |              9
(5 rows)

-- user tables
select * from mySchema2.myTbl1 order by col11,col12;
 col11 |   col12    | col13 
-------+------------+-------
     1 | ABC        | \x1c
     2 | ABC        | \x1c
     3 | ABC        | \x1c
     4 | ABC        | \x0c
     5 | ABC        | \x0c
     6 | ABC        | \x0c
     7 | ABC        | \x0c
     8 | ABC        | \x0c
     9 | ABC        | \x0c
    10 | ABC        | \x0c
(10 rows)

select * from mySchema2.myTbl2 order by col21;
 col21 | col22 |   col23    
-------+-------+------------
     1 | ABC   | 01-01-2010
     2 | DEF   | 
(2 rows)

select col31,col33 from mySchema2."myTbl3" order by col31;
 col31 | col33 
-------+-------
    11 | 10.00
    12 | 10.00
    13 | 10.00
    14 | 10.00
    15 | 10.00
    16 | 10.00
    17 | 10.00
    18 | 10.00
    19 | 10.00
    20 | 10.00
(10 rows)

select * from mySchema2.myTbl4 order by col41;
 col41 | col42 | col43 | col44 |   col45    
-------+-------+-------+-------+------------
     1 | FK... |     2 |     1 | ABC       
     2 | FK... |     2 |     1 | ABC       
(2 rows)

select * from mySchema2.myTbl5 order by col51;
 col51 |     col52     |  col53  |          col54          
-------+---------------+---------+-------------------------
     1 | {abc,def,ghi} | {1,2,3} | {11-28-2010,12-03-2010}
(1 row)

select * from mySchema2.myTbl6 order by col61;
 col61 |  col62  |    col63    |   col64   |         col65         |     col66      
-------+---------+-------------+-----------+-----------------------+----------------
     0 |         |             |           |                       | 
     4 | (4,1.3) | (2,2),(0,0) | <(5,5),4> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
     5 | (5,1.3) | (2,2),(0,0) | <(5,5),5> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
     6 | (6,1.3) | (2,2),(0,0) | <(5,5),6> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
     7 | (7,1.3) | (2,2),(0,0) | <(5,5),7> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
     8 | (8,1.3) | (2,2),(0,0) | <(5,5),8> | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27
(6 rows)

-- log tables
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema2_myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid 
-------+------------+-------+-----------+------------+----------
     1 | ABC        | \x0c  | INS       | NEW        |   100038
     2 | ABC        | \x0c  | INS       | NEW        |   100039
     3 | ABC        | \x0c  | INS       | NEW        |   100040
     4 | ABC        | \x0c  | INS       | NEW        |   100041
     5 | ABC        | \x0c  | INS       | NEW        |   100042
     6 | ABC        | \x0c  | INS       | NEW        |   100043
     7 | ABC        | \x0c  | INS       | NEW        |   100044
     8 | ABC        | \x0c  | INS       | NEW        |   100045
     9 | ABC        | \x0c  | INS       | NEW        |   100046
    10 | ABC        | \x0c  | INS       | NEW        |   100047
    11 | ABC        | \x0c  | INS       | NEW        |   100048
     1 | ABC        | \x0c  | UPD       | OLD        |   100049
     1 | ABC        | \x1c  | UPD       | NEW        |   100049
     2 | ABC        | \x0c  | UPD       | OLD        |   100050
     2 | ABC        | \x1c  | UPD       | NEW        |   100050
     3 | ABC        | \x0c  | UPD       | OLD        |   100051
     3 | ABC        | \x1c  | UPD       | NEW        |   100051
    11 | ABC        | \x0c  | DEL       | OLD        |   100053
(18 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema2_myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 |   col23    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+------------+-----------+------------+----------
     1 | ABC   | 01-01-2010 | INS       | NEW        |   100052
     2 | DEF   |            | INS       | NEW        |   100054
(2 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid from "emajC"."myschema2_myTbl3_log" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
    11 | 10.00 | INS       | NEW        |   100055
    12 | 10.00 | INS       | NEW        |   100056
    13 | 10.00 | INS       | NEW        |   100057
    14 | 10.00 | INS       | NEW        |   100058
    15 | 10.00 | INS       | NEW        |   100059
    16 | 10.00 | INS       | NEW        |   100060
    17 | 10.00 | INS       | NEW        |   100061
    18 | 10.00 | INS       | NEW        |   100062
    19 | 10.00 | INS       | NEW        |   100063
    20 | 10.00 | INS       | NEW        |   100064
(10 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema2_myTbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 |   col45    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+------------+-----------+------------+----------
     1 | FK... |     1 |     1 | ABC        | INS       | NEW        |   100079
     2 | FK... |     1 |     1 | ABC        | INS       | NEW        |   100080
     1 | FK... |     1 |     1 | ABC        | UPD       | OLD        |   100081
     1 | FK... |     2 |     1 | ABC        | UPD       | NEW        |   100081
     2 | FK... |     1 |     1 | ABC        | UPD       | OLD        |   100082
     2 | FK... |     2 |     1 | ABC        | UPD       | NEW        |   100082
(6 rows)

select col51, col52, col53, col54, emaj_verb, emaj_tuple, emaj_gid from emaj."otherPrefix4mytbl5_log" order by emaj_gid, emaj_tuple desc;
 col51 |     col52     |  col53  |          col54          | emaj_verb | emaj_tuple | emaj_gid 
-------+---------------+---------+-------------------------+-----------+------------+----------
     1 | {abc,def,ghi} | {1,2,3} |                         | INS       | NEW        |   100065
     2 | {abc,def,ghi} | {3,4,5} | {02-01-2000,02-28-2000} | INS       | NEW        |   100066
     1 | {abc,def,ghi} | {1,2,3} |                         | UPD       | OLD        |   100067
     1 | {abc,def,ghi} | {1,2,3} | {11-28-2010,12-03-2010} | UPD       | NEW        |   100067
     2 | {abc,def,ghi} | {3,4,5} | {02-01-2000,02-28-2000} | DEL       | OLD        |   100083
(5 rows)

select col61, col62, col63, col64, col65, col66, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema2_myTbl6_log order by emaj_gid, emaj_tuple desc;
 col61 |  col62  |    col63    |    col64    |         col65         |     col66      | emaj_verb | emaj_tuple | emaj_gid 
-------+---------+-------------+-------------+-----------------------+----------------+-----------+------------+----------
     1 | (1,1.3) | (2,2),(0,0) | <(5,5),1>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100068
     2 | (2,1.3) | (2,2),(0,0) | <(5,5),2>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100069
     3 | (3,1.3) | (2,2),(0,0) | <(5,5),3>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100070
     4 | (4,1.3) | (2,2),(0,0) | <(5,5),4>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100071
     5 | (5,1.3) | (2,2),(0,0) | <(5,5),5>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100072
     6 | (6,1.3) | (2,2),(0,0) | <(5,5),6>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100073
     7 | (7,1.3) | (2,2),(0,0) | <(5,5),7>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100074
     8 | (8,1.3) | (2,2),(0,0) | <(5,5),8>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | INS       | NEW        |   100075
     1 | (1,1.3) | (2,2),(0,0) | <(5,5),1>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | UPD       | OLD        |   100076
     1 | (1,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | UPD       | NEW        |   100076
     2 | (2,1.3) | (2,2),(0,0) | <(5,5),2>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | UPD       | OLD        |   100077
     2 | (2,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | UPD       | NEW        |   100077
     3 | (3,1.3) | (2,2),(0,0) | <(5,5),3>   | ((-2,-2),(3,0),(1,4)) | 10.20.30.40/27 | UPD       | OLD        |   100078
     3 | (3,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | UPD       | NEW        |   100078
     1 | (1,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        |   100084
     2 | (2,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        |   100085
     3 | (3,1.3) | (2,2),(0,0) | <(5,6),3.5> |                       | 10.20.30.40/27 | DEL       | OLD        |   100086
(17 rows)

-----------------------------
-- Step 6 : for myGroup1, update tables, rollback, other updates, then logged rollback
-----------------------------
set search_path=public,myschema1;
--
insert into myTbl1 values (1, 'Step 6', E'\\000'::bytea);
insert into myTbl4 values (11,'FK...',1,1,'Step 6');
insert into myTbl4 values (12,'FK...',1,1,'Step 6');
--
select * from emaj.emaj_rollback_group('myGroup1','M5',false) order by 1,2;
 rlbk_severity |                  rlbk_message                   
---------------+-------------------------------------------------
 Notice        | 2 tables and 2 sequences effectively processed.
(1 row)

--
insert into myTbl1 values (1, 'Step 6', E'\\001'::bytea);
insert into myTbl4 values (11,'',1,1,'Step 6');
insert into myTbl4 values (12,'',1,1,'Step 6');
--
-- for an equivalent of "select * from emaj.emaj_logged_rollback_group('myGroup1','M4',true);"
select * from emaj._rlbk_async(emaj._rlbk_init(array['myGroup1'], 'M4', true, 1, false, true), false, true);
 rlbk_severity |                  rlbk_message                   
---------------+-------------------------------------------------
 Notice        | 3 tables and 2 sequences effectively processed.
(1 row)

-- and check the rollback result
select rlbk_id, rlbk_groups, rlbk_mark, rlbk_time_id, rlbk_is_logged, rlbk_is_alter_group_allowed, rlbk_nb_session, rlbk_nb_table, rlbk_nb_sequence, 
       rlbk_eff_nb_table, rlbk_status, rlbk_msg
 from emaj.emaj_rlbk order by rlbk_id desc limit 1;
 rlbk_id | rlbk_groups | rlbk_mark | rlbk_time_id | rlbk_is_logged | rlbk_is_alter_group_allowed | rlbk_nb_session | rlbk_nb_table | rlbk_nb_sequence | rlbk_eff_nb_table | rlbk_status |                         rlbk_msg                          
---------+-------------+-----------+--------------+----------------+-----------------------------+-----------------+---------------+------------------+-------------------+-------------+-----------------------------------------------------------
   10006 | {myGroup1}  | M4        |        10021 | t              | t                           |               1 |             5 |                2 |                 3 | COMPLETED   | Completed: 3 tables and 2 sequences effectively processed
(1 row)

-----------------------------
-- Checking step 6
-----------------------------
-- emaj tables
select mark_id, mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d','%','g'), mark_time_id, mark_is_deleted, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_id;
 mark_id | mark_group | regexp_replace  | mark_time_id | mark_is_deleted | mark_is_rlbk_protected | mark_comment | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
---------+------------+-----------------+--------------+-----------------+------------------------+--------------+---------------------------+------------------------------
   10001 | myGroup1   | M1              |        10003 | f               | f                      |              |                        27 | 
   10002 | myGroup2   | M1              |        10004 | f               | f                      |              |                        41 | 
   10003 | myGroup1   | M2              |        10005 | f               | f                      |              |                        13 | 
   10005 | myGroup2   | M2              |        10007 | f               | f                      |              |                         8 | 
   10006 | myGroup2   | M3              |        10008 | f               | f                      |              |                           | 
   10011 | myGroup1   | M4              |        10014 | f               | f                      |              |                        10 | 
   10012 | myGroup1   | M5              |        10015 | f               | f                      |              |                         3 | 
   10016 | myGroup1   | RLBK_M4_%_START |        10021 | f               | f                      |              |                        23 | 
   10017 | myGroup1   | RLBK_M4_%_DONE  |        10022 | f               | f                      |              |                           | M4
(9 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
 sequ_schema |         sequ_name          | sequ_time_id | sequ_last_val | sequ_is_called 
-------------+----------------------------+--------------+---------------+----------------
 emaj        | myschema1_mytbl1_log_seq   |        10003 |             1 | f
 emaj        | myschema1_mytbl2_log_seq   |        10003 |             1 | f
 emaj        | myschema1_mytbl4_log_seq   |        10003 |             1 | f
 emajb       | myschema1_mytbl2b_log_seq  |        10003 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10003 |             1 | f
 myschema1   | mytbl2b_col20_seq          |        10003 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10003 |            11 | f
 emaj        | myschema2_mytbl1_log_seq   |        10004 |             1 | f
 emaj        | myschema2_mytbl2_log_seq   |        10004 |             1 | f
 emaj        | myschema2_mytbl4_log_seq   |        10004 |             1 | f
 emaj        | myschema2_mytbl6_log_seq   |        10004 |             1 | f
 emaj        | otherPrefix4mytbl5_log_seq |        10004 |             1 | f
 emajC       | myschema2_myTbl3_log_seq   |        10004 |             1 | f
 myschema2   | myseq1                     |        10004 |          1000 | f
 myschema2   | myTbl3_col31_seq           |        10004 |            10 | t
 emaj        | myschema1_mytbl1_log_seq   |        10005 |            15 | t
 emaj        | myschema1_mytbl2_log_seq   |        10005 |             2 | t
 emaj        | myschema1_mytbl4_log_seq   |        10005 |             1 | f
 emajb       | myschema1_mytbl2b_log_seq  |        10005 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10005 |            10 | t
 myschema1   | mytbl2b_col20_seq          |        10005 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10005 |            20 | t
 emaj        | myschema2_mytbl1_log_seq   |        10007 |            15 | t
 emaj        | myschema2_mytbl2_log_seq   |        10007 |             2 | t
 emaj        | myschema2_mytbl4_log_seq   |        10007 |             1 | f
 emaj        | myschema2_mytbl6_log_seq   |        10007 |            11 | t
 emaj        | otherPrefix4mytbl5_log_seq |        10007 |             3 | t
 emajC       | myschema2_myTbl3_log_seq   |        10007 |            10 | t
 myschema2   | myseq1                     |        10007 |          1000 | t
 myschema2   | myTbl3_col31_seq           |        10007 |            20 | t
 emaj        | myschema2_mytbl1_log_seq   |        10008 |            15 | t
 emaj        | myschema2_mytbl2_log_seq   |        10008 |             2 | t
 emaj        | myschema2_mytbl4_log_seq   |        10008 |             4 | t
 emaj        | myschema2_mytbl6_log_seq   |        10008 |            14 | t
 emaj        | otherPrefix4mytbl5_log_seq |        10008 |             4 | t
 emajC       | myschema2_myTbl3_log_seq   |        10008 |            10 | t
 myschema2   | myseq1                     |        10008 |          1003 | t
 myschema2   | myTbl3_col31_seq           |        10008 |            20 | t
 emaj        | myschema1_mytbl1_log_seq   |        10014 |            30 | t
 emaj        | myschema1_mytbl2_log_seq   |        10014 |             3 | t
 emaj        | myschema1_mytbl4_log_seq   |        10014 |             8 | t
 emajb       | myschema1_mytbl2b_log_seq  |        10014 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10014 |            10 | t
 myschema1   | mytbl2b_col20_seq          |        10014 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10014 |            20 | t
 emaj        | myschema1_mytbl1_log_seq   |        10015 |            30 | t
 emaj        | myschema1_mytbl2_log_seq   |        10015 |             3 | t
 emaj        | myschema1_mytbl4_log_seq   |        10015 |             8 | t
 emajb       | myschema1_mytbl2b_log_seq  |        10015 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10015 |            20 | t
 myschema1   | mytbl2b_col20_seq          |        10015 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10015 |            20 | t
 emaj        | myschema1_mytbl1_log_seq   |        10021 |            32 | t
 emaj        | myschema1_mytbl2_log_seq   |        10021 |             3 | t
 emaj        | myschema1_mytbl4_log_seq   |        10021 |            12 | t
 emajb       | myschema1_mytbl2b_log_seq  |        10021 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10021 |            20 | t
 myschema1   | mytbl2b_col20_seq          |        10021 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10021 |            20 | t
 emaj        | myschema1_mytbl1_log_seq   |        10022 |            33 | t
 emaj        | myschema1_mytbl2_log_seq   |        10022 |             3 | t
 emaj        | myschema1_mytbl4_log_seq   |        10022 |            14 | t
 emajb       | myschema1_mytbl2b_log_seq  |        10022 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10022 |            40 | t
 myschema1   | mytbl2b_col20_seq          |        10022 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10022 |            20 | t
(66 rows)

-- check that mark_log_stat_before_next column is always equal to either NULL or the emaj_log_stat_rows() function's result
-- this should always return 0 row
select * from 
  (select mark_id, mark_group, mark_name, mark_log_rows_before_next - 
    (select sum(stat_rows) from emaj.emaj_log_stat_group(mark_group, mark_name, 
      (select mark_name from emaj.emaj_mark m2 where m2.mark_group = m1.mark_group and m2.mark_id > m1.mark_id order by mark_id limit 1))
    ) as checked_stat_rows from emaj.emaj_mark m1 where mark_log_rows_before_next is not null
  ) as t 
  where checked_stat_rows <> 0;
 mark_id | mark_group | mark_name | checked_stat_rows 
---------+------------+-----------+-------------------
(0 rows)

--
select sqhl_schema, sqhl_table, sqhl_begin_time_id, sqhl_end_time_id, sqhl_hole_size from emaj.emaj_seq_hole order by 1,2,3;
 sqhl_schema | sqhl_table | sqhl_begin_time_id | sqhl_end_time_id | sqhl_hole_size 
-------------+------------+--------------------+------------------+----------------
 myschema1   | mytbl1     |              10005 |            10013 |              3
 myschema1   | mytbl1     |              10015 |            10020 |              1
 myschema1   | mytbl4     |              10005 |            10013 |              8
 myschema1   | mytbl4     |              10015 |            10020 |              2
 myschema2   | mytbl4     |              10008 |            10019 |              6
 myschema2   | mytbl5     |              10008 |            10019 |              3
 myschema2   | mytbl6     |              10008 |            10019 |              9
(7 rows)

-- user tables
select * from mySchema1.myTbl1 order by col11,col12;
 col11 |   col12    | col13 
-------+------------+-------
     2 | ABC        | \x1c
     3 | ABC        | \x1c
     4 | ABC        | \x0c
     5 | ABC        | \x0c
     6 | ABC        | \x0c
     7 | ABC        | \x0c
     8 | ABC        | \x0c
     9 | ABC        | \x0c
    10 | ABC        | \x0c
   100 | DEF        | \x00
   101 | DEF        | \x00
   102 | DEF        | \x00
   103 | DEF        | \x00
   104 | DEF        | \x00
   105 | DEF        | \x00
   106 | DEF        | \x00
   107 | DEF        | \x00
   108 | DEF        | \x00
   109 | DEF        | \x00
   110 | DEF        | \x00
(20 rows)

select * from mySchema1.myTbl2 order by col21;
 col21 | col22 |   col23    
-------+-------+------------
     1 | ABC   | 12-31-2010
     2 | DEF   | 
     3 | GHI   | 01-02-2010
(3 rows)

select * from mySchema1.myTbl2b order by col20;
 col20 | col21 
-------+-------
(0 rows)

select col31,col33 from mySchema1."myTbl3" order by col31;
 col31 | col33 
-------+-------
    11 | 10.00
    12 | 10.00
    13 | 10.00
    14 | 10.00
    15 | 10.00
    16 | 10.00
    17 | 10.00
    18 | 10.00
    19 | 10.00
    20 | 10.00
(10 rows)

select * from mySchema1.myTbl4 order by col41;
 col41 | col42 | col43 | col44 | col45 
-------+-------+-------+-------+-------
(0 rows)

-- log tables
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema1_myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid 
-------+------------+-------+-----------+------------+----------
     1 | ABC        | \x0c  | INS       | NEW        |   100000
     2 | ABC        | \x0c  | INS       | NEW        |   100001
     3 | ABC        | \x0c  | INS       | NEW        |   100002
     4 | ABC        | \x0c  | INS       | NEW        |   100003
     5 | ABC        | \x0c  | INS       | NEW        |   100004
     6 | ABC        | \x0c  | INS       | NEW        |   100005
     7 | ABC        | \x0c  | INS       | NEW        |   100006
     8 | ABC        | \x0c  | INS       | NEW        |   100007
     9 | ABC        | \x0c  | INS       | NEW        |   100008
    10 | ABC        | \x0c  | INS       | NEW        |   100009
    11 | ABC        | \x0c  | INS       | NEW        |   100010
     1 | ABC        | \x0c  | UPD       | OLD        |   100011
     1 | ABC        | \x1c  | UPD       | NEW        |   100011
     2 | ABC        | \x0c  | UPD       | OLD        |   100012
     2 | ABC        | \x1c  | UPD       | NEW        |   100012
     3 | ABC        | \x0c  | UPD       | OLD        |   100013
     3 | ABC        | \x1c  | UPD       | NEW        |   100013
    11 | ABC        | \x0c  | DEL       | OLD        |   100015
   100 | DEF        | \x00  | INS       | NEW        |   100099
   101 | DEF        | \x00  | INS       | NEW        |   100100
   102 | DEF        | \x00  | INS       | NEW        |   100101
   103 | DEF        | \x00  | INS       | NEW        |   100102
   104 | DEF        | \x00  | INS       | NEW        |   100103
   105 | DEF        | \x00  | INS       | NEW        |   100104
   106 | DEF        | \x00  | INS       | NEW        |   100105
   107 | DEF        | \x00  | INS       | NEW        |   100106
   108 | DEF        | \x00  | INS       | NEW        |   100107
   109 | DEF        | \x00  | INS       | NEW        |   100108
   110 | DEF        | \x00  | INS       | NEW        |   100109
     1 | ABC        | \x1c  | DEL       | OLD        |   100111
     1 | Step 6     | \x01  | INS       | NEW        |   100131
     1 | Step 6     | \x01  | DEL       | OLD        |   100154
(32 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema1_myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 |   col23    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+------------+-----------+------------+----------
     1 | ABC   | 12-31-2010 | INS       | NEW        |   100014
     2 | DEF   |            | INS       | NEW        |   100016
     3 | GHI   | 01-02-2010 | INS       | NEW        |   100110
(3 rows)

select col20, col21, emaj_verb, emaj_tuple, emaj_gid from emajb.mySchema1_myTbl2b_log order by emaj_gid, emaj_tuple desc;
 col20 | col21 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
(0 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid from "emajC"."myschema1_myTbl3_log" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
    11 | 10.00 | INS       | NEW        |   100017
    12 | 10.00 | INS       | NEW        |   100018
    13 | 10.00 | INS       | NEW        |   100019
    14 | 10.00 | INS       | NEW        |   100020
    15 | 10.00 | INS       | NEW        |   100021
    16 | 10.00 | INS       | NEW        |   100022
    17 | 10.00 | INS       | NEW        |   100023
    18 | 10.00 | INS       | NEW        |   100024
    19 | 10.00 | INS       | NEW        |   100025
    20 | 10.00 | INS       | NEW        |   100026
    11 | 10.00 | UPD       | OLD        |   100112
    11 |  5.00 | UPD       | NEW        |   100112
    12 | 10.00 | UPD       | OLD        |   100113
    12 |  5.00 | UPD       | NEW        |   100113
    13 | 10.00 | UPD       | OLD        |   100114
    13 |  5.00 | UPD       | NEW        |   100114
    14 | 10.00 | UPD       | OLD        |   100115
    14 |  5.00 | UPD       | NEW        |   100115
    15 | 10.00 | UPD       | OLD        |   100116
    15 |  5.00 | UPD       | NEW        |   100116
    16 | 10.00 | UPD       | OLD        |   100117
    16 |  5.00 | UPD       | NEW        |   100117
    17 | 10.00 | UPD       | OLD        |   100118
    17 |  5.00 | UPD       | NEW        |   100118
    18 | 10.00 | UPD       | OLD        |   100119
    18 |  5.00 | UPD       | NEW        |   100119
    19 | 10.00 | UPD       | OLD        |   100120
    19 |  5.00 | UPD       | NEW        |   100120
    20 | 10.00 | UPD       | OLD        |   100121
    20 |  5.00 | UPD       | NEW        |   100121
    11 |  5.00 | DEL       | OLD        |   100134
    12 |  5.00 | DEL       | OLD        |   100135
    13 |  5.00 | DEL       | OLD        |   100136
    14 |  5.00 | DEL       | OLD        |   100137
    15 |  5.00 | DEL       | OLD        |   100138
    16 |  5.00 | DEL       | OLD        |   100139
    17 |  5.00 | DEL       | OLD        |   100140
    18 |  5.00 | DEL       | OLD        |   100141
    19 |  5.00 | DEL       | OLD        |   100142
    20 |  5.00 | DEL       | OLD        |   100143
    11 | 10.00 | INS       | NEW        |   100144
    12 | 10.00 | INS       | NEW        |   100145
    13 | 10.00 | INS       | NEW        |   100146
    14 | 10.00 | INS       | NEW        |   100147
    15 | 10.00 | INS       | NEW        |   100148
    16 | 10.00 | INS       | NEW        |   100149
    17 | 10.00 | INS       | NEW        |   100150
    18 | 10.00 | INS       | NEW        |   100151
    19 | 10.00 | INS       | NEW        |   100152
    20 | 10.00 | INS       | NEW        |   100153
(50 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema1_myTbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 |   col45    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+------------+-----------+------------+----------
    11 |       |     1 |     1 | Step 6     | INS       | NEW        |   100132
    12 |       |     1 |     1 | Step 6     | INS       | NEW        |   100133
    11 |       |     1 |     1 | Step 6     | DEL       | OLD        |   100155
    12 |       |     1 |     1 | Step 6     | DEL       | OLD        |   100156
(4 rows)

-----------------------------
-- Step 7 : for myGroup1, update tables, rename a mark, then delete 2 marks then delete all before a mark 
-----------------------------
set search_path=public,myschema1;
--
delete from "myTbl3" where col31 = 14;
delete from "myTbl3" where col31 = 15;
delete from "myTbl3" where col31 = 16;
delete from "myTbl3" where col31 = 17;
delete from "myTbl3" where col31 = 18;
--
select emaj.emaj_rename_mark_group('myGroup1',mark_name,'Before logged rollback to M4') from emaj.emaj_mark where mark_name like 'RLBK_M4_%_START';
 emaj_rename_mark_group 
------------------------
 
(1 row)

-- 
select emaj.emaj_delete_mark_group('myGroup1',mark_name) from emaj.emaj_mark where mark_name like 'RLBK_M4_%_DONE';
 emaj_delete_mark_group 
------------------------
                      1
(1 row)

select emaj.emaj_delete_mark_group('myGroup1','M1');
 emaj_delete_mark_group 
------------------------
                      1
(1 row)

--
select emaj.emaj_delete_before_mark_group('myGroup1','M4');
 emaj_delete_before_mark_group 
-------------------------------
                             1
(1 row)

-----------------------------
-- Checking step 7
-----------------------------
-- emaj tables
select mark_id, mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d','%','g'), mark_time_id, mark_is_deleted, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_id;
 mark_id | mark_group |        regexp_replace        | mark_time_id | mark_is_deleted | mark_is_rlbk_protected | mark_comment | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
---------+------------+------------------------------+--------------+-----------------+------------------------+--------------+---------------------------+------------------------------
   10002 | myGroup2   | M1                           |        10004 | f               | f                      |              |                        41 | 
   10005 | myGroup2   | M2                           |        10007 | f               | f                      |              |                         8 | 
   10006 | myGroup2   | M3                           |        10008 | f               | f                      |              |                           | 
   10011 | myGroup1   | M4                           |        10014 | f               | f                      |              |                        10 | 
   10012 | myGroup1   | M5                           |        10015 | f               | f                      |              |                         3 | 
   10016 | myGroup1   | Before logged rollback to M4 |        10021 | f               | f                      |              |                           | 
(6 rows)

select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp where time_id >= 10000 order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
   10000 |              99999 | M
   10001 |              99999 | C
   10002 |              99999 | C
   10003 |              99999 | M
   10004 |              99999 | M
   10005 |             100026 | M
   10006 |             100037 | M
   10007 |             100078 | M
   10008 |             100086 | M
   10009 |             100086 | R
   10010 |             100092 | M
   10011 |             100092 | R
   10012 |             100098 | M
   10013 |             100098 | R
   10014 |             100111 | M
   10015 |             100121 | M
   10016 |             100121 | M
   10017 |             100121 | R
   10018 |             100127 | M
   10019 |             100127 | R
   10020 |             100130 | R
   10021 |             100133 | R
   10022 |             100156 | M
(23 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
 sequ_schema |         sequ_name          | sequ_time_id | sequ_last_val | sequ_is_called 
-------------+----------------------------+--------------+---------------+----------------
 emaj        | myschema2_mytbl1_log_seq   |        10004 |             1 | f
 emaj        | myschema2_mytbl2_log_seq   |        10004 |             1 | f
 emaj        | myschema2_mytbl4_log_seq   |        10004 |             1 | f
 emaj        | myschema2_mytbl6_log_seq   |        10004 |             1 | f
 emaj        | otherPrefix4mytbl5_log_seq |        10004 |             1 | f
 emajC       | myschema2_myTbl3_log_seq   |        10004 |             1 | f
 myschema2   | myseq1                     |        10004 |          1000 | f
 myschema2   | myTbl3_col31_seq           |        10004 |            10 | t
 emaj        | myschema2_mytbl1_log_seq   |        10007 |            15 | t
 emaj        | myschema2_mytbl2_log_seq   |        10007 |             2 | t
 emaj        | myschema2_mytbl4_log_seq   |        10007 |             1 | f
 emaj        | myschema2_mytbl6_log_seq   |        10007 |            11 | t
 emaj        | otherPrefix4mytbl5_log_seq |        10007 |             3 | t
 emajC       | myschema2_myTbl3_log_seq   |        10007 |            10 | t
 myschema2   | myseq1                     |        10007 |          1000 | t
 myschema2   | myTbl3_col31_seq           |        10007 |            20 | t
 emaj        | myschema2_mytbl1_log_seq   |        10008 |            15 | t
 emaj        | myschema2_mytbl2_log_seq   |        10008 |             2 | t
 emaj        | myschema2_mytbl4_log_seq   |        10008 |             4 | t
 emaj        | myschema2_mytbl6_log_seq   |        10008 |            14 | t
 emaj        | otherPrefix4mytbl5_log_seq |        10008 |             4 | t
 emajC       | myschema2_myTbl3_log_seq   |        10008 |            10 | t
 myschema2   | myseq1                     |        10008 |          1003 | t
 myschema2   | myTbl3_col31_seq           |        10008 |            20 | t
 emaj        | myschema1_mytbl1_log_seq   |        10014 |            30 | t
 emaj        | myschema1_mytbl2_log_seq   |        10014 |             3 | t
 emaj        | myschema1_mytbl4_log_seq   |        10014 |             8 | t
 emajb       | myschema1_mytbl2b_log_seq  |        10014 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10014 |            10 | t
 myschema1   | mytbl2b_col20_seq          |        10014 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10014 |            20 | t
 emaj        | myschema1_mytbl1_log_seq   |        10015 |            30 | t
 emaj        | myschema1_mytbl2_log_seq   |        10015 |             3 | t
 emaj        | myschema1_mytbl4_log_seq   |        10015 |             8 | t
 emajb       | myschema1_mytbl2b_log_seq  |        10015 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10015 |            20 | t
 myschema1   | mytbl2b_col20_seq          |        10015 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10015 |            20 | t
 emaj        | myschema1_mytbl1_log_seq   |        10021 |            32 | t
 emaj        | myschema1_mytbl2_log_seq   |        10021 |             3 | t
 emaj        | myschema1_mytbl4_log_seq   |        10021 |            12 | t
 emajb       | myschema1_mytbl2b_log_seq  |        10021 |             1 | f
 emajC       | myschema1_myTbl3_log_seq   |        10021 |            20 | t
 myschema1   | mytbl2b_col20_seq          |        10021 |             3 | f
 myschema1   | myTbl3_col31_seq           |        10021 |            20 | t
(45 rows)

select sqhl_schema, sqhl_table, sqhl_begin_time_id, sqhl_end_time_id, sqhl_hole_size from emaj.emaj_seq_hole order by 1,2,3;
 sqhl_schema | sqhl_table | sqhl_begin_time_id | sqhl_end_time_id | sqhl_hole_size 
-------------+------------+--------------------+------------------+----------------
 myschema1   | mytbl1     |              10015 |            10020 |              1
 myschema1   | mytbl4     |              10015 |            10020 |              2
 myschema2   | mytbl4     |              10008 |            10019 |              6
 myschema2   | mytbl5     |              10008 |            10019 |              3
 myschema2   | mytbl6     |              10008 |            10019 |              9
(5 rows)

-- user tables
select * from mySchema1.myTbl1 order by col11,col12;
 col11 |   col12    | col13 
-------+------------+-------
     2 | ABC        | \x1c
     3 | ABC        | \x1c
     4 | ABC        | \x0c
     5 | ABC        | \x0c
     6 | ABC        | \x0c
     7 | ABC        | \x0c
     8 | ABC        | \x0c
     9 | ABC        | \x0c
    10 | ABC        | \x0c
   100 | DEF        | \x00
   101 | DEF        | \x00
   102 | DEF        | \x00
   103 | DEF        | \x00
   104 | DEF        | \x00
   105 | DEF        | \x00
   106 | DEF        | \x00
   107 | DEF        | \x00
   108 | DEF        | \x00
   109 | DEF        | \x00
   110 | DEF        | \x00
(20 rows)

select * from mySchema1.myTbl2 order by col21;
 col21 | col22 |   col23    
-------+-------+------------
     1 | ABC   | 12-31-2010
     2 | DEF   | 
     3 | GHI   | 01-02-2010
(3 rows)

select * from mySchema1.myTbl2b order by col20;
 col20 | col21 
-------+-------
(0 rows)

select col31,col33 from mySchema1."myTbl3" order by col31;
 col31 | col33 
-------+-------
    11 | 10.00
    12 | 10.00
    13 | 10.00
    19 | 10.00
    20 | 10.00
(5 rows)

select * from mySchema1.myTbl4 order by col41;
 col41 | col42 | col43 | col44 | col45 
-------+-------+-------+-------+-------
(0 rows)

-- log tables
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema1_myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid 
-------+------------+-------+-----------+------------+----------
     1 | Step 6     | \x01  | INS       | NEW        |   100131
     1 | Step 6     | \x01  | DEL       | OLD        |   100154
(2 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema1_myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 | col23 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-----------+------------+----------
(0 rows)

select col20, col21, emaj_verb, emaj_tuple, emaj_gid from emajb.mySchema1_myTbl2b_log order by emaj_gid, emaj_tuple desc;
 col20 | col21 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
(0 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid from "emajC"."myschema1_myTbl3_log" order by emaj_gid, emaj_tuple desc;
 col31 | col33 | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-----------+------------+----------
    11 | 10.00 | UPD       | OLD        |   100112
    11 |  5.00 | UPD       | NEW        |   100112
    12 | 10.00 | UPD       | OLD        |   100113
    12 |  5.00 | UPD       | NEW        |   100113
    13 | 10.00 | UPD       | OLD        |   100114
    13 |  5.00 | UPD       | NEW        |   100114
    14 | 10.00 | UPD       | OLD        |   100115
    14 |  5.00 | UPD       | NEW        |   100115
    15 | 10.00 | UPD       | OLD        |   100116
    15 |  5.00 | UPD       | NEW        |   100116
    16 | 10.00 | UPD       | OLD        |   100117
    16 |  5.00 | UPD       | NEW        |   100117
    17 | 10.00 | UPD       | OLD        |   100118
    17 |  5.00 | UPD       | NEW        |   100118
    18 | 10.00 | UPD       | OLD        |   100119
    18 |  5.00 | UPD       | NEW        |   100119
    19 | 10.00 | UPD       | OLD        |   100120
    19 |  5.00 | UPD       | NEW        |   100120
    20 | 10.00 | UPD       | OLD        |   100121
    20 |  5.00 | UPD       | NEW        |   100121
    11 |  5.00 | DEL       | OLD        |   100134
    12 |  5.00 | DEL       | OLD        |   100135
    13 |  5.00 | DEL       | OLD        |   100136
    14 |  5.00 | DEL       | OLD        |   100137
    15 |  5.00 | DEL       | OLD        |   100138
    16 |  5.00 | DEL       | OLD        |   100139
    17 |  5.00 | DEL       | OLD        |   100140
    18 |  5.00 | DEL       | OLD        |   100141
    19 |  5.00 | DEL       | OLD        |   100142
    20 |  5.00 | DEL       | OLD        |   100143
    11 | 10.00 | INS       | NEW        |   100144
    12 | 10.00 | INS       | NEW        |   100145
    13 | 10.00 | INS       | NEW        |   100146
    14 | 10.00 | INS       | NEW        |   100147
    15 | 10.00 | INS       | NEW        |   100148
    16 | 10.00 | INS       | NEW        |   100149
    17 | 10.00 | INS       | NEW        |   100150
    18 | 10.00 | INS       | NEW        |   100151
    19 | 10.00 | INS       | NEW        |   100152
    20 | 10.00 | INS       | NEW        |   100153
    14 | 10.00 | DEL       | OLD        |   100157
    15 | 10.00 | DEL       | OLD        |   100158
    16 | 10.00 | DEL       | OLD        |   100159
    17 | 10.00 | DEL       | OLD        |   100160
    18 | 10.00 | DEL       | OLD        |   100161
(45 rows)

select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema1_myTbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 |   col45    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+------------+-----------+------------+----------
    11 |       |     1 |     1 | Step 6     | INS       | NEW        |   100132
    12 |       |     1 |     1 | Step 6     | INS       | NEW        |   100133
    11 |       |     1 |     1 | Step 6     | DEL       | OLD        |   100155
    12 |       |     1 |     1 | Step 6     | DEL       | OLD        |   100156
(4 rows)

--
--		grp1									grp2
--1	M1 up M2 up M3 
--2											M1 up M2 up M3
--3											LR-M2 (->M2%S+M2%E) LR-M3 (->M3%S+M3%E)
--4	R-M2 up M4 up M5 up M6
--5											LR-M2 (->M2%S+M2%E) R-M3
--6	up R-M5 up LR-M4(->M4S+M4E)
--7	up M7 REN-M4S DEL-M4E DEL-M1 DELBEF-M4
--
-----------------------------
-- check grants on other functions to emaj_adm role
-----------------------------
select * from emaj.emaj_verify_all();
  emaj_verify_all  
-------------------
 No error detected
(1 row)

select emaj.emaj_create_group('dummyGroup');
ERROR:  emaj_create_group: The group "dummyGroup" is unknown in the emaj_group_def table. To create an empty group, explicitely set the third parameter to true.
CONTEXT:  PL/pgSQL function emaj.emaj_create_group(text,boolean,boolean) line 31 at RAISE
select emaj.emaj_drop_group('dummyGroup');
ERROR:  _drop_group: The group "dummyGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj._drop_group(text,boolean) line 20 at RAISE
SQL statement "SELECT emaj._drop_group(v_groupName, FALSE)"
PL/pgSQL function emaj.emaj_drop_group(text) line 12 at SQL statement
select emaj.emaj_force_drop_group('dummyGroup');
ERROR:  _drop_group: The group "dummyGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj._drop_group(text,boolean) line 20 at RAISE
SQL statement "SELECT emaj._drop_group(v_groupName, TRUE)"
PL/pgSQL function emaj.emaj_force_drop_group(text) line 17 at SQL statement
select emaj.emaj_get_previous_mark_group('dummyGroup', '2010-01-01');
ERROR:  emaj_get_previous_mark_group (2): The group "dummyGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj.emaj_get_previous_mark_group(text,text) line 14 at RAISE
select emaj.emaj_get_previous_mark_group('dummyGroup', 'EMAJ_LAST_MARK');
ERROR:  emaj_get_previous_mark_group (2): The group "dummyGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj.emaj_get_previous_mark_group(text,text) line 14 at RAISE
select * from emaj.emaj_log_stat_group('dummyGroup', 'dummyMark', NULL); 
ERROR:  emaj_log_stat_group: The group "dummyGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj.emaj_log_stat_group(text,text,text) line 25 at RAISE
select * from emaj.emaj_detailed_log_stat_group('dummyGroup', 'dummyMark', NULL);
ERROR:  emaj_detailed_log_stat_group: The group "dummyGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj.emaj_detailed_log_stat_group(text,text,text) line 27 at RAISE
select emaj.emaj_estimate_rollback_group('dummyGroup', 'dummyMark', TRUE);
ERROR:  _rlbk_check: The group "dummyGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj._rlbk_check(text[],text,boolean,boolean) line 23 at RAISE
SQL statement "SELECT emaj._rlbk_check(v_groupNames, v_mark, TRUE, TRUE)"
PL/pgSQL function emaj._estimate_rollback_groups(text[],text,boolean) line 16 at SQL statement
PL/pgSQL function emaj.emaj_estimate_rollback_group(text,text,boolean) line 8 at RETURN
select emaj.emaj_estimate_rollback_groups(array['dummyGroup'], 'dummyMark', FALSE);
ERROR:  _rlbk_check: The group "dummyGroup" does not exist.
CONTEXT:  PL/pgSQL function emaj._rlbk_check(text[],text,boolean,boolean) line 23 at RAISE
SQL statement "SELECT emaj._rlbk_check(v_groupNames, v_mark, TRUE, TRUE)"
PL/pgSQL function emaj._estimate_rollback_groups(text[],text,boolean) line 16 at SQL statement
PL/pgSQL function emaj.emaj_estimate_rollback_groups(text[],text,boolean) line 8 at RETURN
select * from emaj.emaj_rollback_activity();
 rlbk_id | rlbk_groups | rlbk_mark | rlbk_mark_datetime | rlbk_is_logged | rlbk_is_alter_group_allowed | rlbk_nb_session | rlbk_nb_table | rlbk_nb_sequence | rlbk_eff_nb_table | rlbk_status | rlbk_start_datetime | rlbk_elapse | rlbk_remaining | rlbk_completion_pct 
---------+-------------+-----------+--------------------+----------------+-----------------------------+-----------------+---------------+------------------+-------------------+-------------+---------------------+-------------+----------------+---------------------
(0 rows)

select substr(pg_size_pretty(pg_database_size(current_database())),1,0);
 substr 
--------
 
(1 row)

