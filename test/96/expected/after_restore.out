-- after_restore.sql: Test emaj environment restored from a dump taken at the end of schedule reg tests
--                All operations are executed by super-user
--
-----------------------------
-- Checking restore
-----------------------------
select relname,relkind from pg_class where relname like 'emaj_%';
                         relname                         | relkind 
---------------------------------------------------------+---------
 emaj_alter_plan                                         | r
 emaj_alter_plan_pkey                                    | i
 emaj_consolidable_rollback_type                         | c
 emaj_detailed_log_stat_type                             | c
 emaj_global_seq                                         | S
 emaj_group                                              | r
 emaj_group_def                                          | r
 emaj_group_def_idx1                                     | i
 emaj_group_def_pkey                                     | i
 emaj_group_pkey                                         | i
 emaj_hist                                               | r
 emaj_hist_hist_id_seq                                   | S
 emaj_hist_pkey                                          | i
 emaj_log_stat_type                                      | c
 emaj_mark                                               | r
 emaj_mark_idx1                                          | i
 emaj_mark_mark_id_seq                                   | S
 emaj_mark_pkey                                          | i
 emaj_param                                              | r
 emaj_param_pkey                                         | i
 emaj_relation                                           | r
 emaj_relation_idx1                                      | i
 emaj_relation_idx2                                      | i
 emaj_relation_pkey                                      | i
 emaj_relation_rel_schema_rel_tblseq_rel_time_range_excl | i
 emaj_rlbk                                               | r
 emaj_rlbk_idx1                                          | i
 emaj_rlbk_pkey                                          | i
 emaj_rlbk_plan                                          | r
 emaj_rlbk_plan_pkey                                     | i
 emaj_rlbk_rlbk_id_seq                                   | S
 emaj_rlbk_session                                       | r
 emaj_rlbk_session_pkey                                  | i
 emaj_rlbk_stat                                          | r
 emaj_rlbk_stat_pkey                                     | i
 emaj_rollback_activity_type                             | c
 emaj_schema                                             | r
 emaj_schema_pkey                                        | i
 emaj_seq_hole                                           | r
 emaj_seq_hole_pkey                                      | i
 emaj_sequence                                           | r
 emaj_sequence_pkey                                      | i
 emaj_time_stamp                                         | r
 emaj_time_stamp_pkey                                    | i
 emaj_time_stamp_time_id_seq                             | S
 emaj_visible_param                                      | v
(46 rows)

select * from emaj.emaj_global_seq;
  sequence_name  | last_value | start_value | increment_by |      max_value      | min_value | cache_value | log_cnt | is_cycled | is_called 
-----------------+------------+-------------+--------------+---------------------+-----------+-------------+---------+-----------+-----------
 emaj_global_seq |        174 |           1 |            1 | 9223372036854775807 |         1 |           1 |       0 | f         | t
(1 row)

-----------------------------
-- Step 1 : for myGroup2, update tables and set a mark 
-----------------------------
set search_path=myschema2;
SET
insert into myTbl1 select 100+i, 'KLM', E'\\000\\014'::bytea from generate_series (1,11) as i;
INSERT 0 11
update myTbl1 set col13=E'\\000\\034'::bytea where col11 >105;
UPDATE 6
insert into myTbl2 values (100,'KLM','2012-12-31');
INSERT 0 1
delete from myTbl1 where col11 > 110;
DELETE 1
select nextval('myschema2.myseq1');
 nextval 
---------
    9999
(1 row)

--
select emaj.emaj_set_mark_group('myGroup2','After restore mark');
 emaj_set_mark_group 
---------------------
                   6
(1 row)

--
-----------------------------
-- Checking step 1
-----------------------------
-- emaj tables
select mark_id, mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d','%','g'), mark_time_id, mark_is_deleted, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_id;
 mark_id |    mark_group    |        regexp_replace        | mark_time_id | mark_is_deleted | mark_is_rlbk_protected | mark_comment | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
---------+------------------+------------------------------+--------------+-----------------+------------------------+--------------+---------------------------+------------------------------
       2 | myGroup2         | M1                           |            5 | f               | f                      |              |                        27 | 
       3 | phil's group#3", | M1                           |            6 | f               | f                      |              |                           | 
       6 | myGroup2         | M2                           |           11 | f               | f                      |              |                         4 | 
       7 | myGroup2         | M3                           |           12 | f               | f                      |              |                         0 | 
      18 | myGroup1         | M4                           |           23 | f               | f                      |              |                         0 | 
      19 | myGroup1         | M5                           |           24 | f               | f                      |              |                         3 | 
      23 | myGroup1         | Before logged rollback to M4 |           30 | f               | f                      |              |                         3 | 
      25 | myGroup1         | Multi-1                      |           32 | f               | f                      |              |                           | 
      26 | myGroup2         | Multi-1                      |           32 | f               | f                      |              |                        43 | 
      27 | myGroup2         | After restore mark           |           33 | f               | f                      |              |                           | 
(10 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
  sequ_schema   |             sequ_name              | sequ_time_id | sequ_last_val | sequ_is_called 
----------------+------------------------------------+--------------+---------------+----------------
 emaj           | myschema2_mytbl1_log_seq           |            5 |             1 | f
 emaj           | myschema2_mytbl2_log_seq           |            5 |             1 | f
 emaj           | myschema2_myTbl3_log_seq           |            5 |             1 | f
 emaj           | myschema2_mytbl4_log_seq           |            5 |             1 | f
 myschema2      | myseq1                             |            5 |          1000 | f
 myschema2      | myTbl3_col31_seq                   |            5 |             1 | f
 emaj           | phil's schema3_myTbl2\_log_seq     |            6 |             1 | f
 emaj           | phil's schema3_phil's tbl1_log_seq |            6 |             1 | f
 phil's schema3 | phil's seq\1                       |            6 |          1000 | f
 emaj           | myschema1_myTbl3_log_seq           |            7 |            10 | t
 emaj           | myschema1_myTbl3_log_seq           |            8 |            10 | t
 emaj           | myschema2_mytbl1_log_seq           |           11 |            15 | t
 emaj           | myschema2_mytbl2_log_seq           |           11 |             2 | t
 emaj           | myschema2_myTbl3_log_seq           |           11 |            10 | t
 emaj           | myschema2_mytbl4_log_seq           |           11 |             1 | f
 myschema2      | myseq1                             |           11 |          1000 | t
 myschema2      | myTbl3_col31_seq                   |           11 |            10 | t
 emaj           | myschema2_mytbl1_log_seq           |           12 |            15 | t
 emaj           | myschema2_mytbl2_log_seq           |           12 |             2 | t
 emaj           | myschema2_myTbl3_log_seq           |           12 |            10 | t
 emaj           | myschema2_mytbl4_log_seq           |           12 |             4 | t
 myschema2      | myseq1                             |           12 |          1003 | t
 myschema2      | myTbl3_col31_seq                   |           12 |            10 | t
 emaj           | myschema1_myTbl3_log_seq           |           17 |            10 | t
 emaj           | myschema1_myTbl3_log_seq           |           18 |            10 | t
 emaj           | myschema1_mytbl1_log_seq           |           23 |            41 | t
 emaj           | myschema1_mytbl2b_log_seq          |           23 |             5 | t
 emaj           | myschema1_mytbl2_log_seq           |           23 |             4 | t
 emaj           | myschema1_mytbl4_log_seq           |           23 |            11 | t
 myschema1      | myTbl3_col31_seq                   |           23 |            10 | t
 emaj           | myschema1_mytbl1_log_seq           |           24 |            41 | t
 emaj           | myschema1_mytbl2b_log_seq          |           24 |             5 | t
 emaj           | myschema1_mytbl2_log_seq           |           24 |             4 | t
 emaj           | myschema1_mytbl4_log_seq           |           24 |            11 | t
 myschema1      | myTbl3_col31_seq                   |           24 |            10 | t
 emaj           | myschema1_mytbl1_log_seq           |           30 |            43 | t
 emaj           | myschema1_mytbl2b_log_seq          |           30 |             5 | t
 emaj           | myschema1_mytbl2_log_seq           |           30 |             4 | t
 emaj           | myschema1_mytbl4_log_seq           |           30 |            15 | t
 myschema1      | myTbl3_col31_seq                   |           30 |            10 | t
 emaj           | myschema1_mytbl1_log_seq           |           32 |            44 | t
 emaj           | myschema1_mytbl2b_log_seq          |           32 |             5 | t
 emaj           | myschema1_mytbl2_log_seq           |           32 |             4 | t
 emaj           | myschema1_mytbl4_log_seq           |           32 |            17 | t
 emaj           | myschema2_mytbl1_log_seq           |           32 |            15 | t
 emaj           | myschema2_mytbl2_log_seq           |           32 |             2 | t
 emaj           | myschema2_myTbl3_log_seq           |           32 |            10 | t
 emaj           | myschema2_mytbl4_log_seq           |           32 |            10 | t
 myschema1      | myTbl3_col31_seq                   |           32 |            10 | t
 myschema2      | myseq1                             |           32 |          1004 | f
 myschema2      | myTbl3_col31_seq                   |           32 |            10 | t
 emaj           | myschema2_mytbl1_log_seq           |           33 |            43 | t
 emaj           | myschema2_mytbl2_log_seq           |           33 |             5 | t
 emaj           | myschema2_myTbl3_log_seq           |           33 |            20 | t
 emaj           | myschema2_mytbl4_log_seq           |           33 |            12 | t
 myschema2      | myseq1                             |           33 |          9999 | t
 myschema2      | myTbl3_col31_seq                   |           33 |            10 | t
(57 rows)

-- user tables
select * from mySchema2.myTbl1 order by col11,col12;
 col11 |   col12    | col13  
-------+------------+--------
   101 | KLM        | \x000c
   102 | KLM        | \x000c
   103 | KLM        | \x000c
   104 | KLM        | \x000c
   105 | KLM        | \x000c
   106 | KLM        | \x001c
   107 | KLM        | \x001c
   108 | KLM        | \x001c
   109 | KLM        | \x001c
   110 | KLM        | \x001c
(10 rows)

select * from mySchema2.myTbl2 order by col21;
 col21 | col22 |   col23    
-------+-------+------------
   100 | KLM   | 2012-12-31
(1 row)

select col31,col33 from mySchema2."myTbl3" order by col31;
 col31 | col33 
-------+-------
(0 rows)

select * from mySchema2.myTbl4 order by col41;
 col41 | col42 | col43 | col44 | col45 
-------+-------+-------+-------+-------
(0 rows)

-- log tables
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema2_myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13  | emaj_verb | emaj_tuple | emaj_gid 
-------+------------+--------+-----------+------------+----------
     1 | ABC        | \x0c   | INS       | NEW        |       51
     2 | ABC        | \x0c   | INS       | NEW        |       52
     3 | ABC        | \x0c   | INS       | NEW        |       53
     4 | ABC        | \x0c   | INS       | NEW        |       54
     5 | ABC        | \x0c   | INS       | NEW        |       55
     6 | ABC        | \x0c   | INS       | NEW        |       56
     7 | ABC        | \x0c   | INS       | NEW        |       57
     8 | ABC        | \x0c   | INS       | NEW        |       58
     9 | ABC        | \x0c   | INS       | NEW        |       59
    10 | ABC        | \x0c   | INS       | NEW        |       60
    11 | ABC        | \x0c   | INS       | NEW        |       61
     1 | ABC        | \x0c   | UPD       | OLD        |       62
     1 | ABC        | \x1c   | UPD       | NEW        |       62
     2 | ABC        | \x0c   | UPD       | OLD        |       63
     2 | ABC        | \x1c   | UPD       | NEW        |       63
     3 | ABC        | \x0c   | UPD       | OLD        |       64
     3 | ABC        | \x1c   | UPD       | NEW        |       64
    11 | ABC        | \x0c   | DEL       | OLD        |       66
     4 | ABC        | \x0c   | DEL       | OLD        |      153
     5 | ABC        | \x0c   | DEL       | OLD        |      154
     6 | ABC        | \x0c   | DEL       | OLD        |      155
     7 | ABC        | \x0c   | DEL       | OLD        |      156
     8 | ABC        | \x0c   | DEL       | OLD        |      157
     9 | ABC        | \x0c   | DEL       | OLD        |      158
    10 | ABC        | \x0c   | DEL       | OLD        |      159
     1 | ABC        | \x1c   | DEL       | OLD        |      160
     2 | ABC        | \x1c   | DEL       | OLD        |      161
     3 | ABC        | \x1c   | DEL       | OLD        |      162
   101 | KLM        | \x000c | INS       | NEW        |      175
   102 | KLM        | \x000c | INS       | NEW        |      176
   103 | KLM        | \x000c | INS       | NEW        |      177
   104 | KLM        | \x000c | INS       | NEW        |      178
   105 | KLM        | \x000c | INS       | NEW        |      179
   106 | KLM        | \x000c | INS       | NEW        |      180
   107 | KLM        | \x000c | INS       | NEW        |      181
   108 | KLM        | \x000c | INS       | NEW        |      182
   109 | KLM        | \x000c | INS       | NEW        |      183
   110 | KLM        | \x000c | INS       | NEW        |      184
   111 | KLM        | \x000c | INS       | NEW        |      185
   106 | KLM        | \x000c | UPD       | OLD        |      186
   106 | KLM        | \x001c | UPD       | NEW        |      186
   107 | KLM        | \x000c | UPD       | OLD        |      187
   107 | KLM        | \x001c | UPD       | NEW        |      187
   108 | KLM        | \x000c | UPD       | OLD        |      188
   108 | KLM        | \x001c | UPD       | NEW        |      188
   109 | KLM        | \x000c | UPD       | OLD        |      189
   109 | KLM        | \x001c | UPD       | NEW        |      189
   110 | KLM        | \x000c | UPD       | OLD        |      190
   110 | KLM        | \x001c | UPD       | NEW        |      190
   111 | KLM        | \x000c | UPD       | OLD        |      191
   111 | KLM        | \x001c | UPD       | NEW        |      191
   111 | KLM        | \x001c | DEL       | OLD        |      193
(52 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema2_myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 |   col23    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+------------+-----------+------------+----------
     1 | ABC   | 2010-01-01 | INS       | NEW        |       65
     2 | DEF   |            | INS       | NEW        |       67
     1 | ABC   | 2010-01-01 | DEL       | OLD        |      163
     2 | DEF   |            | DEL       | OLD        |      164
   100 | KLM   | 2012-12-31 | INS       | NEW        |      192
(5 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid from "emajC"."myschema2_myTbl3_log" order by emaj_gid, emaj_tuple desc;
ERROR:  relation "emajC.myschema2_myTbl3_log" does not exist
LINE 1: ...ol31, col33, emaj_verb, emaj_tuple, emaj_gid from "emajC"."m...
                                                             ^
select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema2_myTbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 |   col45    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+------------+-----------+------------+----------
     1 | FK... |     1 |     1 | ABC        | INS       | NEW        |       78
     2 | FK... |     1 |     1 | ABC        | INS       | NEW        |       79
     1 | FK... |     1 |     1 | ABC        | UPD       | OLD        |       80
     1 | FK... |     2 |     1 | ABC        | UPD       | NEW        |       80
     2 | FK... |     1 |     1 | ABC        | UPD       | OLD        |       81
     2 | FK... |     2 |     1 | ABC        | UPD       | NEW        |       81
     1 | FK... |     2 |     1 | ABC        | DEL       | OLD        |      151
     2 | FK... |     2 |     1 | ABC        | DEL       | OLD        |      152
(8 rows)

--
-----------------------------
-- Step 2 : for myGroup2, rollback to mark Multi-1 (set before dump/restore) 
-----------------------------
select * from emaj.emaj_log_stat_group('myGroup2','Multi-1',NULL);
 stat_group | stat_schema | stat_table | stat_first_mark |   stat_first_mark_datetime    | stat_last_mark | stat_last_mark_datetime | stat_rows 
------------+-------------+------------+-----------------+-------------------------------+----------------+-------------------------+-----------
 myGroup2   | myschema2   | mytbl1     | Multi-1         | 2018-04-06 18:41:00.232932+02 |                |                         |        28
 myGroup2   | myschema2   | mytbl2     | Multi-1         | 2018-04-06 18:41:00.232932+02 |                |                         |         3
 myGroup2   | myschema2   | myTbl3     | Multi-1         | 2018-04-06 18:41:00.232932+02 |                |                         |        10
 myGroup2   | myschema2   | mytbl4     | Multi-1         | 2018-04-06 18:41:00.232932+02 |                |                         |         2
(4 rows)

select emaj.emaj_rollback_group('myGroup2','Multi-1');
 emaj_rollback_group 
---------------------
                   6
(1 row)

--
-----------------------------
-- Checking step 2
-----------------------------
-- emaj tables
select mark_id, mark_group, regexp_replace(mark_name,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d','%','g'), mark_time_id, mark_is_deleted, mark_is_rlbk_protected, mark_comment, mark_log_rows_before_next, mark_logged_rlbk_target_mark from emaj.emaj_mark order by mark_id;
 mark_id |    mark_group    |        regexp_replace        | mark_time_id | mark_is_deleted | mark_is_rlbk_protected | mark_comment | mark_log_rows_before_next | mark_logged_rlbk_target_mark 
---------+------------------+------------------------------+--------------+-----------------+------------------------+--------------+---------------------------+------------------------------
       2 | myGroup2         | M1                           |            5 | f               | f                      |              |                        27 | 
       3 | phil's group#3", | M1                           |            6 | f               | f                      |              |                           | 
       6 | myGroup2         | M2                           |           11 | f               | f                      |              |                         4 | 
       7 | myGroup2         | M3                           |           12 | f               | f                      |              |                         0 | 
      18 | myGroup1         | M4                           |           23 | f               | f                      |              |                         0 | 
      19 | myGroup1         | M5                           |           24 | f               | f                      |              |                         3 | 
      23 | myGroup1         | Before logged rollback to M4 |           30 | f               | f                      |              |                         3 | 
      25 | myGroup1         | Multi-1                      |           32 | f               | f                      |              |                           | 
      26 | myGroup2         | Multi-1                      |           32 | f               | f                      |              |                           | 
(9 rows)

select sequ_schema, sequ_name, sequ_time_id, sequ_last_val, sequ_is_called from emaj.emaj_sequence order by sequ_time_id, sequ_schema, sequ_name;
  sequ_schema   |             sequ_name              | sequ_time_id | sequ_last_val | sequ_is_called 
----------------+------------------------------------+--------------+---------------+----------------
 emaj           | myschema2_mytbl1_log_seq           |            5 |             1 | f
 emaj           | myschema2_mytbl2_log_seq           |            5 |             1 | f
 emaj           | myschema2_myTbl3_log_seq           |            5 |             1 | f
 emaj           | myschema2_mytbl4_log_seq           |            5 |             1 | f
 myschema2      | myseq1                             |            5 |          1000 | f
 myschema2      | myTbl3_col31_seq                   |            5 |             1 | f
 emaj           | phil's schema3_myTbl2\_log_seq     |            6 |             1 | f
 emaj           | phil's schema3_phil's tbl1_log_seq |            6 |             1 | f
 phil's schema3 | phil's seq\1                       |            6 |          1000 | f
 emaj           | myschema1_myTbl3_log_seq           |            7 |            10 | t
 emaj           | myschema1_myTbl3_log_seq           |            8 |            10 | t
 emaj           | myschema2_mytbl1_log_seq           |           11 |            15 | t
 emaj           | myschema2_mytbl2_log_seq           |           11 |             2 | t
 emaj           | myschema2_myTbl3_log_seq           |           11 |            10 | t
 emaj           | myschema2_mytbl4_log_seq           |           11 |             1 | f
 myschema2      | myseq1                             |           11 |          1000 | t
 myschema2      | myTbl3_col31_seq                   |           11 |            10 | t
 emaj           | myschema2_mytbl1_log_seq           |           12 |            15 | t
 emaj           | myschema2_mytbl2_log_seq           |           12 |             2 | t
 emaj           | myschema2_myTbl3_log_seq           |           12 |            10 | t
 emaj           | myschema2_mytbl4_log_seq           |           12 |             4 | t
 myschema2      | myseq1                             |           12 |          1003 | t
 myschema2      | myTbl3_col31_seq                   |           12 |            10 | t
 emaj           | myschema1_myTbl3_log_seq           |           17 |            10 | t
 emaj           | myschema1_myTbl3_log_seq           |           18 |            10 | t
 emaj           | myschema1_mytbl1_log_seq           |           23 |            41 | t
 emaj           | myschema1_mytbl2b_log_seq          |           23 |             5 | t
 emaj           | myschema1_mytbl2_log_seq           |           23 |             4 | t
 emaj           | myschema1_mytbl4_log_seq           |           23 |            11 | t
 myschema1      | myTbl3_col31_seq                   |           23 |            10 | t
 emaj           | myschema1_mytbl1_log_seq           |           24 |            41 | t
 emaj           | myschema1_mytbl2b_log_seq          |           24 |             5 | t
 emaj           | myschema1_mytbl2_log_seq           |           24 |             4 | t
 emaj           | myschema1_mytbl4_log_seq           |           24 |            11 | t
 myschema1      | myTbl3_col31_seq                   |           24 |            10 | t
 emaj           | myschema1_mytbl1_log_seq           |           30 |            43 | t
 emaj           | myschema1_mytbl2b_log_seq          |           30 |             5 | t
 emaj           | myschema1_mytbl2_log_seq           |           30 |             4 | t
 emaj           | myschema1_mytbl4_log_seq           |           30 |            15 | t
 myschema1      | myTbl3_col31_seq                   |           30 |            10 | t
 emaj           | myschema1_mytbl1_log_seq           |           32 |            44 | t
 emaj           | myschema1_mytbl2b_log_seq          |           32 |             5 | t
 emaj           | myschema1_mytbl2_log_seq           |           32 |             4 | t
 emaj           | myschema1_mytbl4_log_seq           |           32 |            17 | t
 emaj           | myschema2_mytbl1_log_seq           |           32 |            15 | t
 emaj           | myschema2_mytbl2_log_seq           |           32 |             2 | t
 emaj           | myschema2_myTbl3_log_seq           |           32 |            10 | t
 emaj           | myschema2_mytbl4_log_seq           |           32 |            10 | t
 myschema1      | myTbl3_col31_seq                   |           32 |            10 | t
 myschema2      | myseq1                             |           32 |          1004 | f
 myschema2      | myTbl3_col31_seq                   |           32 |            10 | t
(51 rows)

select time_id, time_last_emaj_gid, time_event from emaj.emaj_time_stamp order by time_id;
 time_id | time_last_emaj_gid | time_event 
---------+--------------------+------------
       1 |                  0 | C
       2 |                  0 | C
       3 |                  0 | C
       4 |                  0 | M
       5 |                  0 | M
       6 |                  0 | M
       7 |                 29 | M
       8 |                 40 | M
       9 |                 46 | R
      10 |                 49 | R
      11 |                 77 | M
      12 |                 81 | M
      13 |                 81 | R
      14 |                 83 | M
      15 |                 83 | R
      16 |                 85 | M
      17 |                 85 | M
      18 |                 85 | A
      19 |                 85 | R
      20 |                 85 | R
      21 |                 92 | M
      22 |                 92 | A
      23 |                106 | M
      24 |                106 | M
      25 |                106 | M
      26 |                106 | R
      27 |                108 | M
      28 |                108 | R
      29 |                111 | R
      30 |                114 | R
      31 |                117 | M
      32 |                117 | M
      33 |                193 | M
      34 |                193 | R
(34 rows)

-- user tables
select * from mySchema2.myTbl1 order by col11,col12;
 col11 |   col12    | col13 
-------+------------+-------
     1 | ABC        | \x1c
     2 | ABC        | \x1c
     3 | ABC        | \x1c
     4 | ABC        | \x0c
     5 | ABC        | \x0c
     6 | ABC        | \x0c
     7 | ABC        | \x0c
     8 | ABC        | \x0c
     9 | ABC        | \x0c
    10 | ABC        | \x0c
(10 rows)

select * from mySchema2.myTbl2 order by col21;
 col21 | col22 |   col23    
-------+-------+------------
     1 | ABC   | 2010-01-01
     2 | DEF   | 
(2 rows)

select col31,col33 from mySchema2."myTbl3" order by col31;
 col31 | col33 
-------+-------
     1 | 10.00
     2 | 10.00
     3 | 10.00
     4 | 10.00
     5 | 10.00
     6 | 10.00
     7 | 10.00
     8 | 10.00
     9 | 10.00
    10 | 10.00
(10 rows)

select * from mySchema2.myTbl4 order by col41;
 col41 | col42 | col43 | col44 |   col45    
-------+-------+-------+-------+------------
     1 | FK... |     2 |     1 | ABC       
     2 | FK... |     2 |     1 | ABC       
(2 rows)

-- log tables
select col11, col12, col13, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema2_myTbl1_log order by emaj_gid, emaj_tuple desc;
 col11 |   col12    | col13 | emaj_verb | emaj_tuple | emaj_gid 
-------+------------+-------+-----------+------------+----------
     1 | ABC        | \x0c  | INS       | NEW        |       51
     2 | ABC        | \x0c  | INS       | NEW        |       52
     3 | ABC        | \x0c  | INS       | NEW        |       53
     4 | ABC        | \x0c  | INS       | NEW        |       54
     5 | ABC        | \x0c  | INS       | NEW        |       55
     6 | ABC        | \x0c  | INS       | NEW        |       56
     7 | ABC        | \x0c  | INS       | NEW        |       57
     8 | ABC        | \x0c  | INS       | NEW        |       58
     9 | ABC        | \x0c  | INS       | NEW        |       59
    10 | ABC        | \x0c  | INS       | NEW        |       60
    11 | ABC        | \x0c  | INS       | NEW        |       61
     1 | ABC        | \x0c  | UPD       | OLD        |       62
     1 | ABC        | \x1c  | UPD       | NEW        |       62
     2 | ABC        | \x0c  | UPD       | OLD        |       63
     2 | ABC        | \x1c  | UPD       | NEW        |       63
     3 | ABC        | \x0c  | UPD       | OLD        |       64
     3 | ABC        | \x1c  | UPD       | NEW        |       64
    11 | ABC        | \x0c  | DEL       | OLD        |       66
(18 rows)

select col21, col22, col23, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema2_myTbl2_log order by emaj_gid, emaj_tuple desc;
 col21 | col22 |   col23    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+------------+-----------+------------+----------
     1 | ABC   | 2010-01-01 | INS       | NEW        |       65
     2 | DEF   |            | INS       | NEW        |       67
(2 rows)

select col31, col33, emaj_verb, emaj_tuple, emaj_gid from "emajC"."myschema2_myTbl3_log" order by emaj_gid, emaj_tuple desc;
ERROR:  relation "emajC.myschema2_myTbl3_log" does not exist
LINE 1: ...ol31, col33, emaj_verb, emaj_tuple, emaj_gid from "emajC"."m...
                                                             ^
select col41, col42, col43, col44, col45, emaj_verb, emaj_tuple, emaj_gid from emaj.mySchema2_myTbl4_log order by emaj_gid, emaj_tuple desc;
 col41 | col42 | col43 | col44 |   col45    | emaj_verb | emaj_tuple | emaj_gid 
-------+-------+-------+-------+------------+-----------+------------+----------
     1 | FK... |     1 |     1 | ABC        | INS       | NEW        |       78
     2 | FK... |     1 |     1 | ABC        | INS       | NEW        |       79
     1 | FK... |     1 |     1 | ABC        | UPD       | OLD        |       80
     1 | FK... |     2 |     1 | ABC        | UPD       | NEW        |       80
     2 | FK... |     1 |     1 | ABC        | UPD       | OLD        |       81
     2 | FK... |     2 |     1 | ABC        | UPD       | NEW        |       81
(6 rows)

--
-----------------------------
-- Step 3 : stop myGroup2
-----------------------------
select emaj.emaj_stop_group('myGroup2');
 emaj_stop_group 
-----------------
               6
(1 row)

--
-----------------------------
-- test end: check and reset history
-----------------------------
select hist_id, hist_function, hist_event, hist_object, regexp_replace(regexp_replace(hist_wording,E'\\d\\d\.\\d\\d\\.\\d\\d\\.\\d\\d\\d','%','g'),E'\\[.+\\]','(timestamp)','g'), hist_user from 
  (select * from emaj.emaj_hist order by hist_id) as t;
 hist_id |   hist_function   |  hist_event  |         hist_object          |                         regexp_replace                         | hist_user 
---------+-------------------+--------------+------------------------------+----------------------------------------------------------------+-----------
       1 | EMAJ_INSTALL      |              | E-Maj <devel>                | Initialisation completed                                       | postgres
   30000 | SET_MARK_GROUPS   | BEGIN        | myGroup1,myGroup2            | Multi-1                                                        | postgres
   30001 | LOCK_GROUPS       | BEGIN        | myGroup1,myGroup2            |                                                                | postgres
   30002 | LOCK_GROUPS       | END          | myGroup1,myGroup2            | 8 tables locked, 0 deadlock(s)                                 | postgres
   30003 | SET_MARK_GROUPS   | END          | myGroup1,myGroup2            | Multi-1                                                        | postgres
   30004 | SET_MARK_GROUP    | BEGIN        | myGroup2                     |                                                                | postgres
   30005 | LOCK_GROUP        | BEGIN        | myGroup2                     |                                                                | postgres
   30006 | LOCK_GROUP        | END          | myGroup2                     | 4 tables locked, 0 deadlock(s)                                 | postgres
   30007 | SET_MARK_GROUP    | END          | myGroup2                     | After restore mark                                             | postgres
   30008 | ROLLBACK_GROUP    | BEGIN        | myGroup2                     | Unlogged rollback to mark Multi-1 (timestamp)                  | postgres
   30009 | DBLINK_OPEN_CNX   |              | rlbk#1                       | Status = -2                                                    | postgres
   30010 | LOCK_GROUP        | BEGIN        | myGroup2                     | Rollback session #1                                            | postgres
   30011 | LOCK_GROUP        | END          | myGroup2                     | Rollback session #1: 4 tables locked, 0 deadlock(s)            | postgres
   30012 | ROLLBACK_TABLE    | BEGIN        | myschema2.mytbl1             | All log rows with emaj_gid > 117 and <= 193                    | postgres
   30013 | ROLLBACK_TABLE    | END          | myschema2.mytbl1             | 21 rolled back primary keys                                    | postgres
   30014 | ROLLBACK_TABLE    | BEGIN        | myschema2.mytbl2             | All log rows with emaj_gid > 117 and <= 193                    | postgres
   30015 | ROLLBACK_TABLE    | END          | myschema2.mytbl2             | 3 rolled back primary keys                                     | postgres
   30016 | ROLLBACK_TABLE    | BEGIN        | myschema2.mytbl4             | All log rows with emaj_gid > 117 and <= 193                    | postgres
   30017 | ROLLBACK_TABLE    | END          | myschema2.mytbl4             | 2 rolled back primary keys                                     | postgres
   30018 | ROLLBACK_TABLE    | BEGIN        | myschema2."myTbl3"           | All log rows with emaj_gid > 117 and <= 193                    | postgres
   30019 | ROLLBACK_TABLE    | END          | myschema2."myTbl3"           | 10 rolled back primary keys                                    | postgres
   30020 | ROLLBACK_GROUP    | MARK DELETED | myGroup2                     | mark After restore mark is deleted                             | postgres
   30021 | ROLLBACK_SEQUENCE |              | myschema2.myseq1             | RESTART 1004                                                   | postgres
   30022 | ROLLBACK_SEQUENCE |              | myschema2."myTbl3_col31_seq" |                                                                | postgres
   30023 | ROLLBACK_GROUP    | NOTICE       | Rollback id 11               | 4 / 4 tables effectively processed.                            | postgres
   30024 | ROLLBACK_GROUP    | NOTICE       | Rollback id 11               | 2 sequences processed.                                         | postgres
   30025 | ROLLBACK_GROUP    | END          | myGroup2                     | Rollback_id 11, 4 tables and 2 sequences effectively processed | postgres
   30026 | STOP_GROUP        | BEGIN        | myGroup2                     |                                                                | postgres
   30027 | LOCK_GROUP        | BEGIN        | myGroup2                     |                                                                | postgres
   30028 | LOCK_GROUP        | END          | myGroup2                     | 4 tables locked, 0 deadlock(s)                                 | postgres
   30029 | SET_MARK_GROUP    | BEGIN        | myGroup2                     | STOP_%                                                         | postgres
   30030 | SET_MARK_GROUP    | END          | myGroup2                     | STOP_%                                                         | postgres
   30031 | STOP_GROUP        | END          | myGroup2                     | 6 tables/sequences processed                                   | postgres
(33 rows)

--
truncate emaj.emaj_hist;
TRUNCATE TABLE
alter sequence emaj.emaj_hist_hist_id_seq restart 30000;
ALTER SEQUENCE
